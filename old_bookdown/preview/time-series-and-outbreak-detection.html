<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>7 Time series and outbreak detection | The Epidemiologist R Handbook</title>
<meta name="author" content="the handbook team">
<meta name="description" content="7.1 Overview This tab demonstrates the use of several packages for time series analysis. It primarily relies on packages from the tidyverts family, but will also use the RECON trending package to...">
<meta name="generator" content="bookdown 0.34 with bs4_book()">
<meta property="og:title" content="7 Time series and outbreak detection | The Epidemiologist R Handbook">
<meta property="og:type" content="book">
<meta property="og:description" content="7.1 Overview This tab demonstrates the use of several packages for time series analysis. It primarily relies on packages from the tidyverts family, but will also use the RECON trending package to...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="7 Time series and outbreak detection | The Epidemiologist R Handbook">
<meta name="twitter:description" content="7.1 Overview This tab demonstrates the use of several packages for time series analysis. It primarily relies on packages from the tidyverts family, but will also use the RECON trending package to...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.0/transition.js"></script><script src="libs/bs3compat-0.5.0/tabs.js"></script><script src="libs/bs3compat-0.5.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.2/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.28/datatables.js"></script><link href="libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">
<script src="libs/tabwid-1.1.3/tabwid.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.2/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.2/leaflet-providers-plugin.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script>
</head>
<body>
<div class="alert alert-info alert-dismissible">
      <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
      <strong>Need help learning R?</strong> Enroll in Applied Epi's <a href="https://www.appliedepi.org/live/" class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/" class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/" class="alert-link">Community Q&amp;A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org" class="alert-link">R Help Desk service</a>.
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">The Epidemiologist R Handbook</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">Analysis</li>
<li><a class="" href="descriptive-tables.html"><span class="header-section-number">1</span> Descriptive tables</a></li>
<li><a class="" href="simple-statistical-tests.html"><span class="header-section-number">2</span> Simple statistical tests</a></li>
<li><a class="" href="univariate-and-multivariable-regression.html"><span class="header-section-number">3</span> Univariate and multivariable regression</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">4</span> Missing data</a></li>
<li><a class="" href="standardised-rates.html"><span class="header-section-number">5</span> Standardised rates</a></li>
<li><a class="" href="moving-averages.html"><span class="header-section-number">6</span> Moving averages</a></li>
<li><a class="active" href="time-series-and-outbreak-detection.html"><span class="header-section-number">7</span> Time series and outbreak detection</a></li>
<li><a class="" href="epidemic-modeling.html"><span class="header-section-number">8</span> Epidemic modeling</a></li>
<li><a class="" href="contact-tracing.html"><span class="header-section-number">9</span> Contact tracing</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">10</span> Survey analysis</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">11</span> Survival analysis</a></li>
<li><a class="" href="gis-basics.html"><span class="header-section-number">12</span> GIS basics</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="time-series-and-outbreak-detection" class="section level1" number="7">
<h1>
<span class="header-section-number">7</span> Time series and outbreak detection<a class="anchor" aria-label="anchor" href="#time-series-and-outbreak-detection"><i class="fas fa-link"></i></a>
</h1>
<!-- ======================================================= -->
<div id="overview-1" class="section level2" number="7.1">
<h2>
<span class="header-section-number">7.1</span> Overview<a class="anchor" aria-label="anchor" href="#overview-1"><i class="fas fa-link"></i></a>
</h2>
<p>This tab demonstrates the use of several packages for time series analysis.
It primarily relies on packages from the <a href="https://tidyverts.org/"><strong>tidyverts</strong></a>
family, but will also use the RECON <a href="https://github.com/reconhub/trending"><strong>trending</strong></a>
package to fit models that are more appropriate for infectious disease epidemiology.</p>
<p>Note in the below example we use a dataset from the <strong>surveillance</strong> package
on Campylobacter in Germany (see the <a href="https://epirhandbook.com/download-handbook-and-data.html">data chapter</a>,
of the handbook for details). However, if you wanted to run the same code on a dataset
with multiple countries or other strata, then there is an example code template for this in the
<a href="https://github.com/R4EPI/epitsa">r4epis github repo</a>.</p>
<p>Topics covered include:</p>
<ol style="list-style-type: decimal">
<li>Time series data</li>
<li>Descriptive analysis</li>
<li>Fitting regressions</li>
<li>Relation of two time series</li>
<li>Outbreak detection</li>
<li>Interrupted time series</li>
</ol>
<!-- ======================================================= -->
</div>
<div id="preparation-6" class="section level2" number="7.2">
<h2>
<span class="header-section-number">7.2</span> Preparation<a class="anchor" aria-label="anchor" href="#preparation-6"><i class="fas fa-link"></i></a>
</h2>
<div id="packages" class="section level3 unnumbered">
<h3>Packages<a class="anchor" aria-label="anchor" href="#packages"><i class="fas fa-link"></i></a>
</h3>
<p>This code chunk shows the loading of packages required for the analyses. In this handbook we emphasize <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> from <strong>pacman</strong>, which installs the package if necessary <em>and</em> loads it for use. You can also load packages with <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> from <strong>base</strong> R. See the page on <a href="https://epirhandbook.com/r-basics.html">R basics</a> for more information on R packages.</p>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">rio</span>,          <span class="co"># File import</span></span>
<span>               <span class="va">here</span>,         <span class="co"># File locator</span></span>
<span>               <span class="va">tidyverse</span>,    <span class="co"># data management + ggplot2 graphics</span></span>
<span>               <span class="va">tsibble</span>,      <span class="co"># handle time series datasets</span></span>
<span>               <span class="va">slider</span>,       <span class="co"># for calculating moving averages</span></span>
<span>               <span class="va">imputeTS</span>,     <span class="co"># for filling in missing values</span></span>
<span>               <span class="va">feasts</span>,       <span class="co"># for time series decomposition and autocorrelation</span></span>
<span>               <span class="va">forecast</span>,     <span class="co"># fit sin and cosin terms to data (note: must load after feasts)</span></span>
<span>               <span class="va">trending</span>,     <span class="co"># fit and assess models </span></span>
<span>               <span class="va">tmaptools</span>,    <span class="co"># for getting geocoordinates (lon/lat) based on place names</span></span>
<span>               <span class="va">ecmwfr</span>,       <span class="co"># for interacting with copernicus sateliate CDS API</span></span>
<span>               <span class="va">stars</span>,        <span class="co"># for reading in .nc (climate data) files</span></span>
<span>               <span class="va">units</span>,        <span class="co"># for defining units of measurement (climate data)</span></span>
<span>               <span class="va">yardstick</span>,    <span class="co"># for looking at model accuracy</span></span>
<span>               <span class="va">surveillance</span>  <span class="co"># for aberration detection</span></span>
<span>               <span class="op">)</span></span></code></pre></div>
</div>
<div id="load-data" class="section level3 unnumbered">
<h3>Load data<a class="anchor" aria-label="anchor" href="#load-data"><i class="fas fa-link"></i></a>
</h3>
<p>You can download all the data used in this handbook via the instructions in the [Download handbook and data] page.</p>
<p>The example dataset used in this section is weekly counts of campylobacter cases reported in Germany between 2001 and 2011. <a href="https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/time_series/campylobacter_germany.xlsx" class="download-button">
You can click here to download<span> this data file (.xlsx).</span></a></p>
<p>This dataset is a reduced version of the dataset available in the <a href="https://cran.r-project.org/web/packages/surveillance/"><strong>surveillance</strong></a> package.
(for details load the surveillance package and see <code>?campyDE</code>)</p>
<p>Import these data with the <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> function from the <strong>rio</strong> package (it handles many file types like .xlsx, .csv, .rds - see the [Import and export] page for details).</p>
<div class="sourceCode" id="cb281"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># import the counts into R</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"campylobacter_germany.xlsx"</span><span class="op">)</span></span></code></pre></div>
<p>The first 10 rows of the counts are displayed below.</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-8d9a6b660e2c4c50c613" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-8d9a6b660e2c4c50c613">{"x":{"filter":"none","vertical":false,"data":[["2001-12-31T00:00:00Z","2002-01-07T00:00:00Z","2002-01-14T00:00:00Z","2002-01-21T00:00:00Z","2002-01-28T00:00:00Z","2002-02-04T00:00:00Z","2002-02-11T00:00:00Z","2002-02-18T00:00:00Z","2002-02-25T00:00:00Z","2002-03-04T00:00:00Z"],[514,913,1023,887,815,792,803,807,692,705]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>date<\/th>\n      <th>case<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="clean-data-1" class="section level3 unnumbered">
<h3>Clean data<a class="anchor" aria-label="anchor" href="#clean-data-1"><i class="fas fa-link"></i></a>
</h3>
<p>The code below makes sure that the date column is in the appropriate format.
For this tab we will be using the <strong>tsibble</strong> package and so the <code>yearweek</code>
function will be used to create a calendar week variable. There are several other
ways of doing this (see the <a href="https://epirhandbook.com/working-with-dates.html">Working with dates</a>
page for details), however for time series its best to keep within one framework (<strong>tsibble</strong>).</p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## ensure the date column is in the appropriate format</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## create a calendar week variable </span></span>
<span><span class="co">## fitting ISO definitons of weeks starting on a monday</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>epiweek <span class="op">=</span> <span class="fu">yearweek</span><span class="op">(</span><span class="va">date</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="download-climate-data" class="section level3 unnumbered">
<h3>Download climate data<a class="anchor" aria-label="anchor" href="#download-climate-data"><i class="fas fa-link"></i></a>
</h3>
<p>In the <em>relation of two time series</em> section of this page, we will be comparing
campylobacter case counts to climate data.</p>
<p>Climate data for anywhere in the world can be downloaded from the EU’s Copernicus
Satellite. These are not exact measurements, but based on a model (similar to
interpolation), however the benefit is global hourly coverage as well as forecasts.</p>
<p>You can download each of these climate data files from the [Download handbook and data] page.</p>
<p>For purposes of demonstration here, we will show R code to use the <strong>ecmwfr</strong> package to pull these data from the Copernicus
climate data store. You will need to create a free account in order for this to
work. The package website has a useful <a href="https://github.com/bluegreen-labs/ecmwfr#use-copernicus-climate-data-store-cds">walkthrough</a>
of how to do this. Below is example code of how to go about doing this, once you
have the appropriate API keys. You have to replace the X’s below with your account
IDs. You will need to download one year of data at a time otherwise the server times-out.</p>
<p>If you are not sure of the coordinates for a location you want to download data
for, you can use the <strong>tmaptools</strong> package to pull the coordinates off open street
maps. An alternative option is the <a href="https://github.com/rCarto/photon"><strong>photon</strong></a>
package, however this has not been released on to CRAN yet; the nice thing about
<strong>photon</strong> is that it provides more contextual data for when there are several
matches for your search.</p>
<div class="sourceCode" id="cb283"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## retrieve location coordinates</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu">geocode_OSM</span><span class="op">(</span><span class="st">"Germany"</span>, geometry <span class="op">=</span> <span class="st">"point"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## pull together long/lats in format for ERA-5 querying (bounding box) </span></span>
<span><span class="co">## (as just want a single point can repeat coords)</span></span>
<span><span class="va">request_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue_data</a></span><span class="op">(</span><span class="va">coords</span><span class="op">$</span><span class="va">coords</span>, <span class="st">"{y}/{x}/{y}/{x}"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Pulling data modelled from copernicus satellite (ERA-5 reanalysis)</span></span>
<span><span class="co">## https://cds.climate.copernicus.eu/cdsapp#!/software/app-era5-explorer?tab=app</span></span>
<span><span class="co">## https://github.com/bluegreen-labs/ecmwfr</span></span>
<span></span>
<span><span class="co">## set up key for weather data </span></span>
<span><span class="fu">wf_set_key</span><span class="op">(</span>user <span class="op">=</span> <span class="st">"XXXXX"</span>,</span>
<span>           key <span class="op">=</span> <span class="st">"XXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX"</span>,</span>
<span>           service <span class="op">=</span> <span class="st">"cds"</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## run for each year of interest (otherwise server times out)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2002</span><span class="op">:</span><span class="fl">2011</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## pull together a query </span></span>
<span>  <span class="co">## see here for how to do: https://bluegreen-labs.github.io/ecmwfr/articles/cds_vignette.html#the-request-syntax</span></span>
<span>  <span class="co">## change request to a list using addin button above (python to list)</span></span>
<span>  <span class="co">## Target is the name of the output file!!</span></span>
<span>  <span class="va">request</span> <span class="op">&lt;-</span> <span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    product_type <span class="op">=</span> <span class="st">"reanalysis"</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"netcdf"</span>,</span>
<span>    variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2m_temperature"</span>, <span class="st">"total_precipitation"</span><span class="op">)</span>,</span>
<span>    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>,</span>
<span>    month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"05"</span>, <span class="st">"06"</span>, <span class="st">"07"</span>, <span class="st">"08"</span>, <span class="st">"09"</span>, <span class="st">"10"</span>, <span class="st">"11"</span>, <span class="st">"12"</span><span class="op">)</span>,</span>
<span>    day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"05"</span>, <span class="st">"06"</span>, <span class="st">"07"</span>, <span class="st">"08"</span>, <span class="st">"09"</span>, <span class="st">"10"</span>, <span class="st">"11"</span>, <span class="st">"12"</span>,</span>
<span>            <span class="st">"13"</span>, <span class="st">"14"</span>, <span class="st">"15"</span>, <span class="st">"16"</span>, <span class="st">"17"</span>, <span class="st">"18"</span>, <span class="st">"19"</span>, <span class="st">"20"</span>, <span class="st">"21"</span>, <span class="st">"22"</span>, <span class="st">"23"</span>, <span class="st">"24"</span>,</span>
<span>            <span class="st">"25"</span>, <span class="st">"26"</span>, <span class="st">"27"</span>, <span class="st">"28"</span>, <span class="st">"29"</span>, <span class="st">"30"</span>, <span class="st">"31"</span><span class="op">)</span>,</span>
<span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"00:00"</span>, <span class="st">"01:00"</span>, <span class="st">"02:00"</span>, <span class="st">"03:00"</span>, <span class="st">"04:00"</span>, <span class="st">"05:00"</span>, <span class="st">"06:00"</span>, <span class="st">"07:00"</span>,</span>
<span>             <span class="st">"08:00"</span>, <span class="st">"09:00"</span>, <span class="st">"10:00"</span>, <span class="st">"11:00"</span>, <span class="st">"12:00"</span>, <span class="st">"13:00"</span>, <span class="st">"14:00"</span>, <span class="st">"15:00"</span>,</span>
<span>             <span class="st">"16:00"</span>, <span class="st">"17:00"</span>, <span class="st">"18:00"</span>, <span class="st">"19:00"</span>, <span class="st">"20:00"</span>, <span class="st">"21:00"</span>, <span class="st">"22:00"</span>, <span class="st">"23:00"</span><span class="op">)</span>,</span>
<span>    area <span class="op">=</span> <span class="va">request_coords</span>,</span>
<span>    dataset_short_name <span class="op">=</span> <span class="st">"reanalysis-era5-single-levels"</span>,</span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"germany_weather"</span>, <span class="va">i</span>, <span class="st">".nc"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## download the file and store it in the current working directory</span></span>
<span>  <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu">wf_request</span><span class="op">(</span>user     <span class="op">=</span> <span class="st">"XXXXX"</span>,  <span class="co"># user ID (for authentication)</span></span>
<span>                     request  <span class="op">=</span> <span class="va">request</span>,  <span class="co"># the request</span></span>
<span>                     transfer <span class="op">=</span> <span class="cn">TRUE</span>,     <span class="co"># download the file</span></span>
<span>                     path     <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"Weather"</span><span class="op">)</span><span class="op">)</span> <span class="co">## path to save the data</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
</div>
<div id="load-climate-data" class="section level3 unnumbered">
<h3>Load climate data<a class="anchor" aria-label="anchor" href="#load-climate-data"><i class="fas fa-link"></i></a>
</h3>
<p>Whether you downloaded the climate data via our handbook, or used the code above, you now should have 10 years of “.nc” climate data files stored in the same folder on your computer.</p>
<p>Use the code below to import these files into R with the <strong>stars</strong> package.</p>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define path to weather folder </span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span></span>
<span>  <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"time_series"</span>, <span class="st">"weather"</span><span class="op">)</span>, <span class="co"># replace with your own file path </span></span>
<span>  full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## only keep those with the current name of interest </span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="va">file_paths</span><span class="op">[</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">file_paths</span>, <span class="st">"germany"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## read in all the files as a stars object </span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">file_paths</span><span class="op">)</span></span></code></pre></div>
<pre><code>## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp,</code></pre>
<p>Once these files have been imported as the object <code>data</code>, we will convert them to a data frame.</p>
<div class="sourceCode" id="cb286"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## change to a data frame </span></span>
<span><span class="va">temp_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## add in variables and correct units</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## create an calendar week variable </span></span>
<span>    epiweek <span class="op">=</span> <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/year-week.html">yearweek</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, </span>
<span>    <span class="co">## create a date variable (start of calendar week)</span></span>
<span>    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">epiweek</span><span class="op">)</span>,</span>
<span>    <span class="co">## change temperature from kelvin to celsius</span></span>
<span>    t2m <span class="op">=</span> <span class="fu">set_units</span><span class="op">(</span><span class="va">t2m</span>, <span class="va">celsius</span><span class="op">)</span>, </span>
<span>    <span class="co">## change precipitation from metres to millimetres </span></span>
<span>    tp  <span class="op">=</span> <span class="fu">set_units</span><span class="op">(</span><span class="va">tp</span>, <span class="va">mm</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## group by week (keep the date too though)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## get the average per week</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>t2m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">t2m</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            tp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">tp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>## `summarise()` has grouped output by 'epiweek'. You can override using the `.groups` argument.</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="time-series-data" class="section level2" number="7.3">
<h2>
<span class="header-section-number">7.3</span> Time series data<a class="anchor" aria-label="anchor" href="#time-series-data"><i class="fas fa-link"></i></a>
</h2>
<p>There are a number of different packages for structuring and handling time series
data. As said, we will focus on the <strong>tidyverts</strong> family of packages and so will
use the <strong>tsibble</strong> package to define our time series object. Having a data set
defined as a time series object means it is much easier to structure our analysis.</p>
<p>To do this we use the <code>tsibble()</code> function and specify the “index”, i.e. the variable
specifying the time unit of interest. In our case this is the <code>epiweek</code> variable.</p>
<p>If we had a data set with weekly counts by province, for example, we would also
be able to specify the grouping variable using the <code>key =</code> argument.
This would allow us to do analysis for each group.</p>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define time series object </span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span></span></code></pre></div>
<p>Looking at <code>class(counts)</code> tells you that on top of being a tidy data frame
(“tbl_df”, “tbl”, “data.frame”), it has the additional properties of a time series
data frame (“tbl_ts”).</p>
<p>You can take a quick look at your data by using <strong>ggplot2</strong>. We see from the plot that
there is a clear seasonal pattern, and that there are no missings. However, there
seems to be an issue with reporting at the beginning of each year; cases drop
in the last week of the year and then increase for the first week of the next year.</p>
<div class="sourceCode" id="cb289"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## plot a line graph of cases by week</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">case</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/basic_plot-1.png" width="672"></div>
<p><span style="color: red;"><strong><em>DANGER:</em></strong> Most datasets aren’t as clean as this example.
You will need to check for duplicates and missings as below. </span></p>
<!-- ======================================================= -->
<div id="duplicates" class="section level3 unnumbered">
<h3>Duplicates<a class="anchor" aria-label="anchor" href="#duplicates"><i class="fas fa-link"></i></a>
</h3>
<p><strong>tsibble</strong> does not allow duplicate observations. So each row will need to be
unique, or unique within the group (<code>key</code> variable).
The package has a few functions that help to identify duplicates. These include
<code>are_duplicated()</code> which gives you a TRUE/FALSE vector of whether the row is a
duplicate, and <code>duplicates()</code> which gives you a data frame of the duplicated rows.</p>
<p>See the page on <a href="https://epirhandbook.com/de-duplication.html">De-duplication</a>
for more details on how to select rows you want.</p>
<div class="sourceCode" id="cb290"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## get a vector of TRUE/FALSE whether rows are duplicates</span></span>
<span><span class="fu">are_duplicated</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## get a data frame of any duplicated rows </span></span>
<span><span class="fu">duplicates</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> </span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="missings" class="section level3 unnumbered">
<h3>Missings<a class="anchor" aria-label="anchor" href="#missings"><i class="fas fa-link"></i></a>
</h3>
<p>We saw from our brief inspection above that there are no missings, but we also
saw there seems to be a problem with reporting delay around new year.
One way to address this problem could be to set these values to missing and then
to impute values. The simplest form of time series imputation is to draw
a straight line between the last non-missing and the next non-missing value.
To do this we will use the <strong>imputeTS</strong> package function <code>na_interpolation()</code>.</p>
<p>See the <a href="https://epirhandbook.com/missing-data.html">Missing data</a> page for other options for imputation.</p>
<p>Another alternative would be to calculate a moving average, to try and smooth
over these apparent reporting issues (see next section, and the page on <a href="https://epirhandbook.com/moving-averages.html">Moving averages</a>).</p>
<div class="sourceCode" id="cb291"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## create a variable with missings instead of weeks with reporting issues</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>case_miss <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>          <span class="co">## if epiweek contains 52, 53, 1 or 2</span></span>
<span>          <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="st">"W51|W52|W53|W01|W02"</span><span class="op">)</span>, </span>
<span>          <span class="co">## then set to missing </span></span>
<span>          <span class="cn">NA_real_</span>, </span>
<span>          <span class="co">## otherwise keep the value in case</span></span>
<span>          <span class="va">case</span></span>
<span>     <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## alternatively interpolate missings by linear trend </span></span>
<span><span class="co">## between two nearest adjacent points</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>case_int <span class="op">=</span> <span class="fu">imputeTS</span><span class="fu">::</span><span class="fu"><a href="https://SteffenMoritz.github.io/imputeTS/reference/na_interpolation.html">na_interpolation</a></span><span class="op">(</span><span class="va">case_miss</span><span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span></span>
<span><span class="co">## to check what values have been imputed compared to the original</span></span>
<span><span class="fu">ggplot_na_imputations</span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_miss</span>, <span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## make a traditional plot (with black axes and white background)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/missings-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="descriptive-analysis" class="section level2" number="7.4">
<h2>
<span class="header-section-number">7.4</span> Descriptive analysis<a class="anchor" aria-label="anchor" href="#descriptive-analysis"><i class="fas fa-link"></i></a>
</h2>
<!-- ======================================================= -->
<div id="timeseries_moving" class="section level3 unnumbered">
<h3>Moving averages<a class="anchor" aria-label="anchor" href="#timeseries_moving"><i class="fas fa-link"></i></a>
</h3>
<p>If data is very noisy (counts jumping up and down) then it can be helpful to
calculate a moving average. In the example below, for each week we calculate the
average number of cases from the four previous weeks. This smooths the data, to
make it more interpretable. In our case this does not really add much, so we will
stick to the interpolated data for further analysis.
See the <a href="https://epirhandbook.com/moving-averages.html">Moving averages</a> page for more detail.</p>
<div class="sourceCode" id="cb292"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## create a moving average variable (deals with missings)</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="co">## create the ma_4w variable </span></span>
<span>     <span class="co">## slide over each row of the case variable</span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ma_4wk <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide.html">slide_dbl</a></span><span class="op">(</span><span class="va">case</span>, </span>
<span>                               <span class="co">## for each row calculate the name</span></span>
<span>                               <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                               <span class="co">## use the four previous weeks</span></span>
<span>                               .before <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## make a quick visualisation of the difference </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">ma_4wk</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/moving_averages-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="periodicity" class="section level3 unnumbered">
<h3>Periodicity<a class="anchor" aria-label="anchor" href="#periodicity"><i class="fas fa-link"></i></a>
</h3>
<p>Below we define a custom function to create a periodogram. See the [Writing functions] page for information about how to write functions in R.</p>
<p>First, the function is defined. Its arguments include a dataset with a column <code>counts</code>, <code>start_week =</code> which is the first week of the dataset, a number to indicate how many periods per year (e.g. 52, 12), and lastly the output style (see details in the code below).</p>
<div class="sourceCode" id="cb293"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Function arguments</span></span>
<span><span class="co">#####################</span></span>
<span><span class="co">## x is a dataset</span></span>
<span><span class="co">## counts is variable with count data or rates within x </span></span>
<span><span class="co">## start_week is the first week in your dataset</span></span>
<span><span class="co">## period is how many units in a year </span></span>
<span><span class="co">## output is whether you want return spectral periodogram or the peak weeks</span></span>
<span>  <span class="co">## "periodogram" or "weeks"</span></span>
<span></span>
<span><span class="co"># Define function</span></span>
<span><span class="va">periodogram</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                        <span class="va">counts</span>, </span>
<span>                        <span class="va">start_week</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                        <span class="va">period</span> <span class="op">=</span> <span class="fl">52</span>, </span>
<span>                        <span class="va">output</span> <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span></span>
<span>    <span class="co">## make sure is not a tsibble, filter to project and only keep columns of interest</span></span>
<span>    <span class="va">prepare_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># prepare_data &lt;- prepare_data[prepare_data[[strata]] == j, ]</span></span>
<span>    <span class="va">prepare_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">prepare_data</span>, <span class="op">{</span><span class="op">{</span><span class="va">counts</span><span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## create an intermediate "zoo" time series to be able to use with spec.pgram</span></span>
<span>    <span class="va">zoo_cases</span> <span class="op">&lt;-</span> <span class="fu">zoo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/zooreg.html">zooreg</a></span><span class="op">(</span><span class="va">prepare_data</span>, </span>
<span>                             start <span class="op">=</span> <span class="va">start_week</span>, frequency <span class="op">=</span> <span class="va">period</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## get a spectral periodogram not using fast fourier transform </span></span>
<span>    <span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/spec.pgram.html">spec.pgram</a></span><span class="op">(</span><span class="va">zoo_cases</span>, fast <span class="op">=</span> <span class="cn">FALSE</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## return the peak weeks </span></span>
<span>    <span class="va">periodo_weeks</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">periodo</span><span class="op">$</span><span class="va">freq</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">periodo</span><span class="op">$</span><span class="va">spec</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="va">period</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">output</span> <span class="op">==</span> <span class="st">"weeks"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">periodo_weeks</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">periodo</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## get spectral periodogram for extracting weeks with the highest frequencies </span></span>
<span><span class="co">## (checking of seasonality) </span></span>
<span><span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu">periodogram</span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                       <span class="va">case_int</span>, </span>
<span>                       start_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                       output <span class="op">=</span> <span class="st">"periodogram"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## pull spectrum and frequence in to a dataframe for plotting</span></span>
<span><span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">periodo</span><span class="op">$</span><span class="va">freq</span>, <span class="va">periodo</span><span class="op">$</span><span class="va">spec</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## plot a periodogram showing the most frequently occuring periodicity </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">periodo</span>, </span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">periodo.freq</span><span class="op">/</span><span class="fl">52</span><span class="op">)</span>,  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">periodo.spec</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Period (Weeks)"</span>, y <span class="op">=</span> <span class="st">"Log(density)"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/periodogram-1.png" width="672"></div>
<div class="sourceCode" id="cb294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## get a vector weeks in ascending order </span></span>
<span><span class="va">peak_weeks</span> <span class="op">&lt;-</span> <span class="fu">periodogram</span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                          <span class="va">case_int</span>, </span>
<span>                          start_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                          output <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span></span></code></pre></div>
<p><span style="color: black;"><strong><em>NOTE:</em></strong> It is possible to use the above weeks to add them to sin and cosine terms, however we will use a function to generate these terms (see regression section below) </span></p>
<!-- ======================================================= -->
</div>
<div id="decomposition" class="section level3 unnumbered">
<h3>Decomposition<a class="anchor" aria-label="anchor" href="#decomposition"><i class="fas fa-link"></i></a>
</h3>
<p>Classical decomposition is used to break a time series down several parts, which
when taken together make up for the pattern you see.
These different parts are:</p>
<ul>
<li>The trend-cycle (the long-term direction of the data)<br>
</li>
<li>The seasonality (repeating patterns)<br>
</li>
<li>The random (what is left after removing trend and season)</li>
</ul>
<div class="sourceCode" id="cb295"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## decompose the counts dataset </span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># using an additive classical decomposition model</span></span>
<span>  <span class="fu">model</span><span class="op">(</span><span class="fu">classical_decomposition</span><span class="op">(</span><span class="va">case_int</span>, type <span class="op">=</span> <span class="st">"additive"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## extract the important information from the model</span></span>
<span>  <span class="fu">components</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## generate a plot </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/decomposition-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="autocorrelation" class="section level3 unnumbered">
<h3>Autocorrelation<a class="anchor" aria-label="anchor" href="#autocorrelation"><i class="fas fa-link"></i></a>
</h3>
<p>Autocorrelation tells you about the relation between the counts of each week
and the weeks before it (called lags).</p>
<p>Using the <code>ACF()</code> function, we can produce a plot which shows us a number of lines
for the relation at different lags. Where the lag is 0 (x = 0), this line would
always be 1 as it shows the relation between an observation and itself (not shown here).
The first line shown here (x = 1) shows the relation between each observation
and the observation before it (lag of 1), the second shows the relation between
each observation and the observation before last (lag of 2) and so on until lag of
52 which shows the relation between each observation and the observation from 1
year (52 weeks before).</p>
<p>Using the <code>PACF()</code> function (for partial autocorrelation) shows the same type of relation
but adjusted for all other weeks between. This is less informative for determining
periodicity.</p>
<div class="sourceCode" id="cb296"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## using the counts dataset</span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## calculate autocorrelation using a full years worth of lags</span></span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">case_int</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## show a plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/autocorrelation-1.png" width="672"></div>
<div class="sourceCode" id="cb297"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## using the counts data set </span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## calculate the partial autocorrelation using a full years worth of lags</span></span>
<span>  <span class="fu">PACF</span><span class="op">(</span><span class="va">case_int</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## show a plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/autocorrelation-2.png" width="672"></div>
<p>You can formally test the null hypothesis of independence in a time series (i.e. 
that it is not autocorrelated) using the Ljung-Box test (in the <strong>stats</strong> package).
A significant p-value suggests that there is autocorrelation in the data.</p>
<div class="sourceCode" id="cb298"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## test for independance </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  counts$case_int
## X-squared = 462.65, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="fitting-regressions" class="section level2" number="7.5">
<h2>
<span class="header-section-number">7.5</span> Fitting regressions<a class="anchor" aria-label="anchor" href="#fitting-regressions"><i class="fas fa-link"></i></a>
</h2>
<p>It is possible to fit a large number of different regressions to a time series,
however, here we will demonstrate how to fit a negative binomial regression - as
this is often the most appropriate for counts data in infectious diseases.</p>
<!-- ======================================================= -->
<div id="fourier-terms" class="section level3 unnumbered">
<h3>Fourier terms<a class="anchor" aria-label="anchor" href="#fourier-terms"><i class="fas fa-link"></i></a>
</h3>
<p>Fourier terms are the equivalent of sin and cosin curves. The difference is that
these are fit based on finding the most appropriate combination of curves to explain
your data.</p>
<p>If only fitting one fourier term, this would be the equivalent of fitting a sin
and a cosin for your most frequently occurring lag seen in your periodogram (in our
case 52 weeks). We use the <code>fourier()</code> function from the <strong>forecast</strong> package.</p>
<p>In the below code we assign using the <code>$</code>, as <code>fourier()</code> returns two columns (one
for sin one for cosin) and so these are added to the dataset as a list, called
“fourier” - but this list can then be used as a normal variable in regression.</p>
<div class="sourceCode" id="cb300"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## add in fourier terms using the epiweek and case_int variabless</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">fourier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">fourier</span><span class="op">(</span>K <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="negative-binomial" class="section level3 unnumbered">
<h3>Negative binomial<a class="anchor" aria-label="anchor" href="#negative-binomial"><i class="fas fa-link"></i></a>
</h3>
<p>It is possible to fit regressions using base <strong>stats</strong> or <strong>MASS</strong>
functions (e.g. <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>, <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> and <code>glm.nb()</code>). However we will be using those from
the <strong>trending</strong> package, as this allows for calculating appropriate confidence
and prediction intervals (which are otherwise not available).
The syntax is the same, and you specify an outcome variable then a tilde (~)
and then add your various exposure variables of interest separated by a plus (+).</p>
<p>The other difference is that we first define the model and then <code>fit()</code> it to the
data. This is useful because it allows for comparing multiple different models
with the same syntax.</p>
<p><span style="color: darkgreen;"><strong><em>TIP:</em></strong> If you wanted to use rates, rather than
counts you could include the population variable as a logarithmic offset term, by adding
<code>offset(log(population)</code>. You would then need to set population to be 1, before
using <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> in order to produce a rate. </span></p>
<p><span style="color: darkgreen;"><strong><em>TIP:</em></strong> For fitting more complex models such
as ARIMA or prophet, see the <a href="https://fable.tidyverts.org/index.html"><strong>fable</strong></a> package.</span></p>
<div class="sourceCode" id="cb301"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define the model you want to fit (negative binomial) </span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## set number of cases as outcome of interest</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## use epiweek to account for the trend</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## use the fourier terms to account for seasonality</span></span>
<span>    <span class="va">fourier</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## fit your model using the counts dataset</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## calculate confidence intervals and prediction intervals </span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## plot your regression </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">estimate_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in a line for the model estimate</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"Red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in a band for the prediction intervals </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in a line for your observed case counts</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## make a traditional plot (with black axes and white background)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/nb_reg-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="residuals" class="section level3 unnumbered">
<h3>Residuals<a class="anchor" aria-label="anchor" href="#residuals"><i class="fas fa-link"></i></a>
</h3>
<p>To see how well our model fits the observed data we need to look at the residuals.
The residuals are the difference between the observed counts and the counts
estimated from the model. We could calculate this simply by using <code>case_int - estimate</code>,
but the <code><a href="https://rdrr.io/r/stats/residuals.html">residuals()</a></code> function extracts this directly from the regression for us.</p>
<p>What we see from the below, is that we are not explaining all of the variation
that we could with the model. It might be that we should fit more fourier terms,
and address the amplitude. However for this example we will leave it as is.
The plots show that our model does worse in the peaks and troughs (when counts are
at their highest and lowest) and that it might be more likely to underestimate
the observed counts.</p>
<div class="sourceCode" id="cb302"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## calculate the residuals </span></span>
<span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>resid <span class="op">=</span> <span class="va">fitted_model</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## are the residuals fairly constant over time (if not: outbreaks? change in practice?)</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"epiweek"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-210-1.png" width="672"></div>
<div class="sourceCode" id="cb303"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## is there autocorelation in the residuals (is there a pattern to the error?)  </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">resid</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-210-2.png" width="672"></div>
<div class="sourceCode" id="cb304"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## are residuals normally distributed (are under or over estimating?)  </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html">geom_rug</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-210-3.png" width="672"></div>
<div class="sourceCode" id="cb305"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## compare observed counts to their residuals </span></span>
<span>  <span class="co">## should also be no pattern </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fitted"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-210-4.png" width="672"></div>
<div class="sourceCode" id="cb306"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## formally test autocorrelation of the residuals</span></span>
<span><span class="co">## H0 is that residuals are from a white-noise series (i.e. random)</span></span>
<span><span class="co">## test for independence </span></span>
<span><span class="co">## if p value significant then non-random</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">estimate_res</span><span class="op">$</span><span class="va">resid</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  estimate_res$resid
## X-squared = 336.25, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="relation-of-two-time-series" class="section level2" number="7.6">
<h2>
<span class="header-section-number">7.6</span> Relation of two time series<a class="anchor" aria-label="anchor" href="#relation-of-two-time-series"><i class="fas fa-link"></i></a>
</h2>
<p>Here we look at using weather data (specifically the temperature) to explain
campylobacter case counts.</p>
<!-- ======================================================= -->
<div id="merging-datasets" class="section level3 unnumbered">
<h3>Merging datasets<a class="anchor" aria-label="anchor" href="#merging-datasets"><i class="fas fa-link"></i></a>
</h3>
<p>We can join our datasets using the week variable. For more on merging see the
handbook section on <a href="https://epirhandbook.com/joining-data.html">joining</a>.</p>
<div class="sourceCode" id="cb308"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## left join so that we only have the rows already existing in counts</span></span>
<span><span class="co">## drop the date variable from temp_data (otherwise is duplicated)</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">temp_data</span>, <span class="op">-</span><span class="va">date</span><span class="op">)</span>,</span>
<span>                    by <span class="op">=</span> <span class="st">"epiweek"</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="descriptive-analysis-1" class="section level3 unnumbered">
<h3>Descriptive analysis<a class="anchor" aria-label="anchor" href="#descriptive-analysis-1"><i class="fas fa-link"></i></a>
</h3>
<p>First plot your data to see if there is any obvious relation.
The plot below shows that there is a clear relation in the seasonality of the two
variables, and that temperature might peak a few weeks before the case number.
For more on pivoting data, see the handbook section on <a href="https://epirhandbook.com/pivoting-data.html">pivoting data</a>.</p>
<div class="sourceCode" id="cb309"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## keep the variables we are interested </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">case_int</span>, <span class="va">t2m</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## change your data in to long format</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="co">## use epiweek as your key</span></span>
<span>    <span class="op">!</span><span class="va">epiweek</span>,</span>
<span>    <span class="co">## move column names to the new "measure" column</span></span>
<span>    names_to <span class="op">=</span> <span class="st">"measure"</span>, </span>
<span>    <span class="co">## move cell values to the new "values" column</span></span>
<span>    values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## create a plot with the dataset above</span></span>
<span>  <span class="co">## plot epiweek on the x axis and values (counts/celsius) on the y </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="co">## create a separate plot for temperate and case counts </span></span>
<span>    <span class="co">## let them set their own y-axes</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">measure</span> <span class="op">~</span> <span class="va">.</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co">## plot both as a line</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/basic_plot_bivar-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="lags-and-cross-correlation" class="section level3 unnumbered">
<h3>Lags and cross-correlation<a class="anchor" aria-label="anchor" href="#lags-and-cross-correlation"><i class="fas fa-link"></i></a>
</h3>
<p>To formally test which weeks are most highly related between cases and temperature.
We can use the cross-correlation function (<code>CCF()</code>) from the <strong>feasts</strong> package.
You could also visualise (rather than using <code>arrange</code>) using the <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> function.</p>
<div class="sourceCode" id="cb310"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## calculate cross-correlation between interpolated counts and temperature</span></span>
<span>  <span class="fu">CCF</span><span class="op">(</span><span class="va">case_int</span>, <span class="va">t2m</span>,</span>
<span>      <span class="co">## set the maximum lag to be 52 weeks</span></span>
<span>      lag_max <span class="op">=</span> <span class="fl">52</span>, </span>
<span>      <span class="co">## return the correlation coefficient </span></span>
<span>      type <span class="op">=</span> <span class="st">"correlation"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## arange in decending order of the correlation coefficient </span></span>
<span>  <span class="co">## show the most associated lags</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">ccf</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## only show the top ten </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tsibble: 10 x 2 [1W]
##         lag   ccf
##    &lt;cf_lag&gt; &lt;dbl&gt;
##  1      -4W 0.749
##  2      -5W 0.745
##  3      -3W 0.735
##  4      -6W 0.729
##  5      -2W 0.727
##  6      -7W 0.704
##  7      -1W 0.695
##  8      -8W 0.671
##  9       0W 0.649
## 10      47W 0.638</code></pre>
<p>We see from this that a lag of 4 weeks is most highly correlated,
so we make a lagged temperature variable to include in our regression.</p>
<p><span style="color: red;"><strong><em>DANGER:</em></strong> Note that the first four weeks of our data
in the lagged temperature variable are missing (<code>NA</code>) - as there are not four
weeks prior to get data from. In order to use this dataset with the <strong>trending</strong>
<code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> function, we need to use the the <code>simulate_pi = FALSE</code> argument within
<code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> further down. If we did want to use the simulate option, then
we have to drop these missings and store as a new data set by adding <code>drop_na(t2m_lag4)</code>
to the code chunk below.</span></p>
<div class="sourceCode" id="cb312"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## create a new variable for temperature lagged by four weeks</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>t2m_lag4 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">t2m</span>, n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="negative-binomial-with-two-variables" class="section level3 unnumbered">
<h3>Negative binomial with two variables<a class="anchor" aria-label="anchor" href="#negative-binomial-with-two-variables"><i class="fas fa-link"></i></a>
</h3>
<p>We fit a negative binomial regression as done previously. This time we add the
temperature variable lagged by four weeks.</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Note the use of <code>simulate_pi = FALSE</code>
within the <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> argument. This is because the default behaviour of <strong>trending</strong>
is to use the <strong>ciTools</strong> package to estimate a prediction interval. This does not
work if there are <code>NA</code> counts, and also produces more granular intervals.
See <code>?trending::predict.trending_model_fit</code> for details. </span></p>
<div class="sourceCode" id="cb313"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define the model you want to fit (negative binomial) </span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## set number of cases as outcome of interest</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## use epiweek to account for the trend</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## use the fourier terms to account for seasonality</span></span>
<span>    <span class="va">fourier</span> <span class="op">+</span> </span>
<span>    <span class="co">## use the temperature lagged by four weeks </span></span>
<span>    <span class="va">t2m_lag4</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## fit your model using the counts dataset</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## calculate confidence intervals and prediction intervals </span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>To investigate the individual terms, we can pull the original negative binomial
regression out of the <strong>trending</strong> format using <code>get_model()</code> and pass this to the
<strong>broom</strong> package <code>tidy()</code> function to retrieve exponentiated estimates and associated
confidence intervals.</p>
<p>What this shows us is that lagged temperature, after controlling for trend and seasonality,
is similar to the case counts (estimate ~ 1) and significantly associated.
This suggests that it might be a good variable for use in predicting future case
numbers (as climate forecasts are readily available).</p>
<div class="sourceCode" id="cb314"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## extract original negative binomial regression</span></span>
<span>  <span class="fu">get_fitted_model</span><span class="op">(</span><span class="op">)</span> <span class="co">#%&gt;% </span></span></code></pre></div>
<pre><code>## [[1]]
## 
## Call:  glm.nb(formula = case_int ~ epiweek + fourier + t2m_lag4, data = data.frame(counts), 
##     init.theta = 32.80689607, link = log)
## 
## Coefficients:
##  (Intercept)       epiweek  fourierS1-52  fourierC1-52      t2m_lag4  
##   5.82535083    0.00008464   -0.28502594   -0.19537827    0.00667157  
## 
## Degrees of Freedom: 504 Total (i.e. Null);  500 Residual
##   (4 observations deleted due to missingness)
## Null Deviance:       2015 
## Residual Deviance: 508.2     AIC: 6784</code></pre>
<div class="sourceCode" id="cb316"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">## get a tidy dataframe of results</span></span>
<span>  <span class="co">#tidy(exponentiate = TRUE, </span></span>
<span>  <span class="co">#     conf.int = TRUE)</span></span></code></pre></div>
<p>A quick visual inspection of the model shows that it might do a better job of
estimating the observed case counts.</p>
<div class="sourceCode" id="cb317"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## plot your regression </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">estimate_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in a line for the model estimate</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"Red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in a band for the prediction intervals </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in a line for your observed case counts</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## make a traditional plot (with black axes and white background)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_nb_reg_bivar-1.png" width="672"></div>
<div id="residuals-1" class="section level4 unnumbered">
<h4>Residuals<a class="anchor" aria-label="anchor" href="#residuals-1"><i class="fas fa-link"></i></a>
</h4>
<p>We investigate the residuals again to see how well our model fits the observed data.
The results and interpretation here are similar to those of the previous regression,
so it may be more feasible to stick with the simpler model without temperature.</p>
<div class="sourceCode" id="cb318"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## calculate the residuals </span></span>
<span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>resid <span class="op">=</span> <span class="va">case_int</span> <span class="op">-</span> <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## are the residuals fairly constant over time (if not: outbreaks? change in practice?)</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"epiweek"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-211-1.png" width="672"></div>
<div class="sourceCode" id="cb319"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## is there autocorelation in the residuals (is there a pattern to the error?)  </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">resid</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-211-2.png" width="672"></div>
<div class="sourceCode" id="cb320"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## are residuals normally distributed (are under or over estimating?)  </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html">geom_rug</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-211-3.png" width="672"></div>
<div class="sourceCode" id="cb321"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## compare observed counts to their residuals </span></span>
<span>  <span class="co">## should also be no pattern </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fitted"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-211-4.png" width="672"></div>
<div class="sourceCode" id="cb322"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## formally test autocorrelation of the residuals</span></span>
<span><span class="co">## H0 is that residuals are from a white-noise series (i.e. random)</span></span>
<span><span class="co">## test for independence </span></span>
<span><span class="co">## if p value significant then non-random</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">estimate_res</span><span class="op">$</span><span class="va">resid</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  estimate_res$resid
## X-squared = 339.52, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="outbreak-detection" class="section level2" number="7.7">
<h2>
<span class="header-section-number">7.7</span> Outbreak detection<a class="anchor" aria-label="anchor" href="#outbreak-detection"><i class="fas fa-link"></i></a>
</h2>
<p>We will demonstrate two (similar) methods of detecting outbreaks here.
The first builds on the sections above.
We use the <strong>trending</strong> package to fit regressions to previous years, and then
predict what we expect to see in the following year. If observed counts are above
what we expect, then it could suggest there is an outbreak.
The second method is based on similar principles but uses the <strong>surveillance</strong> package,
which has a number of different algorithms for aberration detection.</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Normally, you are interested in the current year (where you only know counts up to the present week). So in this example we are pretending to be in week 39 of 2011.</span></p>
<!-- ======================================================= -->
<div id="trending-package" class="section level3 unnumbered">
<h3>
<strong>trending</strong> package<a class="anchor" aria-label="anchor" href="#trending-package"><i class="fas fa-link"></i></a>
</h3>
<p>For this method we define a baseline (which should usually be about 5 years of data).
We fit a regression to the baseline data, and then use that to predict the estimates
for the next year.</p>
<!-- ======================================================= -->
<div id="cut-off-date" class="section level4 unnumbered">
<h4>Cut-off date<a class="anchor" aria-label="anchor" href="#cut-off-date"><i class="fas fa-link"></i></a>
</h4>
<p>It is easier to define your dates in one place and then use these throughout the
rest of your code.</p>
<p>Here we define a start date (when our observations started) and a cut-off date
(the end of our baseline period - and when the period we want to predict for starts).
~We also define how many weeks are in our year of interest (the one we are going to
be predicting)~.
We also define how many weeks are between our baseline cut-off and the end date
that we are interested in predicting for.</p>
<p><span style="color: black;"><strong><em>NOTE:</em></strong> In this example we pretend to currently be at the end of September 2011 (“2011 W39”).</span></p>
<div class="sourceCode" id="cb324"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define start date (when observations began)</span></span>
<span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## define a cut-off week (end of baseline, start of prediction period)</span></span>
<span><span class="va">cut_off</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2010-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## define the last date interested in (i.e. end of prediction)</span></span>
<span><span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2011-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## find how many weeks in period (year) of interest</span></span>
<span><span class="va">num_weeks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">end_date</span> <span class="op">-</span> <span class="va">cut_off</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="add-rows" class="section level4 unnumbered">
<h4>Add rows<a class="anchor" aria-label="anchor" href="#add-rows"><i class="fas fa-link"></i></a>
</h4>
<p>To be able to forecast in a tidyverse format, we need to have the right number
of rows in our dataset, i.e. one row for each week up to the <code>end_date</code>defined above.
The code below allows you to add these rows for by a grouping variable - for example
if we had multiple countries in one dataset, we could group by country and then
add rows appropriately for each.
The <code>group_by_key()</code> function from <strong>tsibble</strong> allows us to do this grouping
and then pass the grouped data to <strong>dplyr</strong> functions, <code><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify()</a></code> and
<code><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row()</a></code>. Then we specify the sequence of weeks between one after the maximum week
currently available in the data and the end week.</p>
<div class="sourceCode" id="cb325"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## add in missing weeks till end of year </span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## group by the region</span></span>
<span>  <span class="fu">group_by_key</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## for each group add rows from the highest epiweek to the end of year</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span><span class="op">(</span><span class="va">.</span>,</span>
<span>                        epiweek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, </span>
<span>                                      <span class="va">end_date</span>,</span>
<span>                                      by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="fourier-terms-1" class="section level4 unnumbered">
<h4>Fourier terms<a class="anchor" aria-label="anchor" href="#fourier-terms-1"><i class="fas fa-link"></i></a>
</h4>
<p>We need to redefine our fourier terms - as we want to fit them to the baseline
date only and then predict (extrapolate) those terms for the next year.
To do this we need to combine two output lists from the <code>fourier()</code> function together;
the first one is for the baseline data, and the second one predicts for the
year of interest (by defining the <code>h</code> argument).</p>
<p><em>N.b.</em> to bind rows we have to use <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code> (rather than tidyverse <code>bind_rows</code>) as
the fourier columns are a list (so not named individually).</p>
<div class="sourceCode" id="cb326"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define fourier terms (sincos) </span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## combine fourier terms for weeks prior to  and after 2010 cut-off date</span></span>
<span>    <span class="co">## (nb. 2011 fourier terms are predicted)</span></span>
<span>    fourier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>      <span class="co">## get fourier terms for previous years</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## only keep the rows before 2011</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span>, </span>
<span>        <span class="co">## include one set of sin cos terms </span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span></span>
<span>        <span class="op">)</span>, </span>
<span>      <span class="co">## predict the fourier terms for 2011 (using baseline data)</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## only keep the rows before 2011</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span>,</span>
<span>        <span class="co">## include one set of sin cos terms </span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span>, </span>
<span>        <span class="co">## predict 52 weeks ahead</span></span>
<span>        h <span class="op">=</span> <span class="va">num_weeks</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="split-data-and-fit-regression" class="section level4 unnumbered">
<h4>Split data and fit regression<a class="anchor" aria-label="anchor" href="#split-data-and-fit-regression"><i class="fas fa-link"></i></a>
</h4>
<p>We now have to split our dataset in to the baseline period and the prediction
period. This is done using the <strong>dplyr</strong> <code><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split()</a></code> function after <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code>,
and will create a list with two data frames, one for before your cut-off and one
for after.</p>
<p>We then use the <strong>purrr</strong> package <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> function to pull the datasets out of the
list (equivalent of using square brackets, e.g. <code>dat[[1]]</code>), and can then fit
our model to the baseline data, and then use the <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> function for our data
of interest after the cut-off.</p>
<p>See the page on [Iteration, loops, and lists] to learn more about <strong>purrr</strong>.</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Note the use of <code>simulate_pi = FALSE</code>
within the <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> argument. This is because the default behaviour of <strong>trending</strong>
is to use the <strong>ciTools</strong> package to estimate a prediction interval. This does not
work if there are <code>NA</code> counts, and also produces more granular intervals.
See <code>?trending::predict.trending_model_fit</code> for details. </span></p>
<div class="sourceCode" id="cb327"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># split data for fitting and prediction</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## define the model you want to fit (negative binomial) </span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## set number of cases as outcome of interest</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## use epiweek to account for the trend</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## use the furier terms to account for seasonality</span></span>
<span>    <span class="va">fourier</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define which data to use for fitting and which for predicting</span></span>
<span><span class="va">fitting_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">pred_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">case_int</span>, <span class="va">epiweek</span>, <span class="va">fourier</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit model </span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fitting_data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get confint and estimates for fitted data</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span>simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># forecast with data want to predict with </span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">pred_data</span><span class="op">)</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## combine baseline and predicted datasets</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span>, <span class="va">forecasts</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span></code></pre></div>
<p>As previously, we can visualise our model with <strong>ggplot</strong>. We highlight alerts with
red dots for observed counts above the 95% prediction interval.
This time we also add a vertical line to label when the forecast starts.</p>
<div class="sourceCode" id="cb328"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## plot your regression </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">observed</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in a line for the model estimate</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in a band for the prediction intervals </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in a line for your observed case counts</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## plot in points for the observed counts above expected</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">observed</span>, <span class="va">case_int</span> <span class="op">&gt;</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>    colour <span class="op">=</span> <span class="st">"red"</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add vertical line and label to show where forecasting started</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span></span>
<span>           xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">cut_off</span><span class="op">)</span>, </span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Forecast"</span>, </span>
<span>           x <span class="op">=</span> <span class="va">cut_off</span>, </span>
<span>           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">upper_pi</span><span class="op">)</span> <span class="op">-</span> <span class="fl">250</span>, </span>
<span>           angle <span class="op">=</span> <span class="fl">90</span>, </span>
<span>           vjust <span class="op">=</span> <span class="fl">1</span></span>
<span>           <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## make a traditional plot (with black axes and white background)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Removed 13 rows containing missing values (`geom_line()`).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/forecast_plot-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="prediction-validation" class="section level4 unnumbered">
<h4>Prediction validation<a class="anchor" aria-label="anchor" href="#prediction-validation"><i class="fas fa-link"></i></a>
</h4>
<p>Beyond inspecting residuals, it is important to investigate how good your model is
at predicting cases in the future. This gives you an idea of how reliable your
threshold alerts are.</p>
<p>The traditional way of validating is to see how well you can predict the latest
year before the present one (because you don’t yet know the counts for the “current year”).
For example in our data set we would use the data from 2002 to 2009 to predict 2010,
and then see how accurate those predictions are. Then refit the model to include
2010 data and use that to predict 2011 counts.</p>
<p>As can be seen in the figure below by <em>Hyndman et al</em> in <a href="https://otexts.com/fpp3/">“Forecasting principles
and practice”</a>.</p>
<p><img src="https://otexts.com/fpp3/fpp_files/figure-html/traintest-1.png"><em>figure reproduced with permission from the authors</em></p>
<p>The downside of this is that you are not using all the data available to you, and
it is not the final model that you are using for prediction.</p>
<p>An alternative is to use a method called cross-validation. In this scenario you
roll over all of the data available to fit multiple models to predict one year ahead.
You use more and more data in each model, as seen in the figure below from the
same [<em>Hyndman et al</em> text]((<a href="https://otexts.com/fpp3/" class="uri">https://otexts.com/fpp3/</a>).
For example, the first model uses 2002 to predict 2003, the second uses 2002 and
2003 to predict 2004, and so on.
<img src="https://otexts.com/fpp2/fpp_files/figure-html/cv1-1.png"><em>figure reproduced with permission from the authors</em></p>
<p>In the below we use <strong>purrr</strong> package <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> function to loop over each dataset.
We then put estimates in one data set and merge with the original case counts,
to use the <strong>yardstick</strong> package to compute measures of accuracy.
We compute four measures including: Root mean squared error (RMSE), Mean absolute error
(MAE), Mean absolute scaled error (MASE), Mean absolute percent error (MAPE).</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Note the use of <code>simulate_pi = FALSE</code>
within the <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> argument. This is because the default behaviour of <strong>trending</strong>
is to use the <strong>ciTools</strong> package to estimate a prediction interval. This does not
work if there are <code>NA</code> counts, and also produces more granular intervals.
See <code>?trending::predict.trending_model_fit</code> for details. </span></p>
<div class="sourceCode" id="cb330"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Cross validation: predicting week(s) ahead based on sliding window</span></span>
<span></span>
<span><span class="co">## expand your data by rolling over in 52 week windows (before + after) </span></span>
<span><span class="co">## to predict 52 week ahead</span></span>
<span><span class="co">## (creates longer and longer chains of observations - keeps older data)</span></span>
<span></span>
<span><span class="co">## define window want to roll over</span></span>
<span><span class="va">roll_window</span> <span class="op">&lt;-</span> <span class="fl">52</span></span>
<span></span>
<span><span class="co">## define weeks ahead want to predict </span></span>
<span><span class="va">weeks_ahead</span> <span class="op">&lt;-</span> <span class="fl">52</span></span>
<span></span>
<span><span class="co">## create a data set of repeating, increasingly long data</span></span>
<span><span class="co">## label each data set with a unique id</span></span>
<span><span class="co">## only use cases before year of interest (i.e. 2011)</span></span>
<span><span class="va">case_roll</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;</span> <span class="va">cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## only keep the week and case counts variables</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## drop the last x observations </span></span>
<span>    <span class="co">## depending on how many weeks ahead forecasting </span></span>
<span>    <span class="co">## (otherwise will be an actual forecast to "unknown")</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">weeks_ahead</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## roll over each week in x after windows to create grouping ID </span></span>
<span>    <span class="co">## depending on what rolling window specify</span></span>
<span>    <span class="fu">stretch_tsibble</span><span class="op">(</span>.init <span class="op">=</span> <span class="va">roll_window</span>, .step <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## drop the first couple - as have no "before" cases</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">.id</span> <span class="op">&gt;</span> <span class="va">roll_window</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## for each of the unique data sets run the code below</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">case_roll</span><span class="op">$</span><span class="va">.id</span><span class="op">)</span>, </span>
<span>                        <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## only keep the current fold being fit </span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">case_roll</span>, <span class="va">.id</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## create an empty data set for forecasting on </span></span>
<span>  <span class="va">forecast_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    epiweek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mini_data</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mini_data</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="va">weeks_ahead</span>,</span>
<span>                  by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    case_int <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep.int</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">weeks_ahead</span><span class="op">)</span>,</span>
<span>    .id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep.int</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">weeks_ahead</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## add the forecast data to the original </span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">mini_data</span>, <span class="va">forecast_data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## define the cut off based on latest non missing count data </span></span>
<span>  <span class="va">cv_cut_off</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## only keep non-missing rows</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## get the latest week</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## extract so is not in a dataframe</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## make mini_data back in to a tsibble</span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">mini_data</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## define fourier terms (sincos) </span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## combine fourier terms for weeks prior to  and after cut-off date</span></span>
<span>    fourier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>      <span class="co">## get fourier terms for previous years</span></span>
<span>      <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/fourier.html">fourier</a></span><span class="op">(</span></span>
<span>        <span class="co">## only keep the rows before cut-off</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">mini_data</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span>, </span>
<span>        <span class="co">## include one set of sin cos terms </span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span></span>
<span>        <span class="op">)</span>, </span>
<span>      <span class="co">## predict the fourier terms for following year (using baseline data)</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## only keep the rows before cut-off</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">mini_data</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span>,</span>
<span>        <span class="co">## include one set of sin cos terms </span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span>, </span>
<span>        <span class="co">## predict 52 weeks ahead</span></span>
<span>        h <span class="op">=</span> <span class="va">weeks_ahead</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># split data for fitting and prediction</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## define the model you want to fit (negative binomial) </span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>    <span class="co">## set number of cases as outcome of interest</span></span>
<span>    <span class="va">case_int</span> <span class="op">~</span></span>
<span>      <span class="co">## use epiweek to account for the trend</span></span>
<span>      <span class="va">epiweek</span> <span class="op">+</span></span>
<span>      <span class="co">## use the furier terms to account for seasonality</span></span>
<span>      <span class="va">fourier</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># define which data to use for fitting and which for predicting</span></span>
<span>  <span class="va">fitting_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">pred_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># fit model </span></span>
<span>  <span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">fitting_data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># forecast with data want to predict with </span></span>
<span>  <span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">pred_data</span><span class="op">)</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">forecasts</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>       <span class="co">## only keep the week and the forecast estimate</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## make the list in to a data frame with all the forecasts</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">forecasts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## join the forecasts with the observed</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">forecasts</span>, </span>
<span>                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span>,</span>
<span>                       by <span class="op">=</span> <span class="st">"epiweek"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## using {yardstick} compute metrics</span></span>
<span>  <span class="co">## RMSE: Root mean squared error</span></span>
<span>  <span class="co">## MAE:  Mean absolute error  </span></span>
<span>  <span class="co">## MASE: Mean absolute scaled error</span></span>
<span>  <span class="co">## MAPE: Mean absolute percent error</span></span>
<span><span class="va">model_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="co">## in your forcasted dataset compare the observed to the predicted</span></span>
<span>  <span class="fu">rmse</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>, </span>
<span>  <span class="fu">mae</span><span class="op">(</span> <span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="fu">mase</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="fu">mape</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## only keep the metric type and its output</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>Metric  <span class="op">=</span> <span class="va">.metric</span>, </span>
<span>         Measure <span class="op">=</span> <span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## make in to wide format so can bind rows after</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">Metric</span>, values_from <span class="op">=</span> <span class="va">Measure</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## return model metrics </span></span>
<span><span class="va">model_metrics</span></span></code></pre></div>
<pre><code>## # A tibble: 1 × 4
##    rmse   mae  mase  mape
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  252.  199.  1.96  17.3</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="surveillance-package" class="section level3 unnumbered">
<h3>
<strong>surveillance</strong> package<a class="anchor" aria-label="anchor" href="#surveillance-package"><i class="fas fa-link"></i></a>
</h3>
<p>In this section we use the <strong>surveillance</strong> package to create alert thresholds
based on outbreak detection algorithms. There are several different methods
available in the package, however we will focus on two options here.
For details, see these papers on the <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/monitoringCounts.pdf">application</a>
and <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">theory</a>
of the alogirthms used.</p>
<p>The first option uses the improved Farrington method. This fits a negative
binomial glm (including trend) and down-weights past outbreaks (outliers) to
create a threshold level.</p>
<p>The second option use the glrnb method. This also fits a negative binomial glm
but includes trend and fourier terms (so is favoured here). The regression is used
to calculate the “control mean” (~fitted values) - it then uses a computed
generalized likelihood ratio statistic to assess if there is shift in the mean
for each week. Note that the threshold for each week takes in to account previous
weeks so if there is a sustained shift an alarm will be triggered.
(Also note that after each alarm the algorithm is reset)</p>
<p>In order to work with the <strong>surveillance</strong> package, we first need to define a
“surveillance time series” object (using the <code>sts()</code> function) to fit within the
framework.</p>
<div class="sourceCode" id="cb332"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define surveillance time series object</span></span>
<span><span class="co">## nb. you can include a denominator with the population object (see ?sts)</span></span>
<span><span class="va">counts_sts</span> <span class="op">&lt;-</span> <span class="fu">sts</span><span class="op">(</span>observed <span class="op">=</span> <span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                  start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                    <span class="co">## subset to only keep the year from start_date </span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                    <span class="co">## subset to only keep the week from start_date</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="fl">7</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                  <span class="co">## define the type of data (in this case weekly)</span></span>
<span>                  freq <span class="op">=</span> <span class="fl">52</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## define the week range that you want to include (ie. prediction period)</span></span>
<span><span class="co">## nb. the sts object only counts observations without assigning a week or </span></span>
<span><span class="co">## year identifier to them - so we use our data to define the appropriate observations</span></span>
<span><span class="va">weekrange</span> <span class="op">&lt;-</span> <span class="va">cut_off</span> <span class="op">-</span> <span class="va">start_date</span></span></code></pre></div>
<!-- ======================================================= -->
<div id="farrington-method" class="section level4 unnumbered">
<h4>Farrington method<a class="anchor" aria-label="anchor" href="#farrington-method"><i class="fas fa-link"></i></a>
</h4>
<p>We then define each of our parameters for the Farrington method in a <code>list</code>.
Then we run the algorithm using <code>farringtonFlexible()</code> and then we can extract the
threshold for an alert using <code>farringtonmethod@upperbound</code>to include this in our
dataset. It is also possible to extract a TRUE/FALSE for each week if it triggered
an alert (was above the threshold) using <code>farringtonmethod@alarm</code>.</p>
<div class="sourceCode" id="cb333"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define control</span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="co">## define what time period that want threshold for (i.e. 2011)</span></span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts_sts</span><span class="op">@</span><span class="va">epoch</span> <span class="op">&gt;</span> <span class="va">weekrange</span><span class="op">)</span>,</span>
<span>  b <span class="op">=</span> <span class="fl">9</span>, <span class="co">## how many years backwards for baseline</span></span>
<span>  w <span class="op">=</span> <span class="fl">2</span>, <span class="co">## rolling window size in weeks</span></span>
<span>  weightsThreshold <span class="op">=</span> <span class="fl">2.58</span>, <span class="co">## reweighting past outbreaks (improved noufaily method - original suggests 1)</span></span>
<span>  <span class="co">## pastWeeksNotIncluded = 3, ## use all weeks available (noufaily suggests drop 26)</span></span>
<span>  trend <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pThresholdTrend <span class="op">=</span> <span class="fl">1</span>, <span class="co">## 0.05 normally, however 1 is advised in the improved method (i.e. always keep)</span></span>
<span>  thresholdMethod <span class="op">=</span> <span class="st">"nbPlugin"</span>,</span>
<span>  populationOffset <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## apply farrington flexible method</span></span>
<span><span class="va">farringtonmethod</span> <span class="op">&lt;-</span> <span class="fu">farringtonFlexible</span><span class="op">(</span><span class="va">counts_sts</span>, <span class="va">ctrl</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## create a new variable in the original dataset called threshold</span></span>
<span><span class="co">## containing the upper bound from farrington </span></span>
<span><span class="co">## nb. this is only for the weeks in 2011 (so need to subset rows)</span></span>
<span><span class="va">counts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">cut_off</span> <span class="op">&amp;</span> </span>
<span>               <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="st">"threshold"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">farringtonmethod</span><span class="op">@</span><span class="va">upperbound</span></span></code></pre></div>
<p>We can then visualise the results in ggplot as done previously.</p>
<div class="sourceCode" id="cb334"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in observed case counts as a line</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in upper bound of aberration algorithm</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">threshold</span>, colour <span class="op">=</span> <span class="st">"Alert threshold"</span><span class="op">)</span>, </span>
<span>            linetype <span class="op">=</span> <span class="st">"dashed"</span>, </span>
<span>            size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## define colours</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Alert threshold"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## make a traditional plot (with black axes and white background)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## remove title of legend </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_farrington-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="glrnb-method" class="section level4 unnumbered">
<h4>GLRNB method<a class="anchor" aria-label="anchor" href="#glrnb-method"><i class="fas fa-link"></i></a>
</h4>
<p>Similarly for the GLRNB method we define each of our parameters for the in a <code>list</code>,
then fit the algorithm and extract the upper bounds.</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> This method uses “brute force” (similar to bootstrapping) for calculating thresholds, so can take a long time!</span></p>
<p>See the <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">GLRNB vignette</a>
for details.</p>
<div class="sourceCode" id="cb335"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define control options</span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="co">## define what time period that want threshold for (i.e. 2011)</span></span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts_sts</span><span class="op">@</span><span class="va">epoch</span> <span class="op">&gt;</span> <span class="va">weekrange</span><span class="op">)</span>,</span>
<span>  mu0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">1</span>,    <span class="co">## number of fourier terms (harmonics) to include</span></span>
<span>  trend <span class="op">=</span> <span class="cn">TRUE</span>,   <span class="co">## whether to include trend or not</span></span>
<span>  refit <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="co">## whether to refit model after each alarm</span></span>
<span>  <span class="co">## cARL = threshold for GLR statistic (arbitrary)</span></span>
<span>     <span class="co">## 3 ~ middle ground for minimising false positives</span></span>
<span>     <span class="co">## 1 fits to the 99%PI of glm.nb - with changes after peaks (threshold lowered for alert)</span></span>
<span>   c.ARL <span class="op">=</span> <span class="fl">2</span>,</span>
<span>   <span class="co"># theta = log(1.5), ## equates to a 50% increase in cases in an outbreak</span></span>
<span>   ret <span class="op">=</span> <span class="st">"cases"</span>     <span class="co">## return threshold upperbound as case counts</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## apply the glrnb method</span></span>
<span><span class="va">glrnbmethod</span> <span class="op">&lt;-</span> <span class="fu">glrnb</span><span class="op">(</span><span class="va">counts_sts</span>, control <span class="op">=</span> <span class="va">ctrl</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## create a new variable in the original dataset called threshold</span></span>
<span><span class="co">## containing the upper bound from glrnb </span></span>
<span><span class="co">## nb. this is only for the weeks in 2011 (so need to subset rows)</span></span>
<span><span class="va">counts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">cut_off</span> <span class="op">&amp;</span> </span>
<span>               <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="st">"threshold_glrnb"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">glrnbmethod</span><span class="op">@</span><span class="va">upperbound</span></span></code></pre></div>
<p>Visualise the outputs as previously.</p>
<div class="sourceCode" id="cb336"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in observed case counts as a line</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in upper bound of aberration algorithm</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">threshold_glrnb</span>, colour <span class="op">=</span> <span class="st">"Alert threshold"</span><span class="op">)</span>, </span>
<span>            linetype <span class="op">=</span> <span class="st">"dashed"</span>, </span>
<span>            size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## define colours</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Alert threshold"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## make a traditional plot (with black axes and white background)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## remove title of legend </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_glrnb-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="interrupted-timeseries" class="section level2" number="7.8">
<h2>
<span class="header-section-number">7.8</span> Interrupted timeseries<a class="anchor" aria-label="anchor" href="#interrupted-timeseries"><i class="fas fa-link"></i></a>
</h2>
<p>Interrupted timeseries (also called segmented regression or intervention analysis),
is often used in assessing the impact of vaccines on the incidence of disease.
But it can be used for assessing impact of a wide range of interventions or introductions.
For example changes in hospital procedures or the introduction of a new disease
strain to a population.
In this example we will pretend that a new strain of Campylobacter was introduced
to Germany at the end of 2008, and see if that affects the number of cases.
We will use negative binomial regression again. The regression this time will be
split in to two parts, one before the intervention (or introduction of new strain here)
and one after (the pre and post-periods). This allows us to calculate an incidence rate ratio comparing the
two time periods. Explaining the equation might make this clearer (if not then just
ignore!).</p>
<p>The negative binomial regression can be defined as follows:</p>
<p><span class="math display">\[\log(Y_t)= β_0 + β_1 \times t+ β_2 \times δ(t-t_0) + β_3\times(t-t_0 )^+ + log(pop_t) + e_t\]</span></p>
<p>Where:
<span class="math inline">\(Y_t\)</span>is the number of cases observed at time <span class="math inline">\(t\)</span><br><span class="math inline">\(pop_t\)</span> is the population size in 100,000s at time <span class="math inline">\(t\)</span> (not used here)<br><span class="math inline">\(t_0\)</span> is the last year of the of the pre-period (including transition time if any)<br><span class="math inline">\(δ(x\)</span> is the indicator function (it is 0 if x≤0 and 1 if x&gt;0)<br><span class="math inline">\((x)^+\)</span> is the cut off operator (it is x if x&gt;0 and 0 otherwise)<br><span class="math inline">\(e_t\)</span> denotes the residual
Additional terms trend and season can be added as needed.</p>
<p><span class="math inline">\(β_2 \times δ(t-t_0) + β_3\times(t-t_0 )^+\)</span> is the generalised linear
part of the post-period and is zero in the pre-period.
This means that the <span class="math inline">\(β_2\)</span> and <span class="math inline">\(β_3\)</span> estimates are the effects of the intervention.</p>
<p>We need to re-calculate the fourier terms without forecasting here, as we will use
all the data available to us (i.e. retrospectively). Additionally we need to calculate
the extra terms needed for the regression.</p>
<div class="sourceCode" id="cb337"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## add in fourier terms using the epiweek and case_int variabless</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">fourier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">fourier</span><span class="op">(</span>K <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## define intervention week </span></span>
<span><span class="va">intervention_week</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2008-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## define variables for regression </span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## corresponds to t in the formula</span></span>
<span>      <span class="co">## count of weeks (could probably also just use straight epiweeks var)</span></span>
<span>    <span class="co"># linear = row_number(epiweek), </span></span>
<span>    <span class="co">## corresponds to delta(t-t0) in the formula</span></span>
<span>      <span class="co">## pre or post intervention period</span></span>
<span>    intervention <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">intervention_week</span><span class="op">)</span>, </span>
<span>    <span class="co">## corresponds to (t-t0)^+ in the formula</span></span>
<span>      <span class="co">## count of weeks post intervention</span></span>
<span>      <span class="co">## (choose the larger number between 0 and whatever comes from calculation)</span></span>
<span>    time_post <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">epiweek</span> <span class="op">-</span> <span class="va">intervention_week</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then use these terms to fit a negative binomial regression, and produce a
table with percentage change. What this example shows is that there was no
significant change.</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Note the use of <code>simulate_pi = FALSE</code>
within the <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> argument. This is because the default behaviour of <strong>trending</strong>
is to use the <strong>ciTools</strong> package to estimate a prediction interval. This does not
work if there are <code>NA</code> counts, and also produces more granular intervals.
See <code>?trending::predict.trending_model_fit</code> for details. </span></p>
<div class="sourceCode" id="cb338"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## define the model you want to fit (negative binomial) </span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## set number of cases as outcome of interest</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## use epiweek to account for the trend</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## use the furier terms to account for seasonality</span></span>
<span>    <span class="va">fourier</span> <span class="op">+</span> </span>
<span>    <span class="co">## add in whether in the pre- or post-period </span></span>
<span>    <span class="va">intervention</span> <span class="op">+</span> </span>
<span>    <span class="co">## add in the time post intervention </span></span>
<span>    <span class="va">time_post</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## fit your model using the counts dataset</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">counts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## calculate confidence intervals and prediction intervals </span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb339"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## show estimates and percentage change in a table</span></span>
<span><span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## extract original negative binomial regression</span></span>
<span>  <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## get a tidy dataframe of results</span></span>
<span>  <span class="fu">tidy</span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>       conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## only keep the intervention value </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"intervention"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## change the IRR to percentage change for estimate and CIs </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## for each of the columns of interest - create a new column</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"estimate"</span>, <span class="st">"conf.low"</span>, <span class="st">"conf.high"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      <span class="co">## apply the formula to calculate percentage change</span></span>
<span>            .f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>      <span class="co">## add a suffix to new column names with "_perc"</span></span>
<span>      .names <span class="op">=</span> <span class="st">"{.col}_perc"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## only keep (and rename) certain columns </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"IRR"</span> <span class="op">=</span> <span class="va">estimate</span>, </span>
<span>         <span class="st">"95%CI low"</span> <span class="op">=</span> <span class="va">conf.low</span>, </span>
<span>         <span class="st">"95%CI high"</span> <span class="op">=</span> <span class="va">conf.high</span>,</span>
<span>         <span class="st">"Percentage change"</span> <span class="op">=</span> <span class="va">estimate_perc</span>, </span>
<span>         <span class="st">"95%CI low (perc)"</span> <span class="op">=</span> <span class="va">conf.low_perc</span>, </span>
<span>         <span class="st">"95%CI high (perc)"</span> <span class="op">=</span> <span class="va">conf.high_perc</span>,</span>
<span>         <span class="st">"p-value"</span> <span class="op">=</span> <span class="va">p.value</span><span class="op">)</span></span></code></pre></div>
<p>As previously we can visualise the outputs of the regression.</p>
<div class="sourceCode" id="cb340"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">estimate_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in observed case counts as a line</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in a line for the model estimate</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span>, col <span class="op">=</span> <span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add in a band for the prediction intervals </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## add vertical line and label to show where forecasting started</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span></span>
<span>           xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">intervention_week</span><span class="op">)</span>, </span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Intervention"</span>, </span>
<span>           x <span class="op">=</span> <span class="va">intervention_week</span>, </span>
<span>           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>           angle <span class="op">=</span> <span class="fl">90</span>, </span>
<span>           vjust <span class="op">=</span> <span class="fl">1</span></span>
<span>           <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## define colours</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Estimate"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## make a traditional plot (with black axes and white background)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Unknown or uninitialised column: `upper_pi`.</code></pre>
<pre><code>## Warning in max(observed$upper_pi): no non-missing arguments to max; returning -Inf</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/plot_interrupted-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="resources-6" class="section level2" number="7.9">
<h2>
<span class="header-section-number">7.9</span> Resources<a class="anchor" aria-label="anchor" href="#resources-6"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://otexts.com/fpp3/">forecasting: principles and practice textbook</a><br><a href="https://github.com/EPIET/TimeSeriesAnalysis">EPIET timeseries analysis case studies</a><br><a href="https://online.stat.psu.edu/stat510/lesson/1">Penn State course</a>
<a href="https://www.jstatsoft.org/article/view/v070i10">Surveillance package manuscript</a></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="moving-averages.html"><span class="header-section-number">6</span> Moving averages</a></div>
<div class="next"><a href="epidemic-modeling.html"><span class="header-section-number">8</span> Epidemic modeling</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#time-series-and-outbreak-detection"><span class="header-section-number">7</span> Time series and outbreak detection</a></li>
<li><a class="nav-link" href="#overview-1"><span class="header-section-number">7.1</span> Overview</a></li>
<li>
<a class="nav-link" href="#preparation-6"><span class="header-section-number">7.2</span> Preparation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#packages">Packages</a></li>
<li><a class="nav-link" href="#load-data">Load data</a></li>
<li><a class="nav-link" href="#clean-data-1">Clean data</a></li>
<li><a class="nav-link" href="#download-climate-data">Download climate data</a></li>
<li><a class="nav-link" href="#load-climate-data">Load climate data</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#time-series-data"><span class="header-section-number">7.3</span> Time series data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#duplicates">Duplicates</a></li>
<li><a class="nav-link" href="#missings">Missings</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#descriptive-analysis"><span class="header-section-number">7.4</span> Descriptive analysis</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#timeseries_moving">Moving averages</a></li>
<li><a class="nav-link" href="#periodicity">Periodicity</a></li>
<li><a class="nav-link" href="#decomposition">Decomposition</a></li>
<li><a class="nav-link" href="#autocorrelation">Autocorrelation</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#fitting-regressions"><span class="header-section-number">7.5</span> Fitting regressions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#fourier-terms">Fourier terms</a></li>
<li><a class="nav-link" href="#negative-binomial">Negative binomial</a></li>
<li><a class="nav-link" href="#residuals">Residuals</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#relation-of-two-time-series"><span class="header-section-number">7.6</span> Relation of two time series</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#merging-datasets">Merging datasets</a></li>
<li><a class="nav-link" href="#descriptive-analysis-1">Descriptive analysis</a></li>
<li><a class="nav-link" href="#lags-and-cross-correlation">Lags and cross-correlation</a></li>
<li><a class="nav-link" href="#negative-binomial-with-two-variables">Negative binomial with two variables</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#outbreak-detection"><span class="header-section-number">7.7</span> Outbreak detection</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#trending-package">trending package</a></li>
<li><a class="nav-link" href="#surveillance-package">surveillance package</a></li>
</ul>
</li>
<li><a class="nav-link" href="#interrupted-timeseries"><span class="header-section-number">7.8</span> Interrupted timeseries</a></li>
<li><a class="nav-link" href="#resources-6"><span class="header-section-number">7.9</span> Resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>The Epidemiologist R Handbook</strong>" was written by the handbook team. It was last built on 2023-07-18.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
