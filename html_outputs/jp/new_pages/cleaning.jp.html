<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="jp" xml:lang="jp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>8  データクリーニングと主要関数 – 疫学のための R ハンドブック</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>
<script src="../site_libs/quarto-nav/quarto-nav.js"></script><script src="../site_libs/quarto-nav/headroom.min.js"></script><script src="../site_libs/clipboard/clipboard.min.js"></script><script src="../site_libs/quarto-search/autocomplete.umd.js"></script><script src="../site_libs/quarto-search/fuse.min.js"></script><script src="../site_libs/quarto-search/quarto-search.js"></script><meta name="quarto:offset" content="../">
<link href="../new_pages/dates.jp.html" rel="next">
<link href="../new_pages/importing.jp.html" rel="prev">
<link href="../images/Applied_Epi_logo.png" rel="icon" type="image/png">
<script src="../site_libs/cookie-consent/cookie-consent.js"></script><link href="../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../site_libs/quarto-html/quarto.js"></script><script src="../site_libs/quarto-html/popper.min.js"></script><script src="../site_libs/quarto-html/tippy.umd.min.js"></script><script src="../site_libs/quarto-html/anchor.min.js"></script><link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script><link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script><link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QXDW878QLX', { 'anonymize_ip': true});
</script><script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"dark",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"jp"
  });
});
</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script>

  window.dataLayer = window.dataLayer || [];

  function gtag(){dataLayer.push(arguments);}

  gtag('js', new Date());



  gtag('config', 'G-QXDW878QLX');

</script>
</head>
<body class="nav-sidebar floating">
<div class="alert alert-info alert-dismissible">

  <!-- <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>

  <strong>Need help learning R?</strong> Enroll in Applied Epi's <a href="https://www.appliedepi.org/live/"

    class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/"

    class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/"

    class="alert-link">Community Q&A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org"

    class="alert-link">R Help Desk service</a>. -->

</div>



<script>



  // Function to extract the last two characters from the URL path

  function getLanguageFromURL() {

    const path = window.location.pathname.split('/');

    

    if (path.length > 1) {

      return path[1]; // Assume the language code is the second segment

    }



    return '';

  }



  const language = getLanguageFromURL();

  const supportedLanguages = ['fr', 'es', 'vn', 'jp', 'pt', 'tr', 'ru', 'en'];

  const defaultLanguage = 'en';

  const isSupportedLanguage = supportedLanguages.includes(language);



  // Translations for the content

  const translations = {

    en: '<strong>Need help learning R?</strong> Enroll in Applied Epi\'s <a href="https://www.appliedepi.org/live/" class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/" class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/" class="alert-link">Community Q&A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org" class="alert-link">R Help Desk service</a>.',

    fr: '<strong>Besoin d\'aide pour apprendre R ?</strong> Inscrivez-vous au <a href="https://www.appliedepi.org/live/" class="alert-link">cours d\'introduction à R</a> d\'Applied Epi, essayez nos <a href="https://www.appliedepi.org/tutorial/" class="alert-link">tutoriels R gratuits</a>, postez dans notre forum de <a href="https://community.appliedepi.org/" class="alert-link">questions-réponses communautaires</a>, ou demandez-nous des informations sur <a href="mailto:contact@appliedepi.org" class="alert-link"> notre service d\'assistance R</a>.',

    es: '<strong>¿Necesitas ayuda para aprender R?</strong> Inscríbete en el <a href="https://www.appliedepi.org/live/" class="alert-link">Curso de introducción a R</a> de Applied Epi, prueba nuestros <a href="https://www.appliedepi.org/tutorial/" class="alert-link">Tutoriales gratuitos de R</a>, escribe en nuestro <a href="https://community.appliedepi.org/" class="alert-link">Foro de preguntas y respuestas,</a> o pregunta por nuestra <a href="mailto:contact@appliedepi.org" class="alert-link">Asistencia técnica para R</a>.',

    vn: '<strong>Bạn cần giúp đỡ trong việc học R?</strong> Hãy đăng ký khóa học R cơ bản của Applied Epi tại <a href="https://www.appliedepi.org/live/" class="alert-link">đây</a>, hoặc thử các <a href="https://www.appliedepi.org/tutorial/" class="alert-link">hướng dẫn R miễn phí</a>, đăng bài trong <a href="https://community.appliedepi.org/" class="alert-link">diễn đàn cộng đồng</a>, hoặc gửi câu hỏi tới <a href="mailto:contact@appliedepi.org" class="alert-link">dịch vụ Trợ giúp R</a> của chúng tôi.',

    jp: '<strong>Rの学習について助けが必要ですか？</strong>Applied Epiの<a href="https://www.appliedepi.org/live/" class="alert-link">R入門コース</a>に登録するか、<a href="https://www.appliedepi.org/tutorial/" class="alert-link">無料Rチュートリアル</a>を試すか、<a href="https://community.appliedepi.org/" class="alert-link">コミュニティQ＆Aフォーラム</a>に投稿するか、<a href="mailto:contact@appliedepi.org" class="alert-link">Rヘルプデスクサービス</a>についてお問い合わせください。',

    pt: '<strong>Você precisa de ajuda para aprender R??</strong> Inscreva-se no curso de <a href="https://www.appliedepi.org/live/" class="alert-link">introdução ao R da Applied Epi</a>, experimente nossos <a href="https://www.appliedepi.org/tutorial/" class="alert-link">tutoriais gratuitos sobre o R</a>, publique em nosso <a href="https://community.appliedepi.org/" class="alert-link">fórum de perguntas e respostas</a>, ou solicite nosso <a href="mailto:contact@appliedepi.org" class="alert-link">suporte ao R</a>.',

    tr: '<strong>R öğrenmekte yardıma mı ihtiyacınız var?</strong> Applied Epi\'\nin <a href="https://www.appliedepi.org/live/" class="alert-link">R\'ye giriş kursuna</a> kaydolun, <a href="https://www.appliedepi.org/tutorial/" class="alert-link">ücretsiz R derslerimizi</a> deneyin, <a href="https://community.appliedepi.org/" class="alert-link">Topluluk Q&A forumunda</a> soru paylaşın, ya da <a href="mailto:contact@appliedepi.org" class="alert-link">R Yardım Masası hizmetimiz</a> hakkında sorun.',

    ru: '<strong>Нужна помощь в изучении R?</strong> Запишитесь на <a href="https://www.appliedepi.org/live/" class="alert-link">вводный курс по R</a> от Applied Epi, попробуйте наши <a href="https://www.appliedepi.org/tutorial/" class="alert-link">бесплатные учебные материалы по R</a>, задайте вопрос в нашем <a href="https://community.appliedepi.org/" class="alert-link">форуме вопросов и ответов сообщества</a>, или спросите о нашей услуге <a href="mailto:contact@appliedepi.org" class="alert-link">Службы поддержки по R</a>.'

  };



  // Default to English if the detected language is not supported

  const contentToDisplay = translations[isSupportedLanguage ? language : defaultLanguage];





  // Select the element where the content should be displayed

  const alertElement = document.querySelector('.alert');

  if (alertElement) {

    alertElement.innerHTML = contentToDisplay;

    alertElement.style.display = 'block'; // Make sure to display the element

  }



</script><link href="../site_libs/htmltools-fill-0.5.8/fill.css" rel="stylesheet">
<script src="../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../site_libs/datatables-binding-0.31/datatables.js"></script><script src="../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script><link href="../site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script><link href="../site_libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="../site_libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="../site_libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="../site_libs/selectize-0.12.0/selectize.min.js"></script><div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb">
<li class="breadcrumb-item"><a href="../new_pages/cleaning.jp.html">データマネジメント</a></li>
<li class="breadcrumb-item"><a href="../new_pages/cleaning.jp.html"><span class="chapter-number">8</span>  <span class="chapter-title">データクリーニングと主要関数</span></a></li>
</ol></nav><a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/Applied_Epi_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none"></a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">疫学のための R ハンドブック</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://twitter.com/appliedepi" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
    <a href="https://www.linkedin.com/company/appliedepi/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="https://github.com/appliedepi/epiRhandbook_eng" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="dropdown" id="languages-links-parent">
<button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="languages-button"><i class="bi bi-globe2"></i></button><ul class="dropdown-menu" id="languages-links">
<a class="dropdown-item" href="/new_pages/cleaning.html" id="language-link-en">English</a><a class="dropdown-item" href="/fr/new_pages/cleaning.fr.html" id="language-link-fr">Français</a>
<a class="dropdown-item" href="/es/new_pages/cleaning.es.html" id="language-link-es">Español</a>
<a class="dropdown-item" href="/vn/new_pages/cleaning.vn.html" id="language-link-vn">Tiếng Việt</a>
<a class="dropdown-item" href="/pt/new_pages/cleaning.pt.html" id="language-link-pt">Português</a>
<a class="dropdown-item" href="/tr/new_pages/cleaning.tr.html" id="language-link-tr">Türkçe</a>
<a class="dropdown-item" href="/ru/new_pages/cleaning.ru.html" id="language-link-ru">Русский</a>
</ul>
</div>
<div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">いらっしゃいませ</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">本書について</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/editorial_style.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>  <span class="chapter-title">編集前記・技術注記</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/data_used.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>  <span class="chapter-title">ハンドブックとデータのダウンロード</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">基本編</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/basics.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>  <span class="chapter-title">R の基礎</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/transition_to_R.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>  <span class="chapter-title">Excel・Stata・SASとの比較</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/packages_suggested.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>  <span class="chapter-title">推奨パッケージ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/r_projects.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>  <span class="chapter-title">R プロジェクト</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/importing.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>  <span class="chapter-title">データのインポート・エクスポート</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">データマネジメント</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/cleaning.jp.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>  <span class="chapter-title">データクリーニングと主要関数</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/dates.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>  <span class="chapter-title">日付型データ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/characters_strings.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>  <span class="chapter-title">文字型・文字列型データ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/factors.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>  <span class="chapter-title">因子（ファクタ）型データ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/pivoting.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>  <span class="chapter-title">データの縦横変換</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/grouping.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>  <span class="chapter-title">データのグループ化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/joining_matching.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>  <span class="chapter-title">データの結合</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/deduplication.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>  <span class="chapter-title">重複データの排除</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/iteration.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>  <span class="chapter-title">ループと反復処理・リストの操作</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">データ分析</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/tables_descriptive.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>  <span class="chapter-title">記述統計表の作り方</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/stat_tests.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>  <span class="chapter-title">基本的な統計的検定</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/regression.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>  <span class="chapter-title">単変量と多変量回帰</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/missing_data.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>  <span class="chapter-title">データの欠損</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/standardization.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>  <span class="chapter-title">標準化率</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/moving_average.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>  <span class="chapter-title">移動平均</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/time_series.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>  <span class="chapter-title">時系列分析とアウトブレイクの検出{#time-series}</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/epidemic_models.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>  <span class="chapter-title">エピデミックモデリング</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/contact_tracing.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>  <span class="chapter-title">接触者の追跡{#contact-tracing}</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/survey_analysis.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>  <span class="chapter-title">標本調査データ分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/survival_analysis.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>  <span class="chapter-title">生存時間解析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/gis.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>  <span class="chapter-title">GIS の基本</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">データの可視化</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/tables_presentation.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>  <span class="chapter-title">見やすい表の作り方</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/ggplot_basics.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>  <span class="chapter-title">ggplot の基本</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/ggplot_tips.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>  <span class="chapter-title">ggplotのヒント</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/epicurves.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>  <span class="chapter-title">流行曲線（エピカーブ）</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/age_pyramid.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>  <span class="chapter-title">人口ピラミッドとリッカート尺度</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/heatmaps.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>  <span class="chapter-title">ヒートマップ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/diagrams.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>  <span class="chapter-title">フローチャート・サンキー図・タイムライン</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/combination_analysis.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>  <span class="chapter-title">複数回答データの分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/transmission_chains.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>  <span class="chapter-title">感染連鎖</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/phylogenetic_trees.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>  <span class="chapter-title">系統樹</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/interactive_plots.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>  <span class="chapter-title">動的な図の作成</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">レポートとダッシュボード</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/rmarkdown.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>  <span class="chapter-title">R Markdown で作るレポート</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/reportfactory.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>  <span class="chapter-title">ルーチンで作成するレポートの整理</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/flexdashboard.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>  <span class="chapter-title">R Markdownで作るダッシュボード</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/shiny_basics.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>  <span class="chapter-title">Shiny で作るダッシュボード</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">その他</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/writing_functions.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>  <span class="chapter-title">関数の作成</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/directories.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>  <span class="chapter-title">ディレクトリの操作</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/collaboration.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>  <span class="chapter-title">Git と Github を使ったバージョン管理と共同作業</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/errors.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>  <span class="chapter-title">よくあるエラー</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/help.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>  <span class="chapter-title">ヘルプ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/network_drives.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">49</span>  <span class="chapter-title">ネットワークドライブで R を使用する場合</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/data_table.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">50</span>  <span class="chapter-title">data.table パッケージを使用したデータ処理</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Appendices</span></span>
  </li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#%E4%B8%BB%E8%A6%81%E9%96%A2%E6%95%B0" id="toc-主要関数" class="nav-link active" data-scroll-target="#主要関数">主要関数</a></li>
  <li><a href="#%E7%94%A8%E8%AA%9E%E4%BD%93%E7%B3%BB" id="toc-用語体系" class="nav-link" data-scroll-target="#用語体系">用語体系</a></li>
  <li><a href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%AB%E3%82%88%E3%82%8B%E3%83%87%E3%83%BC%E3%82%BF%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0" id="toc-パイプラインによるデータクリーニング" class="nav-link" data-scroll-target="#パイプラインによるデータクリーニング"><span class="header-section-number">8.1</span> パイプラインによるデータクリーニング</a></li>
  <li><a href="#%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF" id="toc-パッケージの読み込み" class="nav-link" data-scroll-target="#パッケージの読み込み"><span class="header-section-number">8.2</span> パッケージの読み込み</a></li>
  <li>
<a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88" id="toc-データのインポート" class="nav-link" data-scroll-target="#データのインポート"><span class="header-section-number">8.3</span> データのインポート</a>
  <ul class="collapse">
<li><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B" id="toc-データをインポートする" class="nav-link" data-scroll-target="#データをインポートする">データをインポートする</a></li>
  <li><a href="#%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%97%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B" id="toc-インポートしたデータを確認する" class="nav-link" data-scroll-target="#インポートしたデータを確認する">インポートしたデータを確認する</a></li>
  </ul>
</li>
  <li>
<a href="#%E5%88%97%E5%90%8D" id="toc-列名" class="nav-link" data-scroll-target="#列名"><span class="header-section-number">8.4</span> 列名</a>
  <ul class="collapse">
<li><a href="#%E8%87%AA%E5%8B%95%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0" id="toc-自動クリーニング" class="nav-link" data-scroll-target="#自動クリーニング">自動クリーニング</a></li>
  <li><a href="#%E6%89%8B%E5%8B%95%E3%81%AB%E3%82%88%E3%82%8B%E5%88%97%E5%90%8D%E3%81%AE%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0" id="toc-手動による列名のクリーニング" class="nav-link" data-scroll-target="#手動による列名のクリーニング">手動による列名のクリーニング</a></li>
  <li><a href="#%E5%88%97%E3%81%AE%E4%BD%8D%E7%BD%AE%E3%81%AB%E3%82%88%E3%82%8B%E5%90%8D%E5%89%8D%E3%81%AE%E5%A4%89%E6%9B%B4" id="toc-列の位置による名前の変更" class="nav-link" data-scroll-target="#列の位置による名前の変更">列の位置による名前の変更</a></li>
  <li><a href="#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E8%AA%B2%E9%A1%8C" id="toc-その他の課題" class="nav-link" data-scroll-target="#その他の課題">その他の課題</a></li>
  </ul>
</li>
  <li>
<a href="#%E5%88%97%E3%81%AE%E9%81%B8%E6%8A%9E%E3%81%A8%E4%B8%A6%E3%81%B3%E6%9B%BF%E3%81%88" id="toc-列の選択と並び替え" class="nav-link" data-scroll-target="#列の選択と並び替え"><span class="header-section-number">8.5</span> 列の選択と並び替え</a>
  <ul class="collapse">
<li><a href="#%E5%88%97%E3%81%AE%E4%BF%9D%E6%8C%81" id="toc-列の保持" class="nav-link" data-scroll-target="#列の保持">列の保持</a></li>
  <li><a href="#clean_tidyselect" id="toc-clean_tidyselect" class="nav-link" data-scroll-target="#clean_tidyselect">“tidyselect” ヘルパー関数</a></li>
  <li><a href="#%E5%88%97%E3%81%AE%E9%99%A4%E5%A4%96" id="toc-列の除外" class="nav-link" data-scroll-target="#列の除外">列の除外</a></li>
  <li><a href="#%E7%8B%AC%E7%AB%8B%E5%9E%8B" id="toc-独立型" class="nav-link" data-scroll-target="#独立型">独立型</a></li>
  </ul>
</li>
  <li><a href="#%E9%87%8D%E8%A4%87%E8%A1%8C%E3%81%AE%E5%89%8A%E9%99%A4" id="toc-重複行の削除" class="nav-link" data-scroll-target="#重複行の削除"><span class="header-section-number">8.6</span> 重複行の削除</a></li>
  <li>
<a href="#%E5%88%97%E3%81%AE%E4%BD%9C%E6%88%90%E3%81%A8%E5%A4%89%E6%8F%9B" id="toc-列の作成と変換" class="nav-link" data-scroll-target="#列の作成と変換"><span class="header-section-number">8.7</span> 列の作成と変換</a>
  <ul class="collapse">
<li><a href="#%E6%96%B0%E3%81%97%E3%81%84%E5%88%97%E3%81%AE%E4%BD%9C%E6%88%90" id="toc-新しい列の作成" class="nav-link" data-scroll-target="#新しい列の作成">新しい列の作成</a></li>
  <li><a href="#%E5%88%97%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E5%9E%8B%E3%81%AE%E5%A4%89%E6%8F%9B" id="toc-列のデータ型の変換" class="nav-link" data-scroll-target="#列のデータ型の変換">列のデータ型の変換</a></li>
  <li><a href="#%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E5%8C%96%E3%81%95%E3%82%8C%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF" id="toc-グループ化されたデータ" class="nav-link" data-scroll-target="#グループ化されたデータ">グループ化されたデータ</a></li>
  <li><a href="#clean_across" id="toc-clean_across" class="nav-link" data-scroll-target="#clean_across">複数列の一斉変換</a></li>
  <li><a href="#coalesce" id="toc-coalesce" class="nav-link" data-scroll-target="#coalesce"><code>coalesce()</code></a></li>
  <li><a href="#%E7%B4%AF%E7%A9%8D%E8%A8%88%E7%AE%97" id="toc-累積計算" class="nav-link" data-scroll-target="#累積計算">累積計算</a></li>
  <li><a href="#r-%E3%81%AE%E5%9F%BA%E6%9C%AC%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8-base-%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B" id="toc-r-の基本パッケージ-base-を使用する" class="nav-link" data-scroll-target="#r-の基本パッケージ-base-を使用する">R の基本パッケージ <strong>base</strong> を使用する</a></li>
  <li><a href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%B8%E3%81%AE%E8%BF%BD%E5%8A%A0" id="toc-パイプラインへの追加" class="nav-link" data-scroll-target="#パイプラインへの追加">パイプラインへの追加</a></li>
  </ul>
</li>
  <li>
<a href="#%E5%80%A4%E3%81%AE%E5%86%8D%E5%AE%9A%E7%BE%A9" id="toc-値の再定義" class="nav-link" data-scroll-target="#値の再定義"><span class="header-section-number">8.8</span> 値の再定義</a>
  <ul class="collapse">
<li><a href="#%E7%89%B9%E5%AE%9A%E3%81%AE%E5%80%A4" id="toc-特定の値" class="nav-link" data-scroll-target="#特定の値">特定の値</a></li>
  <li><a href="#%E8%AB%96%E7%90%86%E6%9D%A1%E4%BB%B6" id="toc-論理条件" class="nav-link" data-scroll-target="#論理条件">論理条件</a></li>
  <li><a href="#%E5%8D%98%E7%B4%94%E3%81%AA%E8%AB%96%E7%90%86%E6%9D%A1%E4%BB%B6" id="toc-単純な論理条件" class="nav-link" data-scroll-target="#単純な論理条件">単純な論理条件</a></li>
  <li><a href="#clean_case_when" id="toc-clean_case_when" class="nav-link" data-scroll-target="#clean_case_when">複雑な論理条件</a></li>
  <li><a href="#%E6%AC%A0%E6%90%8D%E5%80%A4" id="toc-欠損値" class="nav-link" data-scroll-target="#欠損値">欠損値</a></li>
  <li><a href="#%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0%E3%83%87%E3%82%A3%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%8A%E3%83%AAcleaning-dictionary" id="toc-クリーニングディクショナリcleaning-dictionary" class="nav-link" data-scroll-target="#クリーニングディクショナリcleaning-dictionary">クリーニングディクショナリ（Cleaning dictionary）</a></li>
  </ul>
</li>
  <li>
<a href="#num_cats" id="toc-num_cats" class="nav-link" data-scroll-target="#num_cats"><span class="header-section-number">8.9</span> 数値カテゴリ</a>
  <ul class="collapse">
<li><a href="#%E5%88%86%E5%B8%83%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B" id="toc-分布を確認する" class="nav-link" data-scroll-target="#分布を確認する">分布を確認する</a></li>
  <li><a href="#age_categories" id="toc-age_categories" class="nav-link" data-scroll-target="#age_categories"><code>age_categories()</code></a></li>
  <li><a href="#cut" id="toc-cut" class="nav-link" data-scroll-target="#cut"><code>cut()</code></a></li>
  <li><a href="#%E5%9B%9B%E5%88%86%E4%BD%8D%E6%95%B0%E3%81%AB%E3%82%88%E3%82%8B%E5%88%86%E5%89%B2" id="toc-四分位数による分割" class="nav-link" data-scroll-target="#四分位数による分割">四分位数による分割</a></li>
  <li><a href="#%E5%9D%87%E7%AD%89%E3%81%AA%E5%A4%A7%E3%81%8D%E3%81%95%E3%81%AE%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97" id="toc-均等な大きさのグループ" class="nav-link" data-scroll-target="#均等な大きさのグループ">均等な大きさのグループ</a></li>
  <li><a href="#case_when" id="toc-case_when" class="nav-link" data-scroll-target="#case_when"><code>case_when()</code></a></li>
  <li><a href="#%E3%83%91%E3%82%A4%E3%83%97%E3%83%81%E3%82%A7%E3%83%BC%E3%83%B3%E3%81%B8%E3%81%AE%E8%BF%BD%E5%8A%A0-1" id="toc-パイプチェーンへの追加-1" class="nav-link" data-scroll-target="#パイプチェーンへの追加-1">パイプチェーンへの追加</a></li>
  </ul>
</li>
  <li>
<a href="#%E8%A1%8C%E3%81%AE%E8%BF%BD%E5%8A%A0" id="toc-行の追加" class="nav-link" data-scroll-target="#行の追加"><span class="header-section-number">8.10</span> 行の追加</a>
  <ul class="collapse">
<li><a href="#%E4%B8%80%E8%A1%8C%E3%81%9A%E3%81%A4%E8%BF%BD%E5%8A%A0%E3%81%99%E3%82%8B" id="toc-一行ずつ追加する" class="nav-link" data-scroll-target="#一行ずつ追加する">一行ずつ追加する</a></li>
  <li><a href="#%E8%A4%87%E6%95%B0%E8%A1%8C%E3%82%92%E7%B5%90%E5%90%88%E3%81%99%E3%82%8B" id="toc-複数行を結合する" class="nav-link" data-scroll-target="#複数行を結合する">複数行を結合する</a></li>
  </ul>
</li>
  <li>
<a href="#%E8%A1%8C%E3%81%AE%E6%8A%BD%E5%87%BA%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0" id="toc-行の抽出フィルタリング" class="nav-link" data-scroll-target="#行の抽出フィルタリング"><span class="header-section-number">8.11</span> 行の抽出（フィルタリング）</a>
  <ul class="collapse">
<li><a href="#%E5%8D%98%E7%B4%94%E3%81%AA%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0" id="toc-単純なフィルタリング" class="nav-link" data-scroll-target="#単純なフィルタリング">単純なフィルタリング</a></li>
  <li><a href="#%E6%AC%A0%E6%90%8D%E5%80%A4%E3%81%AE%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0" id="toc-欠損値のフィルタリング" class="nav-link" data-scroll-target="#欠損値のフィルタリング">欠損値のフィルタリング</a></li>
  <li><a href="#%E8%A1%8C%E7%95%AA%E5%8F%B7%E3%81%AB%E3%82%88%E3%82%8B%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0" id="toc-行番号によるフィルタリング" class="nav-link" data-scroll-target="#行番号によるフィルタリング">行番号によるフィルタリング</a></li>
  <li><a href="#%E8%A4%87%E9%9B%91%E3%81%AA%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0" id="toc-複雑なフィルタリング" class="nav-link" data-scroll-target="#複雑なフィルタリング">複雑なフィルタリング</a></li>
  <li><a href="#%E7%8B%AC%E7%AB%8B%E5%9E%8B-1" id="toc-独立型-1" class="nav-link" data-scroll-target="#独立型-1">独立型</a></li>
  <li><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E7%B4%A0%E6%97%A9%E3%81%8F%E7%A2%BA%E8%AA%8D" id="toc-データを素早く確認" class="nav-link" data-scroll-target="#データを素早く確認">データを素早く確認</a></li>
  </ul>
</li>
  <li><a href="#%E8%A1%8C%E5%8D%98%E4%BD%8D%E3%81%AE%E8%A8%88%E7%AE%97" id="toc-行単位の計算" class="nav-link" data-scroll-target="#行単位の計算"><span class="header-section-number">8.12</span> 行単位の計算</a></li>
  <li><a href="#%E4%B8%A6%E3%81%B3%E6%9B%BF%E3%81%88%E3%82%A2%E3%83%AC%E3%83%B3%E3%82%B8%E3%81%A8%E3%82%BD%E3%83%BC%E3%83%88" id="toc-並び替えアレンジとソート" class="nav-link" data-scroll-target="#並び替えアレンジとソート"><span class="header-section-number">8.13</span> 並び替え（アレンジとソート）</a></li>
  </ul></nav>
</div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb">
<li class="breadcrumb-item"><a href="../new_pages/cleaning.jp.html">データマネジメント</a></li>
<li class="breadcrumb-item"><a href="../new_pages/cleaning.jp.html"><span class="chapter-number">8</span>  <span class="chapter-title">データクリーニングと主要関数</span></a></li>
</ol></nav><div class="quarto-title">
<h1 class="title"><span id="cleaning" class="quarto-section-identifier"><span class="chapter-number">8</span>  <span class="chapter-title">データクリーニングと主要関数</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="../images/data_cleaning.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="../images/data_cleaning.png" class="quarto-figure quarto-figure-center figure-img" style="height:10.0%" width="503"></a></p>
</figure>
</div>
</div>
</div>
<p>この章では、データクリーニング（データの前処理）の一般的な手順を示し、R を使ったデータ管理に不可欠な機能について説明します。</p>
<p>例として、未加工のラインリスト（症例データ）を使用し、ラインリストのインポートを始め、データクリーニングの手順を段階的に解説していきます。上の図のような処理は、R コードでは「パイプ（“pipe”）」チェーンとして行われ、「パイプ」演算子 <code>%&gt;%</code>によって、対象のデータセットをある操作から次の操作に渡すことができます。</p>
<section id="主要関数" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="主要関数">主要関数</h3>
<p>このハンドブックでは、R パッケージの一つである <a href="https://www.tidyverse.org/"><strong>tidyverse</strong></a> 系関数を主に使用します。以下の表は、本章で使用する基本の R パッケージおよびパッケージに含まれる関数の一覧です。</p>
<p>関数の多くは、データ操作に関する課題を解決するための「動詞」関数を提供する R パッケージ <a href="https://dplyr.tidyverse.org/"><strong>dplyr</strong></a> に属しています（<strong>dplyr</strong> という名前は”data frame-<a href="https://www.thefreedictionary.com/plier#:~:text=also%20ply%C2%B7er%20(pl%C4%AB%E2%80%B2,holding%2C%20bending%2C%20or%20cutting.)%22">plier</a>” にちなんでいます）。<strong>dplyr</strong> パッケージは、<strong>ggplot2</strong>、<strong>tidyr</strong>、<strong>stringr</strong>、<strong>tibble</strong>、<strong>purrr</strong>、<strong>magrittr</strong>、<strong>forcats</strong> などのパッケージを含む R パッケージである <strong>tidyverse</strong> ファミリーの一部です。</p>
<table class="caption-top table">
<colgroup>
<col style="width: 40%">
<col style="width: 39%">
<col style="width: 19%">
</colgroup>
<thead><tr class="header">
<th><strong>関数</strong></th>
<th>機能</th>
<th><strong>パッケージ</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>%&gt;%</code></td>
<td>ある関数から次の関数へデータを「パイプで渡す」</td>
<td><strong>magrittr</strong></td>
</tr>
<tr class="even">
<td><code>mutate()</code></td>
<td>列の作成、変換、再定義</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="odd">
<td><code>select()</code></td>
<td>列の保持、削除、選択、列名の変更</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td><code>rename()</code></td>
<td>列名の変更</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="odd">
<td><code>clean_names()</code></td>
<td>列名の構文を標準化</td>
<td><strong>janitor</strong></td>
</tr>
<tr class="even">
<td>
<code>as.character()</code>, <code>as.numeric()</code>, <code>as.Date()</code> 等</td>
<td>列のデータ型を変換</td>
<td>
<strong>base</strong> R</td>
</tr>
<tr class="odd">
<td><code>across()</code></td>
<td>複数の列を一度に変換</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td>
<strong>tidyselect</strong> 系関数</td>
<td>論理条件を使った列の選択</td>
<td><strong>tidyselect</strong></td>
</tr>
<tr class="odd">
<td><code>filter()</code></td>
<td>特定の行を選択</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td><code>distinct()</code></td>
<td>重複した行の削除</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="odd">
<td><code>rowwise()</code></td>
<td>各行の中の操作、または各行による操作</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td><code>add_row()</code></td>
<td>手動で行を追加</td>
<td><strong>tibble</strong></td>
</tr>
<tr class="odd">
<td><code>arrange()</code></td>
<td>行の並べ替え</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td><code>recode()</code></td>
<td>列の値を再定義</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="odd">
<td><code>case_when()</code></td>
<td>複数の論理基準を使用し列値を再コーディング</td>
<td><strong>dplyr</strong></td>
</tr>
<tr class="even">
<td>
<code>replace_na()</code>, <code>na_if()</code>, <code>coalesce()</code>
</td>
<td>再コーティングのための専用関数</td>
<td><strong>tidyr</strong></td>
</tr>
<tr class="odd">
<td>
<code>age_categories()</code>, <code>cut()</code>
</td>
<td>数値列からカテゴリグループを作成</td>
<td>
<strong>epikit</strong>, <strong>base</strong> R</td>
</tr>
<tr class="even">
<td><code>match_df()</code></td>
<td>データ辞書を使用した値の再定義・処理</td>
<td><strong>matchmaker</strong></td>
</tr>
<tr class="odd">
<td><code>which()</code></td>
<td>論理的基準を適用し、インデックスを抽出</td>
<td>
<strong>base</strong> R</td>
</tr>
</tbody>
</table>
<p>これらの関数を Stata や SAS のコマンドと比較したい場合は、<a href="transition_to_R.jp.html">Excel・Stata・SASとの比較</a> の章を参照にしてください。</p>
<p>また、R パッケージの <strong>data.table</strong> では、<code>:=</code> のような演算子や角括弧 <code>[ ]</code> が頻繁に使用されており、別の形式のデータ管理フレームワークを目にすることがあるかもしれません。この手法と構文については、<a href="data_table.jp.html">データテーブル</a> の章で簡単に説明しています。</p>
</section><section id="用語体系" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="用語体系">用語体系</h3>
<p>このハンドブックでは、一般的に「変数」や「観測値」の代わりに「列」や「行」を使用します。<a href="https://tidyr.tidyverse.org/articles/tidy-data.html">“tidy data”</a> の入門書で説明されているように、疫学統計データセットのほとんどは、行、列、値の構造で構成されています。</p>
<p>「変数」は、同じ基本属性について測定された値（年齢層、アウトカム、発症日など）を示しています。「観測値」は、同じ単位（人、場所、ラボのサンプルなど）で測定されたすべての値を示します。そのため、これらの値を明確に定義することは困難です。</p>
<p>“tidy” データセット（綺麗に整理されたデータセット）では、各列が変数、各行が観測値、そして各セルが 1 つの値となっています。しかし、この型に当てはまらないデータセットもあります。“wide” 型（横型）のデータセットでは、1 つの変数が複数の列に分かれて記録されていることがあります（詳細は、<a href="pivoting.jp.html">データの縦横変換</a> の章で紹介する例をご参照ください）。同様に、観測値が複数の行に分かれていることもあります。</p>
<p>このハンドブックでは、主にデータの管理と変換について取り扱うため、抽象的な観測値や変数よりも、行や列といった具体的なデータ構造を示す呼び方を使用していきます。例外として、データ分析の章では、変数や観測値と呼ぶことがあります。</p>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</section><section id="パイプラインによるデータクリーニング" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="パイプラインによるデータクリーニング">
<span class="header-section-number">8.1</span> パイプラインによるデータクリーニング</h2>
<p><strong>この章では、代表的なデータクリーニングの手順を実行し、パイプに処理を順次追加しながら進めていきます。</strong></p>
<p>疫学的な分析やデータ処理では、クリーニングを行う際、複数の手順が連続して実行されることが多く、手順どうしが互いに関連していることがよくあります。Rでは多くの場合、このように連続した手順はクリーニングを行う一貫したパイプラインとして作成され、データが処理されます。作成されたパイプラインでは、未加工のデータセットが 1 つのデータ処理のステップから別のデータ処理のステップに渡されます。</p>
<p>このような連続処理には、<strong>dplyr</strong> パッケージの「動詞」関数と <strong>magrittr</strong> パッケージのパイプ演算子 <code>%&gt;%</code> が使用されます。パイプ処理は、始めに未加工データ（“linelist_raw.xlsx”）を扱い、最終的に、使用や保存、エクスポートなどが行えるクリーニングされた R データフレーム（<code>linelist</code>）を作成することを目標としています。</p>
<p>パイプラインのデータ処理は、各手順の順番が重要です。クリーニングの手順には以下のようなものがあります。</p>
<ul>
<li><p>データをインポートする<br></p></li>
<li><p>列名を修正、または変更する<br></p></li>
<li><p>重複したデータを排除する<br></p></li>
<li><p>列を作成し、変換する（例：値の再定義または標準化）<br></p></li>
<li><p>行を抽出、または追加する<br></p></li>
</ul>
<!-- ======================================================= --><!-- ======================================================= --><!-- ======================================================= --></section><section id="パッケージの読み込み" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="パッケージの読み込み">
<span class="header-section-number">8.2</span> パッケージの読み込み</h2>
<p>以下のコードを実行すると、分析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、<strong>pacman</strong> パッケージの <code>p_load()</code> を主に使用しています。<code>p_load()</code> は、必要に応じてパッケージをインストールし、現在の R セッションで使用するためにパッケージを読み込む関数です。また、すでにインストールされたパッケージは、R の基本パッケージである <strong>base</strong> の <code>library()</code> を使用して読み込むこともできます。R パッケージに関する詳細は、<a href="basics.jp.html">R の基礎</a> の章をご覧ください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  rio,        <span class="co"># データを読み込むためのパッケージ  </span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  here,       <span class="co"># 相対ファイルパスを設定するためのパッケージ  </span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  janitor,    <span class="co"># データ前処理と表の作成のためのパッケージ  </span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  lubridate,  <span class="co"># 日付操作のためのパッケージ  </span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  matchmaker, <span class="co"># データ辞書に基づいたデータ前処理のためのパッケージ</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  epikit,     <span class="co"># age_categories()を含むパッケージ  </span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  tidyverse   <span class="co"># データ管理と可視化のためのパッケージ  </span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</section><section id="データのインポート" class="level2" data-number="8.3"><h2 data-number="8.3" class="anchored" data-anchor-id="データのインポート">
<span class="header-section-number">8.3</span> データのインポート</h2>
<section id="データをインポートする" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="データをインポートする">データをインポートする</h3>
<p>ここでは、<strong>rio</strong> パッケージの <code>import()</code> を使って、未加工の症例リスト（Excel ファイル）をインポートします。<strong>rio</strong> パッケージは、様々な形式のファイル（.xlsx、.csv、.tsv、.rds など）に対応できます。<strong>rio</strong> パッケージの詳細や、通常とは異なる状況（行のスキップ、欠損値の設定、Googleシートのインポートなど）での対処法を知りたい方は、<a href="importing.jp.html">インポートとエクスポート</a> の章をご覧ください。</p>
<p>お手元の環境でこの章の内容を実行したい方は、<a href="https://github.com/appliedepi/epiRhandbook_eng/raw/master/data/case_linelists/linelist_raw.xlsx">こちら</a> から「未加工の」ラインリストをダウンロードしてください（.xlsx ファイルとしてダウンロードされます）。</p>
<p>データサイズが大きいためにインポートに時間がかかる場合は、インポートするためのコードを、インポート後のデータ前処理を行うパイプラインとは別の場所に書き、未加工データを元データとしてオブジェクトに保存しておくと便利です。コードを分けて書くことで、未加工のデータと前処理済みのデータの比較が容易になります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>linelist_raw <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"linelist_raw.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>データフレームの最初の 50 行を確認してみましょう。</p>
<p>注釈：<strong>base</strong> R に含まれている関数 <code>head(n)</code> を使うと、R コンソールに最初の <code>n</code> 行が表示されます。</p>
<div class="cell">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-bbcdee60cd4fcf4e7673" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-bbcdee60cd4fcf4e7673">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08T00:00:00Z",null,null,"2014-05-04T00:00:00Z","2014-05-18T00:00:00Z","2014-05-03T00:00:00Z","2014-05-22T00:00:00Z","2014-05-28T00:00:00Z",null,null,"2014-05-30T00:00:00Z","2014-05-28T00:00:00Z","2014-06-14T00:00:00Z","2014-06-07T00:00:00Z","2014-06-09T00:00:00Z",null,null,null,"2014-06-23T00:00:00Z","2014-06-18T00:00:00Z","2014-06-24T00:00:00Z",null,null,"2014-07-03T00:00:00Z",null,"2014-07-10T00:00:00Z","2014-06-14T00:00:00Z",null,"2014-06-18T00:00:00Z","2014-06-29T00:00:00Z","2014-07-02T00:00:00Z","2014-07-12T00:00:00Z","2014-07-12T00:00:00Z","2014-06-13T00:00:00Z","2014-07-15T00:00:00Z","2014-06-20T00:00:00Z",null,null,"2014-07-20T00:00:00Z",null,"2014-07-12T00:00:00Z","2014-07-19T00:00:00Z","2014-07-18T00:00:00Z","2014-07-18T00:00:00Z","2014-07-27T00:00:00Z",null,"2014-07-19T00:00:00Z","2014-07-26T00:00:00Z","2014-07-24T00:00:00Z",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15T00:00:00Z","2014-05-14T00:00:00Z","2014-05-18T00:00:00Z","2014-05-20T00:00:00Z","2014-05-22T00:00:00Z","2014-05-23T00:00:00Z","2014-05-29T00:00:00Z","2014-06-03T00:00:00Z","2014-06-06T00:00:00Z","2014-06-07T00:00:00Z","2014-06-08T00:00:00Z","2014-06-15T00:00:00Z","2014-06-17T00:00:00Z","2014-06-17T00:00:00Z","2014-06-20T00:00:00Z","2014-06-19T00:00:00Z","2014-06-23T00:00:00Z","2014-06-24T00:00:00Z","2014-06-27T00:00:00Z","2014-06-28T00:00:00Z","2014-06-29T00:00:00Z","2014-07-03T00:00:00Z","2014-07-09T00:00:00Z","2014-07-09T00:00:00Z","2014-07-11T00:00:00Z","2014-07-11T00:00:00Z","2014-07-13T00:00:00Z","2014-07-14T00:00:00Z","2014-07-14T00:00:00Z","2014-07-13T00:00:00Z","2014-07-14T00:00:00Z","2014-07-17T00:00:00Z","2014-07-17T00:00:00Z","2014-07-18T00:00:00Z","2014-07-19T00:00:00Z","2014-07-20T00:00:00Z","2014-07-20T00:00:00Z","2014-07-22T00:00:00Z","2014-07-24T00:00:00Z","2014-07-26T00:00:00Z","2014-07-24T00:00:00Z","2014-07-27T00:00:00Z","2014-07-25T00:00:00Z","2014-07-27T00:00:00Z","2014-07-31T00:00:00Z","2014-08-01T00:00:00Z","2014-08-03T00:00:00Z","2014-08-02T00:00:00Z","2014-08-02T00:00:00Z","2014-08-04T00:00:00Z"],[null,"2014-05-18T00:00:00Z","2014-05-30T00:00:00Z",null,"2014-05-29T00:00:00Z","2014-05-24T00:00:00Z","2014-06-01T00:00:00Z","2014-06-07T00:00:00Z","2014-06-18T00:00:00Z","2014-06-09T00:00:00Z","2014-06-15T00:00:00Z",null,"2014-07-09T00:00:00Z",null,"2014-06-30T00:00:00Z","2014-07-11T00:00:00Z","2014-07-01T00:00:00Z","2014-06-25T00:00:00Z","2014-07-06T00:00:00Z","2014-07-02T00:00:00Z","2014-07-09T00:00:00Z","2014-07-07T00:00:00Z","2014-07-20T00:00:00Z",null,"2014-07-22T00:00:00Z","2014-07-16T00:00:00Z","2014-07-14T00:00:00Z","2014-07-20T00:00:00Z","2014-07-16T00:00:00Z","2014-07-19T00:00:00Z","2014-07-27T00:00:00Z","2014-07-19T00:00:00Z",null,"2014-07-26T00:00:00Z","2014-08-14T00:00:00Z","2014-08-01T00:00:00Z","2014-07-23T00:00:00Z","2014-08-28T00:00:00Z","2014-07-28T00:00:00Z","2014-07-19T00:00:00Z",null,"2014-08-03T00:00:00Z",null,null,null,"2014-08-06T00:00:00Z","2014-08-21T00:00:00Z","2014-09-13T00:00:00Z","2014-08-04T00:00:00Z",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["m","f","m","f","m","f","f","f","m","f","m","m","m","f","f","m","f","f","f","f","m","m","f","m","f","m","m","f","m","f","f","f","m","m","f","m","f","f","f","m","f","m","f","m","m","f","m","f","m","m"],["Other",null,"St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital",null,null,null,null,"Port Hospital","Military Hospital",null,null,"Other","Port Hospital","Port Hospital","Port Hospital",null,"Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)",null,"Other",null,"St. Marks Maternity Hopital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital",null,"Military Hospital","Other",null,null,"Port Hospital","Port Hospital","Port Hospital",null,"Central Hospital","Military Hospital","Other","Other","Other",null,"St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)",null],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.461830626007281,8.462729314626459,8.461443675342711,8.46191259217774,8.472923276435059,8.48401630165138,8.458371253408441,8.477617055125091,8.47570184950483,8.477799468789719,8.47145134147474,8.478048406853629,8.48528034195779,8.469575303958671,8.45957352078114,8.474048895115439,8.488029171298839,8.473437335922,8.484082637344621,8.46242233645879,8.470268221265719,8.463984474805329,8.464134789434199,8.456230946296071,8.48334624336805,8.47493999153642,8.47832062438022,8.469393389176499,8.48480589906514,8.47121232619015,8.48438437371817,8.484661585743391,8.477141599844281,8.462381270106089,8.455685978131131,8.4632880274758,8.47940722413856,8.46353857052336,8.461789681588639,8.47508713872833,8.458258081280711,8.4532568143863,8.4732571907655,8.479115866419329,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],["2","3","56","18","3","16","16","0","61","27","12","42","19","7","7","13","35","17","11","11","19","54","14","28","6","3","31","6","67","14","10","21","20","45","1","12","3","15","20","36","7","13","14","3","10","1","0","20","26","14"],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","no","no","no","no","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","yes","no",null,"no","no","no","yes","no",null,"no","no","yes",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","yes","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes",null,"yes","yes","yes","yes","yes",null,"yes","yes","yes",null,null,"yes","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","yes","yes","yes","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","yes","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"yes","yes",null,"no","no",null,"no","no","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","no","yes","no","no","no","yes","no","no","no",null,"no","yes","no","no","no",null,"no","no","no",null,null,"no","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","no","yes","yes","yes",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],["a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a","a"],["b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b","b"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>infection date<\/th>\n      <th>date onset<\/th>\n      <th>hosp date<\/th>\n      <th>date_of_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>row_num<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>merged_header<\/th>\n      <th>...28<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,9,10,15,16,17,18,24]},{"name":"case_id","targets":0},{"name":"generation","targets":1},{"name":"infection date","targets":2},{"name":"date onset","targets":3},{"name":"hosp date","targets":4},{"name":"date_of_outcome","targets":5},{"name":"outcome","targets":6},{"name":"gender","targets":7},{"name":"hospital","targets":8},{"name":"lon","targets":9},{"name":"lat","targets":10},{"name":"infector","targets":11},{"name":"source","targets":12},{"name":"age","targets":13},{"name":"age_unit","targets":14},{"name":"row_num","targets":15},{"name":"wt_kg","targets":16},{"name":"ht_cm","targets":17},{"name":"ct_blood","targets":18},{"name":"fever","targets":19},{"name":"chills","targets":20},{"name":"cough","targets":21},{"name":"aches","targets":22},{"name":"vomit","targets":23},{"name":"temp","targets":24},{"name":"time_admission","targets":25},{"name":"merged_header","targets":26},{"name":"...28","targets":27}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section><section id="インポートしたデータを確認する" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="インポートしたデータを確認する">インポートしたデータを確認する</h3>
<p><strong>skimr</strong> パッケージの <code>skim()</code> を使うと、データフレーム全体の概要を把握することができます（詳しくは、<a href="tables_descriptive.jp.html">記述統計表の作り方</a> を参照ください）。列は、文字値や数値などのデータ型別にまとめられています。</p>
<p>注釈：“POSIXct” は未加工の日付データ型の一つです（詳細は、<a href="dates.jp.html">日付型データ</a> の章をご覧ください）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>skimr<span class="sc">::</span><span class="fu">skim</span>(linelist_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">linelist_raw</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">6611</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">28</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">character</td>
<td style="text-align: left;">17</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">POSIXct</td>
<td style="text-align: left;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 20%">
<col style="width: 13%">
<col style="width: 19%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 15%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">empty</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: right;">whitespace</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">case_id</td>
<td style="text-align: right;">137</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5888</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">date onset</td>
<td style="text-align: right;">293</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">580</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">outcome</td>
<td style="text-align: right;">1500</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">gender</td>
<td style="text-align: right;">324</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hospital</td>
<td style="text-align: right;">1512</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">infector</td>
<td style="text-align: right;">2323</td>
<td style="text-align: right;">0.65</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2697</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">source</td>
<td style="text-align: right;">2323</td>
<td style="text-align: right;">0.65</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">age</td>
<td style="text-align: right;">107</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">age_unit</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">fever</td>
<td style="text-align: right;">258</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">chills</td>
<td style="text-align: right;">258</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">cough</td>
<td style="text-align: right;">258</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">aches</td>
<td style="text-align: right;">258</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">vomit</td>
<td style="text-align: right;">258</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">time_admission</td>
<td style="text-align: right;">844</td>
<td style="text-align: right;">0.87</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1091</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">merged_header</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">…28</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 15%">
<col style="width: 10%">
<col style="width: 15%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">generation</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">16.60</td>
<td style="text-align: right;">5.71</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">13.00</td>
<td style="text-align: right;">16.00</td>
<td style="text-align: right;">20.00</td>
<td style="text-align: right;">37.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">lon</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">-13.23</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">-13.27</td>
<td style="text-align: right;">-13.25</td>
<td style="text-align: right;">-13.23</td>
<td style="text-align: right;">-13.22</td>
<td style="text-align: right;">-13.21</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lat</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">8.47</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">8.45</td>
<td style="text-align: right;">8.46</td>
<td style="text-align: right;">8.47</td>
<td style="text-align: right;">8.48</td>
<td style="text-align: right;">8.49</td>
</tr>
<tr class="even">
<td style="text-align: left;">row_num</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3240.91</td>
<td style="text-align: right;">1857.83</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1647.50</td>
<td style="text-align: right;">3241.00</td>
<td style="text-align: right;">4836.50</td>
<td style="text-align: right;">6481.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wt_kg</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">52.69</td>
<td style="text-align: right;">18.59</td>
<td style="text-align: right;">-11.00</td>
<td style="text-align: right;">41.00</td>
<td style="text-align: right;">54.00</td>
<td style="text-align: right;">66.00</td>
<td style="text-align: right;">111.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">ht_cm</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">125.25</td>
<td style="text-align: right;">49.57</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: right;">91.00</td>
<td style="text-align: right;">130.00</td>
<td style="text-align: right;">159.00</td>
<td style="text-align: right;">295.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ct_blood</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">21.26</td>
<td style="text-align: right;">1.67</td>
<td style="text-align: right;">16.00</td>
<td style="text-align: right;">20.00</td>
<td style="text-align: right;">22.00</td>
<td style="text-align: right;">22.00</td>
<td style="text-align: right;">26.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">temp</td>
<td style="text-align: right;">158</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">38.60</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">35.20</td>
<td style="text-align: right;">38.30</td>
<td style="text-align: right;">38.80</td>
<td style="text-align: right;">39.20</td>
<td style="text-align: right;">40.80</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: POSIXct</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 12%">
<col style="width: 17%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 10%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">min</th>
<th style="text-align: left;">max</th>
<th style="text-align: left;">median</th>
<th style="text-align: right;">n_unique</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">infection date</td>
<td style="text-align: right;">2322</td>
<td style="text-align: right;">0.65</td>
<td style="text-align: left;">2012-04-09</td>
<td style="text-align: left;">2015-04-27</td>
<td style="text-align: left;">2014-10-04</td>
<td style="text-align: right;">538</td>
</tr>
<tr class="even">
<td style="text-align: left;">hosp date</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">2012-04-20</td>
<td style="text-align: left;">2015-04-30</td>
<td style="text-align: left;">2014-10-15</td>
<td style="text-align: right;">570</td>
</tr>
<tr class="odd">
<td style="text-align: left;">date_of_outcome</td>
<td style="text-align: right;">1068</td>
<td style="text-align: right;">0.84</td>
<td style="text-align: left;">2012-05-14</td>
<td style="text-align: left;">2015-06-04</td>
<td style="text-align: left;">2014-10-26</td>
<td style="text-align: right;">575</td>
</tr>
</tbody>
</table>
</div>
</div>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</section></section><section id="列名" class="level2" data-number="8.4"><h2 data-number="8.4" class="anchored" data-anchor-id="列名">
<span class="header-section-number">8.4</span> 列名</h2>
<p>Rでは、データセットの「ヘッダー」または各列の「一番上」の値が列名になります。列名は、コード内で列を参照するために使用されるほか、図を作成する際はデフォルトのラベルとして使用されます。</p>
<p>SAS や STATA など他の統計ソフトでは、短い列名を具体的に説明する「ラベル」が列名と共に使用されることが多いですが、R ではほとんど使用されません（R でもデータに列ラベルを追加することは可能です）。列名を図の表示に合わせて変更したい場合は、通常、図をプロットするコードの中で調整します（例えば、図の軸や凡例のタイトル、表示される表のヘッダーなどを調整したい場合です。詳細は、<a href="ggplot_tips.jp.html#ggplot_tips_scales">ggplot のヒントの章の 31.2 スケール</a>と<a href="tables_presentation.jp.html">見やすい表の作り方</a> の章を参照してください）。データに列ラベルを付けたい場合は、<a href="https://cran.r-project.org/web/packages/expss/vignettes/labels-support.html">こちら</a> と <a href="https://cran.r-project.org/web/packages/labelled/vignettes/intro_labelled.html">こちら</a> のページをご覧ください。</p>
<p>R の列名はデータ分析やデータ管理において非常に頻繁に使用されるため、「きれいに」整えられている必要があります。列名を設定する際の一般的なルールとして、以下のように提案します。</p>
<ul>
<li><p>短い名前にする</p></li>
<li><p>スペースを使わない（スペースが必要な場合は、アンダースコア _ に置き換えてください）</p></li>
<li><p>&amp;、#、&lt; &gt; などの特殊な文字を使用しない</p></li>
<li><p>各列似たようなスタイルの用語を使用する（例：異なる種類の日付データを含む列が複数ある場合に、date_onset、date_report、date_death とするなど）</p></li>
</ul>
<p>以下に、<strong>base</strong> R の <code>names()</code> を使用して <code>linelist_raw</code> の列名を表示しました。表示された列名には、次のような特徴がみられます。</p>
<ul>
<li><p>スペースを含む名前がある（例：<code>infection date</code>）</p></li>
<li><p>日付データを含む列が複数あるが、各列異なるルールで名付けられている (例：<code>date onset</code> と <code>infection date</code>）</p></li>
<li><p>最後の 2 列の名前（“merged_header” と “…28”）を見ると、ダウンロードされた元の .xlsx ファイルの最後の 2 列には、マージされたヘッダーがあったことがわかります。2 つの列がマージされてできた列が R によって分割され、マージされてできた列の名前（“merged_header”）は元々の最初の列に割り当てられ、元々の 2 番目の列にはセルを保持するために一時的に “…28” が割り当てられています（マージされる前は空欄の列であり、28番目の列であるため）。</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "case_id"         "generation"      "infection date"  "date onset"     
 [5] "hosp date"       "date_of_outcome" "outcome"         "gender"         
 [9] "hospital"        "lon"             "lat"             "infector"       
[13] "source"          "age"             "age_unit"        "row_num"        
[17] "wt_kg"           "ht_cm"           "ct_blood"        "fever"          
[21] "chills"          "cough"           "aches"           "vomit"          
[25] "temp"            "time_admission"  "merged_header"   "...28"          </code></pre>
</div>
</div>
<p><span style="color: black;"><strong>注釈</strong>：スペースを含む列名を参照するには、その名前をバックティック（`）で囲みます。例えば、linelist$<code>` '\x60infection date\x60'`</code> というように使用します。キーボードでは、バックティック（`）とシングルクォーテーションマーク（’）が異なることに注意してください。</span></p>
<section id="自動クリーニング" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="自動クリーニング">自動クリーニング</h3>
<p><strong>janitor</strong> パッケージの <code>clean_names()</code> は、以下のように列名を標準化し、ユニークにします。</p>
<ul>
<li><p>すべての列名をアンダースコア（_）、数字、文字のみで構成されるように変換します。<br></p></li>
<li><p>アクセント記号付きの文字は ASCII に音訳されます（例：ドイツ語のウムラウト記号付きの o は単に “o” に変換され、スペイン語の “enye”は “n”に変換されます）。<br></p></li>
<li><p>変換後の列名の大文字と小文字の区別は、<code>case =</code> 引数を使って指定できます（デフォルトは “snake” になっていますが、他に “sentence”、“title”、“small_camel” などがあります）。<br></p></li>
<li><p><code>replace =</code> 引数にベクトルを与えることで、特定の名前の置き換えを指定することができます（例：<code>replace = c(onset = "date_of_onset")</code>)</p></li>
<li><p><code>clean_names()</code> に関する公式ドキュメントは、<a href="https://cran.r-project.org/web/packages/janitor/vignettes/janitor.html#cleaning">こちら</a>をご覧ください。</p></li>
</ul>
<p>では、前処理のパイプラインを作成していきます。まず初めに、以下では、未加工のラインリストに対して <code>clean_names()</code> を使用し、列名を整えていきます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 未加工のデータセットをclean_names()にパイプし、出力結果をlinelistとして保存する</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist_raw <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 新しく作成された linelist の列名を確認する</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "case_id"         "generation"      "infection_date"  "date_onset"     
 [5] "hosp_date"       "date_of_outcome" "outcome"         "gender"         
 [9] "hospital"        "lon"             "lat"             "infector"       
[13] "source"          "age"             "age_unit"        "row_num"        
[17] "wt_kg"           "ht_cm"           "ct_blood"        "fever"          
[21] "chills"          "cough"           "aches"           "vomit"          
[25] "temp"            "time_admission"  "merged_header"   "x28"            </code></pre>
</div>
</div>
<p><u><strong>注釈</strong></u><strong>：最終列の列名</strong> “…28” が “x28” に変化したことに注目してください。</p>
</section><section id="手動による列名のクリーニング" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="手動による列名のクリーニング">手動による列名のクリーニング</h3>
<p>上で行った自動クリーニングによる列名の標準化の後に、列名を個別に、一つずつ変更することが必要な場合があります。 <code>rename()</code> は <code>NEW = OLD</code> というスタイルを採用しており、新しい列名を既存の列名の前に書く必要があります。</p>
<p>以下では、上で作成した自動クリーニングのパイプラインに名前を個別に変更するコマンドを追加しています。コードを読みやすくするため、戦略的にスペースを追加しています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプチェーン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################################</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist_raw <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列名の標準化</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列名を個別に変更</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>           <span class="co"># 新しい列名            # 既存の列名</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">date_infection       =</span> infection_date,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_hospitalisation =</span> hosp_date,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_outcome         =</span> date_of_outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これで、列名が変更されていることがわかります。</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> [1] "case_id"              "generation"           "date_infection"      
 [4] "date_onset"           "date_hospitalisation" "date_outcome"        
 [7] "outcome"              "gender"               "hospital"            
[10] "lon"                  "lat"                  "infector"            
[13] "source"               "age"                  "age_unit"            
[16] "row_num"              "wt_kg"                "ht_cm"               
[19] "ct_blood"             "fever"                "chills"              
[22] "cough"                "aches"                "vomit"               
[25] "temp"                 "time_admission"       "merged_header"       
[28] "x28"                 </code></pre>
</div>
</div>
</section><section id="列の位置による名前の変更" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="列の位置による名前の変更">列の位置による名前の変更</h3>
<p>列名ではなく、列の位置によって列の名前を変更することもできます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rename</span>(<span class="at">newNameForFirstColumn  =</span> <span class="dv">1</span>,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">newNameForSecondColumn =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="select-および-summarise-による列名の変更" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="select-および-summarise-による列名の変更">
<code>select()</code> および <code>summarise()</code> による列名の変更</h4>
<p>ショートカットとして、<strong>dplyr</strong> パッケージの <code>select()</code> や <code>summarise()</code> でも列の名前を変更することができます。<code>select()</code> は特定の列だけを残すために使用します（本章で後述します）。<code>summarise()</code> については、<a href="grouping.jp.html">データのグループ化</a> の章や、<a href="tables_descriptive.jp.html">記述統計表の作り方</a> の章で説明します。これらの関数も <code>rename()</code> と同様に、<code>new_name = old_name</code> というフォーマットを使用します。以下はその例です。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>linelist_raw <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="co">#新しい列名             # 既存の列名</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">date_infection       =</span> <span class="st">`</span><span class="at">infection date</span><span class="st">`</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">date_hospitalisation =</span> <span class="st">`</span><span class="at">hosp date</span><span class="st">`</span>) <span class="co">#列名を変更し、変更した列だけを残す</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="その他の課題" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="その他の課題">その他の課題</h3>
<section id="空白の-excel-列名" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="空白の-excel-列名">空白の Excel 列名</h4>
<p>R は、列名（ヘッダー）のないデータセット列を処理することはできません。したがって、データはあるがヘッダーがない Excel データセットをインポートした場合、R は “…1” や “…2” といった名前でヘッダーを埋めます。数字は列番号を表します（例：データセットの 4 列目にヘッダーがない場合、R はその列を “…4” と命名します）。</p>
<p>R によって付与された名前は、ポジション番号（上記の例を参照）または割り当てられた名前（<code>linelist_raw$...1</code>）を参照することで、手動でクリーニングすることができます。</p>
</section><section id="excel-の列名とセルの結合" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="excel-の列名とセルの結合">Excel の列名とセルの結合</h4>
<p>Excel ファイル内のマージされたセルは、データを受け取る際によく問題になります。<a href="transition_to_R.jp.html">Excel・Stata・SASとの比較</a> の章で説明したように、マージされたセルは、人間がデータを読むときには便利ですが、 コンピュータにとっては「整頓されたデータ」ではないため、 データを読み込む際に多くの問題が発生します。R はマージされたセルに対応できないからです。</p>
<p><strong>人間が読めるデータとコンピュータが読めるデータは別物である</strong>ことを、データ入力をする担当者に伝えてください。また、<a href="https://r4ds.had.co.nz/tidy-data.html">整頓されたデータの原則</a> をユーザーに教えるよう努めてください。可能であれば、セルが結合されていない整頓されたフォーマットでデータが手元に届くように、データ入力や収集の手順を変更しましょう。</p>
<ul>
<li>各変数はそれぞれ個別の列でなければなりません。<br>
</li>
<li>各観測値は、それぞれ個別の行である必要があります。<br>
</li>
<li>それぞれの値は、それぞれ別のセルに入力されていなければなりません。</li>
</ul>
<p><strong>rio</strong> パッケージの <code>import()</code> を使用した場合、マージされたセルの値は最初のセルに割り当てられ、それ以降のセルは空になります。</p>
<p>結合されたセルを処理するための一つの解決策は、<strong>openxlsx</strong> パッケージの <code>readWorkbook()</code> を使用してデータをインポートすることです。引数 <code>fillMergedCells = TRUE</code> を設定すると、マージされたセルの値を、マージ範囲内のすべてのセルに入れることができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>linelist_raw <span class="ot">&lt;-</span> openxlsx<span class="sc">::</span><span class="fu">readWorkbook</span>(<span class="st">"linelist_raw.xlsx"</span>, <span class="at">fillMergedCells =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span style="color: red;">警告：<code>readWorkbook()</code> で列名をマージすると、列名が重複してしまうので、手動で修正する必要があります。R は列名が重複するとうまく動作しません！重複した列名がある場合は、手動による列名のクリーニングのセクションで説明したように、列の位置（例えば 5 列目）を参照し、列名を再設定することができます。</span></p>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</section></section></section><section id="列の選択と並び替え" class="level2" data-number="8.5"><h2 data-number="8.5" class="anchored" data-anchor-id="列の選択と並び替え">
<span class="header-section-number">8.5</span> 列の選択と並び替え</h2>
<p><strong>dplyr</strong> パッケージの <code>select()</code> を使って、残したい列を選択し、データフレーム内における列の順番を指定します。</p>
<p><u><strong>注意</strong></u><strong>：</strong>以下の例では、<code>linelist</code> データフレームを <code>select()</code> で変更して表示していますが、これは例としてデータを示すためであり、変更されたデータは保存はされていないことに注意してください。変更された列名は、データフレームを <code>names()</code> にパイプすることで表示されます。</p>
<p>まず、現時点での <code>linelist</code> データフレームのすべての列名を以下に表示します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "case_id"              "generation"           "date_infection"      
 [4] "date_onset"           "date_hospitalisation" "date_outcome"        
 [7] "outcome"              "gender"               "hospital"            
[10] "lon"                  "lat"                  "infector"            
[13] "source"               "age"                  "age_unit"            
[16] "row_num"              "wt_kg"                "ht_cm"               
[19] "ct_blood"             "fever"                "chills"              
[22] "cough"                "aches"                "vomit"               
[25] "temp"                 "time_admission"       "merged_header"       
[28] "x28"                 </code></pre>
</div>
</div>
<section id="列の保持" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="列の保持">列の保持</h3>
<p><strong>残しておきたい列のみを選択する</strong></p>
<p><code>select()</code> の中で、列の名前を引用符（” “）を使わずに指定します。指定された列は、指定された順序でデータフレームに表示されます。存在しない列を指定した場合、R がエラーを返すことに注意してください（このような場合にエラーを出さないようにするには、後述の <code>any_of()</code> の使い方を参照してください）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ラインリストのデータセットはselect()に渡され、name()で列名を表示する</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(case_id, date_onset, date_hospitalisation, fever) <span class="sc">%&gt;%</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>()  <span class="co"># 列名を表示する</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "case_id"              "date_onset"           "date_hospitalisation"
[4] "fever"               </code></pre>
</div>
</div>
</section><section id="clean_tidyselect" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="clean_tidyselect">“tidyselect” ヘルパー関数</h3>
<p><strong>tidyverse</strong> パッケージに含まれる <strong>tidyselect</strong> パッケージのヘルパー関数は、列の保持や除外、または変換する列を簡単に指定するための関数であり、<strong>dplyr</strong> 系関数で列を選択する方法の基礎となっています。</p>
<p>例えば、列の順番を変更したい場合、<code>everything()</code> は「記載されていない他のすべての列」を意味する便利な関数です。以下のコードは、<code>date_onset</code> と <code>date_hospitalisation</code> の列をデータセットの最初（左）に移動させますが、それ以外の列はすべてそのままにします。<code>everything()</code> の括弧内は空であることに注意してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># date_onset と date_hospitalisation を先頭に移動させる</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date_onset, date_hospitalisation, <span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "date_onset"           "date_hospitalisation" "case_id"             
 [4] "generation"           "date_infection"       "date_outcome"        
 [7] "outcome"              "gender"               "hospital"            
[10] "lon"                  "lat"                  "infector"            
[13] "source"               "age"                  "age_unit"            
[16] "row_num"              "wt_kg"                "ht_cm"               
[19] "ct_blood"             "fever"                "chills"              
[22] "cough"                "aches"                "vomit"               
[25] "temp"                 "time_admission"       "merged_header"       
[28] "x28"                 </code></pre>
</div>
</div>
<p>以下に、<code>select()</code>、<code>across()</code>、<code>summary()</code> などの <strong>dplyr</strong> 系関数内で使える他の “tidyselect” ヘルパー関数を紹介します。</p>
<ul>
<li><p><code>everything()</code>：指定されていない他のすべての列を指定します。<br></p></li>
<li><p><code>last_col()</code>：最後の列を指定します。<br></p></li>
<li><p><code>where()</code>：すべての列に関数を適用し、TRUEとなるものを選択します。<br></p></li>
<li>
<p><code>contains()</code>：ある文字列を含む列を指定します。<br></p>
<ul>
<li>例）<code>select(contains("time"))</code><br>
</li>
</ul>
</li>
<li>
<p>starts_with()：指定された接頭語を指定します。</p>
<ul>
<li>例）<code>select(starts_with("date_"))</code><br>
</li>
</ul>
</li>
<li>
<p><code>ends_with()</code>：指定された接尾語を指定します。<br></p>
<ul>
<li>例）<code>select(ends_with("_post"))</code><br>
</li>
</ul>
</li>
<li>
<p><code>matches()</code>：正規表現（regex）を適用し、列を指定します。<br></p>
<ul>
<li>例）<code>select(matches("[pt]al"))</code><br>
</li>
</ul>
</li>
<li><p><code>num_range()</code>：x01、x02、x03 のような数値の範囲を指定します。<br></p></li>
<li>
<p><code>any_of()</code>：関数内で使用した場合、指定する列が存在する場合は、その関数が適用され、存在しない場合は適用されず、エラーを表示しません。<br></p>
<ul>
<li>例）<code>select(any_of(date_onset, date_death, cardiac_arrest))</code><br>
</li>
</ul>
</li>
</ul>
<p>さらに、複数の列を列挙する場合には <code>c()</code>、連続した列には <code>:</code>、反対の列には <code>!</code>、<code>AND</code> には <code>&amp;</code>、<code>OR</code> には <code>|</code> などの通常の演算子が使用できます。</p>
<p>列の論理的な条件を指定したい場合は、<code>where()</code> を使用します。<code>where()</code> の中に関数を入れる場合は、関数の後に空の括弧をつけないでください。以下のコードは、 数字型データの列をすべて選択します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 数字型データの列を選択する</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(is.numeric)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "generation" "lon"        "lat"        "row_num"    "wt_kg"     
[6] "ht_cm"      "ct_blood"   "temp"      </code></pre>
</div>
</div>
<p>ある特定の文字列が含まれている列のみを選択したい場合は、<code>contains()</code> を使用します。 また、<code>ends_with()</code> や <code>starts_with()</code> を使用すると、より詳細に列を指定することができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 特定の文字を含む列を選択する</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">"date"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "date_infection"       "date_onset"           "date_hospitalisation"
[4] "date_outcome"        </code></pre>
</div>
</div>
<p>さらに、<code>contains()</code> と同様の動作をする <code>matches()</code> は、 OR バー（|）で区切られた複数の文字列などの正規表現を括弧内で指定することができます（正規表現の詳細については、<a href="characters_strings.jp.html">文字型・文字列型データ</a> の章を参照ください）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 複数の文字列に当てはまる列を検索する</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"onset|hosp|fev"</span>)) <span class="sc">%&gt;%</span>   <span class="co"># "|" は OR を意味する</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "date_onset"           "date_hospitalisation" "hospital"            
[4] "fever"               </code></pre>
</div>
</div>
<p><span style="color: orange;">注意：指定した列名がデータセットに存在しない場合、エラーが返されてコードの処理が停止することがあります。存在するかどうかわからない列を指定したい場合は、<code>any_of()</code> を使用することをおすすめします。<code>any_of()</code> は、列の除外など、否定的な列の選択をする場合においてと特に有用です。</span></p>
<p>以下のコードでは、指定されている列のうち 1 つだけがデータセットに存在しますが、エラーは発生せず、コードは処理を停止することなく実行されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">any_of</span>(<span class="fu">c</span>(<span class="st">"date_onset"</span>, <span class="st">"village_origin"</span>, <span class="st">"village_detection"</span>, <span class="st">"village_residence"</span>, <span class="st">"village_travel"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "date_onset"</code></pre>
</div>
</div>
</section><section id="列の除外" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="列の除外">列の除外</h3>
<p>データセットから除外したい列がある場合は、列名の前にマイナス記号（-）を付ける（例：<code>select(-outcome)</code>）、または以下のように列名のベクトルの前にマイナス記号（-）を付けて指定すると、除外できます。指定された以外の列はすべて残ります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(date_onset, fever<span class="sc">:</span>vomit)) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>     <span class="co"># date_onsetと、feverからvomitまでのすべての列を削除する</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "case_id"              "generation"           "date_infection"      
 [4] "date_hospitalisation" "date_outcome"         "outcome"             
 [7] "gender"               "hospital"             "lon"                 
[10] "lat"                  "infector"             "source"              
[13] "age"                  "age_unit"             "row_num"             
[16] "wt_kg"                "ht_cm"                "ct_blood"            
[19] "temp"                 "time_admission"       "merged_header"       
[22] "x28"                 </code></pre>
</div>
</div>
<p>R の基本的な構文を使用し、除外したい列を NULL と定義して削除することもできます。例えば、以下のようになります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>linelist<span class="sc">$</span>date_onset <span class="ot">&lt;-</span> <span class="cn">NULL</span>   <span class="co"># Rの基本的な構文で列を削除する</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="独立型" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="独立型">独立型</h3>
<p><code>select()</code> は、パイプ内で使用するだけでなく、独立したコマンドとして使用することもできます。この場合、最初の引数には前処理したい元のデータフレームを指定します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># IDと年齢に関連した列を持つ新しいラインリストを作成する</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>linelist_age <span class="ot">&lt;-</span> <span class="fu">select</span>(linelist, case_id, <span class="fu">contains</span>(<span class="st">"age"</span>))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 列名を表示する</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist_age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "case_id"  "age"      "age_unit"</code></pre>
</div>
</div>
<section id="パイプラインに追加" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="パイプラインに追加">パイプラインに追加</h4>
<p><code>linelist_raw</code> データセットには、<code>row_num</code>、<code>merged_header</code>、<code>x28</code> という必要のない列があります。以下に、前処理パイプラインの <code>select()</code> コマンドで削除する例を示します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプライン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################################</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプラインを開始する</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="do">###########################</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist_raw <span class="sc">%&gt;%</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 列名の標準化</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 列名を個別に変更</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>           <span class="co">#新しい列名            #既存の列名</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">date_infection       =</span> infection_date,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_hospitalisation =</span> hosp_date,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_outcome         =</span> date_of_outcome) <span class="sc">%&gt;%</span> </span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="do">#####################################################</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>   <span class="co"># 列の除外</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(row_num, merged_header, x28))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</section></section></section><section id="重複行の削除" class="level2" data-number="8.6"><h2 data-number="8.6" class="anchored" data-anchor-id="重複行の削除">
<span class="header-section-number">8.6</span> 重複行の削除</h2>
<p>重複したデータを削除する方法の詳細については、このハンドブックの <a href="deduplication.jp.html">重複データの排除</a> の章を参照してください。本章では、重複した行の削除について、非常に簡単な例のみを紹介します。</p>
<p><strong>dplyr</strong> パッケージの <code>distinct()</code> は、データフレーム内のすべての行をチェックし、重複していない行のみを残します。つまり、完全に重複している行をデータフレームから削除します。</p>
<p>重複する行をチェックする際には、列の範囲を指定できますが、デフォルトではデータフレーム内のすべての列が対象となります。<a href="deduplication.jp.html">重複データの排除</a> の章にあるように、対象となる列の範囲を調整して特定の列に関してのみ、重複した行があるかをチェックすることもできます。</p>
<p>以下は、空のコマンド <code>distinct()</code> をパイプチェーンに追加するだけのシンプルな例です。これにより、他の行と完全に同一である行がない（重複している行がない）ことが保証されます（データフレーム内のすべての列がチェックされます）。</p>
<p>現時点の <code>linelist</code> データフレームには、全部で <code>nrow(linelist)</code> 行が含まれています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>上のコードを実行して重複削除すると、データフレームの行数は <code>nrow(linelist)</code> になります。他の行と完全に同一である行が削除されました。</p>
<p>以下では、パイプラインに <code>distinct()</code> コマンドを追加しています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプチェーン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################################</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプラインを開始する</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="do">###########################</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist_raw <span class="sc">%&gt;%</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 列名の標準化</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 列名を個別に変更</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>           <span class="co"># 新しい列名            # 既存の列名</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">date_infection       =</span> infection_date,</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_hospitalisation =</span> hosp_date,</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_outcome         =</span> date_of_outcome) <span class="sc">%&gt;%</span> </span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列の除去</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(row_num, merged_header, x28)) <span class="sc">%&gt;%</span> </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    <span class="do">#####################################################</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 重複の除去</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</section><section id="列の作成と変換" class="level2" data-number="8.7"><h2 data-number="8.7" class="anchored" data-anchor-id="列の作成と変換">
<span class="header-section-number">8.7</span> 列の作成と変換</h2>
<p>新しい列の追加や、既存の列の修正が必要な場合には、<strong>dplyr</strong> 系関数の <code>mutate()</code> を使用することをおすすめします。</p>
<p>以下に、<code>mutate()</code> を使用して新しい列を作成する例を紹介します。次のような構文を使用します：<code>mutate(new_column_name = value or transformation)</code></p>
<p>Stata の <code>generate</code> コマンドに似ていますが、R の <code>mutate()</code> は既存の列を修正する場合にも使用できます。</p>
<section id="新しい列の作成" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="新しい列の作成">新しい列の作成</h3>
<p>以下は、<code>mutate()</code> を使用して新しい列を作成する最も基本的なコマンドです。ここでは、すべての行の値が 10 である新しい列 <code>new_col</code> を作成します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">new_col =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>また、他の列の値を参照して、計算を行うこともできます。以下では、<code>bmi</code> という新しい列が作成され、各症例（各行）の Body Mass Index（BMI）を格納しています。これは、既存の列である <code>ht_cm</code> と <code>wt_kg</code> を使用して、BMI = kg/m^2 の式で計算されたものです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bmi =</span> wt_kg <span class="sc">/</span> (ht_cm<span class="sc">/</span><span class="dv">100</span>)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>新しい列を複数作成する場合は、それぞれをコンマで区切って改行します。以下は、<strong>stringr</strong> パッケージの <code>str_glue()</code> を使って他列の値を組み合わせた列を作成するなど、複数の新しい列を作成する場合の例です（<code>str_glue()</code> についての詳細は、<a href="characters_strings.jp.html">文字型・文字列型データ</a> の章を参照ください）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>new_col_demo <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span>                       </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_var_dup    =</span> case_id,             <span class="co"># 新しい列＝既存の列のコピーを作成する</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_var_static =</span> <span class="dv">7</span>,                   <span class="co"># 新しい列＝全ての値が同じ</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_var_static =</span> new_var_static <span class="sc">+</span> <span class="dv">5</span>,  <span class="co"># 列を上書きしたり、他の変数を使って計算したりすることができる</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_var_paste  =</span> stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"{hospital} on ({date_hospitalisation})"</span>) </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 新しい列 = 他の列の値を貼り付ける</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(case_id, hospital, date_hospitalisation, <span class="fu">contains</span>(<span class="st">"new"</span>))        </span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># デモ用に新しい列のみを表示</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>以下では、新しい列を確認するために、新しい列とそれを作成するために使用された列のみが表示されています。</p>
<div class="cell">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-31406f843c3b28da32ff" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-31406f843c3b28da32ff">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],["Other",null,"St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital",null,null,null,null,"Port Hospital","Military Hospital",null,null,"Other","Port Hospital","Port Hospital","Port Hospital",null,"Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)",null,"Other",null,"St. Marks Maternity Hopital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital",null,"Military Hospital","Other",null,null,"Port Hospital","Port Hospital","Port Hospital",null,"Central Hospital","Military Hospital","Other","Other","Other",null,"St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)",null],["2014-05-15T00:00:00Z","2014-05-14T00:00:00Z","2014-05-18T00:00:00Z","2014-05-20T00:00:00Z","2014-05-22T00:00:00Z","2014-05-23T00:00:00Z","2014-05-29T00:00:00Z","2014-06-03T00:00:00Z","2014-06-06T00:00:00Z","2014-06-07T00:00:00Z","2014-06-08T00:00:00Z","2014-06-15T00:00:00Z","2014-06-17T00:00:00Z","2014-06-17T00:00:00Z","2014-06-20T00:00:00Z","2014-06-19T00:00:00Z","2014-06-23T00:00:00Z","2014-06-24T00:00:00Z","2014-06-27T00:00:00Z","2014-06-28T00:00:00Z","2014-06-29T00:00:00Z","2014-07-03T00:00:00Z","2014-07-09T00:00:00Z","2014-07-09T00:00:00Z","2014-07-11T00:00:00Z","2014-07-11T00:00:00Z","2014-07-13T00:00:00Z","2014-07-14T00:00:00Z","2014-07-14T00:00:00Z","2014-07-13T00:00:00Z","2014-07-14T00:00:00Z","2014-07-17T00:00:00Z","2014-07-17T00:00:00Z","2014-07-18T00:00:00Z","2014-07-19T00:00:00Z","2014-07-20T00:00:00Z","2014-07-20T00:00:00Z","2014-07-22T00:00:00Z","2014-07-24T00:00:00Z","2014-07-26T00:00:00Z","2014-07-24T00:00:00Z","2014-07-27T00:00:00Z","2014-07-25T00:00:00Z","2014-07-27T00:00:00Z","2014-07-31T00:00:00Z","2014-08-01T00:00:00Z","2014-08-03T00:00:00Z","2014-08-02T00:00:00Z","2014-08-02T00:00:00Z","2014-08-04T00:00:00Z"],["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12],["Other on (2014-05-15)","NA on (2014-05-14)","St. Mark's Maternity Hospital (SMMH) on (2014-05-18)","Port Hospital on (2014-05-20)","Military Hospital on (2014-05-22)","Port Hospital on (2014-05-23)","NA on (2014-05-29)","NA on (2014-06-03)","NA on (2014-06-06)","NA on (2014-06-07)","Port Hospital on (2014-06-08)","Military Hospital on (2014-06-15)","NA on (2014-06-17)","NA on (2014-06-17)","Other on (2014-06-20)","Port Hospital on (2014-06-19)","Port Hospital on (2014-06-23)","Port Hospital on (2014-06-24)","NA on (2014-06-27)","Other on (2014-06-28)","Port Hospital on (2014-06-29)","Port Hospital on (2014-07-03)","St. Mark's Maternity Hospital (SMMH) on (2014-07-09)","NA on (2014-07-09)","Other on (2014-07-11)","NA on (2014-07-11)","St. Marks Maternity Hopital (SMMH) on (2014-07-13)","Military Hospital on (2014-07-14)","Port Hospital on (2014-07-14)","Central Hospital on (2014-07-13)","Military Hospital on (2014-07-14)","Central Hospital on (2014-07-17)","NA on (2014-07-17)","Military Hospital on (2014-07-18)","Other on (2014-07-19)","NA on (2014-07-20)","NA on (2014-07-20)","Port Hospital on (2014-07-22)","Port Hospital on (2014-07-24)","Port Hospital on (2014-07-26)","NA on (2014-07-24)","Central Hospital on (2014-07-27)","Military Hospital on (2014-07-25)","Other on (2014-07-27)","Other on (2014-07-31)","Other on (2014-08-01)","NA on (2014-08-03)","St. Mark's Maternity Hospital (SMMH) on (2014-08-02)","St. Mark's Maternity Hospital (SMMH) on (2014-08-02)","NA on (2014-08-04)"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>hospital<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>new_var_dup<\/th>\n      <th>new_var_static<\/th>\n      <th>new_var_paste<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":4},{"name":"case_id","targets":0},{"name":"hospital","targets":1},{"name":"date_hospitalisation","targets":2},{"name":"new_var_dup","targets":3},{"name":"new_var_static","targets":4},{"name":"new_var_paste","targets":5}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p><u><strong>ヒント</strong></u><strong>：</strong><code>mutate()</code> の変化形として、<code>transmute()</code> という関数があります。この関数は、<code>mutate()</code> と同じように新しい列を追加しますが、括弧の中に書かれていないすべての列を削除または除外します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># HIDDEN FROM READER（ウェブ版には表示されない）</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 上で新しく作成されたデモ用の列を除外する</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># linelist &lt;- linelist %&gt;% </span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(-contains("new_var"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="列のデータ型の変換" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="列のデータ型の変換">列のデータ型の変換</h3>
<p>日付、数字、理論値（TRUE/FALSE）を含む列は、正しく分類された場合のみ期待通りの動きをします。例えば、文字型の “2” と数字型の 2 は異なることに注意してください。</p>
<p>データをインポートするコードの中に列のデータ型を指定する方法もありますが、扱いにくい場合が多いです。オブジェクトや列のデータ型を変換する方法については、<a href="basics.jp.html">R の基礎</a> の章の 3.10 オブジェクトのデータ型のセクションを参照してください。</p>
<p>本章では、まず、重要な列について、正しいデータ型であるかどうかのチェックを行ってみましょう。これは本章の最初に <code>skim()</code> を実行したときに確認しました。</p>
<p>では、具体的に見ていきましょう。現在、<code>age</code> 列のデータ型は 文字列型（character）ですが、定量的な分析を行うためには、<code>age</code> 列の数字が数値として認識される必要があります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(linelist<span class="sc">$</span>age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
</div>
<p>以下で、<code>date_onset</code> 列のデータ型も確認してみると、文字列型であることがわかります。分析を行うためは、<code>date_onset</code> 列の日付が日付として認識される必要があります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(linelist<span class="sc">$</span>date_onset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
</div>
<p>このようなデータ型の相違を解決するために、<code>mutate()</code> の機能を使用し、変換で列を再定義していきます。列の定義は変更しませんが、データ型を変更します。以下では、基本的な例として、<code>age</code> 列を数字型（numeric）に変換します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age =</span> <span class="fu">as.numeric</span>(age))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>同様に、<code>as.character()</code> や <code>as.logical()</code> を使用することもできます。因子型（factor）に変換したい場合は、<strong>base</strong> R の <code>factor()</code> や <strong>forcats</strong> パッケージの <code>as_factor()</code> を使いましょう。詳しくは、<a href="factors.jp.html">因子（ファクタ）型データ</a> の章をご覧ください。</p>
<p>日付型（date）への変換には注意が必要です。<a href="dates.jp.html">日付型データ</a> の章でいくつか方法を紹介しますが、通常、日付型への変換を正しく行うためには、日付データがすべて同じ形式である必要があります（例：“MM/DD/YYYY”、または “DD MM YYYY”）。データを日付型に変換した後にチェックして、各値が正しく変換されたことを確認してください。</p>
</section><section id="グループ化されたデータ" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="グループ化されたデータ">グループ化されたデータ</h3>
<p>データフレームがすでにグループ化されている場合（グループ化の詳細は、<a href="grouping.jp.html">データのグループ化</a> の章を参照ください）は、<code>mutate()</code> の動作がグループ化されていない場合と異なるかもしれません。データフレームがすでにグループ化されている場合、<code>mean()</code>、<code>median()</code>、<code>max()</code> などの要約関数は、すべての行ではなくグループごとに計算されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 全行の平均値で正規化された年齢</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age_norm =</span> age <span class="sc">/</span> <span class="fu">mean</span>(age, <span class="at">na.rm=</span>T))</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 年齢を病院グループの平均値で正規化</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hospital) <span class="sc">%&gt;%</span> </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age_norm =</span> age <span class="sc">/</span> <span class="fu">mean</span>(age, <span class="at">na.rm=</span>T))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>グループ化されたデータフレームでの <code>mutate ()</code> の使用については、こちらの <a href="https://dplyr.tidyverse.org/reference/mutate.html">tidyverse mutate に関するドキュメント</a> で詳しく説明されています。必要な方はご覧ください。</p>
</section><section id="clean_across" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="clean_across">複数列の一斉変換</h3>
<p>コードを簡潔にするために、同じ変換を行うコマンドを複数の列に適用したい場合があります。<strong>dplyr</strong> パッケージ（ <strong>tidyverse</strong> パッケージにも含まれています）の <code>across()</code> を使用すると、データの変換を行うコマンドを一度に複数の列に適用することができます。 <code>across()</code> はすべての <strong>dplyr</strong> 系関数で使用することができますが、一般的には <code>select()</code>、<code>mutate()</code>、<code>filter()</code>、<code>summarise()</code> 内でよく使用されます。<code>across()</code> を <code>summarise()</code> 内でどのように使用するかについて知りたい方は、<a href="tables_descriptive.jp.html">記述統計表の作り方</a> の章をご覧ください。</p>
<p><code>across()</code> では、<code>.cols =</code> 引数には列を指定し、<code>.fns =</code> 引数には適用する関数を指定します。<code>.fns</code> に与える追加の引数は、コンマの後に含めることができます。</p>
<section id="across-を使用して列を選択する" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="across-を使用して列を選択する">
<code>across()</code> を使用して列を選択する</h4>
<p><code>.cols =</code> 引数に列を指定します。 個別に列名を指定することもできますし、“tidyselect” ヘルパー関数を使用することもできます。関数を <code>.fns =</code> 引数に指定します。以下に示すように、関数機能を使用すると、関数はその括弧（ ）なしで記述することに注意してください。</p>
<p>以下の例では、<code>as.character()</code> を使用した文字型への変換が、 <code>across()</code> で指定された特定の列に適用されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">c</span>(temp, ht_cm, wt_kg), <span class="at">.fns =</span> as.character))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>列を指定する際には、“tidyselect” ヘルパー関数を使用すると便利です。“tidyselect” ヘルパー関数には、<code>everything()</code>、<code>last_col()</code>、<code>where()</code>、<code>starts_with()</code>、<code>ends_with()</code>、<code>contains()</code>、<code>matches()</code>、<code>num_range()</code>、<code>any_of()</code> などがあり、本章上部の列の選択と並び替えのセクションで詳述されています。</p>
<p>まず、データフレーム内のすべての列を文字列型（character）に変換する例を以下に示します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># すべての列を文字列型に変換する</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">everything</span>(), <span class="at">.fns =</span> as.character))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>他の例として、例えば列名に “date”という文字列が含まれている列を文字列型に変換したい場合のコマンドを以下に紹介します（コンマと括弧の配置に注意してください）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># date という文字が列名に含まれている列を文字列型に変換する</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">contains</span>(<span class="st">"date"</span>), <span class="at">.fns =</span> as.character))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>また、別の例として、現在 POSIXct 型（未加工の日付時分秒を示すデータ型）の列を日付型（date）に変換する例を示します。まず、<code>is.POSIXct()</code> の評価値が <code>TRUE</code> である列を <code>where()</code> で検索し、次に、これらの列に <code>as.Date()</code> を適用して、通常の 日付型（date）に変換します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">where</span>(is.POSIXct), <span class="at">.fns =</span> as.Date))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><code>across()</code> 内で <code>where()</code> を使用し、<code>is.POSIXct()</code> で各列が TRUE または FALSE か評価できるようにしていることに注意してください。</p></li>
<li><p><code>is.POSIXct()</code>は <strong>lubridate</strong> パッケージの関数であることに注意してください。<code>is.character()</code>、<code>is.numeric()</code>、<code>is.logical()</code> などの他の類似した “is” 系関数は <strong>base</strong> R の関数です。</p></li>
</ul></section><section id="across" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="across"><code>across()</code></h4>
<p><code>across()</code> に関数を与える方法の詳細については、<code>?across</code> をコンソールで実行して表示されるドキュメントをお読みください。要約すると、対象の列に対して実行する関数を指定する方法はいくつかあり、独自の関数を指定することもできます。</p>
<ul>
<li><p>関数名のみを指定することができます（例：<code>mean</code> または <code>as.character</code>）。</p></li>
<li><p>関数を <strong>purrr</strong> スタイルで使用することができます（例：<code>~ mean(.x, na.rm = TRUE))</code> （詳細は、<a href="iteration.jp.html">ループと反復処理・リストの操作</a> の章を参照してください）。</p></li>
<li>
<p>リストを使用することで、複数の関数を指定することができます（例：<code>list(mean = mean, n_miss = ~ sum(is.na(.x)))</code>）。</p>
<ul>
<li>複数の関数を指定した場合は、入力された列ごとに複数の変換後の列が返され、<code>col_fn</code> という形式で一意の名前が付けられます。返された列の名前を調整したい場合は、<code>.names =</code> 引数で <strong>glue</strong> パッケージの構文を使用してください（<strong>glue</strong> パッケージに関する詳細は、<a href="characters_strings.jp.html">文字型・文字列型データ</a> の章を参照ください）。<code>{.col}</code> と <code>{.fn}</code> は入力された列と関数の省略形です。</li>
</ul>
</li>
</ul></section></section><section id="coalesce" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="coalesce"><code>coalesce()</code></h3>
<p><code>coalesce()</code> は、<strong>dplyr</strong> パッケージに含まれており、指定された値のうち、欠損値ではない最初の値を見つける関数です。この関数は、指定された順序で、取得された欠損値ではない最初の値で欠損値を埋めます。</p>
<p>ここでは、データフレーム以外の例を示します。2 つのベクトルがあるとします。1 つは患者の発見された村、もう 1 つは患者の居住地の村です。<code>coalesce()</code> を使用し、各ベクトルの欠損値ではない最初の値を見つけることができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>village_detection <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="cn">NA</span>,  <span class="cn">NA</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>village_residence <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"c"</span>, <span class="st">"a"</span>, <span class="st">"d"</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>village <span class="ot">&lt;-</span> <span class="fu">coalesce</span>(village_detection, village_residence)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>village    <span class="co"># 結果を表示する</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a" "b" "a" "d"</code></pre>
</div>
</div>
<p><code>coalesce()</code> は、データフレームの列を対象とした場合にも同じように動作します。この関数は、指定した列の中で欠損地ではない最初の値を、新しい列の値として各行ごとに割り当てます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="fu">coalesce</span>(village_detection, village_residence))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これは、データフレームの行ごとに処理をしていく「行処理（row-wise 演算）」の一例です。より複雑な行処理については、本章下部の 8.12 行単位の計算 のセクションをご覧ください。</p>
</section><section id="累積計算" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="累積計算">累積計算</h3>
<p>データフレームの行を計算し、その時点までの累積和、平均、最小、最大などを列に反映させたい場合は、以下の関数を使用します。</p>
<p><code>cumsum()</code> は、以下のように、累積和を返します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">15</span>,<span class="dv">10</span>))     <span class="co"># 1つの数字のみを返す</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 31</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cumsum</span>(<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">15</span>,<span class="dv">10</span>))  <span class="co"># 各ステップでの累積和を返す</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  2  6 21 31</code></pre>
</div>
</div>
<p>これは、データフレームで新しい列を作るときに使用できます。例えば、アウトブレイクにおける一日あたりの累積症例数を知りたい場合は、次のようなコードを使って計算できます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>cumulative_case_counts <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span>  <span class="co"># 症例ラインリスト </span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(date_onset) <span class="sc">%&gt;%</span>                 <span class="co"># 一日当たりの行数をカウント   </span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cumulative_cases =</span> <span class="fu">cumsum</span>(n))  <span class="co"># 累積和の新しい列</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>以下に、最初の 10 行を表示します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cumulative_case_counts, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   date_onset n cumulative_cases
1  2012-04-15 1                1
2  2012-05-05 1                2
3  2012-05-08 1                3
4  2012-05-31 1                4
5  2012-06-02 1                5
6  2012-06-07 1                6
7  2012-06-14 1                7
8  2012-06-21 1                8
9  2012-06-24 1                9
10 2012-06-25 1               10</code></pre>
</div>
</div>
<p>流行曲線（エピカーブ）で累積罹患率をプロットする方法については、<a href="epicurves.jp.html">流行曲線（エピカーブ）</a> の章をご覧ください。</p>
<p>関連項目：<a href="https://rdrr.io/r/base/cumsum.html"><code>cumsum()</code></a>、<code>cummean()</code>、<a href="https://rdrr.io/r/base/cumsum.html"><code>cummin()</code></a>、<a href="https://rdrr.io/r/base/cumsum.html"><code>cummax()</code></a>、<code>cumany()</code>、<code>cumall()</code></p>
</section><section id="r-の基本パッケージ-base-を使用する" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="r-の基本パッケージ-base-を使用する">R の基本パッケージ <strong>base</strong> を使用する</h3>
<p><strong>base</strong> R を使って新しい列を定義する（または列を再定義する）こともできます。その場合は、新しい列（または修正する列）にデータフレームの名前を <code>$</code> でつないで書き、代入演算子 <code>&lt;-</code> を使って新しい値を定義します。<strong>base</strong> R を使用する際には、毎回、列名の前にデータフレーム名を指定しなければならないことを覚えておいてください（例：dataframe$column）。ここでは、<strong>base</strong> R を使用して 新しく <code>bmi</code> という列を作成する例を示します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>linelist<span class="sc">$</span>bmi <span class="ot">=</span> linelist<span class="sc">$</span>wt_kg <span class="sc">/</span> (linelist<span class="sc">$</span>ht_cm <span class="sc">/</span> <span class="dv">100</span>) <span class="sc">^</span> <span class="dv">2</span><span class="er">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="パイプラインへの追加" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="パイプラインへの追加">パイプラインへの追加</h3>
<p><strong>以下では、パイプラインに新しい列を追加し、いくつかの列のデータ型を変換しています。</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプライン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################################</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプラインの開始</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="do">###########################</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist_raw <span class="sc">%&gt;%</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 列名の標準化</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 列名を個別に変更</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>           <span class="co"># 新しい列名           #既存の列名</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">date_infection       =</span> infection_date,</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_hospitalisation =</span> hosp_date,</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_outcome         =</span> date_of_outcome) <span class="sc">%&gt;%</span> </span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列の除去</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(row_num, merged_header, x28)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 重複行の削除</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>    <span class="do">###################################################</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 新しい列の追加</span></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">bmi =</span> wt_kg <span class="sc">/</span> (ht_cm<span class="sc">/</span><span class="dv">100</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列のデータ型を変換</span></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"date"</span>), as.Date), </span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>           <span class="at">generation =</span> <span class="fu">as.numeric</span>(generation),</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>           <span class="at">age        =</span> <span class="fu">as.numeric</span>(age)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="値の再定義" class="level2" data-number="8.8"><h2 data-number="8.8" class="anchored" data-anchor-id="値の再定義">
<span class="header-section-number">8.8</span> 値の再定義</h2>
<p>以下のような場合には、値を再定義（変更）する必要があります。</p>
<ul>
<li><p>特定の値を編集する場合（例：日付の年号や書式が間違っている場合など）。</p></li>
<li><p>同じ綴りでない値を調整する場合。</p></li>
<li><p>カテゴリ値の新しい列を作成する場合。</p></li>
<li><p>数値カテゴリの新しい列を作成する（例：年齢カテゴリ）。</p></li>
</ul>
<section id="特定の値" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="特定の値">特定の値</h3>
<p>値を手動で変更するためには、<code>mutate()</code> 内で <code>recode()</code> を使用します。</p>
<p>例えば、データの中に意味のない日付（例：“2014-14-15”）があるとします。未加工の元データ上でマニュアルで日付を修正することもできますし、<code>mutate()</code> と <code>recode()</code> を使用して前処理パイプラインに日付を修正するコマンドを書き込むこともできます。後者の方がより透明性と再現性が高く、行われた分析を理解しようとする第三者や同じように分析しようとする人にとって、分析を再現しやすくなります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 間違っている値の修正                    # 既存の値     # 新しい値</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_onset =</span> <span class="fu">recode</span>(date_onset, <span class="st">"2014-14-15"</span> <span class="ot">=</span> <span class="st">"2014-04-15"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>上の例の <code>mutate()</code> の行は、「<code>date_onset</code> 列内の間違っている値を新しい値に変換し、<code>date_onset</code> 列に再定義する」と読むことができます。<code>recode()</code> のパターン（既存の値 = 新しい値）は、ほとんどの R の関数のパターン（新しい値 = 既存の値）とは逆であることに注意してください。R の開発コミュニティでは、この相違の統一化に取り組んでいます。</p>
<p><strong>以下に、別の例として、1 つの列において複数の値を再定義する例を紹介します。</strong></p>
<p><code>linelist</code> の <code>hospital</code> 列には、いくつか綴り（つづり）が間違った値があることに加え、多くの欠損値があるため、<code>hospital</code> 列の値をクリーニングする必要があります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(linelist<span class="sc">$</span>hospital, <span class="at">useNA =</span> <span class="st">"always"</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                     Central Hopital                     Central Hospital 
                                  11                                  457 
                          Hospital A                           Hospital B 
                                 290                                  289 
                    Military Hopital                    Military Hospital 
                                  32                                  798 
                    Mitylira Hopital                    Mitylira Hospital 
                                   1                                   79 
                               Other                         Port Hopital 
                                 907                                   48 
                       Port Hospital St. Mark's Maternity Hospital (SMMH) 
                                1756                                  417 
  St. Marks Maternity Hopital (SMMH)                                 &lt;NA&gt; 
                                  11                                 1512 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># 欠損値を含むすべての一意の値のテーブルを表示する</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>以下の <code>recode()</code> コマンドでは、指定した複数の値を書き換え、<code>hospital</code> 列を再定義しています。既存の値から新しい値に書き換えるそれぞれのコードの後にコンマを忘れないようにしてください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">recode</span>(hospital,</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># 参照:     既存の値 = 新しい値</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Mitylira Hopital"</span>  <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Mitylira Hospital"</span> <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Military Hopital"</span>  <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Port Hopital"</span>      <span class="ot">=</span> <span class="st">"Port Hospital"</span>,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Central Hopital"</span>   <span class="ot">=</span> <span class="st">"Central Hospital"</span>,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"other"</span>             <span class="ot">=</span> <span class="st">"Other"</span>,</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"St. Marks Maternity Hopital (SMMH)"</span> <span class="ot">=</span> <span class="st">"St. Mark's Maternity Hospital (SMMH)"</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>                      ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>上のコードを実行すると、 <code>hospital</code> 列内で間違った綴りの値が修正され、正しい綴りの値のグループに統合されていることがわかります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(linelist<span class="sc">$</span>hospital, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                    Central Hospital                           Hospital A 
                                 468                                  290 
                          Hospital B                    Military Hospital 
                                 289                                  910 
                               Other                        Port Hospital 
                                 907                                 1804 
St. Mark's Maternity Hospital (SMMH)                                 &lt;NA&gt; 
                                 428                                 1512 </code></pre>
</div>
</div>
<p><u><strong>ヒント</strong></u>：等号（=）の前後には、スペースをいくつか入れても問題ありません。コードを読みやすくするために、すべての行またはほとんどの行で等号（=）の場所を揃えることをおすすめします。また、ハッシュタグでコメント行を追加し、どちらが古い値でどちらが新しい値なのかを、第三者に明確にわかるようにすることも大事なポイントです。</p>
<p><u><strong>ヒント</strong></u>：データセットの中には、空白文字の値が存在することがあります（これは、R の欠損値である NA として認識されません）。このような値を参照するためには、2 つの引用符をスペースを空けずに（““）使用します。</p>
</section><section id="論理条件" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="論理条件">論理条件</h3>
<p>以下では、論理条件を使用して列の値を再定義する方法を説明します。</p>
<ul>
<li><p>単純な論理条件：<code>replace()</code>、<code>ifelse()</code>、<code>if_else()</code> を使う</p></li>
<li><p>複雑な論理条件：<code>case_when()</code> を使う</p></li>
</ul></section><section id="単純な論理条件" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="単純な論理条件">単純な論理条件</h3>
<section id="replace" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="replace"><code>replace()</code></h4>
<p><code>replace()</code> は <strong>base</strong> R の関数で、論理条件を使って変更する行を指定します。一般的な構文は以下の通りです。</p>
<p><code>mutate(col_to_change = replace(col_to_change, criteria for rows, new value))</code></p>
<p><code>replace()</code> を使用する一般的な状況としては、一意の行識別子（症例ごとの ID 番号など）を使用して、1 つの行の 1 つの値だけを変更する場合です。下の例では、<code>case_id</code> が「2195」である行の性別を “Female”に変更しています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 例：ある特定の観測データの性別を "Female" に変更する</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gender =</span> <span class="fu">replace</span>(gender, case_id <span class="sc">==</span> <span class="st">"2195"</span>, <span class="st">"Female"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>R の基本的な構文と角括弧 [ ] を使った同等のコマンドは、以下の通りです。<code>linelist</code> データフレームの <code>gender</code> 列の値を（<code>linelist</code> の <code>case_id</code> 列の値が「2195」である行について）“Female” に変更する、と読めます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>linelist<span class="sc">$</span>gender[linelist<span class="sc">$</span>case_id <span class="sc">==</span> <span class="st">"2195"</span>] <span class="ot">&lt;-</span> <span class="st">"Female"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="ifelse-と-if_else" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="ifelse-と-if_else">
<code>ifelse()</code> と <code>if_else()</code>
</h4>
<p>簡潔な論理条件のためのツールとして、<code>ifelse()</code> とそのパートナーである <code>if_else()</code> があります。しかし、ほとんどの場合、再定義のためには<code>case_when()</code>（以下に詳述）を使ったほうがわかりやすいでしょう。これらの “if else” コマンドは、<code>if</code> と<code>else</code> のプログラミング文を簡略化したものです。一般的な構文は以下の通りです。</p>
<p><code>ifelse(condition, value to return if condition evaluates to TRUE, value to return if condition evaluates to FALSE)</code></p>
<p>下の例では、<code>source_known</code> という列が新しく定義されています。既存の列 <code>source</code> の値が欠損していなければ、<code>source_known</code> 列の値は “known” に設定され、<code>source</code> 列の値が欠落している場合は、 “unknown” に設定されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">source_known =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(source), <span class="st">"known"</span>, <span class="st">"unknown"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>if_else()</code> は、日付を扱う <strong>dplyr</strong> の特別バージョンです。真（TRUE）の値が日付の場合、「偽（FALSE）」の値も日付でなければならないことに注意してください。そのため、単に NA ではなく NA_real_ という特別な値を使用しています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  患者が死亡していない場合はNAとなる死亡日の列を作成する</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_death =</span> <span class="fu">if_else</span>(outcome <span class="sc">==</span> <span class="st">"Death"</span>, date_outcome, <span class="cn">NA_real_</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>ifelseコマンドをたくさん並べるのは避けましょう…</strong>代わりに<code>case_when()</code>を使ってください！<code>case_when()</code> の方がずっと読みやすく、エラーも少なくなります。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="../images/ifelse%20bad.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="../images/ifelse%20bad.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>
<p>データフレーム以外で、コード内で使用するオブジェクトの値を切り替えたい場合は、<strong>base</strong> R の<code>switch()</code> の使用を検討してください。</p>
</section></section><section id="clean_case_when" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="clean_case_when">複雑な論理条件</h3>
<p>ある変数を複数のグループに分ける場合や、複雑な論理条件文を使って値を再定義する必要がある場合は、<strong>dplyr</strong> の <code>case_when()</code> を使用します。この関数は、データフレーム内のすべての行を計算し、その行が指定された基準を満たしているかどうかを評価して、正しい値を新しく割り当てます。</p>
<p><code>case_when()</code> コマンドは、右側（Right-Hand Side: RHS）左側（Left-Hand Side: LHS）をチルダ <code>~</code> で区切ったコードで構成されています。各コードの左側には論理条件が、右側には準拠値が記述されて、コンマで区切られています。</p>
<p>例えば、ここでは <code>age</code> と <code>age_unit</code> の列を利用して <code>age_years</code> の列を作成しています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age_years =</span> <span class="fu">case_when</span>(</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>       age_unit <span class="sc">==</span> <span class="st">"years"</span>  <span class="sc">~</span> age,       <span class="co"># 年齢が年単位の場合</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>       age_unit <span class="sc">==</span> <span class="st">"months"</span> <span class="sc">~</span> age<span class="sc">/</span><span class="dv">12</span>,    <span class="co"># 年齢が月単位の場合、値を 12 で割る</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>       <span class="fu">is.na</span>(age_unit)      <span class="sc">~</span> age))      <span class="co"># 年齢の単位が見つからない場合は、年を仮定</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>                                         <span class="co"># その他の状況では、欠損値 NA とする</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>データの各行が評価されるとき、<code>case_when()</code> 内に書かれたコードの順に、上から下へと適用・評価されます。ある行で論理式が <code>TRUE</code> と評価された場合、その行の評価式の右側（RHS）の値がオブジェクトに割り当てられ、残りの論理式は同じ行では評価されません。したがって、もっとも明確な範囲の論理式（狭い範囲の論理式）を最初に記述して、もっとも一般的な範囲の論理式（広い範囲の論理式）を最後に書くのがよいでしょう。いずれの論理式の右側 (RHS) にも当てはまらなかった場合は、オブジェクトに <code>NA</code> が割り当てられます。</p>
<p>ときには、最後の行にそれ以前の行で記述しなかったすべての場合に値を割り当てる論理式を記述する必要があるかもしれません。この場合の論理式は、左辺 (LHS) に <code>TRUE</code> と記述すると実現できます。この記述方法は、この行より前の行の論理式のいずれも当てはまらない場合に対応します。左辺に <code>TRUE</code> と書いた論理式の右辺 (RHS) には、“check me!” や “missing” のような文字列型を指定できます。</p>
<p>以下は、<code>case_when()</code> の別例です。確定症例と疑義症例を定義する論理式に従い、症例各行の分類を示す新しい列を作成する例です。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="at">case_status =</span> <span class="fu">case_when</span>(</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 患者が血液検査を受けて、結果が陽性だった場合、</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 該当行の case_status 列に "Confirmed"（確定症例）を代入する</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>          ct_blood <span class="sc">&lt;</span> <span class="dv">20</span>                   <span class="sc">~</span> <span class="st">"Confirmed"</span>,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 患者の血液検査が陽性ではなく、かつ</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>          <span class="co"># "source"（疫学的関係あり）であり、かつ、発熱している (fever) 場合</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 該当行の case_status 列に "Suspect"（疑義症例）を代入する</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>          <span class="sc">!</span><span class="fu">is.na</span>(source) <span class="sc">&amp;</span> fever <span class="sc">==</span> <span class="st">"yes"</span> <span class="sc">~</span> <span class="st">"Suspect"</span>,</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 上記の論理式に該当しない患者の場合</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>          <span class="co"># "To investigate"（要調査）を代入する</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span>                            <span class="sc">~</span> <span class="st">"To investigate"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span style="color: red;">警告：右側の値はすべて同じデータ型でなければなりません。欠損値（NA）を割り当てるには、NA_character_、<code>NA_real_</code>（数値や POSIX の場合）、<code>as.Date(NA)</code>など、データ型によって異なる NA を使用する必要があるかもしれません。詳しくは、日付型データの章の<a href="https://epirhandbook.com/en/working-with-dates.html#working-with-dates-1">日付の操作</a> のセクションをご覧ください。</span></p>
</section><section id="欠損値" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="欠損値">欠損値</h3>
<p>以下は、データクリーニングの観点から欠損値を処理するための特別な関数です。</p>
<p>論理的に欠損値をテストする <code>is.na()</code> などの関数について知りたい場合など、欠損値の識別と処理に関して詳しく学びたい方は、<a href="missing-data">欠損データの処理</a> の章を参照してください。</p>
<p><strong><code>replace_na()</code></strong></p>
<p>欠損値（NA）を “Missing” などの特定の値に変更する場合は、<strong>dplyr</strong> パッケージに含まれる <code>replace_na()</code> を<code>mutate()</code> 内で使用します。これは、上記の <code>recode</code> と同じように使用されることに注意してください 。対象となる変数の名前は、<code>replace_na()</code> 内で再度明記される必要があります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">replace_na</span>(hospital, <span class="st">"Missing"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>fct_explicit_na()</strong></p>
<p><code>fct_explicit_na()</code> は、<strong>forcats</strong> パッケージに含まれている関数です。<strong>forcats</strong> パッケージは、因子（ファクタ）型の列を扱います。因子型は、<code>c("First", "Second", "Third")</code> のような順序付きの値を扱うための R の方法であり、表やプロットに表示される値（病院など）の順序を設定します。詳細は、<a href="factors.jp.html">因子（ファクタ）型データ</a> の章を参照してください。</p>
<p>データが因子型で、<code>replace_na()</code> を使って <code>NA</code> を “Missing” に変換しようとすると、以下のようなエラーが表示されます。</p>
<p><code>invalid factor level, NA generated.</code></p>
<p>“Missing” を因子型がとれるレベルとして定義せずに追加しようとしたため、エラーとなります。</p>
<p>この問題を解決する最も簡単な方法は、<strong>forcats</strong> パッケージの <code>fct_explicit_na()</code> を使用することです。この関数は、列を因子型に変換し、<code>NA</code> 値を文字型の “(Missing)” に変換します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">fct_explicit_na</span>(hospital))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>もう一つ、さらに手間がかかる方法ですが、<code>fct_expand()</code> を用いて因子型を追加し、その後、欠損値を変換しても同じ結果を得ることができます。</p>
<p><strong><code>na_if()</code></strong></p>
<p>特定の値を <code>NA</code> に変換するには、<strong>dplyr</strong> の <code>na_if()</code> を使います。以下のコマンドは <code>replace_na()</code> とは逆の操作を行います。以下の例では、列 <code>hospital</code> の “Missing” の値はすべて <code>NA</code> に変換されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">na_if</span>(hospital, <span class="st">"Missing"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>注意： <code>na_if()</code> は論理的条件（例：“all values &gt; 99”）には使用できません。このような論理的条件には、<code>replace()</code> または <code>case_when()</code> を使用してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 40度以上の温度をNAに変換する </span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">temp =</span> <span class="fu">replace</span>(temp, temp <span class="sc">&gt;</span> <span class="dv">40</span>, <span class="cn">NA</span>))</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2000年1月1日以前の発症日を欠損に変換する</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_onset =</span> <span class="fu">replace</span>(date_onset, date_onset <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2000-01-01"</span>), <span class="cn">NA</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="クリーニングディクショナリcleaning-dictionary" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="クリーニングディクショナリcleaning-dictionary">クリーニングディクショナリ（Cleaning dictionary）</h3>
<p>R の <strong>matchemaker</strong> パッケージに含まれる関数 <code>match_df()</code> を使用し、データフレームをクリーニングディクショナリを用いて前処理します。</p>
<ol type="1">
<li>まず、クリーニングディクショナリを作成します。クリーニングディクショナリは、以下の 3 つの列で構成される必要があります。</li>
</ol>
<ul>
<li><p>from 列（不正な値）</p></li>
<li><p>to 列（正しい値）</p></li>
<li><p>変更を適用する列を指定する列（すべての列に変更を適用する場合は、“.global” と記入する）</p></li>
</ul>
<p>注意：.globalのディクショナリ項目は、列固有のディクショナリ項目によって上書きされます。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="../images/cleaning_dict.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="../images/cleaning_dict.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
<ol start="2" type="1">
<li>本章では、<a href="data_used.jp.html">ハンドブックとデータのダウンロード</a> の章にあるクリーニングディクショナリを例として使用しますので、上のリンクからダウンロードし、インポートしてください。</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>cleaning_dict <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"cleaning_dict.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>
<u>未加工の</u>ラインリストを <code>match_df()</code> に渡し、<code>distionary =</code> 引数にインポートしたクリーニングディクショナリデータフレームを指定します。引数 <code>from =</code> には「置き換え前」の値を含むディクショナリの列名を指定します。引数 <code>by =</code> には対応する「置き換え後」の値を含む列名を指定し、データフレームの 3 列目には置き換えする列名を列挙します。すべての列に対して置き換えを実行する場合は、<code>by =</code> 列に <code>.global</code> を指定します。4 列目 <code>order</code> は、変更後の値の並び順を指定します。</li>
</ol>
<p>詳しくは <code>?match_df</code> を実行すると表示される<a href="https://cran.r-project.org/web/packages/matchmaker/vignettes/intro.html">パッケージドキュメント</a>を参照してください。この関数は、サイズの大きなデータセットでは、実行時間が長いことに注意してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span>     <span class="co"># match_df() にデータセットを渡す</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>     matchmaker<span class="sc">::</span><span class="fu">match_df</span>(</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">dictionary =</span> cleaning_dict,  <span class="co"># ディクショナリデータフレームのオブジェクト名を指定</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">from =</span> <span class="st">"from"</span>,               <span class="co"># 置き換える値を格納した列を指定（デフォルトでは、1 列目）</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">to =</span> <span class="st">"to"</span>,                   <span class="co"># 置き換え後の値を格納した列を指定（デフォルトでは 2 列目）</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">by =</span> <span class="st">"col"</span>                   <span class="co"># 置き換え対象の列名を列挙した列を指定（デフォルトでは 3 列目）</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>以下の表を右側にスクロールすると、上のコマンドを実行後に値がどのように変化したかがわかります。特に、性別の変化（小文字から大文字に変換された）や、すべての症状の列が yes/no の 2 択から 1/0 の 2 択に変化したことに注目してください。</p>
<div class="cell">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-1bdb5d7a491779107f33" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-1bdb5d7a491779107f33">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"2\" data-max=\"13\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1399075200000\" data-max=\"1406419200000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1399939200000\" data-max=\"1.407024e+12\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1400025600000\" data-max=\"1407110400000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"date\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1400371200000\" data-max=\"1410566400000\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"-13.2697246824573\" data-max=\"-13.209391925612\" data-scale=\"13\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"8.45171855856465\" data-max=\"8.48802917129884\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"67\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\" disabled=\"\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"100\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"11\" data-max=\"241\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"20\" data-max=\"24\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"35.9\" data-max=\"38\" data-scale=\"1\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"428.994082840237\" data-scale=\"14\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"0\" data-max=\"67\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08",null,null,"2014-05-04","2014-05-18","2014-05-03","2014-05-22","2014-05-28",null,null,"2014-05-30","2014-05-28","2014-06-14","2014-06-07","2014-06-09",null,null,null,"2014-06-23","2014-06-18","2014-06-24",null,null,"2014-07-03",null,"2014-07-10","2014-06-14",null,"2014-06-18","2014-06-29","2014-07-02","2014-07-12","2014-07-12","2014-06-13","2014-07-15","2014-06-20",null,null,"2014-07-20",null,"2014-07-12","2014-07-19","2014-07-18","2014-07-18","2014-07-27",null,"2014-07-19","2014-07-26","2014-07-24",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15","2014-05-14","2014-05-18","2014-05-20","2014-05-22","2014-05-23","2014-05-29","2014-06-03","2014-06-06","2014-06-07","2014-06-08","2014-06-15","2014-06-17","2014-06-17","2014-06-20","2014-06-19","2014-06-23","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-03","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-13","2014-07-14","2014-07-14","2014-07-13","2014-07-14","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-20","2014-07-22","2014-07-24","2014-07-26","2014-07-24","2014-07-27","2014-07-25","2014-07-27","2014-07-31","2014-08-01","2014-08-03","2014-08-02","2014-08-02","2014-08-04"],[null,"2014-05-18","2014-05-30",null,"2014-05-29","2014-05-24","2014-06-01","2014-06-07","2014-06-18","2014-06-09","2014-06-15",null,"2014-07-09",null,"2014-06-30","2014-07-11","2014-07-01","2014-06-25","2014-07-06","2014-07-02","2014-07-09","2014-07-07","2014-07-20",null,"2014-07-22","2014-07-16","2014-07-14","2014-07-20","2014-07-16","2014-07-19","2014-07-27","2014-07-19",null,"2014-07-26","2014-08-14","2014-08-01","2014-07-23","2014-08-28","2014-07-28","2014-07-19",null,"2014-08-03",null,null,null,"2014-08-06","2014-08-21","2014-09-13","2014-08-04",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["M","F","M","F","M","F","F","F","M","F","M","M","M","F","F","M","F","F","F","F","M","M","F","M","F","M","M","F","M","F","F","F","M","M","F","M","F","F","F","M","F","M","F","M","M","F","M","F","M","M"],["Other",null,"St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital",null,null,null,null,"Port Hospital","Military Hospital",null,null,"Other","Port Hospital","Port Hospital","Port Hospital",null,"Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)",null,"Other",null,"St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital",null,"Military Hospital","Other",null,null,"Port Hospital","Port Hospital","Port Hospital",null,"Central Hospital","Military Hospital","Other","Other","Other",null,"St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)",null],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.461830626007281,8.462729314626459,8.461443675342711,8.46191259217774,8.472923276435059,8.48401630165138,8.458371253408441,8.477617055125091,8.47570184950483,8.477799468789719,8.47145134147474,8.478048406853629,8.48528034195779,8.469575303958671,8.45957352078114,8.474048895115439,8.488029171298839,8.473437335922,8.484082637344621,8.46242233645879,8.470268221265719,8.463984474805329,8.464134789434199,8.456230946296071,8.48334624336805,8.47493999153642,8.47832062438022,8.469393389176499,8.48480589906514,8.47121232619015,8.48438437371817,8.484661585743391,8.477141599844281,8.462381270106089,8.455685978131131,8.4632880274758,8.47940722413856,8.46353857052336,8.461789681588639,8.47508713872833,8.458258081280711,8.4532568143863,8.4732571907655,8.479115866419329,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["0",null,null,"0","0","0",null,"0","0","0","0","0","0","0","0","0","0","0",null,"0","0","0","0","0",null,"0","0","0",null,null,"0","0",null,"0","0",null,null,"0","0",null,"0","0",null,"0","0","0","0","0","0",null],["0",null,null,"0","0","0",null,"0","0","0","0","0","0","0","0","0","1","0",null,"0","0","0","1","0",null,"0","0","1",null,null,"0","0",null,"0","0",null,null,"0","0",null,"0","0",null,"0","1","0","0","0","0",null],["1",null,null,"0","1","1",null,"1","1","1","1","1","1","1","1","1","1","1",null,"1","1","1","1","1",null,"1","1","1",null,null,"1","1",null,"1","1",null,null,"1","1",null,"1","1",null,"1","1","1","1","1","0",null],["0",null,null,"0","0","0",null,"0","0","0","0","0","0","0","0","1","0","0",null,"0","0","0","0","0",null,"0","0","0",null,null,"0","0",null,"0","0",null,null,"1","1",null,"0","0",null,"0","0","0","0","0","0",null],["1",null,null,"0","1","1",null,"1","1","0","1","0","0","0","1","0","0","0",null,"0","1","0","0","0",null,"0","0","0",null,null,"0","1",null,"1","1",null,null,"1","1",null,"1","1",null,"1","1","0","1","1","1",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],[117.1875,71.81844297615629,16.06524962926347,22.49657064471879,71.41440190438405,41.61712247324614,62.09538908706566,0,16.83765369253662,22.79032897344431,53.41198979591836,24.28026361429067,22.46003435064077,54.32098765432099,41.05784325564545,28.56648199445983,17.03205520132763,25.04129149128882,38.7172182043977,27.3876813705495,31.55555555555556,14.80690759456621,30.88398111998135,26.61934338952972,59.37499999999999,96.61835748792272,19.23947487550928,84.94031221303948,18.41993774061044,27.77226740726046,41.32231404958677,17.20806665861611,24.16716240333135,15.72189710891781,428.9940828402366,27.99302202929125,243.2610124917817,20.23950075898128,30.52744643563797,25.15589569160998,47,39.04,31.06616432017979,77.96836711962574,29.51659612385831,166.4932362122789,100.3086419753086,37.76,20.60378034578518,23.45856237526698],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>age_years<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,9,10,13,15,16,17,23,25,26]},{"name":"case_id","targets":0},{"name":"generation","targets":1},{"name":"date_infection","targets":2},{"name":"date_onset","targets":3},{"name":"date_hospitalisation","targets":4},{"name":"date_outcome","targets":5},{"name":"outcome","targets":6},{"name":"gender","targets":7},{"name":"hospital","targets":8},{"name":"lon","targets":9},{"name":"lat","targets":10},{"name":"infector","targets":11},{"name":"source","targets":12},{"name":"age","targets":13},{"name":"age_unit","targets":14},{"name":"wt_kg","targets":15},{"name":"ht_cm","targets":16},{"name":"ct_blood","targets":17},{"name":"fever","targets":18},{"name":"chills","targets":19},{"name":"cough","targets":20},{"name":"aches","targets":21},{"name":"vomit","targets":22},{"name":"temp","targets":23},{"name":"time_admission","targets":24},{"name":"bmi","targets":25},{"name":"age_years","targets":26}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>クリーニングディクショナリの <code>col</code> 列に記入される列名は、クリーニングする時点での列名と同一でなければならないことに注意してください。詳細については、<a href="https://www.repidemicsconsortium.org/linelist/reference/clean_data.html">こちら</a> の <strong>linelist</strong> パッケージのドキュメントを参照してください。</p>
<section id="パイプチェーンへの追加" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="パイプチェーンへの追加">パイプチェーンへの追加</h4>
<p>以下では、いくつかの新しい列と列変換がパイプチェーンに追加されています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">#クリーニングパイプチェーン (未加工データから始まり、クリーニングステップ経由してパイプで処理される)</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################################</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプチェーンの処理開始</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="do">###########################</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist_raw <span class="sc">%&gt;%</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 列名の構文の標準化</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 手動で列名を変更</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>           <span class="co"># 新しい列名             # 既存の列名</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">date_infection       =</span> infection_date,</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_hospitalisation =</span> hosp_date,</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_outcome         =</span> date_of_outcome) <span class="sc">%&gt;%</span> </span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列の除去</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(row_num, merged_header, x28)) <span class="sc">%&gt;%</span> </span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 重複除去</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列を追加</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">bmi =</span> wt_kg <span class="sc">/</span> (ht_cm<span class="sc">/</span><span class="dv">100</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span>     </span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列のデータ型を変換</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"date"</span>), as.Date), </span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>           <span class="at">generation =</span> <span class="fu">as.numeric</span>(generation),</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>           <span class="at">age        =</span> <span class="fu">as.numeric</span>(age)) <span class="sc">%&gt;%</span> </span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列の追加: 入院の遅れ</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">days_onset_hosp =</span> <span class="fu">as.numeric</span>(date_hospitalisation <span class="sc">-</span> date_onset)) <span class="sc">%&gt;%</span> </span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>   <span class="do">###################################################</span></span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 病院の列の値をクリーニングする</span></span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">recode</span>(hospital,</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># OLD = NEW</span></span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Mitylira Hopital"</span>  <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Mitylira Hospital"</span> <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Military Hopital"</span>  <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Port Hopital"</span>      <span class="ot">=</span> <span class="st">"Port Hospital"</span>,</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Central Hopital"</span>   <span class="ot">=</span> <span class="st">"Central Hospital"</span>,</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"other"</span>             <span class="ot">=</span> <span class="st">"Other"</span>,</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"St. Marks Maternity Hopital (SMMH)"</span> <span class="ot">=</span> <span class="st">"St. Mark's Maternity Hospital (SMMH)"</span></span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>                      )) <span class="sc">%&gt;%</span> </span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">replace_na</span>(hospital, <span class="st">"Missing"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># age_years 列を新しく作成する (age 列と age_unit 列を使用する)</span></span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age_years =</span> <span class="fu">case_when</span>(</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>          age_unit <span class="sc">==</span> <span class="st">"years"</span> <span class="sc">~</span> age,</span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>          age_unit <span class="sc">==</span> <span class="st">"months"</span> <span class="sc">~</span> age<span class="sc">/</span><span class="dv">12</span>,</span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>          <span class="fu">is.na</span>(age_unit) <span class="sc">~</span> age,</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</section></section></section><section id="num_cats" class="level2" data-number="8.9"><h2 data-number="8.9" class="anchored" data-anchor-id="num_cats">
<span class="header-section-number">8.9</span> 数値カテゴリ</h2>
<p>ここでは、数値データをカテゴリ化する方法を説明します。一般的な例としては、年齢のカテゴリー化や、検査結果のグループ化などがあります。ここでは、以下について説明します。</p>
<ul>
<li><p><code>age_categories()</code> ( <strong>epikit</strong> パッケージより)</p></li>
<li><p><code>cut()</code>（<strong>base</strong> Rより）</p></li>
<li><p><code>case_when(</code>)</p></li>
<li><p><code>quantile()</code> と <code>ntile()</code> を使った分位数による分割</p></li>
</ul>
<section id="分布を確認する" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="分布を確認する">分布を確認する</h3>
<p>例として、<code>age_years</code> 列を使用して新たに <code>age_cat</code> 列を作成していきます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># linelistのage列のデータ型をチェックする</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(linelist<span class="sc">$</span>age_years)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "numeric"</code></pre>
</div>
</div>
<p>まずデータの分布を確認し、適切な分割点（カットポイント）を作ります。詳しくは <a href="ggplot_basics.jp.html">ggplot の基礎</a> の章をご覧ください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 分布を確認する</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(linelist<span class="sc">$</span>age_years)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="cleaning.jp_files/figure-html/unnamed-chunk-69-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="cleaning.jp_files/figure-html/unnamed-chunk-69-1.png" style="height:50.0%" width="672" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linelist<span class="sc">$</span>age_years, <span class="at">na.rm=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   0.00    6.00   13.00   16.04   23.00   84.00     107 </code></pre>
</div>
</div>
<p><span style="color: orange;"><strong>注意</strong>：数字型のデータが文字列型としてインポートされることがあります。これは、値の一部に数字以外の文字が含まれている場合に発生します。例えば、年齢を「2ヶ月」と入力した場合や、（R のロケール設定にもよりますが）小数点の代わりにコンマが使用されている場合などです（例：“4,5” が 4 年半の意味で使われている場合）。</span></p>
<!-- ======================================================= -->
</section><section id="age_categories" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="age_categories"><code>age_categories()</code></h3>
<p><strong>epikit</strong> パッケージの <code>age_categories()</code> を使用すると、数値列の分類やラベル付けを簡単に行うことができます（注：この関数は、年齢以外の数値変数にも適用できます）。結果として出力される列は、自動的に順序付けられたカテゴリーとなります。</p>
<p>入力する必要がある項目は、以下の通りです。</p>
<ul>
<li><p>数値のベクトル（列）</p></li>
<li><p><code>breakers =</code> 引数：新しいグループの分割点の数値ベクトルを指定する。</p></li>
</ul>
<p>まず、簡単な例を示します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 簡単な例</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="do">################</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(epikit)                     <span class="co">#パッケージの読み込み</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_cat =</span> <span class="fu">age_categories</span>(             <span class="co"># 新しい列の作成</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>      age_years,                           <span class="co"># 分割点によってグループ化する数値列</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">breakers =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>,       <span class="co"># 分割点</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>                   <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>)))</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="co"># テーブルを表示</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(linelist<span class="sc">$</span>age_cat, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0-4   5-9 10-14 15-19 20-29 30-39 40-49 50-59 60-69   70+  &lt;NA&gt; 
 1227  1223  1048   827  1216   597   251    78    27     7   107 </code></pre>
</div>
</div>
<p>指定した分割点によるグループ分けは、デフォルトでは下限の値から始まります。つまり、下限の値は「上位」のグループに含まれ、グループが下または左に「開いている」状態になります。下図のように、各分割点に1を加えることで、上または右で開いたグループにすることができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 同じカテゴリーの上端を含める</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_cat =</span> <span class="fu">age_categories</span>(</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>      age_years, </span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">breakers =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">11</span>, <span class="dv">16</span>, <span class="dv">21</span>, <span class="dv">31</span>, <span class="dv">41</span>, <span class="dv">51</span>, <span class="dv">61</span>, <span class="dv">71</span>)))</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="co"># テーブルを表示</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(linelist<span class="sc">$</span>age_cat, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0-5  6-10 11-15 16-20 21-30 31-40 41-50 51-60 61-70   71+  &lt;NA&gt; 
 1469  1195  1040   770  1149   547   231    70    24     6   107 </code></pre>
</div>
</div>
<p><code>separator =</code> を使用すると、ラベルの表示方法を調整できます。 デフォルトは “-” です。</p>
<p>また、<code>ceiling =</code> を使用し、分割点として指定された数値のうち最大の値の扱い方を調整できます。<code>ceiling = TRUE</code> と設定すると、指定された分割点の最大値が「上限（ceiling）」となり、最大値を超えるカテゴリ “XX+” は作成されません。分割点の最大値（または <code>upper =</code> 引数が使用されている場合は、その値）を超える値は、<code>NA</code> に分類されます。以下は、<code>ceiling = TRUE</code> の例で、XX+ のカテゴリは作成されず、70（分割点の最大値）を超える値は <code>NA</code> として割り当てられます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 上限をTRUEに設定した場合</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="do">##########################</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_cat =</span> <span class="fu">age_categories</span>(</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>      age_years, </span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">breakers =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">60</span>, <span class="dv">70</span>),</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">ceiling =</span> <span class="cn">TRUE</span>)) <span class="co"># 70 が上限となり、70 以上の値は NA となる</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="co"># テーブルを表示</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(linelist<span class="sc">$</span>age_cat, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0-4   5-9 10-14 15-19 20-29 30-39 40-49 50-59 60-70  &lt;NA&gt; 
 1227  1223  1048   827  1216   597   251    78    28   113 </code></pre>
</div>
</div>
<p>また、<code>breakers =</code> の代わりに、<code>lower＝</code>、<code>upper＝</code>、<code>by＝</code> のすべてを指定することもできます。</p>
<ul>
<li><p><code>lower =</code> 下限となる値（デフォルトは 0）</p></li>
<li><p><code>upper =</code> 上限となる値</p></li>
<li><p><code>by =</code> グループ内の年の数</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_cat =</span> <span class="fu">age_categories</span>(</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>      age_years, </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower =</span> <span class="dv">0</span>,</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper =</span> <span class="dv">100</span>,</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="dv">10</span>))</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a><span class="co"># テーブルの表示</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(linelist<span class="sc">$</span>age_cat, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  0-9 10-19 20-29 30-39 40-49 50-59 60-69 70-79 80-89 90-99  100+  &lt;NA&gt; 
 2450  1875  1216   597   251    78    27     6     1     0     0   107 </code></pre>
</div>
</div>
<p>詳細は、age_categories() のヘルプページをご覧ください（R コンソールで <code>?age_categories</code> と入力してください）。</p>
<!-- ======================================================= -->
</section><section id="cut" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="cut"><code>cut()</code></h3>
<p><code>cut()</code> は <code>age_categories()</code> に代わる <strong>base</strong> R の関数ですが、<code>age_categories()</code> と比較すると複雑です。以下の説明を読むと、この処理を簡単にするために <code>age_categories()</code> が開発されたことがわかると思います。<code>age_categories()</code> との注目すべき違いは、以下のとおりです。</p>
<ul>
<li><p>別のパッケージをインストール・ロードする必要がない。</p></li>
<li><p>グループが右か左に開いているか閉じているかを指定できる。</p></li>
<li><p>正確なラベルを自分で用意する必要がある。</p></li>
<li><p>一番下のグループに “0” を入れたい場合は、その旨を明記する必要がある。</p></li>
</ul>
<p><code>cut()</code> の基本的な構文は、まず分割したい数値列（<code>age_years</code>）を指定し、次に <u>breaks</u> 引数に分割点の数値ベクトル <code>c()</code> を指定します。<code>cut()</code> を使用すると、結果として出力される列は順序付けられたカテゴリとなります。</p>
<p>デフォルトでは、右または上側が「オープン」で包括的（左または下側が「クローズ」で排他的）になるように分類されます。これは、<code>age_categories()</code> 関数とは逆の動作です。デフォルトのラベルでは “(A, B]” という表記が使われており、これは「Aは含まれないがBは含まれる」という意味です。<code>right = TRUE</code> <strong>に設定することで、この動作を逆にすることができます。</strong></p>
<p>デフォルトでは、“0” の値は一番下のグループから除外され、<code>NA</code> に分類されることに注意してください。乳幼児が 0 歳としてコードされているデータもあるので、注意が必要です。これを変更するには、引数 <code>include.latest = TRUE</code> を追加して、“0” の値が一番下のグループに含まれるようにします。この場合、自動的に作成される一番下のカテゴリのラベルは “[A],B]” となります。なお、<code>include.latest = TRUE</code> を指定し、かつ <code>right = TRUE</code> を指定した場合、含まれるのは最小値ではなく最大値の分割点とカテゴリーに適用されることに注意してください。</p>
<p><code>labels =</code> 引数を使って、カスタマイズされたラベルのベクトルを指定することができます。手作業で指定する必要があるため、間違えのないように十分注意してください。後述するように、クロス集計を用いて作業を確認してください。</p>
<p><code>age_years</code> に <code>cut()</code> を使用して、新しい変数 <code>age_cat</code> を作成した例を以下に示します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 年齢変数を分割してカテゴリ化した変数を新しく作る</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 下限の分割点は除外されるが、上限の分割点は各カテゴリに含まれる</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_cat =</span> <span class="fu">cut</span>(</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>      age_years,</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>,</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>                 <span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">70</span>, <span class="dv">100</span>),</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">include.lowest =</span> <span class="cn">TRUE</span>         </span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>      ))              <span class="co"># 一番下のグループに0を入れる</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="co"># グループごとの観測値の数を集計する</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(linelist<span class="sc">$</span>age_cat, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   [0,5]   (5,10]  (10,15]  (15,20]  (20,30]  (30,50]  (50,70] (70,100] 
    1469     1195     1040      770     1149      778       94        6 
    &lt;NA&gt; 
     107 </code></pre>
</div>
</div>
<p><strong>分割した結果を確認してください！！！</strong>数値列とカテゴリ列をクロス集計して、各年齢値が正しいカテゴリに割り当てられていることを検証します。特に、境界値の割り当てを確認してください（例：隣接するカテゴリが 10-15 と 16-20 の場合、15 の値がどこに割り当てられているか）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 数値列とカテゴリ列のクロス集計</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="st">"Numeric Values"</span> <span class="ot">=</span> linelist<span class="sc">$</span>age_years,   <span class="co"># 分かりやすくするために、表の中に名前を入れる</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Categories"</span>     <span class="ot">=</span> linelist<span class="sc">$</span>age_cat,</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">useNA =</span> <span class="st">"always"</span>)                        <span class="co"># NA値の検証を忘れずに</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    Categories
Numeric Values       [0,5] (5,10] (10,15] (15,20] (20,30] (30,50] (50,70]
  0                    136      0       0       0       0       0       0
  0.0833333333333333     1      0       0       0       0       0       0
  0.25                   2      0       0       0       0       0       0
  0.333333333333333      6      0       0       0       0       0       0
  0.416666666666667      1      0       0       0       0       0       0
  0.5                    6      0       0       0       0       0       0
  0.583333333333333      3      0       0       0       0       0       0
  0.666666666666667      3      0       0       0       0       0       0
  0.75                   3      0       0       0       0       0       0
  0.833333333333333      1      0       0       0       0       0       0
  0.916666666666667      1      0       0       0       0       0       0
  1                    275      0       0       0       0       0       0
  1.5                    2      0       0       0       0       0       0
  2                    308      0       0       0       0       0       0
  3                    246      0       0       0       0       0       0
  4                    233      0       0       0       0       0       0
  5                    242      0       0       0       0       0       0
  6                      0    241       0       0       0       0       0
  7                      0    256       0       0       0       0       0
  8                      0    239       0       0       0       0       0
  9                      0    245       0       0       0       0       0
  10                     0    214       0       0       0       0       0
  11                     0      0     220       0       0       0       0
  12                     0      0     224       0       0       0       0
  13                     0      0     191       0       0       0       0
  14                     0      0     199       0       0       0       0
  15                     0      0     206       0       0       0       0
  16                     0      0       0     186       0       0       0
  17                     0      0       0     164       0       0       0
  18                     0      0       0     141       0       0       0
  19                     0      0       0     130       0       0       0
  20                     0      0       0     149       0       0       0
  21                     0      0       0       0     158       0       0
  22                     0      0       0       0     149       0       0
  23                     0      0       0       0     125       0       0
  24                     0      0       0       0     144       0       0
  25                     0      0       0       0     107       0       0
  26                     0      0       0       0     100       0       0
  27                     0      0       0       0     117       0       0
  28                     0      0       0       0      85       0       0
  29                     0      0       0       0      82       0       0
  30                     0      0       0       0      82       0       0
  31                     0      0       0       0       0      68       0
  32                     0      0       0       0       0      84       0
  33                     0      0       0       0       0      78       0
  34                     0      0       0       0       0      58       0
  35                     0      0       0       0       0      58       0
  36                     0      0       0       0       0      33       0
  37                     0      0       0       0       0      46       0
  38                     0      0       0       0       0      45       0
  39                     0      0       0       0       0      45       0
  40                     0      0       0       0       0      32       0
  41                     0      0       0       0       0      34       0
  42                     0      0       0       0       0      26       0
  43                     0      0       0       0       0      31       0
  44                     0      0       0       0       0      24       0
  45                     0      0       0       0       0      27       0
  46                     0      0       0       0       0      25       0
  47                     0      0       0       0       0      16       0
  48                     0      0       0       0       0      21       0
  49                     0      0       0       0       0      15       0
  50                     0      0       0       0       0      12       0
  51                     0      0       0       0       0       0      13
  52                     0      0       0       0       0       0       7
  53                     0      0       0       0       0       0       4
  54                     0      0       0       0       0       0       6
  55                     0      0       0       0       0       0       9
  56                     0      0       0       0       0       0       7
  57                     0      0       0       0       0       0       9
  58                     0      0       0       0       0       0       6
  59                     0      0       0       0       0       0       5
  60                     0      0       0       0       0       0       4
  61                     0      0       0       0       0       0       2
  62                     0      0       0       0       0       0       1
  63                     0      0       0       0       0       0       5
  64                     0      0       0       0       0       0       1
  65                     0      0       0       0       0       0       5
  66                     0      0       0       0       0       0       3
  67                     0      0       0       0       0       0       2
  68                     0      0       0       0       0       0       1
  69                     0      0       0       0       0       0       3
  70                     0      0       0       0       0       0       1
  72                     0      0       0       0       0       0       0
  73                     0      0       0       0       0       0       0
  76                     0      0       0       0       0       0       0
  84                     0      0       0       0       0       0       0
  &lt;NA&gt;                   0      0       0       0       0       0       0
                    Categories
Numeric Values       (70,100] &lt;NA&gt;
  0                         0    0
  0.0833333333333333        0    0
  0.25                      0    0
  0.333333333333333         0    0
  0.416666666666667         0    0
  0.5                       0    0
  0.583333333333333         0    0
  0.666666666666667         0    0
  0.75                      0    0
  0.833333333333333         0    0
  0.916666666666667         0    0
  1                         0    0
  1.5                       0    0
  2                         0    0
  3                         0    0
  4                         0    0
  5                         0    0
  6                         0    0
  7                         0    0
  8                         0    0
  9                         0    0
  10                        0    0
  11                        0    0
  12                        0    0
  13                        0    0
  14                        0    0
  15                        0    0
  16                        0    0
  17                        0    0
  18                        0    0
  19                        0    0
  20                        0    0
  21                        0    0
  22                        0    0
  23                        0    0
  24                        0    0
  25                        0    0
  26                        0    0
  27                        0    0
  28                        0    0
  29                        0    0
  30                        0    0
  31                        0    0
  32                        0    0
  33                        0    0
  34                        0    0
  35                        0    0
  36                        0    0
  37                        0    0
  38                        0    0
  39                        0    0
  40                        0    0
  41                        0    0
  42                        0    0
  43                        0    0
  44                        0    0
  45                        0    0
  46                        0    0
  47                        0    0
  48                        0    0
  49                        0    0
  50                        0    0
  51                        0    0
  52                        0    0
  53                        0    0
  54                        0    0
  55                        0    0
  56                        0    0
  57                        0    0
  58                        0    0
  59                        0    0
  60                        0    0
  61                        0    0
  62                        0    0
  63                        0    0
  64                        0    0
  65                        0    0
  66                        0    0
  67                        0    0
  68                        0    0
  69                        0    0
  70                        0    0
  72                        1    0
  73                        3    0
  76                        1    0
  84                        1    0
  &lt;NA&gt;                      0  107</code></pre>
</div>
</div>
<p><strong><code>NA</code>値の再ラベル付け</strong></p>
<p><code>NA</code> 値に “Missing” などのラベルを付けたい場合があります。新しく作成した列は因子型（制限付き型）であるため、この値は拒否されるので、単純に <code>replace_na()</code> で変換させることはできません。代わりに、<a href="factors.jp.html">因子（ファクタ）型データ</a> の章で説明されているように、<strong>forcats</strong> パッケージの <code>fct_explicit_na()</code> を使用してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>   <span class="co"># cut()すると、因子型のage_catが自動的に作成される </span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age_cat =</span> <span class="fu">cut</span>(</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    age_years,</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">70</span>, <span class="dv">100</span>),          </span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">right =</span> <span class="cn">FALSE</span>,</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">include.lowest =</span> <span class="cn">TRUE</span>,        </span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0-4"</span>, <span class="st">"5-9"</span>, <span class="st">"10-14"</span>, <span class="st">"15-19"</span>, <span class="st">"20-29"</span>, <span class="st">"30-49"</span>, <span class="st">"50-69"</span>, <span class="st">"70-100"</span>)),</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 欠損値を明示する</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_cat =</span> <span class="fu">fct_explicit_na</span>(</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>      age_cat,</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">na_level =</span> <span class="st">"Missing age"</span>)  </span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>  )    <span class="co"># ラベルを指定することができる</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There was 1 warning in `mutate()`.
ℹ In argument: `age_cat = fct_explicit_na(age_cat, na_level = "Missing age")`.
Caused by warning:
! `fct_explicit_na()` was deprecated in forcats 1.0.0.
ℹ Please use `fct_na_value_to_level()` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 各カテゴリに含まれる数値の数を表で表示する</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(linelist<span class="sc">$</span>age_cat, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
        0-4         5-9       10-14       15-19       20-29       30-49 
       1227        1223        1048         827        1216         848 
      50-69      70-100 Missing age        &lt;NA&gt; 
        105           7         107           0 </code></pre>
</div>
</div>
<p><strong>切れ目やラベルを素早く作る</strong></p>
<p>ベクトルの改行やラベルを素早く作成するには、以下のような方法があります。<code>seq()</code> や <code>rep()</code> については、<a href="basics.jp.html">R の基礎</a> の章を参照してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 0から90までのブレークポイントを5で割る</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>age_seq <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">90</span>, <span class="at">by =</span> <span class="dv">5</span>)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>age_seq</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="co"># デフォルトのcut()の設定を前提に、上記のカテゴリのラベルを作成する</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>age_labels <span class="ot">=</span> <span class="fu">paste0</span>(age_seq <span class="sc">+</span> <span class="dv">1</span>, <span class="st">"-"</span>, age_seq <span class="sc">+</span> <span class="dv">5</span>)</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>age_labels</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 両方のベクトルが同じ長さであることを確認する</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(age_seq) <span class="sc">==</span> <span class="fu">length</span>(age_labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>cut()</code> の詳細については、Rコンソールで <code>?cut</code> と入力し、表示されるヘルプページを参照してください。</p>
</section><section id="四分位数による分割" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="四分位数による分割">四分位数による分割</h3>
<p>一般的な理解では、「クォンタイル（quantile）」または「パーセンタイル（percentile）」は、通常、下になる値の割合を指します。例えば、<code>linelist</code> の年齢の 95 パーセンタイルは、年齢の 95 %が該当する年齢になります。</p>
<p>しかし、一般的には、「四分位数」や「十分位数」は、データのグループを 4 つまたは 10 のグループに均等に分けたものを指すことがあります（グループよりも分割点が 1 つ多いことに注意してください）。</p>
<p>四分位数を取得するには、<strong>base</strong> R に含まれている <strong>stats</strong> の <code>quantile()</code> を使用します。データセットの列などの数値ベクトルと、0 から 1.0 までの確率の数値ベクトルを指定します。分割点は、数値ベクトルとして返されます。<code>?quantile</code> を入力すると、統計的手法の詳細を調べることができます。</p>
<p>入力された数値ベクトルに欠損値がある場合は、<code>na.rm = TRUE</code> を設定することをお勧めします。</p>
<p><code>names = FALSE</code> を設定すると、名前のない数値ベクトルが得られます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(linelist<span class="sc">$</span>age_years,             <span class="co"># 演算する数値ベクトルを指定</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">probs =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">25</span>, .<span class="dv">50</span>, .<span class="dv">75</span>, .<span class="dv">90</span>, .<span class="dv">95</span>),  <span class="co"># 欲しいパーセンタイルを指定</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)                          <span class="co"># 欠損値を無視する</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 0% 25% 50% 75% 90% 95% 
  0   6  13  23  33  41 </code></pre>
</div>
</div>
<p><code>quantile()</code> の結果は、<code>age_categories()</code> や <code>cut()</code> の分割点として使用できます。以下では、<code>cut()</code> を使って新しい列 <code>deciles</code> を作成し、<code>age_years</code> に対して <code>quantiles()</code> を使って区切りを定義しています。<strong>janitor</strong> の <code>tabyl()</code> を使って結果を表示し、各グループのパーセンテージを見ることができます（詳細は、<a href="tables_descriptive.jp.html">記述統計表の作り方</a> の章を参照ください）。各グループ、正確に 10 %ではないことに注意してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span>                              <span class="co">#linelistから開始。</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">deciles =</span> <span class="fu">cut</span>(age_years,        <span class="co"># 新しい列を作る。 age_years列をcut()でdecileに格納。</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">quantile</span>(                   <span class="co"># quantile()を使ってカットオフを定義する。</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>      age_years,                         <span class="co"># age_yearsの操作。</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>),       <span class="co"># 0.0から1.0へ0.1倍。</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> <span class="cn">TRUE</span>),                    <span class="co"># 欠損値を無視する</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>          <span class="co"># cut()でage 0を含む。</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">tabyl</span>(deciles)                <span class="co"># 表示するテーブルへのパイプ。</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> deciles   n    percent valid_percent
   [0,2] 748 0.11319613    0.11505922
   (2,5] 721 0.10911017    0.11090601
   (5,7] 497 0.07521186    0.07644978
  (7,10] 698 0.10562954    0.10736810
 (10,13] 635 0.09609564    0.09767728
 (13,17] 755 0.11425545    0.11613598
 (17,21] 578 0.08746973    0.08890940
 (21,26] 625 0.09458232    0.09613906
 (26,33] 596 0.09019370    0.09167820
 (33,84] 648 0.09806295    0.09967697
    &lt;NA&gt; 107 0.01619249            NA</code></pre>
</div>
</div>
</section><section id="均等な大きさのグループ" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="均等な大きさのグループ">均等な大きさのグループ</h3>
<p>数値グループを作成するもう 1 つの方法として、<strong>dplyr</strong> の関数 <code>ntile()</code> で、データを n 個の均等な大きさのグループに分割する方法があります。<code>quantile()</code> と異なり、同じ値が複数のグループに入ることがあることに注意してください。この方法では、数値ベクトルを指定し、そして分割するグループの数を指定することが必要ですが、作成される新しい列の値は、グループの「番号」（例：1 から 10）だけで、<code>cut()</code> を使ったときのように値の範囲そのものではありません。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ntile()でグループを作る</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>ntile_data <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">even_groups =</span> <span class="fu">ntile</span>(age_years, <span class="dv">10</span>))</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="co"># グループ別の数と割合の表を作る</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>ntile_table <span class="ot">&lt;-</span> ntile_data <span class="sc">%&gt;%</span> </span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">tabyl</span>(even_groups)</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 範囲を示すために最小値と最大値を添付する</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>ntile_ranges <span class="ot">&lt;-</span> ntile_data <span class="sc">%&gt;%</span> </span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(even_groups) <span class="sc">%&gt;%</span> </span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">min =</span> <span class="fu">min</span>(age_years, <span class="at">na.rm=</span>T),</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">max =</span> <span class="fu">max</span>(age_years, <span class="at">na.rm=</span>T)</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 2 warnings in `summarise()`.
The first warning was:
ℹ In argument: `min = min(age_years, na.rm = T)`.
ℹ In group 11: `even_groups = NA`.
Caused by warning in `min()`:
! no non-missing arguments to min; returning Inf
ℹ Run `dplyr::last_dplyr_warnings()` to see the 1 remaining warning.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 結合して表示する（値が複数のグループに存在することに注意）</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(ntile_table, ntile_ranges, <span class="at">by =</span> <span class="st">"even_groups"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> even_groups   n    percent valid_percent min  max
           1 651 0.09851695    0.10013844   0    2
           2 650 0.09836562    0.09998462   2    5
           3 650 0.09836562    0.09998462   5    7
           4 650 0.09836562    0.09998462   7   10
           5 650 0.09836562    0.09998462  10   13
           6 650 0.09836562    0.09998462  13   17
           7 650 0.09836562    0.09998462  17   21
           8 650 0.09836562    0.09998462  21   26
           9 650 0.09836562    0.09998462  26   33
          10 650 0.09836562    0.09998462  33   84
          NA 107 0.01619249            NA Inf -Inf</code></pre>
</div>
</div>
<!-- ======================================================= -->
</section><section id="case_when" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="case_when"><code>case_when()</code></h3>
<p><strong>dplyr</strong> の関数 <code>case_when()</code> を使って数値列からカテゴリを作成することは可能ですが、<strong>epikit</strong> の<code>age_categories()</code> や <code>cut()</code> を使った方が、自動的に順序付けられた要素を作成してくれるので、より簡単です。</p>
<p><code>case_when()</code> を使用する場合は、この章の「値の再定義」のセクションで説明した方法を確認してください。また、右辺にくるすべての値は同じデータ型でなければならないことに注意してください。したがって、右辺の値を <code>NA</code> にしたい場合は、“Missing”と書くか、特別な <code>NA</code> 値である <code>NA_character_</code> を使用する必要があります。</p>
</section><section id="パイプチェーンへの追加-1" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="パイプチェーンへの追加-1">パイプチェーンへの追加</h3>
<p>以下では、カテゴリ化された 2 つの年齢列を作成するコードを、前処理パイプラインに追加しています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプチェーン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################################</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプチェーンのクリーニング開始</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a><span class="do">###########################</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist_raw <span class="sc">%&gt;%</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#列名の構文の標準化</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 手動で列名を変更</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>           <span class="co"># 新しい列名             # 既存の列名</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">date_infection       =</span> infection_date,</span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_hospitalisation =</span> hosp_date,</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_outcome         =</span> date_of_outcome) <span class="sc">%&gt;%</span> </span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># remove column</span></span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 列を削除</span></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(row_num, merged_header, x28)) <span class="sc">%&gt;%</span> </span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 重複除去</span></span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 列の追加</span></span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">bmi =</span> wt_kg <span class="sc">/</span> (ht_cm<span class="sc">/</span><span class="dv">100</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span>     </span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert class of columns</span></span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 列のデータ型を変換</span></span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"date"</span>), as.Date), </span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a>           <span class="at">generation =</span> <span class="fu">as.numeric</span>(generation),</span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a>           <span class="at">age        =</span> <span class="fu">as.numeric</span>(age)) <span class="sc">%&gt;%</span> </span>
<span id="cb111-34"><a href="#cb111-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-35"><a href="#cb111-35" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 列の追加:入院の遅延</span></span>
<span id="cb111-36"><a href="#cb111-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">days_onset_hosp =</span> <span class="fu">as.numeric</span>(date_hospitalisation <span class="sc">-</span> date_onset)) <span class="sc">%&gt;%</span> </span>
<span id="cb111-37"><a href="#cb111-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-38"><a href="#cb111-38" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 病院の列の値をクリーニングする</span></span>
<span id="cb111-39"><a href="#cb111-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">recode</span>(hospital,</span>
<span id="cb111-40"><a href="#cb111-40" aria-hidden="true" tabindex="-1"></a>                         　　　<span class="co"># 既存の値 = 新しい値</span></span>
<span id="cb111-41"><a href="#cb111-41" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Mitylira Hopital"</span>  <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb111-42"><a href="#cb111-42" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Mitylira Hospital"</span> <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb111-43"><a href="#cb111-43" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Military Hopital"</span>  <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb111-44"><a href="#cb111-44" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Port Hopital"</span>      <span class="ot">=</span> <span class="st">"Port Hospital"</span>,</span>
<span id="cb111-45"><a href="#cb111-45" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Central Hopital"</span>   <span class="ot">=</span> <span class="st">"Central Hospital"</span>,</span>
<span id="cb111-46"><a href="#cb111-46" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"other"</span>             <span class="ot">=</span> <span class="st">"Other"</span>,</span>
<span id="cb111-47"><a href="#cb111-47" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"St. Marks Maternity Hopital (SMMH)"</span> <span class="ot">=</span> <span class="st">"St. Mark's Maternity Hospital (SMMH)"</span></span>
<span id="cb111-48"><a href="#cb111-48" aria-hidden="true" tabindex="-1"></a>                      )) <span class="sc">%&gt;%</span> </span>
<span id="cb111-49"><a href="#cb111-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-50"><a href="#cb111-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">replace_na</span>(hospital, <span class="st">"Missing"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb111-51"><a href="#cb111-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-52"><a href="#cb111-52" aria-hidden="true" tabindex="-1"></a>     <span class="co"># age_years列の作成（age 列と age_unit 列を使用する）</span></span>
<span id="cb111-53"><a href="#cb111-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age_years =</span> <span class="fu">case_when</span>(</span>
<span id="cb111-54"><a href="#cb111-54" aria-hidden="true" tabindex="-1"></a>          age_unit <span class="sc">==</span> <span class="st">"years"</span> <span class="sc">~</span> age,</span>
<span id="cb111-55"><a href="#cb111-55" aria-hidden="true" tabindex="-1"></a>          age_unit <span class="sc">==</span> <span class="st">"months"</span> <span class="sc">~</span> age<span class="sc">/</span><span class="dv">12</span>,</span>
<span id="cb111-56"><a href="#cb111-56" aria-hidden="true" tabindex="-1"></a>          <span class="fu">is.na</span>(age_unit) <span class="sc">~</span> age)) <span class="sc">%&gt;%</span></span>
<span id="cb111-57"><a href="#cb111-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-58"><a href="#cb111-58" aria-hidden="true" tabindex="-1"></a>     <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span id="cb111-59"><a href="#cb111-59" aria-hidden="true" tabindex="-1"></a>    <span class="do">###################################################   </span></span>
<span id="cb111-60"><a href="#cb111-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb111-61"><a href="#cb111-61" aria-hidden="true" tabindex="-1"></a>         <span class="co"># 年齢別カテゴリ：カスタマイズする</span></span>
<span id="cb111-62"><a href="#cb111-62" aria-hidden="true" tabindex="-1"></a>          <span class="at">age_cat =</span> epikit<span class="sc">::</span><span class="fu">age_categories</span>(age_years, <span class="at">breakers =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">70</span>)),</span>
<span id="cb111-63"><a href="#cb111-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb111-64"><a href="#cb111-64" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 年齢カテゴリ：0～85歳までの5段階</span></span>
<span id="cb111-65"><a href="#cb111-65" aria-hidden="true" tabindex="-1"></a>          <span class="at">age_cat5 =</span> epikit<span class="sc">::</span><span class="fu">age_categories</span>(age_years, <span class="at">breakers =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">85</span>, <span class="dv">5</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ======================================================= -->
</section></section><section id="行の追加" class="level2" data-number="8.10"><h2 data-number="8.10" class="anchored" data-anchor-id="行の追加">
<span class="header-section-number">8.10</span> 行の追加</h2>
<section id="一行ずつ追加する" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="一行ずつ追加する">一行ずつ追加する</h3>
<p>手作業で一行ずつ追加するのは面倒ですが、<strong>dplyr</strong> の <code>add_row()</code> を使えば可能です。各列は 1 つのデータ型（因子型、数字型、ロジカル型など）の値のみを含む必要があることを覚えておいてください。そのため、行の追加にはこれを維持するための微妙な調整が必要です。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_row</span>(<span class="at">row_num =</span> <span class="dv">666</span>,</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">case_id =</span> <span class="st">"abc"</span>,</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">generation =</span> <span class="dv">4</span>,</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">infection date</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.Date</span>(<span class="st">"2020-10-10"</span>),</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">.before =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>.before</code> と <code>.after.</code> を使って、追加したい行の位置を指定します。<code>.before = 3</code> は、新しい行を現在の 3 行目の前に配置します。デフォルトでは、新しい行は最後に追加されます。指定されていない列は空欄（<code>NA</code>）になります。</p>
<p>新しい<u>行番号</u>は奇妙に見えるかもしれません（“…23”）。既存の行の行番号は変更されているため、このコマンドを 2 回使用する場合は、慎重に検討・テストしてください。</p>
<p>指定したデータ型が実際のデータ型と異なる場合は、以下のようなエラーが表示されます。</p>
<pre><code>Error: Can't combine ..1$infection date &lt;date&gt; and ..2$infection date &lt;character&gt;.</code></pre>
<p>（日付の値を持つ行を挿入する際には、<code>as.Date("2020-10-10")</code> のように <code>as.Date()</code> という関数で日付を囲うことを忘れないでください）。</p>
</section><section id="複数行を結合する" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="複数行を結合する">複数行を結合する</h3>
<p>あるデータフレームの行を別のデータフレームの下部に結合してデータセットを結合するには、<strong>dplyr</strong> の <code>bind_rows()</code> を使用します。これについては、<a href="joining_matching.jp.html">データの結合</a> の章で詳しく説明しています。</p>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</section></section><section id="行の抽出フィルタリング" class="level2" data-number="8.11"><h2 data-number="8.11" class="anchored" data-anchor-id="行の抽出フィルタリング">
<span class="header-section-number">8.11</span> 行の抽出（フィルタリング）</h2>
<p>列を整理し、値を再定義した後の典型的なクリーニングステップは、<strong>dplyr</strong> の <code>filter()</code> を使ってデータフレームの特定の行を抽出（フィルタリング）することです。</p>
<p><code>filter()</code> では、データセット内の特定の行を抜き出すために、<code>TRUE</code> でなければならない論理を指定します。以下では、単純な論理条件と複雑な論理条件に基づいて行を抽出する方法を示します。</p>
<!-- ======================================================= -->
<section id="単純なフィルタリング" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="単純なフィルタリング">単純なフィルタリング</h3>
<p>以下の単純な例では、論理的な条件を満たすように行を抽出した上で、<code>linelist</code> データフレームを再定義します。括弧内の論理条件が評価され、 <code>TRUE</code> となる行のみが残ります。</p>
<p>この例では、論理条件は <code>gender == "f"</code> で、列 <code>gender</code> の値が <code>"f"</code> に等しいかどうかを問いています（大文字と小文字は区別されます）。</p>
<p>フィルタを適用する前の <code>linelist</code> の行数は <code>nrow(linelist)</code> です。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(gender <span class="sc">==</span> <span class="st">"f"</span>)   <span class="co"># 性別が "f" である行だけを残す</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>フィルタを適用した後の <code>linelist</code> の行数は <code>linelist %&gt;% filter(gender == "f") %&gt;% nrow()</code> となります。</p>
</section><section id="欠損値のフィルタリング" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="欠損値のフィルタリング">欠損値のフィルタリング</h3>
<p>欠損値のある行をフィルタリングしたいことはよくあります。<code>filter(!is.na(column) &amp; !is.na(column))</code> と書きたい気持ちを抑えて、代わりにこのためにカスタマイズされた <strong>tidyr</strong> の関数である <code>drop_na()</code> を使いましょう。空の括弧をつけて実行すると、欠損値のある行を削除します。あるいは、欠落があるか評価したい特定の列の名前を指定したり、<a href="https://epirhandbook.com/en/cleaning-data-and-core-functions.html#clean_tidyselect">上述の</a> “tidyselect”ヘルパー関数を使用することもできます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(case_id, age_years)  </span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="co"># case_idやage_yearsの値が欠損している行を削除する。</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>データの欠落の分析や管理の詳細ついては、<a href="missing_data.jp.html">欠損データの処理</a> の章をご覧ください。</p>
</section><section id="行番号によるフィルタリング" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="行番号によるフィルタリング">行番号によるフィルタリング</h3>
<p>データフレームや Tibble では、各行には通常「行番号（row number）」があり、R Viewer で見ると最初の列の左側に表示されます。これは、それ自体はデータの列ではありませんが、<code>filter()</code> を使用する際に参照することができます。</p>
<p>「行番号」に基づいてフィルタリングしたい場合は、フィルタリングの論理条件のとして、<strong>dplyr</strong> の関数 <code>row_number()</code> を空括弧付きで使用します。多くの場合、以下のように、論理条件文の一部として、<code>%in%</code> 演算子を使用して数値の範囲を指定します。<u>最初の</u> N 行を表示するには、特別な <strong>dplyr</strong> 関数 <code>head()</code> を使用することもできます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 最初の100行を表示する</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">100</span>)     </span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="co"># またはtail()を使って最後のn行を見る</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 5列目のみ表示する</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">5</span>)</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2行目から20行目までと、3つの特定の列を見る</span></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(date_onset, outcome, age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>また、データフレームを <strong>tibble</strong> 関数 <code>rownames_to_column()</code> にパイプすることで、行番号を列として変換することができます（括弧の中には何も入れないでください）。</p>
<!-- ======================================================= -->
</section><section id="複雑なフィルタリング" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="複雑なフィルタリング">複雑なフィルタリング</h3>
<p>括弧 <code>（）</code>、OR <code>｜</code>、ネゲート <code>！</code>、<code>％in％</code>、AND <code>＆</code> の各演算子を使って、より複雑な論理条件を作ることができます。その例を以下に示します。</p>
<p>注： 論理的条件の前に <code>!</code> 演算子を使うと、その後の論理的条件が否定されます。例えば、<code>！is.na(column)</code> は、列の値が欠損していない場合に真（TRUE）と評価されます。同様に、<code>！column %in% c("a", "b", "c")</code> は、列の値がベクトルに含まれていない場合に真（TRUE）と評価されます。</p>
<section id="データを調べる" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="データを調べる">データを調べる</h4>
<p>以下は、発症日のヒストグラムを作成するためのシンプルなコマンドです。この未加工データセットには、二つのアウトブレイクが含まれていることはわかります（2012～2013 年に発生した小規模なアウトブレイクと 2014～2015 年に発生した大規模なアウトブレイク）。今回の分析では、最初の小規模なアウトブレイクをラインリストから削除していきます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(linelist<span class="sc">$</span>date_onset, <span class="at">breaks =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="cleaning.jp_files/figure-html/unnamed-chunk-87-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="cleaning.jp_files/figure-html/unnamed-chunk-87-1.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="数値や日付の欠損をフィルターで処理する方法" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="数値や日付の欠損をフィルターで処理する方法">数値や日付の欠損をフィルターで処理する方法</h4>
<p><code>date_onset</code> 列で 2013 年 6 月以降の行を抽出することはできるでしょうか。これには、注意が必要です。<code>filter(date_onset &gt; as.Date("2013-06-01")))</code> というコードを適用すると、発症日が欠落している後期流行の行がすべて削除されてしまいます！</p>
<p><span style="color: red;">警告：日付や数値の「大（&gt;）」または「小（&lt;）」にフィルタリングすると、欠損値（<code>NA</code>）のある行が削除されてしまいます。これは、<code>NA</code> が無限に大きい、または小さいものとして扱われるためです。</span></p>
<p><u>(日付データと <strong>lubridat</strong>e パッケージを使用した処理については、日付データの章の <a href="https://epirhandbook.com/en/working-with-dates.html#working-with-dates-1">日付の操作</a>のセクションを参照してください。）</u></p>
</section><section id="フィルターを作成する" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="フィルターを作成する">フィルターを作成する</h4>
<p>クロス集計を行い、正しい行だけを除外していることを確認して下さい。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="at">Hospital  =</span> linelist<span class="sc">$</span>hospital,                     <span class="co">#病院名</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">YearOnset =</span> lubridate<span class="sc">::</span><span class="fu">year</span>(linelist<span class="sc">$</span>date_onset),  <span class="co">#発症した年</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">useNA     =</span> <span class="st">"always"</span>)                              <span class="co">#欠損値の表示</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                      YearOnset
Hospital                               2012 2013 2014 2015 &lt;NA&gt;
  Central Hospital                        0    0  351   99   18
  Hospital A                            229   46    0    0   15
  Hospital B                            227   47    0    0   15
  Military Hospital                       0    0  676  200   34
  Missing                                 0    0 1117  318   77
  Other                                   0    0  684  177   46
  Port Hospital                           9    1 1372  347   75
  St. Mark's Maternity Hospital (SMMH)    0    0  322   93   13
  &lt;NA&gt;                                    0    0    0    0    0</code></pre>
</div>
</div>
<p>データセットから最初のアウトブレイク（2012～2013 年に発生したアウトブレイク）を除外するために、他にどのような基準でフィルタリングできるでしょうか。次のことがわかりました。</p>
<ul>
<li><p>2012 年と 2013 年に発生した最初のアウトブレイクは、A 病院（Hospital A）と B 病院（Hospital B）で発生し、ポート病院（Port Hospital）でも10件の症例が確認されました。</p></li>
<li><p>2 回目のアウトブレイク（2014～2015 年に発生したアウトブレイク）では、A 病院（Hospital A）と B 病院（Hospital B）には症例は確認されませんでしたが、ポート病院（Port Hospital）には症例が確認されました。</p></li>
</ul>
<p>除外したい項目：</p>
<ul>
<li>
<p>A 病院（Hospital A）、 B 病院（Hospital B）、ポート病院（Port Hospital）のいずれかで 2012 年と 2013 年に発症した <code>nrow(linelist %&gt;% filter(hospital %in% c("Hospital A", "Hospital B") | date_onset &lt; as.Date("2013-06-01")))</code> の行。</p>
<ul>
<li><p>2012 年および 2013 年に発症した <code>nrow(linelist %&gt;% filter(date_onset &lt; as.Date("2013-06-01"))</code> の行を除外する。</p></li>
<li><p><code>nrow(linelist %&gt;% filter(hospital %in% c('Hospital A', 'Hospital B') &amp; is.na(date_onset)))</code> 発症日が欠落している A 病院および B 病院の行を除外する。</p></li>
<li><p><code>nrow(linelist %&gt;% filter(!hospital %in% c('Hospital A', 'Hospital B') &amp; is.na(date_onset))</code> 発症日が見つからない他の行は除外<strong>しない</strong>。</p></li>
</ul>
</li>
</ul>
<p><code>6608</code> のラインリストから始めます。以下がフィルタリングのコードです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a> <span class="co"># 発症日が2013年6月1日以降の行、または発症日が不明でA病院またはB病院以外の病院であった行を残す</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date_onset <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2013-06-01"</span>) <span class="sc">|</span> (<span class="fu">is.na</span>(date_onset) <span class="sc">&amp;</span> <span class="sc">!</span>hospital <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Hospital A"</span>, <span class="st">"Hospital B"</span>)))</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(linelist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6019</code></pre>
</div>
</div>
<p>再度クロス集計を行うと、A 病院と B 病院が完全に取り除かれ、2012 年と 2013 年のポート病院で発生した 10 件が取り除かれ、その他の値はすべて同じになっていることがわかります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="at">Hospital  =</span> linelist<span class="sc">$</span>hospital,                     <span class="co"># 病院名</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">YearOnset =</span> lubridate<span class="sc">::</span><span class="fu">year</span>(linelist<span class="sc">$</span>date_onset),  <span class="co"># 発症した年</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">useNA     =</span> <span class="st">"always"</span>)                              <span class="co"># 欠損値の表示</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                      YearOnset
Hospital                               2014 2015 &lt;NA&gt;
  Central Hospital                      351   99   18
  Military Hospital                     676  200   34
  Missing                              1117  318   77
  Other                                 684  177   46
  Port Hospital                        1372  347   75
  St. Mark's Maternity Hospital (SMMH)  322   93   13
  &lt;NA&gt;                                    0    0    0</code></pre>
</div>
</div>
<p>複数のステートメントを 1 つの <code>filter()</code> コマンドの中に含めることができます（カンマで区切ってください）。または、分かりやすくするために、常に別の <code>filter()</code> コマンドにパイプすることもできます。</p>
<p>注：<code>date_hospitalisation</code> には欠損値がないことから、読者の中には <code>date_hospitalisation</code> でフィルタリングする方が簡単だと思われる方もいるかもしれません。これは事実です。ここでは、複雑なフィルタを理解するために <code>date_onset</code> を使用しました。</p>
</section></section><section id="独立型-1" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="独立型-1">独立型</h3>
<p>フィルタリングは、（パイプチェーンの一部ではなく）独立したコマンドとしても実行できます。他の <strong>dplyr</strong> 系の関数と同様に、この場合、一番最初の引数はデータセットそのものでなければなりません。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dataframe &lt;- filter(dataframe, condition(s) for rows to keep)</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> <span class="fu">filter</span>(linelist, <span class="sc">!</span><span class="fu">is.na</span>(case_id))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>base</strong> Rを使う場合、保持したい [行、列] を、角括弧 [] を使ってサブセット（フィルタリング）することもできます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dataframe &lt;- dataframe[row conditions, column conditions] (blank means keep all)</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist[<span class="sc">!</span><span class="fu">is.na</span>(case_id), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="データを素早く確認" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="データを素早く確認">データを素早く確認</h3>
<p>数少ない行や列のデータを素早く確認したいことがよくあります。<strong>base</strong> R の <code>View()</code> を使用すると、RStudio データフレームが表示されます。</p>
<p>以下のコマンドを実行すると、RStudio でラインリストが表示されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(linelist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>特定のセル（特定の行、特定の列）を表示する 2 つの例を紹介します。</p>
<p><strong>dplyrの関数 <code>filter()</code> と <code>select()</code> を使用する</strong></p>
<p><code>View()</code> の中で、データセットを <code>filter()</code> にパイプして特定の行を残し、<code>select()</code> にパイプして特定の列を残します。例えば、特定の 3 つの症例の発症日と入院日を確認する場合です。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(linelist <span class="sc">%&gt;%</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">filter</span>(case_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"11f8ea"</span>, <span class="st">"76b97a"</span>, <span class="st">"47a5f5"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">select</span>(date_onset, date_hospitalisation))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>base</strong> R でも [ ] を使用してサブセットすると、同じことができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">View</span>(linelist[linelist<span class="sc">$</span>case_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"11f8ea"</span>, <span class="st">"76b97a"</span>, <span class="st">"47a5f5"</span>), <span class="fu">c</span>(<span class="st">"date_onset"</span>, <span class="st">"date_hospitalisation"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="パイプチェーンに追加" class="level4 unnumbered"><h4 class="unnumbered anchored" data-anchor-id="パイプチェーンに追加">パイプチェーンに追加</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプチェーン処理 (未加工データから始まり、クリーニングステップを経由してパイプで処理される)</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="do">##################################################################################</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="co"># パイプチェーンのクリーニング開始</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="do">###########################</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist_raw <span class="sc">%&gt;%</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#列名構文の標準化</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>    janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 手動で列名を変更</span></span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>           <span class="co">#新しい列名            # 既存の列名</span></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">date_infection       =</span> infection_date,</span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_hospitalisation =</span> hosp_date,</span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">date_outcome         =</span> date_of_outcome) <span class="sc">%&gt;%</span> </span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列の除去</span></span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(row_num, merged_header, x28)) <span class="sc">%&gt;%</span> </span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 重複除去</span></span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列を追加する</span></span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">bmi =</span> wt_kg <span class="sc">/</span> (ht_cm<span class="sc">/</span><span class="dv">100</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span>     </span>
<span id="cb129-26"><a href="#cb129-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-27"><a href="#cb129-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列のデータ型を変換</span></span>
<span id="cb129-28"><a href="#cb129-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"date"</span>), as.Date), </span>
<span id="cb129-29"><a href="#cb129-29" aria-hidden="true" tabindex="-1"></a>           <span class="at">generation =</span> <span class="fu">as.numeric</span>(generation),</span>
<span id="cb129-30"><a href="#cb129-30" aria-hidden="true" tabindex="-1"></a>           <span class="at">age        =</span> <span class="fu">as.numeric</span>(age)) <span class="sc">%&gt;%</span> </span>
<span id="cb129-31"><a href="#cb129-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-32"><a href="#cb129-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列の追加: 入院までの時間</span></span>
<span id="cb129-33"><a href="#cb129-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">days_onset_hosp =</span> <span class="fu">as.numeric</span>(date_hospitalisation <span class="sc">-</span> date_onset)) <span class="sc">%&gt;%</span> </span>
<span id="cb129-34"><a href="#cb129-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-35"><a href="#cb129-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 病院列の値を整える</span></span>
<span id="cb129-36"><a href="#cb129-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">recode</span>(hospital,</span>
<span id="cb129-37"><a href="#cb129-37" aria-hidden="true" tabindex="-1"></a>                      <span class="co"># OLD = NEW</span></span>
<span id="cb129-38"><a href="#cb129-38" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Mitylira Hopital"</span>  <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb129-39"><a href="#cb129-39" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Mitylira Hospital"</span> <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb129-40"><a href="#cb129-40" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Military Hopital"</span>  <span class="ot">=</span> <span class="st">"Military Hospital"</span>,</span>
<span id="cb129-41"><a href="#cb129-41" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Port Hopital"</span>      <span class="ot">=</span> <span class="st">"Port Hospital"</span>,</span>
<span id="cb129-42"><a href="#cb129-42" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"Central Hopital"</span>   <span class="ot">=</span> <span class="st">"Central Hospital"</span>,</span>
<span id="cb129-43"><a href="#cb129-43" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"other"</span>             <span class="ot">=</span> <span class="st">"Other"</span>,</span>
<span id="cb129-44"><a href="#cb129-44" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"St. Marks Maternity Hopital (SMMH)"</span> <span class="ot">=</span> <span class="st">"St. Mark's Maternity Hospital (SMMH)"</span></span>
<span id="cb129-45"><a href="#cb129-45" aria-hidden="true" tabindex="-1"></a>                      )) <span class="sc">%&gt;%</span> </span>
<span id="cb129-46"><a href="#cb129-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-47"><a href="#cb129-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hospital =</span> <span class="fu">replace_na</span>(hospital, <span class="st">"Missing"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb129-48"><a href="#cb129-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-49"><a href="#cb129-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># age_years 列を作成する (age列とage_unit列から)</span></span>
<span id="cb129-50"><a href="#cb129-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age_years =</span> <span class="fu">case_when</span>(</span>
<span id="cb129-51"><a href="#cb129-51" aria-hidden="true" tabindex="-1"></a>          age_unit <span class="sc">==</span> <span class="st">"years"</span> <span class="sc">~</span> age,</span>
<span id="cb129-52"><a href="#cb129-52" aria-hidden="true" tabindex="-1"></a>          age_unit <span class="sc">==</span> <span class="st">"months"</span> <span class="sc">~</span> age<span class="sc">/</span><span class="dv">12</span>,</span>
<span id="cb129-53"><a href="#cb129-53" aria-hidden="true" tabindex="-1"></a>          <span class="fu">is.na</span>(age_unit) <span class="sc">~</span> age)) <span class="sc">%&gt;%</span></span>
<span id="cb129-54"><a href="#cb129-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-55"><a href="#cb129-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb129-56"><a href="#cb129-56" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 年齢別カテゴリ：カスタマイズする</span></span>
<span id="cb129-57"><a href="#cb129-57" aria-hidden="true" tabindex="-1"></a>          <span class="at">age_cat =</span> epikit<span class="sc">::</span><span class="fu">age_categories</span>(age_years, <span class="at">breakers =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">70</span>)),</span>
<span id="cb129-58"><a href="#cb129-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb129-59"><a href="#cb129-59" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 年齢カテゴリ：0～85歳までの5段階</span></span>
<span id="cb129-60"><a href="#cb129-60" aria-hidden="true" tabindex="-1"></a>          <span class="at">age_cat5 =</span> epikit<span class="sc">::</span><span class="fu">age_categories</span>(age_years, <span class="at">breakers =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">85</span>, <span class="dv">5</span>)))<span class="sc">%&gt;%</span> </span>
<span id="cb129-61"><a href="#cb129-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-62"><a href="#cb129-62" aria-hidden="true" tabindex="-1"></a>      <span class="co"># ここまでは、すでに説明したクリーニング手順</span></span>
<span id="cb129-63"><a href="#cb129-63" aria-hidden="true" tabindex="-1"></a>    <span class="do">###################################################</span></span>
<span id="cb129-64"><a href="#cb129-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb129-65"><a href="#cb129-65" aria-hidden="true" tabindex="-1"></a>         <span class="co"># case_idが欠落していない行のみを残す</span></span>
<span id="cb129-66"><a href="#cb129-66" aria-hidden="true" tabindex="-1"></a>          <span class="sc">!</span><span class="fu">is.na</span>(case_id),  </span>
<span id="cb129-67"><a href="#cb129-67" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb129-68"><a href="#cb129-68" aria-hidden="true" tabindex="-1"></a>           <span class="co"># 2回目のアウトブレイクだけを残すようにフィルタリングする</span></span>
<span id="cb129-69"><a href="#cb129-69" aria-hidden="true" tabindex="-1"></a>          date_onset <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">"2013-06-01"</span>) <span class="sc">|</span> (<span class="fu">is.na</span>(date_onset) <span class="sc">&amp;</span> <span class="sc">!</span>hospital <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Hospital A"</span>, <span class="st">"Hospital B"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</section></section></section><section id="行単位の計算" class="level2" data-number="8.12"><h2 data-number="8.12" class="anchored" data-anchor-id="行単位の計算">
<span class="header-section-number">8.12</span> 行単位の計算</h2>
<p>行内で計算を行いたい場合は、<strong>dplyr</strong> の <code>rowwise()</code> を利用することができます。例えば、以下のコードでは <code>rowwise()</code> を使用し、ラインリストの各行について、値が “yes” である指定された症状の列の数を合計する新しい列を作成しています。<code>rowwise()</code> は本質的には特殊な <code>group_by()</code> であるため、終わったら <code>ungroup()</code> を使うのがベストです（詳細は、<a href="grouping.jp.html">データのグループ化</a> の章を参照ください）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">num_symptoms =</span> <span class="fu">sum</span>(<span class="fu">c</span>(fever, chills, cough, aches, vomit) <span class="sc">==</span> <span class="st">"yes"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(fever, chills, cough, aches, vomit, num_symptoms) <span class="co"># 表示のため</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,888 × 6
   fever chills cough aches vomit num_symptoms
   &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;        &lt;int&gt;
 1 no    no     yes   no    yes              2
 2 &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;            NA
 3 &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;            NA
 4 no    no     no    no    no               0
 5 no    no     yes   no    yes              2
 6 no    no     yes   no    yes              2
 7 &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;            NA
 8 no    no     yes   no    yes              2
 9 no    no     yes   no    yes              2
10 no    no     yes   no    no               1
# ℹ 5,878 more rows</code></pre>
</div>
</div>
<p>評価する列を指定する際に、この章の <code>select()</code> セクションで説明されている “tidyselect” ヘルパー関数を使用したいと思うかもしれません。その場合は、1 つだけ調整が必要です（ <code>select()</code> や <code>summarise()</code> のような <strong>dplyr</strong> 関数内で使用していないため）。</p>
<p>列指定の基準を <strong>dplyr</strong> の <code>c_across()</code> の中に入れます。これは、<code>c_across</code>（<a href="https://dplyr.tidyverse.org/reference/c_across.html">ドキュメントはこちら</a>）が、特に <code>rowwise()</code> と連動するように設計されているからです。例えば、次のようなコードです。</p>
<ul>
<li><p><code>rowwise()</code> を適用して、各行の中で以下の演算（<code>sum()</code>）が適用されます（列全体の合計ではありません）。</p></li>
<li><p>新しい列 <code>num_NA_dates</code> を作成します。これは、各行について、<code>is.na()</code> が TRUE と評価された列 （列名に “date” を含むもの） の数として定義されます（これらはデータが欠損しています）。</p></li>
<li><p><code>ungroup()</code> により、後続のステップで <code>rowwise()</code> の影響を取り除きます。</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">num_NA_dates =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(<span class="fu">c_across</span>(<span class="fu">contains</span>(<span class="st">"date"</span>))))) <span class="sc">%&gt;%</span> </span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(num_NA_dates, <span class="fu">contains</span>(<span class="st">"date"</span>)) <span class="co"># for display</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,888 × 5
   num_NA_dates date_infection date_onset date_hospitalisation date_outcome
          &lt;int&gt; &lt;date&gt;         &lt;date&gt;     &lt;date&gt;               &lt;date&gt;      
 1            1 2014-05-08     2014-05-13 2014-05-15           NA          
 2            1 NA             2014-05-13 2014-05-14           2014-05-18  
 3            1 NA             2014-05-16 2014-05-18           2014-05-30  
 4            1 2014-05-04     2014-05-18 2014-05-20           NA          
 5            0 2014-05-18     2014-05-21 2014-05-22           2014-05-29  
 6            0 2014-05-03     2014-05-22 2014-05-23           2014-05-24  
 7            0 2014-05-22     2014-05-27 2014-05-29           2014-06-01  
 8            0 2014-05-28     2014-06-02 2014-06-03           2014-06-07  
 9            1 NA             2014-06-05 2014-06-06           2014-06-18  
10            1 NA             2014-06-05 2014-06-07           2014-06-09  
# ℹ 5,878 more rows</code></pre>
</div>
</div>
<p>また、<code>max()</code> のような他の関数を使用し、各行の最新または直近の日付を取得することもできます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">latest_date =</span> <span class="fu">max</span>(<span class="fu">c_across</span>(<span class="fu">contains</span>(<span class="st">"date"</span>)), <span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> </span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(latest_date, <span class="fu">contains</span>(<span class="st">"date"</span>))  <span class="co"># for display</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,888 × 5
   latest_date date_infection date_onset date_hospitalisation date_outcome
   &lt;date&gt;      &lt;date&gt;         &lt;date&gt;     &lt;date&gt;               &lt;date&gt;      
 1 2014-05-15  2014-05-08     2014-05-13 2014-05-15           NA          
 2 2014-05-18  NA             2014-05-13 2014-05-14           2014-05-18  
 3 2014-05-30  NA             2014-05-16 2014-05-18           2014-05-30  
 4 2014-05-20  2014-05-04     2014-05-18 2014-05-20           NA          
 5 2014-05-29  2014-05-18     2014-05-21 2014-05-22           2014-05-29  
 6 2014-05-24  2014-05-03     2014-05-22 2014-05-23           2014-05-24  
 7 2014-06-01  2014-05-22     2014-05-27 2014-05-29           2014-06-01  
 8 2014-06-07  2014-05-28     2014-06-02 2014-06-03           2014-06-07  
 9 2014-06-18  NA             2014-06-05 2014-06-06           2014-06-18  
10 2014-06-09  NA             2014-06-05 2014-06-07           2014-06-09  
# ℹ 5,878 more rows</code></pre>
</div>
</div>
</section><section id="並び替えアレンジとソート" class="level2" data-number="8.13"><h2 data-number="8.13" class="anchored" data-anchor-id="並び替えアレンジとソート">
<span class="header-section-number">8.13</span> 並び替え（アレンジとソート）</h2>
<p><strong>dplyr</strong> の <code>arrange()</code>を使用し、列の値で行を並べ替えたり、順番に並べたりします。</p>
<p>単純に、並び替えたい順に列を列挙します。データに適用されたグループ化を最初並べ替えたい場合は、<code>.by_group = TRUE</code> と指定します（<a href="grouping.jp.html">データのグループ化</a> の章を参照）。</p>
<p>デフォルトでは、列は「昇順」で並び替えされます（これは、数字や文字の列にも適用されます）。変数を <code>desc()</code> で囲むと、「降順」で並び替えできます。</p>
<p><code>arrange()</code> によるデータの並び替えは、<a href="tables_presentation.jp.html">プレゼンテーション用のテーブルを作成するとき</a> や、<code>slice()</code> を使ってグループごとに「上位」の行を抽出するとき、あるいは因子レベルの順序を出現順に設定するときなどに特に便利です。</p>
<p>例えば、<code>linelist</code> デーフレームの行を病院別（<code>hospital</code> 列）に並び替え、次に出現日（<code>date_onset</code> 列）の降順で並び替える場合は、次のようになります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>linelist <span class="sc">%&gt;%</span> </span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(hospital, <span class="fu">desc</span>(date_onset))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../new_pages/importing.jp.html" class="pagination-link" aria-label="データのインポート・エクスポート">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>  <span class="chapter-title">データのインポート・エクスポート</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../new_pages/dates.jp.html" class="pagination-link" aria-label="日付型データ">
        <span class="nav-page-text"><span class="chapter-number">9</span>  <span class="chapter-title">日付型データ</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
       
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div>
</div>
    <div class="nav-footer-right">
       
    </div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"openEffect":"zoom","loop":false,"descPosition":"bottom","closeEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>
</body>
</html>
