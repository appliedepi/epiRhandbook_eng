<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="jp" xml:lang="jp"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>疫学のための R ハンドブック - 16&nbsp; ループと反復処理・リストの操作</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../new_pages/tables_descriptive.jp.html" rel="next">
<link href="../new_pages/deduplication.jp.html" rel="prev">
<link href="../images/Applied_Epi_logo.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QXDW878QLX', { 'anonymize_ip': true});
</script>
<!-- Global site tag (gtag.js) - Google Analytics 
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QXDW878QLX');
</script> -->

</head><body class="nav-sidebar floating"><div class="alert alert-info alert-dismissible">
  <!-- <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
  <strong>Need help learning R?</strong> Enroll in Applied Epi's <a href="https://www.appliedepi.org/live/"
    class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/"
    class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/"
    class="alert-link">Community Q&A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org"
    class="alert-link">R Help Desk service</a>. -->
</div>

<script>

  // Function to extract the last two characters from the URL path to determine the language, adjusting for .html extension
  function getLanguageFromURL() {
    let path = window.location.pathname;
    
    // Check if the URL ends with .html and remove it
    if (path.endsWith('.html')) {
      path = path.substring(0, path.length - 5);
    }

    // Extract the last two characters for the language code
    const lang = path.substr(-2);
    return lang;
  }

  const language = getLanguageFromURL();
  const supportedLanguages = ['fr', 'es', 'vn', 'jp', 'pt', 'tr', 'ru'];
  const defaultLanguage = 'en';
  const isSupportedLanguage = supportedLanguages.includes(language);

  // Translations for the content
  const translations = {
    en: '<strong>Need help learning R?</strong> Enroll in Applied Epi\'s <a href="https://www.appliedepi.org/live/" class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/" class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/" class="alert-link">Community Q&A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org" class="alert-link">R Help Desk service</a>.',
    fr: '<strong>Besoin d\'aide pour apprendre R ?</strong> Inscrivez-vous au <a href="https://www.appliedepi.org/live/" class="alert-link">cours d\'introduction à R</a> d\'Applied Epi, essayez nos <a href="https://www.appliedepi.org/tutorial/" class="alert-link">tutoriels R gratuits</a>, postez dans notre forum de <a href="https://community.appliedepi.org/" class="alert-link">questions-réponses communautaires</a>, ou demandez-nous des informations sur <a href="mailto:contact@appliedepi.org" class="alert-link"> notre service d\'assistance R</a>.',
    es: '<strong>¿Necesitas ayuda para aprender R?</strong> Inscríbete en el <a href="https://www.appliedepi.org/live/" class="alert-link">Curso de introducción a R</a> de Applied Epi, prueba nuestros <a href="https://www.appliedepi.org/tutorial/" class="alert-link">Tutoriales gratuitos de R</a>, escribe en nuestro <a href="https://community.appliedepi.org/" class="alert-link">Foro de preguntas y respuestas,</a> o pregunta por nuestra <a href="mailto:contact@appliedepi.org" class="alert-link">Asistencia técnica para R</a>.',
    vn: '<strong>Bạn cần giúp đỡ trong việc học R?</strong> Hãy đăng ký khóa học R cơ bản của Applied Epi tại <a href="https://www.appliedepi.org/live/" class="alert-link">đây</a>, hoặc thử các <a href="https://www.appliedepi.org/tutorial/" class="alert-link">hướng dẫn R miễn phí</a>, đăng bài trong <a href="https://community.appliedepi.org/" class="alert-link">diễn đàn cộng đồng</a>, hoặc gửi câu hỏi tới <a href="mailto:contact@appliedepi.org" class="alert-link">dịch vụ Trợ giúp R</a> của chúng tôi.',
    jp: '<strong>Rの学習について助けが必要ですか？</strong>Applied Epiの<a href="https://www.appliedepi.org/live/" class="alert-link">R入門コース</a>に登録するか、<a href="https://www.appliedepi.org/tutorial/" class="alert-link">無料Rチュートリアル</a>を試すか、<a href="https://community.appliedepi.org/" class="alert-link">コミュニティQ＆Aフォーラム</a>に投稿するか、<a href="mailto:contact@appliedepi.org" class="alert-link">Rヘルプデスクサービス</a>についてお問い合わせください。',
    pt: '<strong>Você precisa de ajuda para aprender R??</strong> Inscreva-se no curso de <a href="https://www.appliedepi.org/live/" class="alert-link">introdução ao R da Applied Epi</a>, experimente nossos <a href="https://www.appliedepi.org/tutorial/" class="alert-link">tutoriais gratuitos sobre o R</a>, publique em nosso <a href="https://community.appliedepi.org/" class="alert-link">fórum de perguntas e respostas</a>, ou solicite nosso <a href="mailto:contact@appliedepi.org" class="alert-link">suporte ao R</a>.',
    tr: '<strong>R öğrenmekte yardıma mı ihtiyacınız var?</strong> Applied Epi\'\nin <a href="https://www.appliedepi.org/live/" class="alert-link">R\'ye giriş kursuna</a> kaydolun, <a href="https://www.appliedepi.org/tutorial/" class="alert-link">ücretsiz R derslerimizi</a> deneyin, <a href="https://community.appliedepi.org/" class="alert-link">Topluluk Q&A forumunda</a> soru paylaşın, ya da <a href="mailto:contact@appliedepi.org" class="alert-link">R Yardım Masası hizmetimiz</a> hakkında sorun.',
    ru: '<strong>Нужна помощь в изучении R?</strong> Запишитесь на <a href="https://www.appliedepi.org/live/" class="alert-link">вводный курс по R</a> от Applied Epi, попробуйте наши <a href="https://www.appliedepi.org/tutorial/" class="alert-link">бесплатные учебные материалы по R</a>, задайте вопрос в нашем <a href="https://community.appliedepi.org/" class="alert-link">форуме вопросов и ответов сообщества</a>, или спросите о нашей услуге <a href="mailto:contact@appliedepi.org" class="alert-link">Службы поддержки по R</a>.'
  };

  // Default to English if the detected language is not supported
  const contentToDisplay = translations[isSupportedLanguage ? language : defaultLanguage];


  // Select the element where the content should be displayed
  const alertElement = document.querySelector('.alert');
  if (alertElement) {
    alertElement.innerHTML = contentToDisplay;
    alertElement.style.display = 'block'; // Make sure to display the element
  }

</script>
<link href="../site_libs/htmltools-fill-0.5.8/fill.css" rel="stylesheet">
<script src="../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../site_libs/datatables-binding-0.31/datatables.js"></script>
<script src="../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="../site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>






<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../new_pages/cleaning.jp.html">データマネジメント</a></li><li class="breadcrumb-item"><a href="../new_pages/iteration.jp.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">ループと反復処理・リストの操作</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/Applied_Epi_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">疫学のための R ハンドブック</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://twitter.com/appliedepi" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
    <a href="https://www.linkedin.com/company/appliedepi/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="https://github.com/appliedepi/epihandbook_quarto" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">いらっしゃいませ</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">本書について</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/editorial_style.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">編集前記・技術注記</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/data_used.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">ハンドブックとデータのダウンロード</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">基本編</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/basics.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R の基礎</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/transition_to_R.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Excel・Stata・SASとの比較</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/packages_suggested.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">推奨パッケージ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/r_projects.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R プロジェクト</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/importing.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">データのインポート・エクスポート</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">データマネジメント</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/cleaning.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">データクリーニングと主要関数</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/dates.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">日付型データ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/characters_strings.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">文字型・文字列型データ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/factors.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">因子（ファクタ）型データ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/pivoting.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">データの縦横変換</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/grouping.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">データのグループ化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/joining_matching.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">データの結合</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/deduplication.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">重複データの排除</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/iteration.jp.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">ループと反復処理・リストの操作</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">データ分析</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/tables_descriptive.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">記述統計表の作り方</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/stat_tests.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">基本的な統計的検定</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/regression.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">単変量と多変量回帰</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/missing_data.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">データの欠損</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/standardization.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">標準化率</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/moving_average.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">移動平均</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/time_series.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">時系列分析とアウトブレイクの検出{#time-series}</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/epidemic_models.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">エピデミックモデリング</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/contact_tracing.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">接触者の追跡{#contact-tracing}</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/survey_analysis.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">標本調査データ分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/survival_analysis.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">生存時間解析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/gis.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">GIS の基本</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">データの可視化</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/tables_presentation.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">見やすい表の作り方</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/ggplot_basics.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">ggplot の基本</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/ggplot_tips.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">ggplotのヒント</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/epicurves.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">流行曲線（エピカーブ）</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/age_pyramid.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">人口ピラミッドとリッカート尺度</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/heatmaps.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">ヒートマップ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/diagrams.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">フローチャート・サンキー図・タイムライン</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/combination_analysis.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">複数回答データの分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/transmission_chains.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">感染連鎖</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/phylogenetic_trees.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">系統樹</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/interactive_plots.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">動的な図の作成</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">レポートとダッシュボード</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/rmarkdown.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">R Markdown で作るレポート</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/reportfactory.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">ルーチンで作成するレポートの整理</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/flexdashboard.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">R Markdownで作るダッシュボード</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/shiny_basics.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Shiny で作るダッシュボード</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">その他</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/writing_functions.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">関数の作成</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/directories.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">ディレクトリの操作</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/collaboration.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Git と Github を使ったバージョン管理と共同作業</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/errors.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">よくあるエラー</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/help.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">ヘルプ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/network_drives.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">ネットワークドライブで R を使用する場合</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/data_table.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">data.table パッケージを使用したデータ処理</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#準備" id="toc-準備" class="nav-link active" data-scroll-target="#準備"><span class="header-section-number">16.1</span> 準備</a>
  <ul class="collapse">
  <li><a href="#パッケージを読み込む" id="toc-パッケージを読み込む" class="nav-link" data-scroll-target="#パッケージを読み込む">パッケージを読み込む</a></li>
  <li><a href="#データをインポートする" id="toc-データをインポートする" class="nav-link" data-scroll-target="#データをインポートする">データをインポートする</a></li>
  </ul></li>
  <li><a href="#for-ループ" id="toc-for-ループ" class="nav-link" data-scroll-target="#for-ループ"><span class="header-section-number">16.2</span> <u>for ループ</u></a>
  <ul class="collapse">
  <li><a href="#iter_loops" id="toc-iter_loops" class="nav-link" data-scroll-target="#iter_loops">R における <u>for ループ</u></a></li>
  <li><a href="#中心となる要素" id="toc-中心となる要素" class="nav-link" data-scroll-target="#中心となる要素">中心となる要素</a></li>
  <li><a href="#シーケンス" id="toc-シーケンス" class="nav-link" data-scroll-target="#シーケンス">シーケンス</a></li>
  <li><a href="#オペレーション" id="toc-オペレーション" class="nav-link" data-scroll-target="#オペレーション">オペレーション</a></li>
  <li><a href="#コンテナ" id="toc-コンテナ" class="nav-link" data-scroll-target="#コンテナ">コンテナ</a></li>
  <li><a href="#コンテナを使用せず結果を表示する" id="toc-コンテナを使用せず結果を表示する" class="nav-link" data-scroll-target="#コンテナを使用せず結果を表示する">コンテナを使用せず結果を表示する</a></li>
  <li><a href="#for-ループの動作確認を行う" id="toc-for-ループの動作確認を行う" class="nav-link" data-scroll-target="#for-ループの動作確認を行う">for ループの動作確認を行う</a></li>
  <li><a href="#プロットをループする" id="toc-プロットをループする" class="nav-link" data-scroll-target="#プロットをループする">プロットをループする</a></li>
  <li><a href="#ループの進捗状況を確認する" id="toc-ループの進捗状況を確認する" class="nav-link" data-scroll-target="#ループの進捗状況を確認する">ループの進捗状況を確認する</a></li>
  </ul></li>
  <li><a href="#iter_purrr" id="toc-iter_purrr" class="nav-link" data-scroll-target="#iter_purrr"><span class="header-section-number">16.3</span> <strong>purrr</strong> とリスト</a>
  <ul class="collapse">
  <li><a href="#パッケージを読み込む-1" id="toc-パッケージを読み込む-1" class="nav-link" data-scroll-target="#パッケージを読み込む-1">パッケージを読み込む</a></li>
  <li><a href="#map" id="toc-map" class="nav-link" data-scroll-target="#map"><code>map()</code></a></li>
  <li><a href="#データセットを分割しエクスポートする" id="toc-データセットを分割しエクスポートする" class="nav-link" data-scroll-target="#データセットを分割しエクスポートする">データセットを分割しエクスポートする</a></li>
  <li><a href="#カスタム関数" id="toc-カスタム関数" class="nav-link" data-scroll-target="#カスタム関数">カスタム関数</a></li>
  <li><a href="#複数列に対して関数をマッピングする" id="toc-複数列に対して関数をマッピングする" class="nav-link" data-scroll-target="#複数列に対して関数をマッピングする">複数列に対して関数をマッピングする</a></li>
  <li><a href="#リストから抽出する" id="toc-リストから抽出する" class="nav-link" data-scroll-target="#リストから抽出する">リストから抽出する</a></li>
  <li><a href="#リストをデータフレームに変換する" id="toc-リストをデータフレームに変換する" class="nav-link" data-scroll-target="#リストをデータフレームに変換する">リストをデータフレームに変換する</a></li>
  <li><a href="#リストを捨てる保持するコンパクトにする" id="toc-リストを捨てる保持するコンパクトにする" class="nav-link" data-scroll-target="#リストを捨てる保持するコンパクトにする">リストを捨てる・保持する・コンパクトにする</a></li>
  <li><a href="#pmap" id="toc-pmap" class="nav-link" data-scroll-target="#pmap"><code>pmap()</code></a></li>
  </ul></li>
  <li><a href="#apply-関数" id="toc-apply-関数" class="nav-link" data-scroll-target="#apply-関数"><span class="header-section-number">16.4</span> Apply 関数</a></li>
  <li><a href="#参考資料" id="toc-参考資料" class="nav-link" data-scroll-target="#参考資料"><span class="header-section-number">16.5</span> 参考資料</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../new_pages/cleaning.jp.html">データマネジメント</a></li><li class="breadcrumb-item"><a href="../new_pages/iteration.jp.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">ループと反復処理・リストの操作</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="iteration" class="quarto-section-identifier"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">ループと反復処理・リストの操作</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>疫学業務担当者は、国、地域、年齢などによって層別化されたグループを対象に、同じ分析を繰り返し行う必要があります。他にも、非常に多くの場面で<u>反復処理</u>が必要となります。この章では、このような反復処理をより速く、より正確に、そしてより短いコードで行う方法を解説します。</p>
<p>本章では、反復処理を行うための2つの方法、すなわち、<u>for ループ</u>を使用する方法と <strong>purrr</strong> パッケージを使用する方法を紹介します。</p>
<ol type="1">
<li><p>一連の入力されたデータ（本章では、インプット（input）と呼ぶ）に対してコードを反復する <u>for ループ</u>は、他のプログラミング言語に比べて R ではあまり一般的ではありませんが、ここでは学習の一貫として参考までに紹介します。</p></li>
<li><p><strong>purrr</strong> パッケージは、反復処理を行うためのパッケージであり、<strong>tidyverse</strong> パッケージに含まれています。値、列、データセットなどのインプットに対して関数を「マッピング（mapping）」し、反復処理を行います。</p></li>
</ol>
<p>本章では主に、以下の項目に関し、いくつか例を用いて説明します。</p>
<ul>
<li>複数のファイルのインポート・エクスポート</li>
<li>複数の管轄区ごとの流行曲線（エピカーブ）の作成</li>
<li>データフレーム内の複数の列に対する t 検定の実行</li>
</ul>
<p>また、<a href="#iter_purrr">16.3 purrr とリスト</a> では、<code>リスト（list）</code> の作成と処理の例をいくつか紹介します。</p>
<section id="準備" class="level2" data-number="16.1">
<h2 data-number="16.1" class="anchored" data-anchor-id="準備"><span class="header-section-number">16.1</span> 準備</h2>
<section id="パッケージを読み込む" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="パッケージを読み込む">パッケージを読み込む</h3>
<p>以下のコードを実行すると、分析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、pacman パッケージの p_load() を主に使用しています。p_load() は、必要に応じてパッケージをインストールし、現在の R セッションで使用するためにパッケージを読み込む関数です。また、すでにインストールされたパッケージは、R の基本パッケージである base （以下、base R）の library() を使用して読み込むこともできます。R のパッケージに関する詳細は <a href="basics.jp.html">R の基礎</a> の章をご覧ください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>     rio,         <span class="co"># インポート・エクスポートのためのパッケージ</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>     here,        <span class="co"># ファイルの場所の指定のためのパッケージ</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>     purrr,       <span class="co"># 反復処理のためのパッケージ</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>     grates,      <span class="co"># scales in ggplot</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>     tidyverse    <span class="co"># データ管理と視覚化のためのパッケージ</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="データをインポートする" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="データをインポートする">データをインポートする</h3>
<p>エボラ出血熱の流行をシミュレートしたデータセットをインポートします。お手元の環境でこの章の内容を実行したい方は、 <a href="https://github.com/appliedepi/epiRhandbook_eng/raw/master/data/case_linelists/linelist_cleaned.rds" class="download-button">クリック</a>して「前処理された」ラインリスト（linelist）データをダウンロードしてください&gt;（.rds 形式で取得できます）。データは <em>rio</em> パッケージの import() を利用してインポートしましょう（<em>rio</em> パッケージは、.xlsx、.csv、.rds など様々な種類のファイルを取り扱うことができます。詳細は、<a href="importing.jp.html">インポートとエクスポート</a> の章をご覧ください。）</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ラインリストをインポートする</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"linelist_cleaned.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ラインリストの始めの 50 行は、以下の通りです。</p>
<div class="cell">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-24c858b6fd8d7b400e99" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-24c858b6fd8d7b400e99">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08",null,null,"2014-05-04","2014-05-18","2014-05-03","2014-05-22","2014-05-28",null,null,"2014-05-30","2014-05-28","2014-06-14","2014-06-07","2014-06-09",null,null,null,"2014-06-23","2014-06-18","2014-06-24",null,null,"2014-07-03",null,"2014-07-10","2014-06-14",null,"2014-06-18","2014-06-29","2014-07-02","2014-07-12","2014-07-12","2014-06-13","2014-07-15","2014-06-20",null,null,"2014-07-20",null,"2014-07-12","2014-07-19","2014-07-18","2014-07-18","2014-07-27",null,"2014-07-19","2014-07-26","2014-07-24",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15","2014-05-14","2014-05-18","2014-05-20","2014-05-22","2014-05-23","2014-05-29","2014-06-03","2014-06-06","2014-06-07","2014-06-08","2014-06-15","2014-06-17","2014-06-17","2014-06-20","2014-06-19","2014-06-23","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-03","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-13","2014-07-14","2014-07-14","2014-07-13","2014-07-14","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-20","2014-07-22","2014-07-24","2014-07-26","2014-07-24","2014-07-27","2014-07-25","2014-07-27","2014-07-31","2014-08-01","2014-08-03","2014-08-02","2014-08-02","2014-08-04"],[null,"2014-05-18","2014-05-30",null,"2014-05-29","2014-05-24","2014-06-01","2014-06-07","2014-06-18","2014-06-09","2014-06-15",null,"2014-07-09",null,"2014-06-30","2014-07-11","2014-07-01","2014-06-25","2014-07-06","2014-07-02","2014-07-09","2014-07-07","2014-07-20",null,"2014-07-22","2014-07-16","2014-07-14","2014-07-20","2014-07-16","2014-07-19","2014-07-27","2014-07-19",null,"2014-07-26","2014-08-14","2014-08-01","2014-07-23","2014-08-28","2014-07-28","2014-07-19",null,"2014-08-03",null,null,null,"2014-08-06","2014-08-21","2014-09-13","2014-08-04",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["m","f","m","f","m","f","f","f","m","f","m","m","m","f","f","m","f","f","f","f","m","m","f","m","f","m","m","f","m","f","f","f","m","m","f","m","f","f","f","m","f","m","f","m","m","f","m","f","m","m"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["0-4","0-4","50-69","15-19","0-4","15-19","15-19","0-4","50-69","20-29","10-14","30-49","15-19","5-9","5-9","10-14","30-49","15-19","10-14","10-14","15-19","50-69","10-14","20-29","5-9","0-4","30-49","5-9","50-69","10-14","10-14","20-29","20-29","30-49","0-4","10-14","0-4","15-19","20-29","30-49","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-29","20-29","10-14"],["0-4","0-4","55-59","15-19","0-4","15-19","15-19","0-4","60-64","25-29","10-14","40-44","15-19","5-9","5-9","10-14","35-39","15-19","10-14","10-14","15-19","50-54","10-14","25-29","5-9","0-4","30-34","5-9","65-69","10-14","10-14","20-24","20-24","45-49","0-4","10-14","0-4","15-19","20-24","35-39","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-24","25-29","10-14"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing","Port Hospital","Military Hospital","Missing","Missing","Other","Port Hospital","Port Hospital","Port Hospital","Missing","Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Missing","Other","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital","Missing","Military Hospital","Other","Missing","Missing","Port Hospital","Port Hospital","Port Hospital","Missing","Central Hospital","Military Hospital","Other","Other","Other","Missing","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","Missing"],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.461830626007281,8.462729314626459,8.461443675342711,8.46191259217774,8.472923276435059,8.48401630165138,8.458371253408441,8.477617055125091,8.47570184950483,8.477799468789719,8.47145134147474,8.478048406853629,8.48528034195779,8.469575303958671,8.45957352078114,8.474048895115439,8.488029171298839,8.473437335922,8.484082637344621,8.46242233645879,8.470268221265719,8.463984474805329,8.464134789434199,8.456230946296071,8.48334624336805,8.47493999153642,8.47832062438022,8.469393389176499,8.48480589906514,8.47121232619015,8.48438437371817,8.484661585743391,8.477141599844281,8.462381270106089,8.455685978131131,8.4632880274758,8.47940722413856,8.46353857052336,8.461789681588639,8.47508713872833,8.458258081280711,8.4532568143863,8.4732571907655,8.479115866419329,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","no","no","no","no","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","yes","no",null,"no","no","no","yes","no",null,"no","no","yes",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","yes","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes",null,"yes","yes","yes","yes","yes",null,"yes","yes","yes",null,null,"yes","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","yes","yes","yes","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","yes","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"yes","yes",null,"no","no",null,"no","no","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","no","yes","no","no","no","yes","no","no","no",null,"no","yes","no","no","no",null,"no","no","no",null,null,"no","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","no","yes","yes","yes",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],[117.1875,71.81844297615629,16.06524962926347,22.49657064471879,71.41440190438405,41.61712247324614,62.09538908706566,0,16.83765369253662,22.79032897344431,53.41198979591836,24.28026361429067,22.46003435064077,54.32098765432099,41.05784325564545,28.56648199445983,17.03205520132763,25.04129149128882,38.7172182043977,27.3876813705495,31.55555555555556,14.80690759456621,30.88398111998135,26.61934338952972,59.37499999999999,96.61835748792272,19.23947487550928,84.94031221303948,18.41993774061044,27.77226740726046,41.32231404958677,17.20806665861611,24.16716240333135,15.72189710891781,428.9940828402366,27.99302202929125,243.2610124917817,20.23950075898128,30.52744643563797,25.15589569160998,47,39.04,31.06616432017979,77.96836711962574,29.51659612385831,166.4932362122789,100.3086419753086,37.76,20.60378034578518,23.45856237526698],[2,1,2,2,1,1,2,1,1,2,2,2,1,0,2,0,1,1,2,2,1,1,1,0,2,1,1,2,1,0,0,2,1,1,2,2,1,0,2,2,0,2,0,0,2,2,null,1,0,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]},{"name":"case_id","targets":0},{"name":"generation","targets":1},{"name":"date_infection","targets":2},{"name":"date_onset","targets":3},{"name":"date_hospitalisation","targets":4},{"name":"date_outcome","targets":5},{"name":"outcome","targets":6},{"name":"gender","targets":7},{"name":"age","targets":8},{"name":"age_unit","targets":9},{"name":"age_years","targets":10},{"name":"age_cat","targets":11},{"name":"age_cat5","targets":12},{"name":"hospital","targets":13},{"name":"lon","targets":14},{"name":"lat","targets":15},{"name":"infector","targets":16},{"name":"source","targets":17},{"name":"wt_kg","targets":18},{"name":"ht_cm","targets":19},{"name":"ct_blood","targets":20},{"name":"fever","targets":21},{"name":"chills","targets":22},{"name":"cough","targets":23},{"name":"aches","targets":24},{"name":"vomit","targets":25},{"name":"temp","targets":26},{"name":"time_admission","targets":27},{"name":"bmi","targets":28},{"name":"days_onset_hosp","targets":29}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<!-- ======================================================= -->
</section>
</section>
<section id="for-ループ" class="level2" data-number="16.2">
<h2 data-number="16.2" class="anchored" data-anchor-id="for-ループ"><span class="header-section-number">16.2</span> <u>for ループ</u></h2>
<section id="iter_loops" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="iter_loops">R における <u>for ループ</u></h3>
<p><u>for ループ</u>は R ではあまり一般的ではありませんが、他のプログラミング言語では頻繁に使用されています。初心者の方にとって、for ループは反復処理ごとに何が起こっているのかを正確に把握しやすく、コードの確認やデバッグがしやすいため、反復処理の学習や練習に役立ちます。</p>
<p><u>for ループ</u>を扱うこのセクションを飛ばして、<strong>purrr</strong> パッケージでマッピングした関数を使用し反復処理を行う方法を紹介する <a href="#iter_purrr">16.3 purrr とリスト</a> に移動しても構いません。</p>
</section>
<section id="中心となる要素" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="中心となる要素">中心となる要素</h3>
<p><u>for ループ</u>は以下の 3 つの主要な部分から成り立っています。</p>
<ol type="1">
<li>繰り返し実行するアイテムの<strong>シーケンス</strong></li>
<li>シーケンス内の各アイテムに対して実行される<strong>オペレーション</strong></li>
<li>結果を格納する<strong>コンテナ</strong> （必須ではなく、必要な場合のみ作成する）</li>
</ol>
<p>以下に示しているように、基本的な構文は <code>for (アイテム in シーケンス) {アイテムを用いたオペレーションの指示}</code>です。括弧と波括弧の違いに注意してください。結果は、コンソールに出力したり、コンテナに格納したりすることができます。</p>
<p>簡単な <u>for ループ</u>の例を以下に示します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (num <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>)) {  <span class="co"># シーケンスの定義（1 から 5 の数）と "{" によるループの開始</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(num <span class="sc">+</span> <span class="dv">2</span>)             <span class="co"># オペレーション（それぞれのシーケンス内の数に 2 を足して表示してください）</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>}                            <span class="co"># "}" によるループの終了                            </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3
[1] 4
[1] 5
[1] 6
[1] 7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>                             <span class="co"># この例では、結果をコンテナに格納していない</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="シーケンス" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="シーケンス">シーケンス</h3>
<p>これは、<u>for ループ</u>において “for” で示されている部分です。オペレーションはシーケンス内の各アイテムに対して（“for” each item）実行されます。シーケンスには、一連の値（管轄区名、疾患名、列名、リスト要素など）や、一連の連続した数値（1, 2, 3, 4, 5 など）を指定することができます。以下で説明するように、それぞれに実用性があります。</p>
<p>シーケンス文の基本構造は、<code>アイテム in ベクトル</code>です．</p>
<ul>
<li>「アイテム」の部分には任意の文字や単語を書くことができます（例：“i”, “num”, “hosp”, “district” など）。この「アイテム」の値は、ループを繰り返すたびにベクトル内の各値に、指定された順番で変化していきます。</li>
<li><u>ベクトル</u>には、文字列や列名、あるいは数字列などを用いることが出来ます。ループを繰り返すたびに変化していく値であり、これらの値は、「アイテム」を用いたオペレーションの指示により、「for ループ」 の中で使用されます。</li>
</ul>
<p><strong>例：文字列のシーケンス</strong></p>
<p>この例では、あらかじめ病院名の文字ベクトルを定義し、その各値に対してループを実行します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 病院名のベクトルを作成する</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>hospital_names <span class="ot">&lt;-</span> <span class="fu">unique</span>(linelist<span class="sc">$</span>hospital)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>hospital_names <span class="co"># 作成したベクトルを表示する</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Other"                               
[2] "Missing"                             
[3] "St. Mark's Maternity Hospital (SMMH)"
[4] "Port Hospital"                       
[5] "Military Hospital"                   
[6] "Central Hospital"                    </code></pre>
</div>
</div>
<p>ここでは、<code>hospital_names</code> の値を、<code>hosp</code> という単語を使って示しています。一番最初に実行されるループでは、<code>hosp</code> の値は <code>hospital_names[[1]]</code> 、2 回目のループでは <code>hospital_names[[2]]</code> となります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 文字列シーケンスに対する 'for ループ'</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (hosp <span class="cf">in</span> hospital_names){       <span class="co"># シーケンス</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>       <span class="co"># オペレーションがここに来る</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>例：列名のシーケンス</strong></p>
<p>これは、上記の文字列のシーケンスの変形で、既存の R オブジェクトの名前（例えば、データフレームの列名など）を抽出してベクトルとしたシーケンスです。便利なことに、<u>for ループ</u>のオペレーションコードでは、列名を用いて元のデータフレームを<u>指定する</u>（サブセットする）ことが出来ます。</p>
<p>下の例では、<code>linelist</code> データフレームの <code>names()</code>（列名）がシーケンスです。「アイテム」の名前は <code>col</code> で、ループが繰り返すに従い、その表す値が各列名に変化します。</p>
<p>例として、<u>for ループ</u>の中に、シーケンスの値ごとに実行されるオペレーションを加えます。この例では、シーケンスの値（列名）を使って、<code>linelist</code> の列名を一つずつ<u>指定して</u>（サブセットして）います。オペレーションコードでは、<a href="basics.jp.html">R の基礎</a> の章で説明したように、二重角括弧 <code>[[ ]]</code> を使用してサブセットします。そして、ループにより指定された列は <code>is.na()</code>、次に <code>sum()</code> に渡され、列内の欠損値の数を算出します。結果として、コンソールに欠損値の数が各列ごとに表示されます。</p>
<p>列名を用いてインデックスする場合の注意点：列自体を指定したいときには、 <u>単に “col” と書いてはいけません！</u> <code>col</code> は、単に列の名前を表しています。列内の値全体を指定するには、<code>linelist[[col]]</code> と書いて列名を <code>linelist</code> の<u>インデックス</u>として使用する必要があります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (col <span class="cf">in</span> <span class="fu">names</span>(linelist)){        <span class="co"># linelist内の各列に対するループ：列名は "col" で表されている</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># オペレーションコードの例：各列の欠損地の数を表示する </span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">sum</span>(<span class="fu">is.na</span>(linelist[[col]])))  <span class="co"># "col"の値は反復処理の繰り返しごとに変化し、linelist は "col" のその時々の値によってインデックスされる</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0
[1] 0
[1] 2087
[1] 256
[1] 0
[1] 936
[1] 1323
[1] 278
[1] 86
[1] 0
[1] 86
[1] 86
[1] 86
[1] 0
[1] 0
[1] 0
[1] 2088
[1] 2088
[1] 0
[1] 0
[1] 0
[1] 249
[1] 249
[1] 249
[1] 249
[1] 249
[1] 149
[1] 765
[1] 0
[1] 256</code></pre>
</div>
</div>
<p><strong>例：数字のシーケンス</strong></p>
<p>次は、連続した数字の列をシーケンスとして用いる例を説明します。「アイテム」の値は文字値（“Central Hospital” や “date_onset” など）ではなく数字となり、データフレームをループする際に便利です。<u>for ループ</u>内で「アイテム」の番号を使うことで、データフレームを<u>行番号</u>でインデックスすることができます。</p>
<p>例えば、データフレーム内のすべての行をループして、ある情報を抽出したい場合、「アイテム」は行番号になります。この場合、「アイテム」は <code>i</code> と書かれることが多いです。</p>
<p><u>for ループ</u>の処理を言葉で説明すると、「1 からデータフレームの行の総数までの数からなるシーケンス内のすべてのアイテムに対して、X を行う」となります。一番最初に実行されるループでは、「アイテム」<code>i</code> の値は 1 です。2 回目のループでは、<code>i</code> は 2 になります。</p>
<p>このシーケンスをコードにすると、次のようになります：<code>for (i in 1:nrow(linelist)) {#オペレーションのコード}</code>。<code>i</code> は「アイテム」を表し、<code>1:nrow(linelist)</code> は、1 から <code>linelist</code> の総行数までの連続した数字からなるシーケンスを表しています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(linelist)) {  <span class="co"># データフレームに対して使用</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># オペレーションのコードがここに来る</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>}  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>シーケンスを数字にしたいが、（データフレームではなく）ベクトルを用いる場合は、 <code>seq_along()</code> を使うことで、ベクトルの各要素に対する添字のシーケンスを得ることが出来ます。例えば、<code>for (i in seq_along(hospital_names) {#オペレーションのコード}</code> とします。</p>
<p>以下のコードによって添字を得ることができ、その添字がループの <code>i</code> の値になります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">seq_along</span>(hospital_names)  <span class="co"># 名前のついているベクトルに対して使用</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3 4 5 6</code></pre>
</div>
</div>
<p>シーケンスに添字を使うと、ループの出力結果を格納する<u>コンテナ</u>のインデックスとして、<code>i</code> 番号を簡単に使用できるという利点があります。詳しくは、次のオペレーションのセクションで例を示して説明します。</p>
</section>
<section id="オペレーション" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="オペレーション">オペレーション</h3>
<p>オペレーションは、<u>for ループ</u>の中の波括弧 <code>{ }</code> の中に記述されているコードのことです。オペレーションコードは、<u>シーケンス</u>内の各「アイテム」ごとに実行される必要があります。したがって、「アイテム」によって変化するコードの各部分が、実際に変化するように正しくコードされているか注意する必要があります。例えば、インデックスには <code>[[ ]]</code> を使うことを忘れないでください。</p>
<p>以下の例では、<code>linelist</code> データフレームの各行に対して反復処理を実行します。各行の <code>gender</code> と <code>age</code> の値を結合し、文字ベクトルのコンテナである <code>cases_demographics</code> に格納する作業を行います。また、<code>[[i]]</code> を使ってインデックスすることで、ループの出力結果を「コンテナ」のベクトルの正しい位置に保存しているところもポイントです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 結果を格納するコンテナを作成する：文字ベクトル</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>cases_demographics <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"character"</span>, <span class="at">length =</span> <span class="fu">nrow</span>(linelist))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for ループ</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(linelist)){</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># オペレーション</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 角括弧をインデックスに用いることで、linelist の i 行の値を取り出す</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  row_gender  <span class="ot">&lt;-</span> linelist<span class="sc">$</span>gender[[i]]</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  row_age     <span class="ot">&lt;-</span> linelist<span class="sc">$</span>age_years[[i]]    <span class="co"># インデックスを忘れずに！</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># genderとageを結合し、コンテナのベクトル内のインデックスされた場所に格納する</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  cases_demographics[[i]] <span class="ot">&lt;-</span> <span class="fu">str_c</span>(row_gender, row_age, <span class="at">sep =</span> <span class="st">","</span>) </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>}  <span class="co"># ループの終了</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 最初の 10 行を表示する</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cases_demographics, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "m,2"  "f,3"  "m,56" "f,18" "m,3"  "f,16" "f,16" "f,0"  "m,61" "f,27"</code></pre>
</div>
</div>
</section>
<section id="コンテナ" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="コンテナ">コンテナ</h3>
<p><u>for ループ</u>の結果はコンソールに表示したり、RStudio プロットペインに出力したりすることができます。また、後で使用するためにループの実行結果を「コンテナ」に保存しておきたい場合もあります。出力を保存するコンテナとして、ベクトル、データフレーム、あるいはリストなどを使用することが出来ます。</p>
<p>出力結果を保存するコンテナは、<u>for ループ</u>を開始する<u>前に</u>、データが何も入っていない空のベクトル、データフレーム、またはリストを作成するのが最も効率的です。空のコンテナは、ベクトルやリストの場合は <code>vector()</code> で、データフレームの場合は <code>matrix()</code> や <code>data.frame()</code> を使用して作成することができます。</p>
<p><strong>空のベクトルを作成する</strong></p>
<p><code>vector()</code> を使用し、ループの出力結果を挿入するオブジェクトの想定されるデータ型を <code>mode =</code> で指定します（数値データを格納する “double”、“character”、または “logical”のいずれかを指定）。また、事前に <code>length =</code> を指定する必要があります。これは、<u>for ループ</u>のシーケンスの長さになります。</p>
<p>例えば、各病院の入院までの時間の中央値を格納したいとします。その場合、“double” を使用し、予想される出力数（ここではデータセット内の病院の数）を length として設定します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>delays <span class="ot">&lt;-</span> <span class="fu">vector</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"double"</span>,                            <span class="co"># 数値データを格納する</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(linelist<span class="sc">$</span>hospital))) <span class="co"># データセット内の病院の数</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>空のデータフレームを作成する</strong></p>
<p>下のコードのように、行と列の数を指定することで、空のデータフレームを作ることができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>delays <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>空のリストを作成する</strong></p>
<p><u>for ループ</u>で作成した図（プロット）をリストに格納したい場合は、空のリストを作成します。リストとベクトルは似ていますが、リストは複数の異なるデータ型の R オブジェクトを格納することが出来ます。リストの中のアイテムは、数値、データフレーム、ベクトル、を取ることができることのほか、別のリストを取ることもできます。</p>
<p>空のリストを作成する際には、ベクトルを作成した時と同じように <code>vector()</code> を使用しますが、<code>mode = "list"</code> とする必要があります。長さは好きなように指定してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="コンテナを使用せず結果を表示する" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="コンテナを使用せず結果を表示する">コンテナを使用せず結果を表示する</h3>
<p>なお、<u>for ループ</u>内で出力結果を表示する場合は、<code>print()</code> で指示する必要があります。</p>
<p>以下の例では、シーケンスは文字ベクトルであり、これを使用して病院ごとにラインリストをサブセットしています。結果はコンテナには保存されず、<code>print()</code> によってコンソールに出力されています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (hosp <span class="cf">in</span> hospital_names){ </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>     hospital_cases <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> <span class="fu">filter</span>(hospital <span class="sc">==</span> hosp)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">print</span>(<span class="fu">nrow</span>(hospital_cases))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 885
[1] 1469
[1] 422
[1] 1762
[1] 896
[1] 454</code></pre>
</div>
</div>
</section>
<section id="for-ループの動作確認を行う" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="for-ループの動作確認を行う">for ループの動作確認を行う</h3>
<p>意図したようにループが動作するか確認するために、<code>i &lt;- 10</code> や <code>hosp &lt;- "Central Hospital"</code> など、「アイテム」を一時的に代入するコマンドを実行します。これを<u>ループの外</u>で行い、その後、オペレーションコードのみ（波括弧内のコード）を実行し、期待通りの結果が得られるかを確認します。</p>
</section>
<section id="プロットをループする" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="プロットをループする">プロットをループする</h3>
<p>前述した 3 つの要素（コンテナ、シーケンス、オペレーション）をすべて使用し、各病院の流行曲線（エピカーブ）を作成してみましょう（流行曲線についての詳細は、<a href="epicurves.jp.html">流行曲線（エピカーブ）</a> の章をご覧ください）。</p>
<p>まず、<strong>incidence2</strong> パッケージを使用し、<u>すべて</u>の症例を性別ごとに色分けした流行曲線を作成します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 'incidence' のオブジェクトを作成する</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>outbreak <span class="ot">&lt;-</span> incidence2<span class="sc">::</span><span class="fu">incidence</span>(   </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">x =</span> linelist,                   <span class="co"># データフレームを指定する（linelist全体）</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">date_index =</span> <span class="st">"date_onset"</span>,      <span class="co"># 日付の列</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">interval =</span> <span class="st">"week"</span>,              <span class="co"># 週ごとに集計</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">groups =</span> <span class="st">"gender"</span>)              <span class="co"># 性別によるグルーピング</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>     <span class="co">#na_as_group = TRUE)            # 性別の欠損値は欠損のグループ（NA）として扱う</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 流行曲線をプロットする</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(outbreak, <span class="co"># nom de l'objet d'incidence</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date_index, <span class="co">#aesthetiques et axes</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> count, </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> gender), <span class="co"># Fill colour of bars by gender</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"black"</span>      <span class="co"># Contour colour of bars</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>       ) <span class="sc">+</span>  </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_col</span>() <span class="sc">+</span> </span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>     <span class="fu">facet_wrap</span>(<span class="sc">~</span>gender) <span class="sc">+</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>     <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>     <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Outbreak of all cases"</span>, <span class="co">#titre</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> <span class="st">"Counts"</span>, </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>          <span class="at">y =</span> <span class="st">"Date"</span>, </span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">"Gender"</span>, </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"Gender"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.jp_files/figure-html/unnamed-chunk-16-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="iteration.jp_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>次に、各病院ごとに個別のプロットを作成するためには、この流行曲線のコードを <u>for ループ</u>の中に入れる必要があります。</p>
<p><u>for ループを作成する最初の</u>ステップとして、病院名の入ったベクトル <code>hospital_names</code> を保存します。作成する<u>for ループ</u>は、病院の名前ごとに、各病院一度だけ実行されます：<code>for (hosp in hospital_names)</code>。<code>hosp</code> の値は、<u>for ループ</u>が繰り返されるたびに、ベクトル内のそれぞれの病院名を表し、ループ内で使用されます。</p>
<p>ループ内では、通常通り R のコードを書くことができますが、「アイテム」（この場合は <code>hosp</code>）の値が変化することに注意してください。このループ内では、</p>
<ul>
<li>列 <code>hospital</code> が <code>hosp</code> の値と同じになるように、<code>linelist</code> に <code>filter()</code> を適用しています。</li>
<li>incidence オブジェクトは、フィルタリングされたラインリストに対して作成されています。</li>
<li>プロットには、各病院ごとに <code>hosp</code> を用いたタイトルが自動生成されます。</li>
<li>病院ごとに作成された各プロットは、一時的に保存され、そして表示されます。</li>
<li>ループは次の繰り返しを実行し、<code>hospital_names</code> 内の次の病院に対して同じオペレーションが繰り返されます。</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 病院名が格納されたベクトルを作成する</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>hospital_names <span class="ot">&lt;-</span> <span class="fu">unique</span>(linelist<span class="sc">$</span>hospital)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># hospital_names 内のそれぞれの病院名（"hosp"）ごとに、流行曲線を作成し表示する</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (hosp <span class="cf">in</span> hospital_names) {</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 反復処理ごとにその時々の病院に対して incidence オブジェクトを作成する</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>     outbreak_hosp <span class="ot">&lt;-</span> incidence2<span class="sc">::</span><span class="fu">incidence</span>(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> linelist <span class="sc">%&gt;%</span> <span class="fu">filter</span>(hospital <span class="sc">==</span> hosp),   <span class="co"># 現在反復処理が行われている病院名によって linelist をフィルタリングする</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">date_index =</span> <span class="st">"date_onset"</span>,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">interval =</span> <span class="st">"week"</span>, </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">groups =</span> <span class="st">"gender"</span><span class="co">#,</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>          <span class="co">#na_as_group = TRUE</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>     <span class="co"># プロットを作成し保存する</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>     <span class="co"># タイトルは現在反復処理が行われている病院名に合わせて自動生成される</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>     plot_hosp <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(outbreak_hosp, <span class="co"># incidence object name</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">aes</span>(<span class="at">x =</span> date_index, <span class="co">#axes</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>                             <span class="at">y =</span> count, </span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>                             <span class="at">fill =</span> gender), <span class="co"># fill colour by gender</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>                         <span class="at">color =</span> <span class="st">"black"</span>      <span class="co"># colour of bar contour</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>                         ) <span class="sc">+</span>  </span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">geom_col</span>() <span class="sc">+</span> </span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">facet_wrap</span>(<span class="sc">~</span>gender) <span class="sc">+</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>          <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>          <span class="fu">labs</span>(<span class="at">title =</span> stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"Epidemic of cases admitted to {hosp}"</span>), <span class="co">#title</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">x =</span> <span class="st">"Counts"</span>, </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">y =</span> <span class="st">"Date"</span>, </span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">"Gender"</span>, </span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"Gender"</span>)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>     <span class="co"># With older versions of R, remove the # before na_as_group and use this plot command instead.</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot_hosp &lt;- plot(</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="co">#       outbreak_hosp,</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="co">#       fill = "gender",</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="co">#       color = "black",</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="co">#       title = stringr::str_glue("Epidemic of cases admitted to {hosp}")</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 現在反復処理が行われている病院のプロットを表示する</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>     <span class="fu">print</span>(plot_hosp)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>} <span class="co"># hospital_names 内の全ての病院名に対してオペレーションが行われた後、for ループを終了する </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.jp_files/figure-html/unnamed-chunk-17-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="iteration.jp_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.jp_files/figure-html/unnamed-chunk-17-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="iteration.jp_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.jp_files/figure-html/unnamed-chunk-17-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="iteration.jp_files/figure-html/unnamed-chunk-17-3.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.jp_files/figure-html/unnamed-chunk-17-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="iteration.jp_files/figure-html/unnamed-chunk-17-4.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.jp_files/figure-html/unnamed-chunk-17-5.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="iteration.jp_files/figure-html/unnamed-chunk-17-5.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.jp_files/figure-html/unnamed-chunk-17-6.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="iteration.jp_files/figure-html/unnamed-chunk-17-6.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="ループの進捗状況を確認する" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ループの進捗状況を確認する">ループの進捗状況を確認する</h3>
<p>反復回数の多いループは、実行終了までに何分、何時間もかかることがあるため、進捗状況を R のコンソールに表示すると便利です。以下の <code>if</code> 文をループのオペレーションの<u>中に</u>配置することで、100 番目の数字ごとに結果を表示することができます。コード内で用いる際には、<code>i</code> が自分の作成したループ内の「アイテム」となるように適宜変更してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 進捗を 100 回の反復処理のたびに示すループ</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(linelist))){</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print progress</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">%%</span> <span class="dv">100</span><span class="sc">==</span><span class="dv">0</span>){    <span class="co"># 演算子 %% は剰余を示す</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(i)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ======================================================= -->
</section>
</section>
<section id="iter_purrr" class="level2" data-number="16.3">
<h2 data-number="16.3" class="anchored" data-anchor-id="iter_purrr"><span class="header-section-number">16.3</span> <strong>purrr</strong> とリスト</h2>
<p>反復処理のもう一つの方法として、<strong>purrr</strong> パッケージを使用する方法があります。<strong>purrr</strong> パッケージは <strong>tidyverse</strong> パッケージに含まれている反復処理を行うパッケージです。</p>
<p>同じタスクを何度も実行する必要がある場合、汎用性の高い方法を習得していると非常に便利です。この方法は、複数の管轄区域のプロットを作成する際や、多くのファイルをインポートして結合する際などに多くの場面で用いることができます。</p>
<p><strong>purrr</strong> パッケージには他にもいくつか利点があり、パイプ <code>%&gt;%</code> と一緒に使用できること、通常の <u>for ループ</u>よりもエラー処理に優れていること、そして構文が非常にすっきりとしてシンプルであること、などが挙げられます。もし <u>for ループ</u>を使っているのであれば、<strong>purrr</strong> パッケージを使うことでより明確で簡潔にコードを書くことができるでしょう。</p>
<p>コードを書く際は、<strong>purrr</strong> パッケージが<u>関数型のプログラミングツール</u>であることを念頭に置いて進める必要があり、繰り返し適用されるオペレーションは、<u>関数</u>内に示す必要があります。関数を書く方法について詳細を知りたい方は、<a href="writing_functions.jp.html">関数の作成</a> の章をご覧ください。</p>
<p>また、<strong>purrr</strong> パッケージに含まれる関数は、多くの場合<u>リスト</u>と<u>ベクトル</u>に対して働くので、リストやベクトルの各要素に関数を適用すると考えてください！</p>
<section id="パッケージを読み込む-1" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="パッケージを読み込む-1">パッケージを読み込む</h3>
<p><strong>purrr</strong> パッケージは <strong>tidyverse</strong> パッケージの一部なので、別々にパッケージをインストールする・読み込む必要はありません。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>     rio,            <span class="co"># インポート・エクスポート</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>     here,           <span class="co"># ファイルパス</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>     tidyverse,      <span class="co"># データの管理と視覚化</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>     writexl,        <span class="co"># 複数のシートを含むExcelファイルを作成</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>     readxl          <span class="co"># 複数のシートを含むExcelファイルをインポート</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="map" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="map"><code>map()</code></h3>
<p><strong>purrr</strong> パッケージの中核となる関数の一つが <code>map()</code> です。<code>map()</code>は、与えられたリストやベクトルの各インプット要素に関数を「マッピング（mapping）」する（適用する）関数です。</p>
<p>基本的な構文は <code>map(.x = シーケンス, .f = 関数, その他の引数)</code> です。もう少し詳しく説明すると、</p>
<ul>
<li><code>.x =</code> は、<code>.f</code> 関数が繰り返し適用される<u>インプット</u>であり、例えば、管轄区名のベクトル、データフレームの列、またはデータフレームのリストです。</li>
<li><code>.f =</code> は、入力 <code>.x</code> の各要素に対して適用される<u>関数</u>です。これは、すでに存在する <code>print()</code> のような関数でも、自分で定義したカスタム関数でも構いません。関数は、チルダ（<code>~</code>）の後に書かれることが多いです（詳細は後述します）。</li>
</ul>
<p>構文を作成する際は、以下の点についてご注意ください。</p>
<ul>
<li>関数がそれ以上引数を指定する必要がない場合は、括弧やチルダを使わずに書くことができます（例：<code>.f = mean</code>）。全ての反復処理において同じ値になる引数がある場合、<code>map()</code> の中、かつ <code>.f =</code> の外で指定します（例：<code>map(.x = my_list, .f = mean, na.rm = T)</code> の <code>na.rm = T</code>）。</li>
<li><code>.x</code>（または単に<code>.</code>）は、反復処理の <code>.x</code> 値の代用値として、<code>.f =</code> 関数<u>の中</u>で使用することができます。</li>
<li>関数をより細かく設定するには、チルダ構文（<code>~</code>）を使用してください。関数を、括弧を用いて通常通り書いてください（例: <code>map(.x = my_list, .f = ~mean(., na.rm = T))</code>）。特に、引数の値が反復処理ごとに変化する場合や、値が <code>.x</code> 自体である場合には、この構文を使用してください（以下の例を参照ください）。</li>
</ul>
<p><strong><code>map()</code> を用いた際の出力は<u>リスト</u>になります。</strong>リストはベクトルに似ていますが、構成要素が異なります。リストには、多くのデータフレーム、多くのベクトル、多くの単一の値、あるいは多くのリストが含まれる可能性があります。以下に説明するように、他のタイプの出力を生成する <code>map()</code> の代替関数があります（例えば、データフレームを生成する <code>map_dfr()</code>、文字ベクトルを生成する <code>map_chr()</code>、数字ベクトルを生成する <code>map_dbl()</code> など）。</p>
<section id="iter_combined" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="iter_combined">例：エクセルシートをインポートし、結合する</h4>
<p><strong>疫学業務担当者の一般的なタスクを用いて説明します。</strong>例えば、症例データの入った Excel ファイルをインポートしたいが、ファイルには異なる名前シートが複数含まれており、その複数のシートに分かれて症例データが保存されている場合です。どうすれば複数のシートを効率的にインポートして 1 つのデータフレームにまとめることができるでしょうか？</p>
<p>以下のような Excel ファイルが送られてきたとします。病院ごとにシートが分かれており、各シートにはそれぞれの病院の症例が含まれています。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/hospital_linelists_excel_sheets.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="../images/hospital_linelists_excel_sheets.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="615"></a></p>
</figure>
</div>
</div>
</div>
<p>ここでは、<code>map()</code> を使った方法を紹介します。</p>
<ol type="1">
<li><code>import()</code> を、各エクセルシートごとに実行するように <code>map()</code> する。</li>
<li>インポートされた複数のデータフレームを <code>bind_rows()</code> を使用して結合し、一つのデータフレームにまとめる。</li>
<li>一つにまとめる際、元の Excel シートの名前を新しい列に保存する。最終的なデータフレームで、各行の症例が、元々はどの Excel シートに保存されていたのか（どの病院で報告されたのか）をわかるようにする。</li>
</ol>
<p>まず、シート名を抽出してオブジェクトに格納する必要があります。<strong>readxl</strong> パッケージの <code>excel_sheets()</code> にエクセルファイルのパスを渡し、シート名を抽出します。抽出されたシート名は、<code>sheet_names</code> という文字ベクトルに格納されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>sheet_names <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">excel_sheets</span>(<span class="st">"hospital_linelists.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>各シートの名前は、以下の通りです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>sheet_names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Central Hospital"              "Military Hospital"            
[3] "Missing"                       "Other"                        
[5] "Port Hospital"                 "St. Mark's Maternity Hospital"</code></pre>
</div>
</div>
<p>これでシート名を格納したベクトルができたので、<code>map()</code> を用いて <code>import()</code> に 1 つずつ病院の名前を渡すことができます。この例では、<code>sheet_names</code> が <code>.x</code> であり、<code>import()</code> が <code>.f</code> となります。</p>
<p><a href="importing.jp.html">インポートとエクスポート</a> の章で説明したように、Excel ファイルで <code>import()</code> を使用する場合、引数 <code>which =</code> を用いてインポートするシートを指定することができます。<code>map()</code> の <code>.f</code> 関数に <code>import()</code> を使用し、 <code>import()</code> 内で <code>which = .x</code> と指定すると、反復処理を繰り返すたびに、ベクトル <code>sheet_names</code> の表す値が変化します。反復処理の最初の 1 回目では “Central Hospital” 、2 回目には “Military Hospital” となります。</p>
<p>注意点としては、<code>map()</code> を使用しているので、各 Excel シートのデータは、別々のデータフレームとしてリスト内に保存されることです。各リスト要素（リスト内に保存される各データフレーム）に適切な<u>名前</u>を付けるために、<code>sheet_names</code> を <code>map()</code> に渡す前に、<strong>purrr</strong> パッケージの <code>set_names()</code> に渡しています。</p>
<p>反復処理で作成されるリストは <code>combined</code> という名前で保存されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> sheet_names <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">set_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">import</span>(<span class="st">"hospital_linelists.xlsx"</span>, <span class="at">which =</span> .x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>反復処理後に出力されたリストを確認すると、各 Excel シートのデータが名前付きリストに保存されていることがわかります。ここまで順調ですが、まだ完成形ではありません。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/sheets_as_list.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="../images/sheets_as_list.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="544"></a></p>
</figure>
</div>
</div>
</div>
<p>最後に、<strong>dplyr</strong> パッケージの <code>bind_rows()</code> を使用します。これは、互いに似たような構造をもつ複数のデータフレームが含まれたリストを受け取り、それらを 1 つのデータフレームに結合する関数です。リスト要素の<u>名前</u>（この例では、病院名）から新しい列を作成するために、引数 <code>.id =</code> を使用して新しい列に必要な名前を指定します。</p>
<p>以下が一連のコマンドの流れです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>sheet_names <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">excel_sheets</span>(<span class="st">"hospital_linelists.xlsx"</span>)  <span class="co"># シート名を抽出する</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> sheet_names <span class="sc">%&gt;%</span>                                     <span class="co"># シート名から開始</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">set_names</span>() <span class="sc">%&gt;%</span>                                        <span class="co"># 名前を指定</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">import</span>(<span class="st">"hospital_linelists.xlsx"</span>, <span class="at">which =</span> .x)) <span class="sc">%&gt;%</span>  <span class="co"># 反復処理を行い、インポートし、リストに保存する</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"origin_sheet"</span>) <span class="co"># データフレームのリストを結合し、新しい列に元データのシート名を保存する  </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これで元のシート名が保存された列を含むデータフレームができました！</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/sheets_as_df.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="../images/sheets_as_df.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="543"></a></p>
</figure>
</div>
</div>
</div>
<p><code>map()</code> には様々なバリエーションがあります。例えば、<code>map_dfr()</code> はリストではなく、データフレームを返します。そのため、上記のタスクに使用する場合、<code>bind_rows()</code> を使用して行を結合する必要はありません。しかし、各症例がどのシート（病院）のものかは把握できません。</p>
<p><code>map()</code> には他にも、<code>map_chr()</code> や <code>map_dbl()</code> があり、次の 2 つの理由から非常に便利な関数だと言えます。第一に、反復処理の出力を（リストではなく）ベクトルに自動的に変換してくれます。第二に、データがどのような形式で返ってくるかを指定することが出来ます。<code>map_chr()</code> では文字ベクトル、<code>map_dbl()</code> では数値ベクトルとしてデータが戻ってきます。詳細は、本章で後詳します！</p>
<p>また、 <code>map_at()</code> と <code>map_if()</code> も反復処理を行う際に非常に便利な関数です。<code>map_at()</code> を使用する場合はインデックス・名前のベクトルを、<code>map_if()</code> を使用する場合は論理条件（logical test）を適用するだけで、リストのどの要素を反復処理するかを指定することができます。</p>
<p>例えば、前述の各病院の症例データについて、1 枚目のシートをインポートしたくない場合を考えてみましょう。この場合、<code>map()</code> の代わりに <code>map_at()</code> を使用し、<code>.at =</code> の引数に <code>c(-1)</code> を指定します。これは、インプット <code>.x</code> の最初の要素を使用<em>しない</em>ことを意味します。また、<code>.at =</code> に正の数のベクトルや名前を指定して、使用する要素を指定することもできます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>sheet_names <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">excel_sheets</span>(<span class="st">"hospital_linelists.xlsx"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> sheet_names <span class="sc">%&gt;%</span> </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>     purrr<span class="sc">::</span><span class="fu">set_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>     <span class="co"># 1枚目のシートは除く</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">map_at</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">import</span>( <span class="st">"hospital_linelists.xlsx"</span>, <span class="at">which =</span> .x),</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">.at =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>1 枚目のシート名が出力リストの要素として表示されますが、これは単なる文字名（データフレームではない）になっています。行を結合する前には、この要素を削除する必要があります。リストの要素を削除したり変更したりする方法については、本章で後述します。</p>
</section>
</section>
<section id="データセットを分割しエクスポートする" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="データセットを分割しエクスポートする">データセットを分割しエクスポートする</h3>
<p>以下では、一つのデータセットを複数のデータセットに分割し、分割されたデータセットを <code>map()</code> の反復処理を使用してそれぞれ別々の Excel シートまたは CSV ファイルとしてエクスポートする方法を例示します。</p>
<section id="データを分割する" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="データを分割する">データを分割する</h4>
<p>例えば、複数の病院から報告された症例を含んだデータフレーム <code>linelist</code> があり、報告元の病院ごとに個別のラインリストを作成し、それぞれを個別の CSV ファイルとしてエクスポートしたい場合、次のような手順で行います。</p>
<p><strong>dplyr</strong> パッケージの <code>group_split()</code> を使用して、データフレーム <code>linelist</code> を <code>hospital</code> 列内の値で分割します。これにより、病院別のデータフレームからなるリストが出力されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>linelist_split <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">group_split</span>(hospital)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>View(linelist_split)</code> を実行すると、このリストは 6 つのデータフレーム（“tibbles”）からなり、それぞれのデータフレームが各病院で報告された症例を含んでいることがわかります。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/purrr_linelist_split.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="../images/purrr_linelist_split.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="574"></a></p>
</figure>
</div>
</div>
</div>
<p>ただし、リスト内のデータフレームには、デフォルトでは名前が付いていないことに注意してください！次のステップでは、それぞれのデータフレームに名前を付け、CSV ファイルでエクスポートする際にはその名前を使うようにしていきます。</p>
<p>名前を抽出する方法として、<strong>dplyr</strong> パッケージの <code>pull()</code> を使用し、リストの各データフレームから <code>hospital</code> 列を抽出する方法があります。次に、エラーが起こらないように念のため、抽出された値を文字に変換し、<code>unique()</code> を使用してデータフレームの名前（ここでは、病院名）を抽出します。そして、これらのすべてのステップを <code>map()</code> によって各データフレームに適用します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist_split) <span class="ot">&lt;-</span> linelist_split <span class="sc">%&gt;%</span>   <span class="co"># リスト化されたデータフレームの名前を指定する </span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>     <span class="co"># それぞれのデータフレームに以下の関数を適用することで、名前を抽出する </span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">pull</span>(.x, hospital)) <span class="sc">%&gt;%</span>        <span class="co"># hospital 列を取り出す</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">as.character</span>(.x)) <span class="sc">%&gt;%</span>          <span class="co"># 取り出した値を、念のため、文字に変換する</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">unique</span>(.x))                    <span class="co"># 病院名を抽出する</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これで、リストの各要素に名前を付けることができました。付けられた名前は、 <code>names(linelist_split)</code> を実行すると確認できます。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/purrr_linelist_split_named.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="../images/purrr_linelist_split_named.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="575"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Central Hospital"                    
[2] "Military Hospital"                   
[3] "Missing"                             
[4] "Other"                               
[5] "Port Hospital"                       
[6] "St. Mark's Maternity Hospital (SMMH)"</code></pre>
</div>
</div>
<section id="つ以上の列を用いた-group_split" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="つ以上の列を用いた-group_split">2 つ以上の列を用いた <code>group_split()</code></h5>
<p>例えば、病院と性別の組み合わせでラインリストを分割するなど、<u>複数の列（変数）によって</u>ラインリストを分割したい場合は、リストの要素に名前を付ける方法が異なります。この場合は、まず、<strong>dplyr</strong> パッケージの <code>group_keys()</code> を使用し、病院と性別の組み合わせすべてに対して「グループキー」を作成します（グループキーは、データフレームとして作成されます）。そして、二列に渡って作成されたグループキーを、以下のように <code>unite()</code> を使用して一つの値に結合し、結合した組み合わせ名を <code>linelist_split</code> に割り当てます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ラインリストを病院と性別のすべての組み合わせによって分割する</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>linelist_split <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">group_split</span>(hospital, gender)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># グループキーをデータフレームとして抽出する</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>groupings <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">group_by</span>(hospital, gender) <span class="sc">%&gt;%</span>       </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>     <span class="fu">group_keys</span>()</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>groupings      <span class="co"># グループキーを表示する </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 × 2
   hospital                             gender
   &lt;chr&gt;                                &lt;chr&gt; 
 1 Central Hospital                     f     
 2 Central Hospital                     m     
 3 Central Hospital                     &lt;NA&gt;  
 4 Military Hospital                    f     
 5 Military Hospital                    m     
 6 Military Hospital                    &lt;NA&gt;  
 7 Missing                              f     
 8 Missing                              m     
 9 Missing                              &lt;NA&gt;  
10 Other                                f     
11 Other                                m     
12 Other                                &lt;NA&gt;  
13 Port Hospital                        f     
14 Port Hospital                        m     
15 Port Hospital                        &lt;NA&gt;  
16 St. Mark's Maternity Hospital (SMMH) f     
17 St. Mark's Maternity Hospital (SMMH) m     
18 St. Mark's Maternity Hospital (SMMH) &lt;NA&gt;  </code></pre>
</div>
</div>
<p>以下のコードでは、それぞれの組み合わせをダッシュで結合し、それを <code>linelist_split</code> のリスト要素の名前に割り当てます。まず、<code>NA</code> を “Missing” に置き換え、次に、<strong>dplyr</strong> パッケージの <code>unite()</code> を使って列の値をダッシュで結合します。そして、無名のベクトルに変換し、<code>linelist_split</code> のリスト要素の名前として使えるようにします。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 一つの名前の値に結合する </span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist_split) <span class="ot">&lt;-</span> groupings <span class="sc">%&gt;%</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), replace_na, <span class="st">"Missing"</span>)) <span class="sc">%&gt;%</span>  <span class="co"># 全ての列において NA を "Missing" に置き換える</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">unite</span>(<span class="st">"combined"</span>, <span class="at">sep =</span> <span class="st">"-"</span>) <span class="sc">%&gt;%</span>                         <span class="co"># 全ての列の値を一つに結合する</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">setNames</span>(<span class="cn">NULL</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">as_vector</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">as.list</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="excel-シートとして出力する" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="excel-シートとして出力する">Excel シートとして出力する</h4>
<p><strong>writexl</strong> パッケージの <code>write_xlsx()</code> に各リスト要素に名前が付いた <code>linelist_split</code> を渡すことで、<u>シートごとに 1 つの病院の</u>ラインリストを含んだ Excel ファイルとして出力することができます。<code>write_xlsx()</code> は、複数のシートからなる Excel ファイルをエクスポートする機能があり、リスト要素の名前が各シートの名前として自動的に適用されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>linelist_split <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>     writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(<span class="at">path =</span> <span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"hospital_linelists.xlsx"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Excel ファイルを開くと、症例がデータが病院ごとに複数のシートに分割されて保存されているのが確認できます。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/purrr_export_sheets.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="../images/purrr_export_sheets.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="652"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="csvファイルとして出力する" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="csvファイルとして出力する">CSVファイルとして出力する</h4>
<p>少し複雑になりますが、それぞれの病院個別のラインリストを、CSV ファイルとして出力することもできます。ファイルの名前をそれぞれの病院の名前として出力します。</p>
<p>今回も <code>map()</code> を使用します。前述したように、リスト要素の名前（病院名）が含まれたベクトルを <code>map()</code> に渡し、<code>linelist_split</code> リスト内の要素（データフレーム）に <strong>rio</strong> パッケージの <code>export()</code> を繰り返し適用します（<code>export()</code> についての詳細は、<a href="importing.jp.html">インポートとエクスポート</a> の章をご覧ください）。また、リスト要素の名前は、エクスポートする各 CSV ファイルのファイル名として使用します。以下に、CSV ファイルとして出力する方法を示します。</p>
<ul>
<li><p>まず、病院の名前が含まれた文字値ベクターを <code>.x</code> として <code>map()</code> に与えます</p></li>
<li><p><code>.f</code> 関数を <code>export()</code> とし、エクスポートするデータフレームとエクスポート先となるファイルパスを指定します</p></li>
<li><p>入力された <code>.x</code>（病院名）は <code>.f</code> <u>の中において</u>、<code>linelist_split</code> リスト内のインデックスとなります。反復処理が繰り返すたびに一つのデータフレームが <code>export()</code> に渡されます。</p></li>
<li><p>例えば、“Military Hospital” の症例データに対して <code>map()</code> が適用されている時は、<code>linelist_split[[.x]]</code> は実際には <code>linelist_split[["Military Hospital"]]</code> となり、 <code>linelist_split</code> の 2 番目のリスト要素（“Military Hospital” の全章例を含むデータフレーム）が返されます。</p></li>
<li><p><code>export()</code> で指定するファイルパスには、 <code>str_glue()</code> を使用して各病院名を適用します（<code>str_glue()</code> に関する詳細は、<a href="characters_strings.jp.html">文字型・文字列型データ</a> の章を参照ください）。</p>
<ul>
<li>ファイルパスの起点、および “data” フォルダを特定するために <code>here()</code> を用います（<code>str_glue()</code> 内で使用されている二重引用符に影響がないように、一重引用符を使用していることに注意してください）。</li>
</ul></li>
<li><p><code>export()</code> で指定するファイルパス内には、<code>here()</code> を使用した後に <code>/</code> と <code>.x</code> を記載し、各病院名がファイル名になるようにします</p></li>
<li><p>最後に、<code>export()</code> によって CSV ファイルが作成されるように拡張子 “.csv” を記します</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist_split) <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">export</span>(linelist_split[[.x]], <span class="at">file =</span> <span class="fu">str_glue</span>(<span class="st">"{here('data')}/{.x}.csv"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>これで、それぞれのファイルが R プロジェクト “Epi_R_handbook” の “data” フォルダ内に保存されました！</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/purrr_export_csv.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="../images/purrr_export_csv.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="632"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="カスタム関数" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="カスタム関数">カスタム関数</h3>
<p><code>map()</code> に渡す関数を自分で作成したい場合はどうするのでしょうか。</p>
<p>例えば、それぞれの病院ごとに、その病院の全症例を含む流行曲線を作成したいとします。これを <strong>purrr</strong> パッケージを用いて行うには、<code>.f</code> 関数を <code>ggplot()</code> にし、<code>+</code> を使用して通常通り拡張することができます。<code>map()</code> は常にリストを出力するため、作成されたプロットもリストとして保存されます。リストに保存されたプロットは、 <strong>ggpubr</strong> パッケージの <code>ggarrange()</code> を使用して抽出し、プロットすることができます（<strong>ggpubr</strong> パッケージの公式ドキュメントは、<a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html">こちら</a> をご覧ください）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># リストから要素をプロットするためのパッケージを読み込む</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggpubr)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 6つの病院の 「名前」のベクトルに対してマッピングする（すでに作成済）</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot 関数を用いる</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 出力は6つの ggplots を含むリストとなる</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>hospital_names <span class="ot">&lt;-</span> <span class="fu">unique</span>(linelist<span class="sc">$</span>hospital)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>my_plots <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> hospital_names,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">ggplot</span>(<span class="at">data =</span> linelist <span class="sc">%&gt;%</span> <span class="fu">filter</span>(hospital <span class="sc">==</span> .x)) <span class="sc">+</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>                <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_onset)) <span class="sc">+</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">labs</span>(<span class="at">title =</span> .x)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="co"># リストとして保存されている ggplots を表示する</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> my_plots, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.jp_files/figure-html/unnamed-chunk-43-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="iteration.jp_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>上で紹介した <code>map()</code> コードが複雑すぎる場合、<code>ggplot()</code> を用いて作成したコードを自分で定義するカスタム関数として使用しても、同様の結果を得ることができます。例えば、その関数を <code>make_epicurve())</code> と名付け、<code>map()</code> 内で使用することができます。その場合、<code>.x</code> は反復処理の繰り返しごとにそれぞれの病院名となり、<code>make_epicurve()</code> 内では <code>hosp_name</code> として使用されます。関数を作成する手順について詳しく知りたい方は、<a href="writing_functions.jp.html">関数の作成</a> の章を参照してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 関数を作成する</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>make_epicurve <span class="ot">&lt;-</span> <span class="cf">function</span>(hosp_name){</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> linelist <span class="sc">%&gt;%</span> <span class="fu">filter</span>(hospital <span class="sc">==</span> hosp_name)) <span class="sc">+</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_onset)) <span class="sc">+</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> hosp_name)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 作成した関数をマッピングする</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>my_plots <span class="ot">&lt;-</span> <span class="fu">map</span>(hospital_names, <span class="sc">~</span><span class="fu">make_epicurve</span>(<span class="at">hosp_name =</span> .x))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># リストとして保存されている ggplots を表示する</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> my_plots, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="複数列に対して関数をマッピングする" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="複数列に対して関数をマッピングする">複数列に対して関数をマッピングする</h3>
<p>その他に頻繁に用いられる例としては、複数の列に対して同じ関数をマッピングする場合、が挙げられます。以下では、<code>linelist</code> データフレーム内の数値列に対して <code>t.test()</code> を <code>map()</code> し、性別で数値を比較していきます。</p>
<p><a href="stat_tests.jp.html">簡単な統計的検定</a> の章で学んだことを思い出してください。<code>t.test()</code> は、 <code>t.test(文字列 ~ バイナリ変数の列)</code> のような数式形式のインプットを扱うことができることを学びましたね。この例では、以下のことを行います。</p>
<ul>
<li><p>比較したい数値列を、<code>linelist</code> から選びます。これらは、<code>map()</code> に対してのインプット <code>.x</code> になります</p></li>
<li><p><code>t.test()</code> は、<code>.f</code> 関数として、選択されたそれぞれの数値列に対して適用されます</p></li>
<li><p><code>t.test()</code> のカッコ内は、</p>
<ul>
<li>最初の チルダ（<code>~</code> ）は <code>.f</code> に先行し、<code>.x</code> に対して <code>map()</code> が反復処理を行うことを意味します</li>
<li><code>.x</code> は反復処理の繰り返しの際に <code>t.test()</code> に適用される列を表します</li>
<li>2つ目のチルダ（<code>~</code>）は、上で説明した通り、t 検定の数式の一部です</li>
<li><code>t.test()</code> は、チルダ（<code>~</code>）の右側にバイナリ変数の列をあてます。ここでは <code>linelist$gender</code> というベクトルをあてています（<code>select()</code> に gender を含まないように注意してください）</li>
</ul></li>
<li><p><code>map()</code> はリストを返すので、反復処理の終了後、t 検定の結果を示すリストが出力され、一つのリスト要素がそれぞれの数値列の結果を表します。</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 結果はリストとして保存される</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, wt_kg, ht_cm, ct_blood, temp) <span class="sc">%&gt;%</span>  <span class="co"># マッピングしたい数字列だけを選択する</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">t.test</span>(.x <span class="sc">~</span> linelist<span class="sc">$</span>gender))        <span class="co"># t.test() は、数字値 ~ カテゴリ値で表される数式と用いる</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>RStudio では、<code>t.test_results</code> は以下のように表示されます。重要なポイントとして、</p>
<ul>
<li>一番上に全てのリストを束ねる <code>t.test_results</code> と名づけられたリストがあるのが確認できます。これは、5 つの要素からなり、それぞれの要素は <code>linelist</code> から選択され <code>gender</code> での t 検定に用いられた変数名と同じく <code>age</code>, <code>wt_km</code>, <code>ht_cm</code>, <code>ct_blood</code>, <code>temp</code> と名付けられています。<br>
</li>
<li>5 つの要素それぞれはリストであり、<code>p.value</code> や <code>conf.int</code> といった要素を含んでいます。これらの要素のうち、<code>p.value</code> などは単一の値である一方、<code>estimate</code> などは 2 つ以上の要素（<code>mean in group f</code> と <code>mean in group m</code>）を含んでいます。</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="../images/purrr_ttest.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="../images/purrr_ttest.png" style="height:150.0%" width="286" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>注釈：データフレーム内の特定の列にのみ関数を適用したい場合、<a href="cleaning.jp.html">データクリーニングと主要関数</a> の章で説明したように、<code>mutate()</code> と <code>across()</code> を使用すると簡単にできます。以下に、“age” の列にだけ <code>as.character()</code> を適用させる例を示します。括弧とコンマの位置に注意してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 列名に "age" を含む列を文字変数に変換する</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">contains</span>(<span class="st">"age"</span>), <span class="at">.fns =</span> as.character))  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="リストから抽出する" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="リストから抽出する">リストから抽出する</h3>
<p><code>map()</code> はアウトプットをリストとして出力するので、<strong>purrr</strong> パッケージに含まれる関数を用いてリストからデータを抽出する方法について少し説明します。前のセクションで作成した <code>t.test_results</code> リストを例として使用します。<code>t.test_results</code> リストは、5 つのリストからなるリストです。5 つのリストには、<code>linelist</code> データフレームのいくつかの変数とバイナリ変数である <code>gender</code> との間の t 検定の結果がそれぞれ保存されています。リスト構造の図は前のセクションをご覧ください。</p>
<section id="要素の名前を抽出する" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="要素の名前を抽出する">要素の名前を抽出する</h4>
<p>リスト内の要素の名前を抽出するには、<strong>base R</strong> の <code>names()</code> を使うと簡単にできます。今回は、<code>names()</code> を <code>t.test_results</code> に適用することでそれぞれのサブリスト名（t 検定に用いられた変数の名前）を抽出します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(t.test_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "age"      "wt_kg"    "ht_cm"    "ct_blood" "temp"    </code></pre>
</div>
</div>
</section>
<section id="名前または位置によって要素を特定する" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="名前または位置によって要素を特定する">名前または位置によって要素を特定する</h4>
<p><a href="basics.jp.html">R の基礎</a> の章で説明したように、 <code>[[ ]]</code> を用いると、リストの要素を名前、または位置で抽出することができます。以下では、二重括弧を <code>t.tests_results</code> リストに用いてインデックスし、<code>age</code> に対する t 検定の結果（リストの最初の要素）を表示しています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>t.test_results[[<span class="dv">1</span>]] <span class="co"># 位置で最初の要素を特定</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  .x by linelist$gender
t = -21.3, df = 4902.9, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means between group f and group m is not equal to 0
95 percent confidence interval:
 -7.544409 -6.272675
sample estimates:
mean in group f mean in group m 
       12.66085        19.56939 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>t.test_results[[<span class="dv">1</span>]][<span class="st">"p.value"</span>] <span class="co"># 最初の要素内の "p.value" という名前の要素を返す  </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$p.value
[1] 2.350374e-96</code></pre>
</div>
</div>
<p>さらに、より簡単で柔軟性の高い方法として、<strong>purrr</strong> パッケージの <code>map()</code> と <code>pluck()</code> を使用し、同様の結果を抽出する方法を以下で説明していきます。</p>
</section>
<section id="pluck" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="pluck"><code>pluck()</code></h4>
<p><code>pluck()</code> はリスト内の要素を名前もしくは位置で抽出することができます。例えば、年齢に対する t 検定の結果を抽出するには <code>pluck()</code> を以下のように使用します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">"age"</span>)        <span class="co"># 代わりに pluck(1) とすることもできる</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  .x by linelist$gender
t = -21.3, df = 4902.9, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means between group f and group m is not equal to 0
95 percent confidence interval:
 -7.544409 -6.272675
sample estimates:
mean in group f mean in group m 
       12.66085        19.56939 </code></pre>
</div>
</div>
<p>さらに下の階層を抽出するには、コンマを使います。以下の例では、<code>t.test_results</code> というリスト内の <code>age</code> というリストの要素である “p.value” を抽出しています。文字ではなく、数字を代わりに用いることもできます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">"age"</span>, <span class="st">"p.value"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.350374e-96</code></pre>
</div>
</div>
<p>また、リスト内の<u>すべての</u>最上階層から、より下の階層にある要素を抽出するには、<code>map()</code> を用いて <code>pluck()</code> をそれぞれの最上階層の要素に適用させるとできます。例えば、以下のコードでは <code>t.test_results</code> リストに含まれるすべてのサブリストから “p.value” という要素を抽出しています。この場合、<code>t.test_results</code> は反復処理対象となる <code>.x</code> であり、<code>pluck()</code> は反復される関数である <code>.f</code> であり、“p-value” はその関数に対して適用されています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(pluck, <span class="st">"p.value"</span>)   <span class="co"># リストに含まれるすべての p 値を返す</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$age
[1] 2.350374e-96

$wt_kg
[1] 2.664367e-182

$ht_cm
[1] 3.515713e-144

$ct_blood
[1] 0.4473498

$temp
[1] 0.5735923</code></pre>
</div>
</div>
<p>他の方法として、<code>map()</code> で要素の名前を引用符をつけて示し、それを抽出する方法があります。<code>map()</code> を利用する場合はアウトプットがリストで出力されますが、<code>map_chr()</code> を用いる場合は名前付きの文字ベクトルとして出力され、<code>map_dbl()</code> を用いる場合は名前付きの数字ベクトルとして出力されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="st">"p.value"</span>)   <span class="co"># すべての p 値を名前付きの数値ベクトルとして返す</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          age         wt_kg         ht_cm      ct_blood          temp 
 2.350374e-96 2.664367e-182 3.515713e-144  4.473498e-01  5.735923e-01 </code></pre>
</div>
</div>
<p><code>pluck()</code> の詳細は、<strong>purrr</strong> パッケージの <a href="https://purrr.tidyverse.org/reference/pluck.html">公式ドキュメント</a> をご覧ください。<code>chuck()</code> という関数もあり、<code>chuck()</code> は要素が存在しなければ NULL ではなくエラーを返します。</p>
</section>
</section>
<section id="リストをデータフレームに変換する" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="リストをデータフレームに変換する">リストをデータフレームに変換する</h3>
<p>これは少し複雑な内容のため、より網羅的に学びたい方は、本章の最後に記載されている参考資料を参照してください。ここでは、前のセクションでリストとして出力された t 検定の結果（<code>t.test_results</code>）をデータフレームに変換する方法を説明します。p 値の列と 2 つのグループ（男性と女性）それぞれの平均値の列を含むデータフレームを作成していきます。</p>
<p>方法と使用する関数を示します：</p>
<ul>
<li><p>tibble （データフレームのようなもの）を作成するため、<code>tibble()</code> を使います</p>
<ul>
<li><code>t.test_results</code> 全体が tibble の最初の列として保存されないように、<code>tibble()</code> を波括弧でくくります</li>
</ul></li>
<li><p><code>tibble()</code> 内では、それぞれの列が明示的に作成されるので、<code>mutate()</code> で列を作成する方法に似ています。</p>
<ul>
<li>以下のコードでは、<code>.</code> は <code>t.test_results</code> を表しています</li>
<li>列名を t 検定で用いた変数名（それぞれのリスト要素の名前）にしたい場合は、前述したように <code>names()</code> を使用します</li>
<li>列名を p 値にしたい場合は、前述したように <code>map_dbl()</code> を用いて <code>p.value</code> の要素を抽出し、数字ベクトルに変換します</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> {</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">variables =</span> <span class="fu">names</span>(.),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">p         =</span> <span class="fu">map_dbl</span>(., <span class="st">"p.value"</span>))</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  variables         p
  &lt;chr&gt;         &lt;dbl&gt;
1 age       2.35e- 96
2 wt_kg     2.66e-182
3 ht_cm     3.52e-144
4 ct_blood  4.47e-  1
5 temp      5.74e-  1</code></pre>
</div>
</div>
<p>今回は、さらにそれぞれのグループ（男性と女性）の平均値の列を追加していきます。</p>
<p>この場合、<code>estimate</code> という要素を抽出したいのですが、問題はその中に <u>2 つの</u>要素 （<code>mean in group f</code> と <code>mean in group m</code>）が含まれていることです。そのため、<code>map_chr()</code> や <code>map_dbl()</code> を用いてベクターに変換することはできません。その代わり、<code>tibble()</code> 内で <code>map()</code> を用いることで <u>tibble 内にリスト要素の列</u>を作成することができます！</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">tibble</span>(</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">variables =</span> <span class="fu">names</span>(.),</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> <span class="fu">map_dbl</span>(., <span class="st">"p.value"</span>),</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">means =</span> <span class="fu">map</span>(., <span class="st">"estimate"</span>))}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  variables         p means       
  &lt;chr&gt;         &lt;dbl&gt; &lt;named list&gt;
1 age       2.35e- 96 &lt;dbl [2]&gt;   
2 wt_kg     2.66e-182 &lt;dbl [2]&gt;   
3 ht_cm     3.52e-144 &lt;dbl [2]&gt;   
4 ct_blood  4.47e-  1 &lt;dbl [2]&gt;   
5 temp      5.74e-  1 &lt;dbl [2]&gt;   </code></pre>
</div>
</div>
<p>リスト要素の列が一度できると、このような「入れ子構造内のリスト要素の列」を「外に取り出す（“rectangle” または “un-nest”）」のに役立つ <strong>tidyr</strong> パッケージの関数がいくつかあります（<strong>tidyr</strong> パッケージは <strong>tidyverse</strong> パッケージに含まれている）。詳しくは、<a href="https://www.epirhandbook.com/en/iteration-loops-and-lists.html">このページ</a> を参照するか、<code>vignette("rectangle")</code> を実行してください。簡単に述べると、</p>
<ul>
<li><code>unnest_wider()</code>：リスト要素の列のそれぞれの要素を、列として外に出します</li>
<li><code>unnest_longer()</code>：リスト要素の列のそれぞれの要素を、行として外に出します</li>
<li><code>hoist()</code>：<code>unnest_wider()</code> と似ていますが、どの要素を入れ子構造の外に出すか指定する必要があります</li>
</ul>
<p>以下では、<code>unnest_wider()</code> に <code>t.test_results</code> という tibble を渡し、tibble 内の入れ子になっているリスト要素である <code>means</code> 列を指定しています。その結果、<code>means</code> はもともとそれぞれの <code>means</code> のセル内の値であった要素からなる 2 つの列に変換されました。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">tibble</span>(</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">variables =</span> <span class="fu">names</span>(.),</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> <span class="fu">map_dbl</span>(., <span class="st">"p.value"</span>),</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">means =</span> <span class="fu">map</span>(., <span class="st">"estimate"</span>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    )} <span class="sc">%&gt;%</span> </span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(means)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
  variables         p `mean in group f` `mean in group m`
  &lt;chr&gt;         &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;
1 age       2.35e- 96              12.7              19.6
2 wt_kg     2.66e-182              45.8              59.6
3 ht_cm     3.52e-144             109.              142. 
4 ct_blood  4.47e-  1              21.2              21.2
5 temp      5.74e-  1              38.6              38.6</code></pre>
</div>
</div>
</section>
<section id="リストを捨てる保持するコンパクトにする" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="リストを捨てる保持するコンパクトにする">リストを捨てる・保持する・コンパクトにする</h3>
<p><strong>purrr</strong> パッケージの関数はリストを扱うことが多いため、リストを変換するのに用いられる <strong>purrr</strong> パッケージの関数をいくつか簡単に説明します。<strong>purrr</strong> パッケージに含まれる関数について、より詳しい内容を知りたい方は、本章の最後に記載されている参考資料をご覧ください。</p>
<ul>
<li><code>list_modify()</code> にはいくつか用途がありますが、例えばリストの要素を取り除く、といった場合に使用されます<br>
</li>
<li><code>keep()</code> は、引数 <code>.p =</code> で指定された要素、もしくは <code>.p =</code> に与えられた関数が TRUE となる要素を保持（キープ）します<br>
</li>
<li><code>discard()</code> は、引数 <code>.p =</code> で指定された要素、もしくは <code>.p =</code> に与えられた関数が TRUE となる要素を取り除きます<br>
</li>
<li><code>compact()</code> は、全ての空の要素を取り除きます</li>
</ul>
<p>それでは、<code>map()</code> を使用して複数のファイルをインポートし結合した <a href="#iter_combined">例：エクセルシートをインポートし、結合する</a> で作成したリストである <code>combined</code>（6 つのデータフレームを含むリスト）を用いて例を示します。</p>
<p>リスト内の要素を要素名の名前で取り除きたい場合は、<code>list_modify()</code> で取り除きたい要素名を <code>NULL</code> に指定することで取り除くことができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>combined <span class="sc">%&gt;%</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_modify</span>(<span class="st">"Central Hospital"</span> <span class="ot">=</span> <span class="cn">NULL</span>)   <span class="co"># リスト要素を名前で取り除く</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>また、何かの基準を指定して要素を取り除くこともできます。その場合は、「述語」方程式（TRUE か FALSE を判定する方程式）を <code>.p =</code> に渡します。チルダ（<code>~</code>）を関数の前に用い、リスト要素を表す <code>.x</code> を用います。<code>keep()</code> を使用し、TRUE と判定されたリスト要素を保持します。逆に、TRUE と判定されたリスト要素を取り除きたい場合は、<code>discard()</code> を使用してください。以下に例を示します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 500行以上を含むリスト要素のみを保持する</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>combined <span class="sc">%&gt;%</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">keep</span>(<span class="at">.p =</span> <span class="sc">~</span><span class="fu">nrow</span>(.x) <span class="sc">&gt;</span> <span class="dv">500</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>もう一つの例として、データフレームではない要素を取り除くコードを以下に紹介します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># データフレームではないリスト要素を取り除く</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>combined <span class="sc">%&gt;%</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">discard</span>(<span class="at">.p =</span> <span class="sc">~</span><span class="fu">class</span>(.x) <span class="sc">!=</span> <span class="st">"data.frame"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>また、述語方程式にそれぞれのリスト内の要素や列を含めることもできます。以下の例では、<code>ct_blood</code> 列の平均値が 25 よりも大きいリスト要素を取り除いています。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ct_blood 列の平均値が 25 以上のリスト要素を取り除く</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>combined <span class="sc">%&gt;%</span> </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">discard</span>(<span class="at">.p =</span> <span class="sc">~</span><span class="fu">mean</span>(.x<span class="sc">$</span>ct_blood) <span class="sc">&gt;</span> <span class="dv">25</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>すべての空の列を取り除きたい場合は、以下のコードを実行してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 全ての空の列を取り除く</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>combined <span class="sc">%&gt;%</span> </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compact</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pmap" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="pmap"><code>pmap()</code></h3>
<p>このセクションは、作成中です。</p>
</section>
</section>
<section id="apply-関数" class="level2" data-number="16.4">
<h2 data-number="16.4" class="anchored" data-anchor-id="apply-関数"><span class="header-section-number">16.4</span> Apply 関数</h2>
<p><strong>purrr</strong> パッケージの代わりに、<strong>base R</strong> に含まれている種々の “apply” 系の関数を使用して反復処理を行うこともできます。詳しくは、<a href="https://www.datacamp.com/community/tutorials/r-tutorial-apply-family">こちら</a> をご覧ください。</p>
<!-- ======================================================= -->
</section>
<section id="参考資料" class="level2" data-number="16.5">
<h2 data-number="16.5" class="anchored" data-anchor-id="参考資料"><span class="header-section-number">16.5</span> 参考資料</h2>
<p><a href="https://datacarpentry.org/semester-biology/materials/for-loops-R/">Data Carpentry の for loops に関するページ</a></p>
<p><a href="https://r4ds.had.co.nz/iteration.html#iteration">The R for Data Science の iteration に関するページ</a></p>
<p><a href="https://martinctc.github.io/blog/vignette-write-and-read-multiple-excel-files-with-purrr/">Excel ファイルのインポート・エクスポートについて</a></p>
<p>jennybc による purrr の <a href="https://jennybc.github.io/purrr-tutorial/index.html">チュートリアル</a></p>
<p>Rebecca Barter による purrr の <a href="http://www.rebeccabarter.com/blog/2019-08-19_purrr/">チュートリアル</a></p>
<p>map, pmap, and imap についての purrr の <a href="http://zevross.com/blog/2019/06/11/the-power-of-three-purrr-poseful-iteration-in-r-with-map-pmap-and-imap/">チュートリアル</a></p>
<p><a href="https://raw.githubusercontent.com/rstudio/cheatsheets/master/pngs/thumbnails/purrr-cheatsheet-thumbs.png">purrr のチートシート</a></p>
<p><a href="https://www.emilhvitfeldt.com/post/2018-01-08-purrr-tips-and-tricks/">purrr の役立つヒント</a></p>
<p><a href="https://hookedondata.org/going-off-the-map/#keep-and-discard">keep と discard 関数について</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../new_pages/deduplication.jp.html" class="pagination-link" aria-label="重複データの排除">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">重複データの排除</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../new_pages/tables_descriptive.jp.html" class="pagination-link" aria-label="記述統計表の作り方">
        <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">記述統計表の作り方</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","selector":".lightbox","loop":false,"descPosition":"bottom","openEffect":"zoom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>