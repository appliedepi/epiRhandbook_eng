<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="jp" xml:lang="jp"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>疫学のための R ハンドブック - 27&nbsp; 生存時間解析</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../new_pages/gis.jp.html" rel="next">
<link href="../new_pages/survey_analysis.jp.html" rel="prev">
<link href="../images/Applied_Epi_logo.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QXDW878QLX', { 'anonymize_ip': true});
</script>
<!-- Global site tag (gtag.js) - Google Analytics 
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QXDW878QLX');
</script> -->

</head><body class="nav-sidebar floating"><div class="alert alert-info alert-dismissible">
  <!-- <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
  <strong>Need help learning R?</strong> Enroll in Applied Epi's <a href="https://www.appliedepi.org/live/"
    class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/"
    class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/"
    class="alert-link">Community Q&A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org"
    class="alert-link">R Help Desk service</a>. -->
</div>

<script>

  // Function to extract the last two characters from the URL path to determine the language, adjusting for .html extension
  function getLanguageFromURL() {
    let path = window.location.pathname;
    
    // Check if the URL ends with .html and remove it
    if (path.endsWith('.html')) {
      path = path.substring(0, path.length - 5);
    }

    // Extract the last two characters for the language code
    const lang = path.substr(-2);
    return lang;
  }

  const language = getLanguageFromURL();
  const supportedLanguages = ['fr', 'es', 'vn', 'jp', 'pt', 'tr', 'ru'];
  const defaultLanguage = 'en';
  const isSupportedLanguage = supportedLanguages.includes(language);

  // Translations for the content
  const translations = {
    en: '<strong>Need help learning R?</strong> Enroll in Applied Epi\'s <a href="https://www.appliedepi.org/live/" class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/" class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/" class="alert-link">Community Q&A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org" class="alert-link">R Help Desk service</a>.',
    fr: '<strong>Besoin d\'aide pour apprendre R ?</strong> Inscrivez-vous au <a href="https://www.appliedepi.org/live/" class="alert-link">cours d\'introduction à R</a> d\'Applied Epi, essayez nos <a href="https://www.appliedepi.org/tutorial/" class="alert-link">tutoriels R gratuits</a>, postez dans notre forum de <a href="https://community.appliedepi.org/" class="alert-link">questions-réponses communautaires</a>, ou demandez-nous des informations sur <a href="mailto:contact@appliedepi.org" class="alert-link"> notre service d\'assistance R</a>.',
    es: '<strong>¿Necesitas ayuda para aprender R?</strong> Inscríbete en el <a href="https://www.appliedepi.org/live/" class="alert-link">Curso de introducción a R</a> de Applied Epi, prueba nuestros <a href="https://www.appliedepi.org/tutorial/" class="alert-link">Tutoriales gratuitos de R</a>, escribe en nuestro <a href="https://community.appliedepi.org/" class="alert-link">Foro de preguntas y respuestas,</a> o pregunta por nuestra <a href="mailto:contact@appliedepi.org" class="alert-link">Asistencia técnica para R</a>.',
    vn: '<strong>Bạn cần giúp đỡ trong việc học R?</strong> Hãy đăng ký khóa học R cơ bản của Applied Epi tại <a href="https://www.appliedepi.org/live/" class="alert-link">đây</a>, hoặc thử các <a href="https://www.appliedepi.org/tutorial/" class="alert-link">hướng dẫn R miễn phí</a>, đăng bài trong <a href="https://community.appliedepi.org/" class="alert-link">diễn đàn cộng đồng</a>, hoặc gửi câu hỏi tới <a href="mailto:contact@appliedepi.org" class="alert-link">dịch vụ Trợ giúp R</a> của chúng tôi.',
    jp: '<strong>Rの学習について助けが必要ですか？</strong>Applied Epiの<a href="https://www.appliedepi.org/live/" class="alert-link">R入門コース</a>に登録するか、<a href="https://www.appliedepi.org/tutorial/" class="alert-link">無料Rチュートリアル</a>を試すか、<a href="https://community.appliedepi.org/" class="alert-link">コミュニティQ＆Aフォーラム</a>に投稿するか、<a href="mailto:contact@appliedepi.org" class="alert-link">Rヘルプデスクサービス</a>についてお問い合わせください。',
    pt: '<strong>Você precisa de ajuda para aprender R??</strong> Inscreva-se no curso de <a href="https://www.appliedepi.org/live/" class="alert-link">introdução ao R da Applied Epi</a>, experimente nossos <a href="https://www.appliedepi.org/tutorial/" class="alert-link">tutoriais gratuitos sobre o R</a>, publique em nosso <a href="https://community.appliedepi.org/" class="alert-link">fórum de perguntas e respostas</a>, ou solicite nosso <a href="mailto:contact@appliedepi.org" class="alert-link">suporte ao R</a>.',
    tr: '<strong>R öğrenmekte yardıma mı ihtiyacınız var?</strong> Applied Epi\'\nin <a href="https://www.appliedepi.org/live/" class="alert-link">R\'ye giriş kursuna</a> kaydolun, <a href="https://www.appliedepi.org/tutorial/" class="alert-link">ücretsiz R derslerimizi</a> deneyin, <a href="https://community.appliedepi.org/" class="alert-link">Topluluk Q&A forumunda</a> soru paylaşın, ya da <a href="mailto:contact@appliedepi.org" class="alert-link">R Yardım Masası hizmetimiz</a> hakkında sorun.',
    ru: '<strong>Нужна помощь в изучении R?</strong> Запишитесь на <a href="https://www.appliedepi.org/live/" class="alert-link">вводный курс по R</a> от Applied Epi, попробуйте наши <a href="https://www.appliedepi.org/tutorial/" class="alert-link">бесплатные учебные материалы по R</a>, задайте вопрос в нашем <a href="https://community.appliedepi.org/" class="alert-link">форуме вопросов и ответов сообщества</a>, или спросите о нашей услуге <a href="mailto:contact@appliedepi.org" class="alert-link">Службы поддержки по R</a>.'
  };

  // Default to English if the detected language is not supported
  const contentToDisplay = translations[isSupportedLanguage ? language : defaultLanguage];


  // Select the element where the content should be displayed
  const alertElement = document.querySelector('.alert');
  if (alertElement) {
    alertElement.innerHTML = contentToDisplay;
    alertElement.style.display = 'block'; // Make sure to display the element
  }

</script>
<link href="../site_libs/htmltools-fill-0.5.8/fill.css" rel="stylesheet">
<script src="../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../site_libs/datatables-binding-0.31/datatables.js"></script>
<script src="../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="../site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>





<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../new_pages/tables_descriptive.jp.html">データ分析</a></li><li class="breadcrumb-item"><a href="../new_pages/survival_analysis.jp.html"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">生存時間解析</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/Applied_Epi_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">疫学のための R ハンドブック</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://twitter.com/appliedepi" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
    <a href="https://www.linkedin.com/company/appliedepi/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="https://github.com/appliedepi/epihandbook_eng" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">いらっしゃいませ</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">本書について</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/editorial_style.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">編集前記・技術注記</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/data_used.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">ハンドブックとデータのダウンロード</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">基本編</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/basics.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R の基礎</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/transition_to_R.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Excel・Stata・SASとの比較</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/packages_suggested.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">推奨パッケージ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/r_projects.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">R プロジェクト</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/importing.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">データのインポート・エクスポート</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">データマネジメント</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/cleaning.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">データクリーニングと主要関数</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/dates.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">日付型データ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/characters_strings.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">文字型・文字列型データ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/factors.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">因子（ファクタ）型データ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/pivoting.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">データの縦横変換</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/grouping.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">データのグループ化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/joining_matching.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">データの結合</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/deduplication.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">重複データの排除</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/iteration.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">ループと反復処理・リストの操作</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">データ分析</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/tables_descriptive.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">記述統計表の作り方</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/stat_tests.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">基本的な統計的検定</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/regression.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">単変量と多変量回帰</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/missing_data.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">データの欠損</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/standardization.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">標準化率</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/moving_average.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">移動平均</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/time_series.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">時系列分析とアウトブレイクの検出{#time-series}</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/epidemic_models.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">エピデミックモデリング</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/contact_tracing.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">接触者の追跡{#contact-tracing}</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/survey_analysis.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">標本調査データ分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/survival_analysis.jp.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">生存時間解析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/gis.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">GIS の基本</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">データの可視化</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/tables_presentation.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">見やすい表の作り方</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/ggplot_basics.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">ggplot の基本</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/ggplot_tips.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">ggplotのヒント</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/epicurves.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">流行曲線（エピカーブ）</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/age_pyramid.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">人口ピラミッドとリッカート尺度</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/heatmaps.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">ヒートマップ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/diagrams.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">フローチャート・サンキー図・タイムライン</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/combination_analysis.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">複数回答データの分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/transmission_chains.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">感染連鎖</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/phylogenetic_trees.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">系統樹</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/interactive_plots.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">動的な図の作成</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">レポートとダッシュボード</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/rmarkdown.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">R Markdown で作るレポート</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/reportfactory.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">ルーチンで作成するレポートの整理</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/flexdashboard.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">R Markdownで作るダッシュボード</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/shiny_basics.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Shiny で作るダッシュボード</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">その他</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/writing_functions.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">関数の作成</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/directories.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">ディレクトリの操作</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/collaboration.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Git と Github を使ったバージョン管理と共同作業</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/errors.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">よくあるエラー</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/help.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">ヘルプ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/network_drives.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">ネットワークドライブで R を使用する場合</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/data_table.jp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">data.table パッケージを使用したデータ処理</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#概要" id="toc-概要" class="nav-link active" data-scroll-target="#概要"><span class="header-section-number">27.1</span> 概要</a></li>
  <li><a href="#準備" id="toc-準備" class="nav-link" data-scroll-target="#準備"><span class="header-section-number">27.2</span> 準備</a>
  <ul class="collapse">
  <li><a href="#パッケージの読み込み" id="toc-パッケージの読み込み" class="nav-link" data-scroll-target="#パッケージの読み込み">パッケージの読み込み</a></li>
  <li><a href="#データセットのインポート" id="toc-データセットのインポート" class="nav-link" data-scroll-target="#データセットのインポート">データセットのインポート</a></li>
  <li><a href="#データマネジメントと変換" id="toc-データマネジメントと変換" class="nav-link" data-scroll-target="#データマネジメントと変換">データマネジメントと変換</a></li>
  </ul></li>
  <li><a href="#生存時間解析の基本" id="toc-生存時間解析の基本" class="nav-link" data-scroll-target="#生存時間解析の基本"><span class="header-section-number">27.3</span> 生存時間解析の基本</a>
  <ul class="collapse">
  <li><a href="#surv-型オブジェクトの作成" id="toc-surv-型オブジェクトの作成" class="nav-link" data-scroll-target="#surv-型オブジェクトの作成">Surv 型オブジェクトの作成</a></li>
  <li><a href="#最初の解析の実行" id="toc-最初の解析の実行" class="nav-link" data-scroll-target="#最初の解析の実行">最初の解析の実行</a></li>
  <li><a href="#累積ハザード" id="toc-累積ハザード" class="nav-link" data-scroll-target="#累積ハザード">累積ハザード</a></li>
  <li><a href="#kaplanmeier-曲線の作成" id="toc-kaplanmeier-曲線の作成" class="nav-link" data-scroll-target="#kaplanmeier-曲線の作成">Kaplan–Meier 曲線の作成</a></li>
  </ul></li>
  <li><a href="#生存曲線の比較" id="toc-生存曲線の比較" class="nav-link" data-scroll-target="#生存曲線の比較"><span class="header-section-number">27.4</span> 生存曲線の比較</a>
  <ul class="collapse">
  <li><a href="#ログランク検定" id="toc-ログランク検定" class="nav-link" data-scroll-target="#ログランク検定">ログランク検定</a></li>
  </ul></li>
  <li><a href="#cox-回帰分析" id="toc-cox-回帰分析" class="nav-link" data-scroll-target="#cox-回帰分析"><span class="header-section-number">27.5</span> Cox 回帰分析</a>
  <ul class="collapse">
  <li><a href="#cox-回帰モデルの当てはめ" id="toc-cox-回帰モデルの当てはめ" class="nav-link" data-scroll-target="#cox-回帰モデルの当てはめ">Cox 回帰モデルの当てはめ</a></li>
  <li><a href="#フォレストプロット" id="toc-フォレストプロット" class="nav-link" data-scroll-target="#フォレストプロット">フォレストプロット</a></li>
  </ul></li>
  <li><a href="#生存時間モデルにおける時間依存性共変量" id="toc-生存時間モデルにおける時間依存性共変量" class="nav-link" data-scroll-target="#生存時間モデルにおける時間依存性共変量"><span class="header-section-number">27.6</span> 生存時間モデルにおける時間依存性共変量</a>
  <ul class="collapse">
  <li><a href="#時間依存性共変量の設定" id="toc-時間依存性共変量の設定" class="nav-link" data-scroll-target="#時間依存性共変量の設定">時間依存性共変量の設定</a></li>
  <li><a href="#時間依存性共変量を持つ-cox-回帰モデル" id="toc-時間依存性共変量を持つ-cox-回帰モデル" class="nav-link" data-scroll-target="#時間依存性共変量を持つ-cox-回帰モデル">時間依存性共変量を持つ Cox 回帰モデル</a></li>
  </ul></li>
  <li><a href="#参考資料" id="toc-参考資料" class="nav-link" data-scroll-target="#参考資料"><span class="header-section-number">27.7</span> 参考資料</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../new_pages/tables_descriptive.jp.html">データ分析</a></li><li class="breadcrumb-item"><a href="../new_pages/survival_analysis.jp.html"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">生存時間解析</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="survival-analysis" class="quarto-section-identifier"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">生存時間解析</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/survival_analysis.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="../images/survival_analysis.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
<!-- ======================================================= -->
<section id="概要" class="level2" data-number="27.1">
<h2 data-number="27.1" class="anchored" data-anchor-id="概要"><span class="header-section-number">27.1</span> 概要</h2>
<p><u>生存時間解析</u>（survival analysis）は、個々人において観測される<strong><u>イベント時間</u></strong>（コホート研究や集団ベースの研究では<strong><u>追跡期間</u></strong>）と呼ばれる期間の後に発生する<strong><u>イベント</u></strong>（疾病の発生、疾病からの治癒、死亡、治療に反応した後の再発など）を個人または集団について記述する事に着目した方法です。イベント時間を決定するためには、起点 (組入日や診断日などを用いることができます) の時間を定義する必要があります。</p>
<p>つまり、生存時間解析の推測対象は、起点とイベントの間の時間となります。 近年の医学研究では、例えば治療効果を評価する臨床研究や、多種多様ながんの生存指標を評価する疫学研究などにおいて生存時間解析がよく用いられています。</p>
<p>通常、その記述結果は<strong><u>生存確率</u></strong>を通じて提示されます。また、生存確率とは、興味のあるイベントが期間 <span class="math inline">\(t\)</span> を経過した時点で発生していない確率です。</p>
<p><strong><u>打切り</u></strong>: ある個人が追跡終了時点までに興味のあるイベントを発生せず、その人の正しいイベント時間が不明な場合に打切りが発生します。この章では右側打切りに重点を置いています。打切りの詳細と一般の生存時間解析については、文献を参照してください。</p>
<!-- ======================================================= -->
</section>
<section id="準備" class="level2" data-number="27.2">
<h2 data-number="27.2" class="anchored" data-anchor-id="準備"><span class="header-section-number">27.2</span> 準備</h2>
<section id="パッケージの読み込み" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="パッケージの読み込み">パッケージの読み込み</h3>
<p>R において生存時間解析を行うために最もよく用いられるパッケージの1つは <strong>survival</strong> パッケージです。まず最初に、survival パッケージとこの節で用いる他のパッケージをインストールした後に、これらのパッケージの読込みを行います。</p>
<p>以下のコードを実行すると、分析に必要なパッケージが読み込まれます。このハンドブックでは、パッケージを読み込むために、pacman パッケージの p_load() を主に使用しています。p_load() は、必要に応じてパッケージをインストールし、現在の R セッションで使用するためにパッケージを読み込む関数です。また、すでにインストールされたパッケージは、R の基本パッケージである base （以下、base R）の library() を使用して読み込むこともできます。R のパッケージに関する詳細は <a href="basics.jp.html">R の基礎</a> の章をご覧ください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># この章で必要なパッケージのインストールと読込</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>     survival,      <span class="co"># 生存時間解析</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>     survminer,     <span class="co"># 生存時間解析</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>     rio,           <span class="co"># データのインポート</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>     here,          <span class="co"># ファイルの相対パス</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>     janitor,       <span class="co"># 表の作成</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>     SemiCompRisks, <span class="co"># 事例データと準競合リスクデータのための発展的なツール</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>     tidyverse,     <span class="co"># データの操作と可視化</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>     Epi,           <span class="co"># 疫学の統計解析</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>     survival,      <span class="co"># 生存時間解析</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>     survminer      <span class="co"># 生存時間解析：発展的な Kaplan-Meier 曲線</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>この章では、前のほとんどの章でも用いられているラインリストを用いて生存時間解析を行います。また、正しい生存時間データを得るために、ラインリストにいくつかの変更を加えていきます。</p>
</section>
<section id="データセットのインポート" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="データセットのインポート">データセットのインポート</h3>
<p>エボラ出血熱の流行をシミュレートしたデータセットをインポートします。お手元の環境でこの章の内容を実行したい方は、 <a href="https://github.com/appliedepi/epiRhandbook_eng/raw/master/data/case_linelists/linelist_cleaned.rds" class="download-button">クリック</a>して「前処理された」ラインリスト（linelist）データをダウンロードしてください&gt;（.rds 形式で取得できます）。データは <em>rio</em> パッケージの import() を利用してインポートしましょう（<em>rio</em> パッケージは、.xlsx、.csv、.rds など様々な種類のファイルを取り扱うことができます。詳細は、<a href="importing.jp.html">インポートとエクスポート</a> の章をご覧ください。）</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ラインリストのインポート</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>linelist_case_data <span class="ot">&lt;-</span> rio<span class="sc">::</span><span class="fu">import</span>(<span class="st">"linelist_cleaned.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="データマネジメントと変換" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="データマネジメントと変換">データマネジメントと変換</h3>
<p>簡潔に言うと、生存時間データは以下の3つの特徴を持っているといえます：</p>
<ol type="1">
<li>従属変数または反応変数は矛盾なく定義されたイベントの発生までの時間で、</li>
<li>観測値は打切りを受け、データが解析される時点で興味のあるイベントが発生していないことがいくつかの観測単位で認められ、</li>
<li>イベント発生時間に対する影響を評価またはコントロールしたい予測変数や説明変数があります。</li>
</ol>
<p>そのため、上記の構造に沿うための変数を作成してから生存時間分析を実行していきます。</p>
<p>以下のものを定義します：</p>
<ul>
<li>この解析に必要な新しいデータフレーム <code>linelist_surv</code></li>
<li>興味のあるイベントをここでは「死亡」とします（すると、生存確率は起点の時間からある特定の時間が経過したあとで生存している確率となります）</li>
<li>追跡時間（<code>futime</code>）を、発症時間からアウトカムの時間までの<u>日数</u>とします</li>
<li>回復した人か、または最終的なアウトカムが観測されなかった人、つまり「イベント」が観測されなかった人（<code>event=0</code>）を打切りとします。</li>
</ul>
<p><span style="color: orange;"><strong><u>注意：</u></strong> 実際のコホート研究では、起点と追跡終了の時間の情報は観測された個々人で既知であるため、発症日やアウトカムの日付が不明な観測値は削除します。また、発症日がアウトカムの日付よりも遅い場合は誤りであると考えられるため、これも削除します。</span></p>
<p><span style="color: darkgreen;"><strong><u>ヒント：</u></strong> 日付データに対して超過（&gt;）または未満（&lt;）のフィルタリングを行うと欠測値を持つ行も一緒に削除できるため、日付の誤りに対するフィルタリングによって欠測したデータを一緒に削除することができます。</span></p>
<p>次に、<code>case_when()</code> を用いて3つだけ水準を持つ <code>age_cat_small</code> 列を作成します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># linelist_case_data から新しいデータ linelist_surv を作成</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="ot">&lt;-</span> linelist_case_data <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>     dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 誤りまたは発症日かアウトカムの日付に欠測がある観測値を削除</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>          date_outcome <span class="sc">&gt;</span> date_onset) <span class="sc">%&gt;%</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>     dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 死亡した人を1とし右側打切りの人を0としたイベント変数を作成</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">event =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(outcome) <span class="sc">|</span> outcome <span class="sc">==</span> <span class="st">"Recover"</span>, <span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 追跡時間（日）の変数を作成</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">futime =</span> <span class="fu">as.double</span>(date_outcome <span class="sc">-</span> date_onset), </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 3つだけ水準を持つ新しい年齢カテゴリ変数を作成</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">age_cat_small =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>( </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>               age_years <span class="sc">&lt;</span> <span class="dv">5</span>  <span class="sc">~</span> <span class="st">"0-4"</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>               age_years <span class="sc">&gt;=</span> <span class="dv">5</span> <span class="sc">&amp;</span> age_years <span class="sc">&lt;</span> <span class="dv">20</span> <span class="sc">~</span> <span class="st">"5-19"</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>               age_years <span class="sc">&gt;=</span> <span class="dv">20</span>   <span class="sc">~</span> <span class="st">"20+"</span>),</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 上のステップでは age_cat_small が character 型で作成されるため</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>          <span class="co"># factor 型に変換し、水準を指定します</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 値が NA のものは NA のままになり、例えば水準 "unkown" などには置換されません</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>          <span class="co"># そのため、次の解析ではこれらを削除する必要があるので注意してください</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>          <span class="at">age_cat_small =</span> <span class="fu">fct_relevel</span>(age_cat_small, <span class="st">"0-4"</span>, <span class="st">"5-19"</span>, <span class="st">"20+"</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>     )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span style="color: darkgreen;"><strong><u>ヒント：</u></strong> 作成された変数 <code>futime</code> と <code>event</code> および <code>outcome</code> のクロス集計を行うことで、新しい列を検証することができます。この検証の他にも、生存時間解析の結果を解釈する時には、この集計に加えて追跡期間中央値を示すことは良い習慣です。</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linelist_surv<span class="sc">$</span>futime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   1.00    6.00   10.00   11.98   16.00   64.00 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 作成された新しいイベント変数とアウトカム変数のクロス集計</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 意図した通りにコードが動いているかどうかを確認する</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="sc">%&gt;%</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">tabyl</span>(outcome, event)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> outcome    0    1
   Death    0 1952
 Recover 1547    0
    &lt;NA&gt; 1040    0</code></pre>
</div>
</div>
<p>ここで、正しく分類できているかどうかを確認するために、新しい変数 <code>age_cat_small</code> と古い変数 <code>age_cat</code> のクロス集計を行います</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="sc">%&gt;%</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">tabyl</span>(age_cat_small, age_cat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> age_cat_small 0-4 5-9 10-14 15-19 20-29 30-49 50-69 70+ NA_
           0-4 834   0     0     0     0     0     0   0   0
          5-19   0 852   717   575     0     0     0   0   0
           20+   0   0     0     0   862   554    69   5   0
          &lt;NA&gt;   0   0     0     0     0     0     0   0  71</code></pre>
</div>
</div>
<p>次に、<code>linelist_surv</code> データのいくつかの変数（新しく作成された変数も含む）について、最初の10人分の観測値を確認します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">select</span>(case_id, age_cat_small, date_onset, date_outcome, outcome, event, futime) <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   case_id age_cat_small date_onset date_outcome outcome event futime
1   8689b7           0-4 2014-05-13   2014-05-18 Recover     0      5
2   11f8ea           20+ 2014-05-16   2014-05-30 Recover     0     14
3   893f25           0-4 2014-05-21   2014-05-29 Recover     0      8
4   be99c8          5-19 2014-05-22   2014-05-24 Recover     0      2
5   07e3e8          5-19 2014-05-27   2014-06-01 Recover     0      5
6   369449           0-4 2014-06-02   2014-06-07   Death     1      5
7   f393b4           20+ 2014-06-05   2014-06-18 Recover     0     13
8   1389ca           20+ 2014-06-05   2014-06-09   Death     1      4
9   2978ac          5-19 2014-06-06   2014-06-15   Death     1      9
10  fc15ef          5-19 2014-06-16   2014-07-09 Recover     0     23</code></pre>
</div>
</div>
<p>新しい年齢分類の性別ごとのより詳細な分布を得るために、列 <code>age_cat_small</code> と <code>gender</code> のクロス集計も行うことができます。ここでは、<a href="tables_descriptive.jp.html">記述統計表の作り方</a>の章で説明した <strong>janitor</strong> パッケージの <code>tabyl()</code> と <em>adorn</em> 関数を使用します。</p>
<!-- For this we use the `stat.table()` function of the **Epi** package. -->
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">tabyl</span>(gender, age_cat_small, <span class="at">show_na =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">adorn_totals</span>(<span class="at">where =</span> <span class="st">"both"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">adorn_percentages</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">adorn_pct_formatting</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">adorn_ns</span>(<span class="at">position =</span> <span class="st">"front"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> gender         0-4          5-19           20+          Total
      f 482 (22.4%) 1,184 (54.9%)   490 (22.7%) 2,156 (100.0%)
      m 325 (15.0%)   880 (40.6%)   960 (44.3%) 2,165 (100.0%)
  Total 807 (18.7%) 2,064 (47.8%) 1,450 (33.6%) 4,321 (100.0%)</code></pre>
</div>
</div>
<!-- Epi::stat.table(  -->
<!--   #give variables for the cross tabulation -->
<!--   list( -->
<!--     gender,  -->
<!--     age_cat_small -->
<!--     ), -->
<!--   #precise the function you want to call (mean,count..) -->
<!--   list(  -->
<!--     count(), -->
<!--     percent(age_cat_small) -->
<!--     ),  -->
<!--   #add margins -->
<!--   margins=T,  -->
<!--   #data used -->
<!--   data = linelist_surv  -->
<!--   ) -->
<!-- ``` -->
<!-- ======================================================= -->
</section>
</section>
<section id="生存時間解析の基本" class="level2" data-number="27.3">
<h2 data-number="27.3" class="anchored" data-anchor-id="生存時間解析の基本"><span class="header-section-number">27.3</span> 生存時間解析の基本</h2>
<section id="surv-型オブジェクトの作成" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="surv-型オブジェクトの作成">Surv 型オブジェクトの作成</h3>
<p>はじめに、<strong>survival</strong> パッケージの <code>Surv()</code> を用いて、追跡時間とイベントの変数から生存時間解析のオブジェクトを作成します。</p>
<p>このステップを実行すると、時間の情報と興味のあるイベント（死亡）が観測されたかどうかの情報が集約された <em>Surv</em> 型のオブジェクトが作成されます。このオブジェクトは最終的に後で出てくるモデル式の右辺で用いられます（詳細については<a href="https://cran.r-project.org/web/packages/survival/vignettes/survival.pdf）を確認してください">マニュアル</a>。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 右側打切りデータに Surv() 構文を使用</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>survobj <span class="ot">&lt;-</span> <span class="fu">Surv</span>(<span class="at">time =</span> linelist_surv<span class="sc">$</span>futime,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">event =</span> linelist_surv<span class="sc">$</span>event)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ```{r} -->
<!-- survobj <- with(linelist_surv, -->
<!--                 survival::Surv(futime, event) -->
<!--                 ) -->
<!-- ``` -->
<p>ここで、確認のため <code>linelist_surv</code> データのいくつかの重要な変数について最初の10行を表示します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">select</span>(case_id, date_onset, date_outcome, futime, outcome, event) <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   case_id date_onset date_outcome futime outcome event
1   8689b7 2014-05-13   2014-05-18      5 Recover     0
2   11f8ea 2014-05-16   2014-05-30     14 Recover     0
3   893f25 2014-05-21   2014-05-29      8 Recover     0
4   be99c8 2014-05-22   2014-05-24      2 Recover     0
5   07e3e8 2014-05-27   2014-06-01      5 Recover     0
6   369449 2014-06-02   2014-06-07      5   Death     1
7   f393b4 2014-06-05   2014-06-18     13 Recover     0
8   1389ca 2014-06-05   2014-06-09      4   Death     1
9   2978ac 2014-06-06   2014-06-15      9   Death     1
10  fc15ef 2014-06-16   2014-07-09     23 Recover     0</code></pre>
</div>
</div>
<p>さらに、<code>survobj</code> の最初の10要素を表示します。基本的には追跡時間のベクトルが表示され、右側打切りの観測値の場合は “+” も表示されます。各値が上の出力と下の出力でどのようになっているか確認してください。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># このベクトルの最初の10要素を表示し、どのようになっているかを確認</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(survobj, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  5+ 14+  8+  2+  5+  5  13+  4   9  23+</code></pre>
</div>
</div>
</section>
<section id="最初の解析の実行" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="最初の解析の実行">最初の解析の実行</h3>
<p>まず、<code>survfit()</code> を用いて <u>survfit オブジェクト</u> を作成し、解析を始めます。<code>survfit()</code> は、全体（周辺）生存曲線の <strong><em>Kaplan Meier</em></strong>（KM）推定値を得るための標準の解析を行います。KM 推定値はイベントの観測時点でジャンプする階段関数となっています。最終的な <u>survfit オブジェクト</u> は1つかまたはそれ以上の生存曲線を含んでおり、モデルを指定する formula 構文の反応変数として <em>Surv</em> オブジェクトを用いることで作成されます。</p>
<p><span style="color: black;"><strong><u>注釈：</u></strong> Kaplan-Meier 推定量は生存関数のノンパラメトリック最尤推定量（maximum likelihood estimate; MLE）です（詳細についてはその他の情報を確認してください）。</span></p>
<p>この <u>survfit オブジェクト</u> は<u>生命表</u>（life table）と呼ばれるものに要約されます。追跡時間（<code>time</code>）のイベントが発生した各時間区間について（昇順で）：</p>
<ul>
<li>イベント発生のリスクに晒された（イベントも打切りも経験していない人の）人数（<code>n.risk</code>）</li>
<li>イベントが発生した人数（<code>n.event</code>）</li>
<li>上記から求めたイベントを発生して<u>いない</u>確率（死亡していない確率、または特定の時間まで生存する確率）</li>
<li>最後に、その確率の標準誤差と信頼区間が求められ表示されます</li>
</ul>
<p>以下では、上で作成した Surv 型のオブジェクト “survobj” を反応変数とした formula を用いて KM 推定値を求めます。“~ 1” は全体の生存に対するモデルを実行することを意味します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Surv 型オブジェクト "survobj" を反応変数としたモデル式を用いて KM 推定値を求めます</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># "~ 1" は全体の生存に対するモデルを実行することを意味します</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>linelistsurv_fit <span class="ot">&lt;-</span>  survival<span class="sc">::</span><span class="fu">survfit</span>(survobj <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 詳細をみるための要約を表示</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linelistsurv_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = survobj ~ 1)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    1   4539      30    0.993 0.00120        0.991        0.996
    2   4500      69    0.978 0.00217        0.974        0.982
    3   4394     149    0.945 0.00340        0.938        0.952
    4   4176     194    0.901 0.00447        0.892        0.910
    5   3899     214    0.852 0.00535        0.841        0.862
    6   3592     210    0.802 0.00604        0.790        0.814
    7   3223     179    0.757 0.00656        0.745        0.770
    8   2899     167    0.714 0.00700        0.700        0.728
    9   2593     145    0.674 0.00735        0.660        0.688
   10   2311     109    0.642 0.00761        0.627        0.657
   11   2081     119    0.605 0.00788        0.590        0.621
   12   1843      89    0.576 0.00809        0.560        0.592
   13   1608      55    0.556 0.00823        0.540        0.573
   14   1448      43    0.540 0.00837        0.524        0.556
   15   1296      31    0.527 0.00848        0.511        0.544
   16   1152      48    0.505 0.00870        0.488        0.522
   17   1002      29    0.490 0.00886        0.473        0.508
   18    898      21    0.479 0.00900        0.462        0.497
   19    798       7    0.475 0.00906        0.457        0.493
   20    705       4    0.472 0.00911        0.454        0.490
   21    626      13    0.462 0.00932        0.444        0.481
   22    546       8    0.455 0.00948        0.437        0.474
   23    481       5    0.451 0.00962        0.432        0.470
   24    436       4    0.447 0.00975        0.428        0.466
   25    378       4    0.442 0.00993        0.423        0.462
   26    336       3    0.438 0.01010        0.419        0.458
   27    297       1    0.436 0.01017        0.417        0.457
   29    235       1    0.435 0.01030        0.415        0.455
   38     73       1    0.429 0.01175        0.406        0.452</code></pre>
</div>
</div>
<p><code>summary()</code> を用いる際には <code>times</code> オプションを追加することができ、求めたい特定の時点における生存確率などの情報を確認することができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 特定の時点における要約を表示</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linelistsurv_fit, <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">60</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = survobj ~ 1)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    5   3899     656    0.852 0.00535        0.841        0.862
   10   2311     810    0.642 0.00761        0.627        0.657
   20    705     446    0.472 0.00911        0.454        0.490
   30    210      39    0.435 0.01030        0.415        0.455
   60      2       1    0.429 0.01175        0.406        0.452</code></pre>
</div>
</div>
<p>また、<code>print()</code> を用いることもできます。引数に <code>print.rmean = TRUE</code> を指定すると、平均生存時間と標準誤差を表示することができます。</p>
<p><span style="color: black;"><strong><u>注釈：</u></strong> 制限付き平均生存時間（restricted mean survival time; RMST）は生存の要約指標の 1 つであり、がんの生存時間解析で使われるようになってきています。RMST は、しばしば制限時間 <span class="math inline">\(T\)</span> までに観測された人に対して求めた生存曲線の曲線下面積として定義されます（詳細についてはその他の情報の節を確認してください）。</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># linelistsurv_fit オブジェクトを平均生存時間とその標準誤差とともに表示します</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(linelistsurv_fit, <span class="at">print.rmean =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = survobj ~ 1)

        n events rmean* se(rmean) median 0.95LCL 0.95UCL
[1,] 4539   1952   33.1     0.539     17      16      18
    * restricted mean with upper limit =  64 </code></pre>
</div>
</div>
<p><span style="color: darkgreen;"><strong><u>ヒント：</u></strong> <u>Surv オブジェクト</u> を <code>survfit()</code> の中に直接書くこともでき、コードを1行節約することができます。その場合、次のように書きます：<code>linelistsurv_quick &lt;- survfit(Surv(futime, event) ~ 1, data = linelist_surv)</code>。</span></p>
</section>
<section id="累積ハザード" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="累積ハザード">累積ハザード</h3>
<p><code>summary()</code> 以外にも、<code>str()</code> を用いて <code>survfit()</code> オブジェクトの構造についての詳細を確認できます。<code>survfit()</code> オブジェクトは16個の要素を持つリストになっています。</p>
<p>これらの要素の中には重要な要素（<code>cumhaz</code> という実数型のベクトル）があります。これは<strong><u>累積ハザード</u></strong>の図示に用いることができます。<strong><u>ハザード</u></strong>は<strong><u>瞬間イベント発生率</u></strong>です（文献を確認してください）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(linelistsurv_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 16
 $ n        : int 4539
 $ time     : num [1:59] 1 2 3 4 5 6 7 8 9 10 ...
 $ n.risk   : num [1:59] 4539 4500 4394 4176 3899 ...
 $ n.event  : num [1:59] 30 69 149 194 214 210 179 167 145 109 ...
 $ n.censor : num [1:59] 9 37 69 83 93 159 145 139 137 121 ...
 $ surv     : num [1:59] 0.993 0.978 0.945 0.901 0.852 ...
 $ std.err  : num [1:59] 0.00121 0.00222 0.00359 0.00496 0.00628 ...
 $ cumhaz   : num [1:59] 0.00661 0.02194 0.05585 0.10231 0.15719 ...
 $ std.chaz : num [1:59] 0.00121 0.00221 0.00355 0.00487 0.00615 ...
 $ type     : chr "right"
 $ logse    : logi TRUE
 $ conf.int : num 0.95
 $ conf.type: chr "log"
 $ lower    : num [1:59] 0.991 0.974 0.938 0.892 0.841 ...
 $ upper    : num [1:59] 0.996 0.982 0.952 0.91 0.862 ...
 $ call     : language survfit(formula = survobj ~ 1)
 - attr(*, "class")= chr "survfit"</code></pre>
</div>
</div>
<!-- ======================================================= -->
</section>
<section id="kaplanmeier-曲線の作成" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="kaplanmeier-曲線の作成">Kaplan–Meier 曲線の作成</h3>
<p>KM 推定値が計算されていれば、「Kaplan-Meier 曲線」を描画できる基本の <code>plot()</code> を用いて、時間を通じた生存確率を視覚化できます。言い換えると、以下の曲線は集団全体における生存状況を標準的な図で表したものです。</p>
<p>この曲線から、追跡時間の最小値と最大値を容易に確認できます。</p>
<p>簡単な解釈を説明すると、時点0においては全ての人が生存しており生存確率は100%です。この確率は死亡が発生するにつれて時間とともに減少していきます。追跡時間が60日が経過した後の生存割合は約40%です。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(linelistsurv_fit, </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days of follow-up"</span>,     <span class="co"># x 軸のラベル</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>,  <span class="co"># y 軸のラベル</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Overall survival curve"</span> <span class="co"># 図のタイトル</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.jp_files/figure-html/unnamed-chunk-13-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="survival_analysis.jp_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>KM 推定値の信頼区間もデフォルトで描画されますが、<code>plot()</code> コマンドの <code>conf.int = FALSE</code> オプションを追加することで信頼区間を非表示にできます。</p>
<p>興味のあるイベントは「死亡」であるため、1から生存割合を引いたものの曲線を描くと累積発生率の図が得られます。これは <code>lines()</code> で描くことができ、元々あるプロットに情報が追加されます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># オリジナルのプロット</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>     linelistsurv_fit,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days of follow-up"</span>,       </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>,       </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">mark.time =</span> <span class="cn">TRUE</span>,              <span class="co"># 曲線上にイベントのマークを追加："+" を全てのイベント時点に表示</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">conf.int =</span> <span class="cn">FALSE</span>,              <span class="co"># 信頼区間を非表示</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Overall survival curve and cumulative mortality"</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 元のプロットに追加の曲線を描画</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>     linelistsurv_fit,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">lty =</span> <span class="dv">3</span>,             <span class="co"># 分かりやすくするために異なる線種を使用</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">fun =</span> <span class="st">"event"</span>,       <span class="co"># 生存ではなく累積イベントを描画</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">mark.time =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">conf.int =</span> <span class="cn">FALSE</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="co"># プロットに凡例を追加</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>     <span class="st">"topright"</span>,                               <span class="co"># 凡例の位置</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>     <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Survival"</span>, <span class="st">"Cum. Mortality"</span>), <span class="co"># 凡例のテキスト</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>     <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>),                            <span class="co"># 凡例で用いる線種</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex =</span> .<span class="dv">85</span>,                                <span class="co"># 凡例テキストのサイズを定義するパラメータ</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>     <span class="at">bty =</span> <span class="st">"n"</span>                                 <span class="co"># 凡例にボックスを非表示</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.jp_files/figure-html/unnamed-chunk-14-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="survival_analysis.jp_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<!-- ======================================================= -->
</section>
</section>
<section id="生存曲線の比較" class="level2" data-number="27.4">
<h2 data-number="27.4" class="anchored" data-anchor-id="生存曲線の比較"><span class="header-section-number">27.4</span> 生存曲線の比較</h2>
<p>観測された参加者または患者における異なる群の生存を比較するためには、最初にそれぞれの生存曲線を確認し、独立した群間の差を評価する仮説検定を行う必要があるかもしれません。この比較は、性別、年齢、治療法、合併症などに基づいたグループに関するものになるかもしれません。</p>
<section id="ログランク検定" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ログランク検定">ログランク検定</h3>
<p>ログランク検定（log-rank test）は、2つまたはそれ以上の<u>独立</u>した群における生存状況を比較する主要な仮説検定で、生存曲線が同一（重なっている）かそうでないかの仮説検定と考えることができます（帰無仮説として群間の生存確率に差がないことを仮定しています）。<strong>survival パッケージ</strong>の <code>survdiff()</code> は、オプションで <code>rho = 0</code> を指定した場合（デフォルトの設定がこれになっています）にログランク検定を実行できます。ログランク統計量はカイ二乗検定統計量と同様に漸近的にカイ二乗分布に従うため、この仮説検定の結果としてカイ二乗統計量と p 値が出力されます。</p>
<p>まずは性別ごとの生存曲線を比較してみましょう。そのため、最初に視覚化を行ってみます（2つの生存曲線が重なるかどうかを確認します）。新しい <u>survfit オブジェクト</u> は少し異なる formula を用いて作成されます。そして、<u>survdiff オブジェクト</u> が作成されます。</p>
<p>モデル式を記述している formula の右辺に <code>~ gender</code> を指定することで、全体の生存ではなく性別ごとのプロットを作成できます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 性別に基づいて新しい survfit オブジェクトを作成</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>linelistsurv_fit_sex <span class="ot">&lt;-</span>  <span class="fu">survfit</span>(<span class="fu">Surv</span>(futime, event) <span class="sc">~</span> gender, <span class="at">data =</span> linelist_surv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>新しいオブジェクトを作成すると、性別ごとの生存曲線を作成できます。色や凡例を決める前に、性別の列の水準の順番を見てみましょう。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 色を設定</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>col_sex <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"lightgreen"</span>, <span class="st">"darkgreen"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># プロットを作成</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>     linelistsurv_fit_sex,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> col_sex,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days of follow-up"</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 凡例の追加</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>     <span class="st">"topright"</span>,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Female"</span>,<span class="st">"Male"</span>),</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> col_sex,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">lty =</span> <span class="dv">1</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex =</span> .<span class="dv">9</span>,</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">bty =</span> <span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.jp_files/figure-html/unnamed-chunk-15-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="survival_analysis.jp_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>そして、<code>survdiff()</code> を用いて生存曲線の群間差の仮説検定を行うことができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 生存曲線の差の仮説検定を実行</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>survival<span class="sc">::</span><span class="fu">survdiff</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">Surv</span>(futime, event) <span class="sc">~</span> gender, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">data =</span> linelist_surv</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survival::survdiff(formula = Surv(futime, event) ~ gender, data = linelist_surv)

n=4321, 218 observations deleted due to missingness.

            N Observed Expected (O-E)^2/E (O-E)^2/V
gender=f 2156      924      909     0.255     0.524
gender=m 2165      929      944     0.245     0.524

 Chisq= 0.5  on 1 degrees of freedom, p= 0.5 </code></pre>
</div>
</div>
<p>女性と男性の生存曲線が重なっているのが分かり、ログランク検定の結果も生存状況の性差を示唆していませんでした。</p>
<p>他の R パッケージでも生存曲線の群間差の図示と群間差の仮説検定を同時に行うことができます。<strong>survminer</strong> パッケージの <code>ggsurvplot()</code> を用いると、各群の生存曲線とリスク集合の表とログランク検定の p 値を表示することができます。</p>
<p><span style="color: orange;"><strong><u>注意：</u></strong> <strong>ggsurvplot()</strong> では survfit オブジェクト <u>に加えて</u> そのオブジェクトを作成するのに用いたデータを再度指定する必要があります。エラーメッセージが表示されてしまうので、忘れずに指定してください。</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>     linelistsurv_fit_sex, </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">data =</span> linelist_surv,          <span class="co"># linelistsurv_fit_sex を作成するのに用いたデータを再度指定</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">conf.int =</span> <span class="cn">FALSE</span>,              <span class="co"># KM 推定値の信頼区間を非表示</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">surv.scale =</span> <span class="st">"percent"</span>,        <span class="co"># y 軸の確率を % で表示</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">break.time.by =</span> <span class="dv">10</span>,            <span class="co"># x 軸の時間を 10 日刻みで表示</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Follow-up days"</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">pval =</span> T,                      <span class="co"># ログランク検定の p 値を表示</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">pval.coord =</span> <span class="fu">c</span>(<span class="dv">40</span>, .<span class="dv">91</span>),       <span class="co"># 座標を指定して p 値を表示</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">risk.table =</span> T,                <span class="co"># 下にリスク集合の表を表示</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">legend.title =</span> <span class="st">"Gender"</span>,       <span class="co"># 凡例のタイトル</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"Female"</span>, <span class="st">"Male"</span>),</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">font.legend =</span> <span class="dv">10</span>, </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">palette =</span> <span class="st">"Dark2"</span>,             <span class="co"># カラーパレットの指定</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">surv.median.line =</span> <span class="st">"hv"</span>,       <span class="co"># 生存時間中央値の位置に縦と横の補助線を描画</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">ggtheme =</span> <span class="fu">theme_light</span>()        <span class="co"># シンプルなテーマを使用</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.jp_files/figure-html/unnamed-chunk-17-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="survival_analysis.jp_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>また、感染源（汚染源）による生存の違いを検証したい場合があるかもしれません。</p>
<p>このケースについては、<code>alpha = 0.05</code> でのログランク検定により十分な生存確率の差があると考えることにします。葬儀により感染した患者の生存確率は他の場所で感染した患者の生存確率よりも高く、生存に対するベネフィットがあるのかもしれません。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>linelistsurv_fit_source <span class="ot">&lt;-</span>  <span class="fu">survfit</span>(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">Surv</span>(futime, event) <span class="sc">~</span> source,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">data =</span> linelist_surv</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co"># プロット</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>( </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>     linelistsurv_fit_source,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">data =</span> linelist_surv,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">size =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"strata"</span>,   <span class="co"># 線種</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">conf.int =</span> T,</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">surv.scale =</span> <span class="st">"percent"</span>,  </span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">break.time.by =</span> <span class="dv">10</span>, </span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Follow-up days"</span>,</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span> <span class="st">"Survival Probability"</span>,</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">pval =</span> T,</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">pval.coord =</span> <span class="fu">c</span>(<span class="dv">40</span>, .<span class="dv">91</span>),</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">risk.table =</span> T,</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>     <span class="at">legend.title =</span> <span class="st">"Source of </span><span class="sc">\n</span><span class="st">infection"</span>,</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>     <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"Funeral"</span>, <span class="st">"Other"</span>),</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>     <span class="at">font.legend =</span> <span class="dv">10</span>,</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>     <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#E7B800"</span>, <span class="st">"#3E606F"</span>),</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>     <span class="at">surv.median.line =</span> <span class="st">"hv"</span>, </span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>     <span class="at">ggtheme =</span> <span class="fu">theme_light</span>()</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in geom_segment(aes(x = 0, y = max(y2), xend = max(x1), yend = max(y2)), : All aesthetics have length 1, but the data has 2 rows.
ℹ Did you mean to use `annotate()`?
All aesthetics have length 1, but the data has 2 rows.
ℹ Did you mean to use `annotate()`?
All aesthetics have length 1, but the data has 2 rows.
ℹ Did you mean to use `annotate()`?
All aesthetics have length 1, but the data has 2 rows.
ℹ Did you mean to use `annotate()`?</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.jp_files/figure-html/unnamed-chunk-18-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="survival_analysis.jp_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<!-- ======================================================= -->
</section>
</section>
<section id="cox-回帰分析" class="level2" data-number="27.5">
<h2 data-number="27.5" class="anchored" data-anchor-id="cox-回帰分析"><span class="header-section-number">27.5</span> Cox 回帰分析</h2>
<p>Cox の比例ハザードモデル（Cox proportional hazards model / Cox regression model）は生存時間解析の最も一般的な回帰モデルの一つです。Cox 回帰モデルは、比例ハザード性の仮定などの適切に用いるために検証を必要とする <u>重要な仮定</u> をおくため、他のモデルを用いることもできます。詳細は文献を確認してください。</p>
<p>Cox の比例ハザードモデルにおける効果の尺度は <strong><u>ハザード率</u></strong>（hazard rate）で、これは特定の時点までイベントが発生しなかった人のイベント発生リスク（この章の例では、死亡のリスク）になっています。通常、<u>独立</u>な群におけるハザードの比較に興味があるためハザード比（hazard ratio; HR）を用います。ハザード比は多重ロジスティック回帰分析におけるオッズ比に相当する指標です。<strong>survival</strong> パッケージの <code>coxph()</code> は、Cox 回帰モデルの当てはめに用いられます。<strong>survival</strong> パッケージの <code>cox.zph()</code> は、当てはめたモデルについて比例ハザード性の仮定に対する仮説検定に用いることができます。</p>
<p><span style="color: black;"><strong>注釈：</strong> 確率は0から1の間の値をとります。一方で、ハザードは単位時間当たりのイベント発生数の期待値を表しています。</span></p>
<ul>
<li>ある説明変数に対するハザード比が1に近ければ、その説明変数は生存に影響を与えていません</li>
<li>ハザード比が1より小さければ、その説明変数は保護的です（すなわち、生存の改善に関連があります）</li>
<li>ハザード比が1より大きければ、その説明変数はリスクの上昇（生存の悪化）に関連があります。</li>
</ul>
<section id="cox-回帰モデルの当てはめ" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="cox-回帰モデルの当てはめ">Cox 回帰モデルの当てはめ</h3>
<p>まずは、年齢と性別が生存に与える影響を評価するために、モデルの当てはめを行います。モデルの当てはめ結果を表示するだけで、以下の情報が得られます：</p>
<ul>
<li>回帰係数の推定値 <code>coef</code>、この値は説明変数とアウトカムの間の関連を定量化したものです</li>
<li>これらの値を解釈のために指数変換した <code>exp(coef)</code>、これは<u>ハザード比</u>になっています</li>
<li>これらの値の標準誤差 <code>se(coef)</code></li>
<li>z スコア：回帰係数の推定値が 0 から何標準誤差離れているか</li>
<li>p 値：回帰係数が 0 かどうかの仮説検定における p 値。</li>
</ul>
<p>Cox 回帰モデルのオブジェクトに <code>summary()</code> を適用すると、ハザード比の推定値の信頼区間や別の仮説検定の結果などのより詳細な情報が得られます。</p>
<p>最初の共変量 <code>gender</code> の効果は最初の行に表示されています。ここには <code>genderm</code>（男性）と表示されており、最初の水準（“f”）、つまり女性が性別の参照水準となっていることが分かります。そのため、パラメータは女性に対する男性の結果として解釈します。また、p 値から、性別によるハザードの期待値に対する影響または性別と全死亡率の間に関連があるとは言えないです。</p>
<p>同様に、年齢群についても差があるとは言えないです。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox 回帰モデルの当てはめ</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>linelistsurv_cox_sexage <span class="ot">&lt;-</span>  survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">Surv</span>(futime, event) <span class="sc">~</span> gender <span class="sc">+</span> age_cat_small, </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">data =</span> linelist_surv</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルの当てはめ結果の表示</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>linelistsurv_cox_sexage</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survival::coxph(formula = Surv(futime, event) ~ gender + age_cat_small, 
    data = linelist_surv)

                      coef exp(coef) se(coef)      z     p
genderm           -0.03149   0.96900  0.04767 -0.661 0.509
age_cat_small5-19  0.09400   1.09856  0.06454  1.456 0.145
age_cat_small20+   0.05032   1.05161  0.06953  0.724 0.469

Likelihood ratio test=2.8  on 3 df, p=0.4243
n= 4321, number of events= 1853 
   (218 observations deleted due to missingness)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルの要約</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linelistsurv_cox_sexage)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survival::coxph(formula = Surv(futime, event) ~ gender + age_cat_small, 
    data = linelist_surv)

  n= 4321, number of events= 1853 
   (218 observations deleted due to missingness)

                      coef exp(coef) se(coef)      z Pr(&gt;|z|)
genderm           -0.03149   0.96900  0.04767 -0.661    0.509
age_cat_small5-19  0.09400   1.09856  0.06454  1.456    0.145
age_cat_small20+   0.05032   1.05161  0.06953  0.724    0.469

                  exp(coef) exp(-coef) lower .95 upper .95
genderm               0.969     1.0320    0.8826     1.064
age_cat_small5-19     1.099     0.9103    0.9680     1.247
age_cat_small20+      1.052     0.9509    0.9176     1.205

Concordance= 0.514  (se = 0.007 )
Likelihood ratio test= 2.8  on 3 df,   p=0.4
Wald test            = 2.78  on 3 df,   p=0.4
Score (logrank) test = 2.78  on 3 df,   p=0.4</code></pre>
</div>
</div>
<p>モデルの当てはめを行い結果を見るのは面白いですが、最初に比例ハザード性の仮定が成り立つかどうかを検討しておくと、時間の節約になります。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>test_ph_sexage <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">cox.zph</span>(linelistsurv_cox_sexage)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>test_ph_sexage</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              chisq df    p
gender        0.454  1 0.50
age_cat_small 0.838  2 0.66
GLOBAL        1.399  3 0.71</code></pre>
</div>
</div>
<p><span style="color: black;"><strong>注釈：</strong> Cox モデルの当てはめでは2つ目の引数 <u>method</u> を指定でき、タイの取り扱い方法を変更することができます。<u>デフォルト</u>は “efron” で、他にも “breslow” や “exact” が指定できます。</span></p>
<p>他のモデルとして感染源や発症から入院までの日数をリスク因子として追加します。今回は、まず比例ハザード性の仮定の評価を先に行ってみます。</p>
<p>このモデルには連続値の説明変数（<code>days_onset_hosp</code>）が含まれています。このような場合、パラメータ推定値の解釈は、説明変数が1単位増加したときに増加する対数相対ハザードの期待値、となります。まずは、比例ハザード性の仮定の評価を行います。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルの当てはめ</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>linelistsurv_cox <span class="ot">&lt;-</span>  <span class="fu">coxph</span>(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">Surv</span>(futime, event) <span class="sc">~</span> gender <span class="sc">+</span> age_years <span class="sc">+</span> source <span class="sc">+</span> days_onset_hosp,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">data =</span> linelist_surv</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 比例ハザード性の仮説検定</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>linelistsurv_ph_test <span class="ot">&lt;-</span> <span class="fu">cox.zph</span>(linelistsurv_cox)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>linelistsurv_ph_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   chisq df       p
gender           0.45062  1    0.50
age_years        0.00199  1    0.96
source           1.79622  1    0.18
days_onset_hosp 31.66167  1 1.8e-08
GLOBAL          34.08502  4 7.2e-07</code></pre>
</div>
</div>
<p>また、<strong>survminer</strong> パッケージの <code>ggcoxzph()</code> を用いて、この仮定に対する視覚的な評価を行うことができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>survminer<span class="sc">::</span><span class="fu">ggcoxzph</span>(linelistsurv_ph_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.jp_files/figure-html/unnamed-chunk-19-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="survival_analysis.jp_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>モデルの当てはめ結果から、発症から入院までの日数と全死亡率の間に負の関連があることが示唆されます。ハザードの期待値は、性別などを固定したもとで、発症から入院までの日数が1日遅くなると0.9倍となっていました。もっと直接的に説明すると、発症から入院までの日数が1日伸びると、死亡のリスクが10.7%（<code>coef *100</code>）減少する、となります。</p>
<p>また、モデルの結果は感染源と全死亡率の間の正の関連も示していました。これについては、他の感染による患者は葬儀で感染した患者と比べて死亡リスクが高い（1.21倍）という結果でした。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルの要約を表示</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linelistsurv_cox)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(futime, event) ~ gender + age_years + source + 
    days_onset_hosp, data = linelist_surv)

  n= 2772, number of events= 1180 
   (1767 observations deleted due to missingness)

                     coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
genderm          0.004710  1.004721  0.060827  0.077   0.9383    
age_years       -0.002249  0.997753  0.002421 -0.929   0.3528    
sourceother      0.178393  1.195295  0.084291  2.116   0.0343 *  
days_onset_hosp -0.104063  0.901169  0.014245 -7.305 2.77e-13 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                exp(coef) exp(-coef) lower .95 upper .95
genderm            1.0047     0.9953    0.8918    1.1319
age_years          0.9978     1.0023    0.9930    1.0025
sourceother        1.1953     0.8366    1.0133    1.4100
days_onset_hosp    0.9012     1.1097    0.8764    0.9267

Concordance= 0.566  (se = 0.009 )
Likelihood ratio test= 71.31  on 4 df,   p=1e-14
Wald test            = 59.22  on 4 df,   p=4e-12
Score (logrank) test = 59.54  on 4 df,   p=4e-12</code></pre>
</div>
</div>
<p>この関係を表にして確認することもできます：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>linelist_case_data <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">tabyl</span>(days_onset_hosp, outcome) <span class="sc">%&gt;%</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">adorn_percentages</span>() <span class="sc">%&gt;%</span>  </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">adorn_pct_formatting</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> days_onset_hosp Death Recover   NA_
               0 44.3%   31.4% 24.3%
               1 46.6%   32.2% 21.2%
               2 43.0%   32.8% 24.2%
               3 45.0%   32.3% 22.7%
               4 41.5%   38.3% 20.2%
               5 40.0%   36.2% 23.8%
               6 32.2%   48.7% 19.1%
               7 31.8%   38.6% 29.5%
               8 29.8%   38.6% 31.6%
               9 30.3%   51.5% 18.2%
              10 16.7%   58.3% 25.0%
              11 36.4%   45.5% 18.2%
              12 18.8%   62.5% 18.8%
              13 10.0%   60.0% 30.0%
              14 10.0%   50.0% 40.0%
              15 28.6%   42.9% 28.6%
              16 20.0%   80.0%  0.0%
              17  0.0%  100.0%  0.0%
              18  0.0%  100.0%  0.0%
              22  0.0%  100.0%  0.0%
              NA 52.7%   31.2% 16.0%</code></pre>
</div>
</div>
<p>このデータにおいて、なぜこの様な関連が見られたのかについて考え、検討する必要があります。入院まで時間がかかっていても生き延びていた患者はもともと重症度が低かった可能性があるという説明が可能です。また、別の説明も考えられ、シミュレーションによる疑似データセットを使用したため、このパターンが現実を反映していないのかもしれません。</p>
<!-- ======================================================= -->
</section>
<section id="フォレストプロット" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="フォレストプロット">フォレストプロット</h3>
<p>Cox 回帰モデルの結果について、<strong>survminer</strong> パッケージの <code>ggforest()</code> を用いて、フォレストプロットによる可視化を行うことができます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggforest</span>(linelistsurv_cox, <span class="at">data =</span> linelist_surv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.jp_files/figure-html/forestp-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="survival_analysis.jp_files/figure-html/forestp-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<!-- ======================================================= -->
</section>
</section>
<section id="生存時間モデルにおける時間依存性共変量" class="level2" data-number="27.6">
<h2 data-number="27.6" class="anchored" data-anchor-id="生存時間モデルにおける時間依存性共変量"><span class="header-section-number">27.6</span> 生存時間モデルにおける時間依存性共変量</h2>
<p>以下の節の一部は、<a href="https://www.emilyzabor.com/">Dr.&nbsp;Emily Zabor</a> の許可を得て <a href="https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html">Survival analysis in R</a> の素晴らしい解説から引用しています。</p>
<p>前の節では、Cox 回帰モデルを用いて興味のある共変量と生存アウトカムの間の関連を評価する方法を説明しました。しかし、これらの解析では、共変量がベースライン時点、つまりイベントの追跡が始まる前に測定されていること想定していました。</p>
<p>興味のある共変量が追跡を開始した<strong>後で</strong>測定されているとどうなるでしょうか？もしくは、時間で変化する共変量がある場合はどうなるでしょう？</p>
<p>例えば、臨床検査値を繰り返し測定した臨床データを扱っている場合、その値は時間の経過とともに変化する可能性があります。これは <strong>時間依存性共変量（Time Dependent Covariate）</strong> の一例です。時間依存性共変量を扱うためには特別な準備が必要です。しかし、幸運なことに Cox 回帰モデルはとても柔軟であり、また、<strong>survival</strong> パッケージと一連のツールを用いてこのタイプのデータをモデル化することができます。</p>
<section id="時間依存性共変量の設定" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="時間依存性共変量の設定">時間依存性共変量の設定</h3>
<p>R において時間依存性共変量の解析を行うためには特別なデータセットを準備する必要があります。興味があれば <strong>survival</strong> パッケージの著者による、より詳細な説明（<a href="https://cran.r-project.org/web/packages/survival/vignettes/timedep.pdf）">Using Time Dependent Covariates and Time Dependent Coefficients in the Cox Model</a> を確認してください。</p>
<p>ここでは、<code>SemiCompRisks</code> パッケージの <code>BMT</code> という新しいデータセットを使用します。このデータは137名の骨髄移植患者のデータです。この節で扱う変数は以下の通りです：</p>
<ul>
<li><code>T1</code> - 死亡時間または最終追跡時間 (日)</li>
<li><code>delta1</code> - 死亡の指示変数；1-死亡、0-生存<br>
</li>
<li><code>TA</code> - 急性移植片対宿主病発生までの時間</li>
<li><code>deltaA</code> - 急性移植片対宿主病の指示変数；</li>
<li>1 - 急性移植片対宿主病の発生あり</li>
<li>0 - 急性移植片対宿主病の発生なし</li>
</ul>
<p><strong>base</strong> の R コマンド <code>data()</code> を用いて、<strong>SemiCompRisks</strong> パッケージからこのデータセットを読み込みます。このコマンドは R パッケージに含まれているデータを読み込むことができます。以下を実行すると、<code>BMT</code> というデータフレームが R 上に読み込まれます。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(BMT, <span class="at">package =</span> <span class="st">"SemiCompRisks"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="患者固有の-id-の追加" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="患者固有の-id-の追加">患者固有の ID の追加</h4>
<p><code>BMT</code> データには患者固有の ID がありませんが、時間依存性共変量の解析には固有の ID 変数が必要です。そのため、<strong>tidyverse</strong> の <strong>tibble</strong> パッケージの <code>rowid_to_column()</code> を用いて <code>my_id</code> という新しい ID の列を作成します（データフレームの最初に1から始まる連番の ID の列を追加します）。そして、このデータフレームの名前は <code>bmt</code> としました。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>bmt <span class="ot">&lt;-</span> <span class="fu">rowid_to_column</span>(BMT, <span class="st">"my_id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>このデータセットは以下のようになります：</p>
<div class="cell">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-494f244faa31106e076b" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-494f244faa31106e076b">{"x":{"filter":"none","vertical":false,"data":[[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[2081,1602,1496,1462,1433,1377,1330,996,226,1199,1111,530,1182,1167,418,417,276,156,781,172,487,716,194,371,526,122,1279,110,243,86,466,262,162,262,1,107,269,350,2569,2506,2409,2218,1857,1829,1562,1470,1363,1030,860,1258,2246,1870,1799,1709,1674,1568,1527,1324,957,932,847,848,1850,1843,1535,1447,1384,414,2204,1063,481,105,641,390,288,522,79,1156,583,48,431,1074,393,10,53,80,35,1499,704,653,222,1356,2640,2430,2252,2140,2133,1238,1631,2024,1345,1136,845,491,162,1298,121,2,62,265,547,341,318,195,469,93,515,183,105,128,164,129,122,80,677,73,168,74,16,248,732,105,392,63,97,153,363],[2081,1602,1496,1462,1433,1377,1330,996,226,1199,1111,530,1182,1167,418,383,276,104,609,172,487,662,194,230,526,122,129,74,122,86,466,192,109,55,1,107,110,332,2569,2506,2409,2218,1857,1829,1562,1470,1363,1030,860,1258,2246,1870,1799,1709,1674,1568,1527,1324,957,932,847,848,1850,1843,1535,1447,1384,414,2204,1063,481,105,641,390,288,421,79,748,486,48,272,1074,381,10,53,80,35,248,704,211,219,606,2640,2430,2252,2140,2133,1238,1631,2024,1345,1136,845,422,162,84,100,2,47,242,456,268,318,32,467,47,390,183,105,115,164,93,120,80,677,64,168,74,16,157,625,48,273,63,76,113,363],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,0,1,0,1,0,0,1,1,1,0,0,1,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,1,0,1,0,0,0,0,1,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,1,1,1,1,0,1,1,1,1,0,0,1,0,1,1,0,0,1,0,0,0,1,1,1,1,0,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[67,1602,1496,70,1433,1377,1330,72,226,1199,1111,38,1182,39,418,417,276,28,781,22,487,716,194,371,526,88,1279,110,243,86,466,10,162,262,1,107,269,350,2569,2506,2409,2218,1857,1829,1562,1470,1363,1030,860,1258,52,1870,1799,20,1674,1568,1527,25,957,29,847,848,1850,1843,1535,1447,1384,414,2204,1063,30,21,641,390,18,25,16,1156,583,48,431,1074,393,10,53,10,35,1499,36,653,222,1356,2640,2430,2252,2140,2133,1238,1631,2024,32,1136,845,491,162,1298,28,2,62,265,547,21,318,195,469,93,515,183,105,128,164,129,122,21,677,73,168,29,16,248,732,105,392,38,97,153,363],[1,0,0,1,0,0,0,1,0,0,0,1,0,1,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,1,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0],[121,139,307,95,236,123,96,121,226,91,1111,84,112,487,220,417,81,156,781,172,76,716,94,184,121,122,1279,110,243,86,119,84,162,262,1,107,120,350,2569,2506,2409,2218,260,1829,1562,180,200,210,860,120,380,230,140,348,1674,1568,1527,1324,957,932,847,155,1850,1843,1535,220,200,414,2204,240,120,105,641,390,100,140,79,180,583,48,431,120,100,10,53,80,35,1499,155,653,123,1356,2640,2430,150,220,250,250,150,180,360,140,845,180,162,1298,121,2,62,210,130,100,140,195,90,93,515,130,105,128,164,129,122,80,150,73,200,74,16,100,732,105,122,63,97,153,363],[1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,0,1,0,0,0,1,0,1,1,1,0,0,0,0,0,1,1,0,0,0,0,1,0,0,0,0,0,1,0,0,1,1,1,0,1,1,1,1,1,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,1,0,0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,1,1,1,1,1,1,1,1,0,1,0,0,0,0,0,1,1,1,1,0,1,0,0,1,0,0,0,0,0,0,1,0,1,0,0,1,0,0,1,0,0,0,0],[13,18,12,13,12,12,17,12,10,29,22,34,22,1167,21,16,21,20,26,37,22,17,25,9,11,13,22,49,23,86,100,59,40,24,1,107,27,33,21,17,16,11,15,19,18,14,12,14,15,66,15,16,12,19,24,14,13,15,69,7,16,16,9,19,21,24,19,27,12,16,24,15,11,11,288,20,79,18,11,14,12,19,16,10,53,80,35,9,18,23,52,14,22,14,17,18,17,18,40,16,14,15,20,491,13,1298,65,2,11,14,24,17,12,16,20,28,31,21,105,12,164,51,12,0,8,38,48,24,16,52,18,30,24,16,97,59,19],[1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1,1],[26,21,26,17,32,22,20,22,18,24,19,17,24,27,18,15,18,20,27,40,22,28,26,39,15,20,17,28,37,17,15,29,36,23,42,30,29,22,19,31,35,16,29,19,26,27,13,25,25,30,45,33,32,23,37,15,22,46,18,27,28,23,37,34,35,33,21,21,25,50,35,37,26,50,45,28,43,14,17,32,30,30,33,34,33,30,23,35,29,23,28,33,18,29,35,27,36,24,27,35,50,47,40,22,22,8,39,20,27,32,31,20,35,36,35,7,23,11,14,37,19,37,25,35,15,45,32,41,27,33,39,17,43,44,48,31,52],[33,37,35,21,36,31,17,24,21,40,28,28,23,22,14,20,5,33,27,37,20,32,32,31,20,26,20,25,38,26,18,32,43,16,48,19,20,20,13,34,31,16,35,18,30,34,24,29,31,16,39,30,23,28,34,19,12,31,17,30,29,26,36,32,32,28,18,15,19,38,36,34,24,48,43,30,43,19,14,33,23,32,28,54,41,35,25,18,21,16,30,22,23,26,31,17,39,28,21,41,36,27,39,21,23,2,48,19,25,32,28,23,40,39,33,2,25,7,18,35,32,34,29,28,14,42,43,29,36,39,43,14,50,37,56,25,48],[1,1,1,0,1,1,1,1,0,1,1,1,0,0,1,1,0,1,1,0,1,1,0,0,1,1,0,1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,0,0,0,0,1,0,1,1,0,1,1,0,1,1,0,0,0,0,0,1,0,1,1,1,1,1,1,1,0,1,0,0,0,1,0,1,0,0,0,1,0,1,1,1,1,1,1,1,0,1,1,0,1,1,0,0,1,0,1,1,1,1,1,0,0,1,0,1,1,0,1,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,1,0,1],[0,1,1,1,1,1,0,0,1,1,1,1,0,1,1,1,0,1,0,0,1,1,1,1,1,0,0,0,1,0,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,0,1,1,0,0,0,1,1,0,1,1,1,0,1,1,0,0,1,1,0,1,0,0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,1,0,1,1,1,0,1,1,1,1,0,1,1,0,0,1,1,0,0,0,0,0,1,1,1,0,0,1,1,1,0,1,1,1,0,0,0,1,1,0,1,1,1,1,0,0,1,1,1,1,1,1,1],[1,0,1,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,1,1,1,0,1,1,1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,0,1,0,1,0,1,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,1,1,1,0,0,1,0,0,0,0,1,1,1,0,1,1,0,1,0,1,0,1,1,0,0,0,1,0,1,1,0,1,1,1,0,0,1,1,0,0,0,1,1,1,0,1,0,1,0,0,1,0,1,1,0,1,1,1,1,1,1,1,0,1,0,1,1,1],[1,0,0,0,1,1,1,0,0,1,1,0,1,1,0,0,0,1,1,1,0,0,0,1,0,1,0,0,1,0,0,0,0,1,0,1,1,0,0,0,1,0,0,0,1,1,0,0,1,0,0,1,0,0,0,0,1,1,0,0,0,0,1,1,0,1,0,1,1,0,1,1,0,0,1,1,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,1,0,0,0,1,1,1,0,0,0,0,0,0,1,1,0,1,0,0,0,1,1,0,1,1,0,0,0,1,1,0],[98,1720,127,168,93,2187,1006,1319,208,174,236,151,203,191,110,824,146,85,187,129,128,84,329,147,943,2616,937,303,170,239,508,74,393,331,196,178,361,834,270,60,120,60,90,210,90,240,90,210,180,180,105,225,120,90,60,90,450,75,90,60,75,180,180,270,180,150,120,120,60,270,90,120,90,120,90,90,90,60,120,150,120,150,120,240,180,150,150,30,105,90,120,210,750,24,120,210,240,240,690,105,120,900,210,210,300,105,210,75,90,180,630,180,300,90,120,135,210,120,150,270,285,240,510,780,150,180,150,750,180,180,150,210,240,360,330,240,180],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,0,0,1,0,0,0,0,1,0,0,1,0,1,1,0,0,0,0,1,0,0,0,1,1,1,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,1,0,0,1,1,0,1,1,1,1,1,1,1,0,1,0,1,1,1,1,0,1,1,1,1,1,1,1,0,0,1,1,1,0,1,0,0,0],[1,1,1,1,1,1,1,1,1,3,3,3,2,2,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,3,3,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,2,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,4,4,4,3,3,1,1,1,1,1,1,2,4,4,3,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,4,4,4,4,3,3,3,3,3],[0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,1,1,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,1,1,1,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>my_id<\/th>\n      <th>g<\/th>\n      <th>T1<\/th>\n      <th>T2<\/th>\n      <th>delta1<\/th>\n      <th>delta2<\/th>\n      <th>delta3<\/th>\n      <th>TA<\/th>\n      <th>deltaA<\/th>\n      <th>TC<\/th>\n      <th>deltaC<\/th>\n      <th>TP<\/th>\n      <th>deltaP<\/th>\n      <th>Z1<\/th>\n      <th>Z2<\/th>\n      <th>Z3<\/th>\n      <th>Z4<\/th>\n      <th>Z5<\/th>\n      <th>Z6<\/th>\n      <th>Z7<\/th>\n      <th>Z8<\/th>\n      <th>Z9<\/th>\n      <th>Z10<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22]},{"name":"my_id","targets":0},{"name":"g","targets":1},{"name":"T1","targets":2},{"name":"T2","targets":3},{"name":"delta1","targets":4},{"name":"delta2","targets":5},{"name":"delta3","targets":6},{"name":"TA","targets":7},{"name":"deltaA","targets":8},{"name":"TC","targets":9},{"name":"deltaC","targets":10},{"name":"TP","targets":11},{"name":"deltaP","targets":12},{"name":"Z1","targets":13},{"name":"Z2","targets":14},{"name":"Z3","targets":15},{"name":"Z4","targets":16},{"name":"Z5","targets":17},{"name":"Z6","targets":18},{"name":"Z7","targets":19},{"name":"Z8","targets":20},{"name":"Z9","targets":21},{"name":"Z10","targets":22}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="患者の行の展開" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="患者の行の展開">患者の行の展開</h4>
<p>次に、時間依存性共変量のために再構成したデータセットを作成するために、補助関数 <code>event()</code> および <code>tdc()</code> とともに <code>tmerge()</code> を使用していきます。目標は、各患者のデータが異なる値の <code>deltaA</code> を持つ時間区間になるように分割し、データセットを再構成することです。このデータの場合、各患者は急性移植片対宿主病を発症したか否かに応じて、最大で2行のデータを持つことができます。以下では、急性移植片対宿主病を発症したかどうかの新しい指示変数を <code>agvhd</code> と呼ぶことにします。</p>
<ul>
<li><code>tmerge()</code> は各患者の異なる共変量の値に応じて複数の時間区間の縦長の long 型データセットを作成します</li>
<li><code>event()</code> は新しく作成された時間区間に対応する新しいイベントの指示変数を作成します</li>
<li><code>tdc()</code> は新しく作成された時間区間に対応する新しい時間依存性共変量の列（<code>agvhd</code>）を作成します</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>td_dat <span class="ot">&lt;-</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">tmerge</span>(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">data1 =</span> bmt <span class="sc">%&gt;%</span> <span class="fu">select</span>(my_id, T1, delta1), </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">data2 =</span> bmt <span class="sc">%&gt;%</span> <span class="fu">select</span>(my_id, T1, delta1, TA, deltaA), </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">id =</span> my_id, </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">death =</span> <span class="fu">event</span>(T1, delta1),</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">agvhd =</span> <span class="fu">tdc</span>(TA)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>     )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>上記のコードで何が行われるのか、最初の5人の患者のデータを見てみましょう。</p>
<p>元のデータにおける各変数の値は以下のようになっていました：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>bmt <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">select</span>(my_id, T1, delta1, TA, deltaA) <span class="sc">%&gt;%</span> </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">filter</span>(my_id <span class="sc">%in%</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  my_id   T1 delta1   TA deltaA
1     1 2081      0   67      1
2     2 1602      0 1602      0
3     3 1496      0 1496      0
4     4 1462      0   70      1
5     5 1433      0 1433      0</code></pre>
</div>
</div>
<p>新しいデータセットにおける同じ患者のデータは以下のようになります：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>td_dat <span class="sc">%&gt;%</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">filter</span>(my_id <span class="sc">%in%</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  my_id   T1 delta1 tstart tstop death agvhd
1     1 2081      0      0    67     0     0
2     1 2081      0     67  2081     0     1
3     2 1602      0      0  1602     0     0
4     3 1496      0      0  1496     0     0
5     4 1462      0      0    70     0     0
6     4 1462      0     70  1462     0     1
7     5 1433      0      0  1433     0     0</code></pre>
</div>
</div>
<p>このデータでは、一部の患者は2つの行を持っており、各行が新しい変数 <code>agvhd</code> に異なる値を持つ2つの区間に対応するようになっています。例えば、患者1は <code>agvhd</code> の値が0の時間0から67の区間と、<code>agvhd</code> の値が1の時間67から2081の区間の2つの行を持っています。</p>
</section>
</section>
<section id="時間依存性共変量を持つ-cox-回帰モデル" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="時間依存性共変量を持つ-cox-回帰モデル">時間依存性共変量を持つ Cox 回帰モデル</h3>
<p>データを再構成し、新しく時間依存性共変量の変数 <code>aghvd</code> が追加されたので、単純な1つの時間依存性共変量を持つ Cox 回帰モデルを当てはめてみましょう。前の節で用いたものと同じ <code>coxph()</code> を用いることができますが、<code>Surv()</code> で各区間の開始時間と終了時間を指定する必要があります。これは引数 <code>time1 =</code> と <code>time2 =</code> で指定します。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>bmt_td_model <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">Surv</span>(<span class="at">time =</span> tstart, <span class="at">time2 =</span> tstop, <span class="at">event =</span> death) <span class="sc">~</span> agvhd, </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">data =</span> td_dat</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bmt_td_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time = tstart, time2 = tstop, event = death) ~ 
    agvhd, data = td_dat)

  n= 163, number of events= 80 

        coef exp(coef) se(coef)    z Pr(&gt;|z|)
agvhd 0.3351    1.3980   0.2815 1.19    0.234

      exp(coef) exp(-coef) lower .95 upper .95
agvhd     1.398     0.7153    0.8052     2.427

Concordance= 0.535  (se = 0.024 )
Likelihood ratio test= 1.33  on 1 df,   p=0.2
Wald test            = 1.42  on 1 df,   p=0.2
Score (logrank) test = 1.43  on 1 df,   p=0.2</code></pre>
</div>
</div>
<p>また、<strong>survminer</strong> パッケージの <code>ggforest()</code> を用いて Cox 回帰モデルの結果を可視化してみます：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggforest</span>(bmt_td_model, <span class="at">data =</span> td_dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.jp_files/figure-html/unnamed-chunk-28-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="survival_analysis.jp_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>フォレストプロット、信頼区間、および p 値から分かるように、この単純なモデルにおいては死亡と急性移植片対宿主病の間に強い関連があるとは言えませんでした。</p>
<!-- ======================================================= -->
</section>
</section>
<section id="参考資料" class="level2" data-number="27.7">
<h2 data-number="27.7" class="anchored" data-anchor-id="参考資料"><span class="header-section-number">27.7</span> 参考資料</h2>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2394262/">Survival Analysis Part I: Basic concepts and first analyses</a></p>
<p><a href="https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html">Survival Analysis in R</a></p>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2954271/">Survival analysis in infectious disease research: Describing events in time</a></p>
<p><a href="https://data.princeton.edu/wws509/notes/c7.pdf">Chapter on advanced survival models Princeton</a></p>
<p><a href="https://cran.r-project.org/web/packages/survival/vignettes/timedep.pdf">Using Time Dependent Covariates and Time Dependent Coefficients in the Cox Model</a></p>
<p><a href="https://publicifsv.sund.ku.dk/~ts/survival/survival-cheat.pdf">Survival analysis cheatsheet R</a></p>
<p><a href="https://paulvanderlaken.files.wordpress.com/2017/08/survminer_cheatsheet.pdf">Survminer cheatsheet</a></p>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6322561/">Paper on different survival measures for cancer registry data with Rcode provided as supplementary materials</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../new_pages/survey_analysis.jp.html" class="pagination-link" aria-label="標本調査データ分析">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">標本調査データ分析</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../new_pages/gis.jp.html" class="pagination-link" aria-label="GIS の基本">
        <span class="nav-page-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">GIS の基本</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"loop":false,"closeEffect":"zoom","descPosition":"bottom","selector":".lightbox","openEffect":"zoom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>