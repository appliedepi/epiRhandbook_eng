<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>26 Survey analysis | The Epidemiologist R Handbook</title>
<meta name="author" content="the handbook team">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.9/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.1/tabs.js"></script><script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.18/datatables.js"></script><link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.0.0/tabwid.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.9.3/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-1.57.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-1.57.1/plotly-latest.min.js"></script><link href="libs/vis-4.20.1/vis.css" rel="stylesheet">
<script src="libs/vis-4.20.1/vis.min.js"></script><script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-1.57.1/plotly-basic-1.57.1.min.js"></script><script src="libs/plotly-cartesian-1.57.1/plotly-cartesian-1.57.1.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-8.1.2/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-8.1.2/highcharts.js"></script><script src="libs/highcharts-8.1.2/highcharts-3d.js"></script><script src="libs/highcharts-8.1.2/highcharts-more.js"></script><script src="libs/highcharts-8.1.2/modules/stock.js"></script><script src="libs/highcharts-8.1.2/modules/map.js"></script><script src="libs/highcharts-8.1.2/modules/annotations.js"></script><script src="libs/highcharts-8.1.2/modules/data.js"></script><script src="libs/highcharts-8.1.2/modules/drilldown.js"></script><script src="libs/highcharts-8.1.2/modules/item-series.js"></script><script src="libs/highcharts-8.1.2/modules/offline-exporting.js"></script><script src="libs/highcharts-8.1.2/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-8.1.2/modules/exporting.js"></script><script src="libs/highcharts-8.1.2/modules/export-data.js"></script><script src="libs/highcharts-8.1.2/modules/funnel.js"></script><script src="libs/highcharts-8.1.2/modules/heatmap.js"></script><script src="libs/highcharts-8.1.2/modules/treemap.js"></script><script src="libs/highcharts-8.1.2/modules/sankey.js"></script><script src="libs/highcharts-8.1.2/modules/dependency-wheel.js"></script><script src="libs/highcharts-8.1.2/modules/organization.js"></script><script src="libs/highcharts-8.1.2/modules/solid-gauge.js"></script><script src="libs/highcharts-8.1.2/modules/streamgraph.js"></script><script src="libs/highcharts-8.1.2/modules/sunburst.js"></script><script src="libs/highcharts-8.1.2/modules/vector.js"></script><script src="libs/highcharts-8.1.2/modules/wordcloud.js"></script><script src="libs/highcharts-8.1.2/modules/xrange.js"></script><script src="libs/highcharts-8.1.2/modules/tilemap.js"></script><script src="libs/highcharts-8.1.2/modules/venn.js"></script><script src="libs/highcharts-8.1.2/modules/gantt.js"></script><script src="libs/highcharts-8.1.2/modules/timeline.js"></script><script src="libs/highcharts-8.1.2/modules/parallel-coordinates.js"></script><script src="libs/highcharts-8.1.2/modules/bullet.js"></script><script src="libs/highcharts-8.1.2/modules/coloraxis.js"></script><script src="libs/highcharts-8.1.2/modules/dumbbell.js"></script><script src="libs/highcharts-8.1.2/modules/lollipop.js"></script><script src="libs/highcharts-8.1.2/modules/series-label.js"></script><script src="libs/highcharts-8.1.2/plugins/motion.js"></script><script src="libs/highcharts-8.1.2/custom/reset.js"></script><script src="libs/highcharts-8.1.2/modules/boost.js"></script><script src="libs/highchart-binding-0.8.2/highchart.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">The Epidemiologist R Handbook</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">About this book</li>
<li><a class="" href="editorial-and-technical-notes.html"><span class="header-section-number">1</span> Editorial and technical notes</a></li>
<li><a class="" href="download-handbook-and-data.html"><span class="header-section-number">2</span> Download handbook and data</a></li>
<li class="book-part">Basics</li>
<li><a class="" href="r-basics.html"><span class="header-section-number">3</span> R Basics</a></li>
<li><a class="" href="transition-to-r.html"><span class="header-section-number">4</span> Transition to R</a></li>
<li><a class="" href="suggested-packages-1.html"><span class="header-section-number">5</span> Suggested packages</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R projects</a></li>
<li><a class="" href="import-and-export.html"><span class="header-section-number">7</span> Import and export</a></li>
<li class="book-part">Data Management</li>
<li><a class="" href="cleaning-data-and-core-functions.html"><span class="header-section-number">8</span> Cleaning data and core functions</a></li>
<li><a class="" href="working-with-dates.html"><span class="header-section-number">9</span> Working with dates</a></li>
<li><a class="" href="characters-and-strings.html"><span class="header-section-number">10</span> Characters and strings</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> Factors</a></li>
<li><a class="" href="pivoting-data.html"><span class="header-section-number">12</span> Pivoting data</a></li>
<li><a class="" href="grouping-data.html"><span class="header-section-number">13</span> Grouping data</a></li>
<li><a class="" href="joining-data.html"><span class="header-section-number">14</span> Joining data</a></li>
<li><a class="" href="de-duplication.html"><span class="header-section-number">15</span> De-duplication</a></li>
<li><a class="" href="iteration-loops-and-lists.html"><span class="header-section-number">16</span> Iteration, loops, and lists</a></li>
<li class="book-part">Analysis</li>
<li><a class="" href="descriptive-tables.html"><span class="header-section-number">17</span> Descriptive tables</a></li>
<li><a class="" href="simple-statistical-tests.html"><span class="header-section-number">18</span> Simple statistical tests</a></li>
<li><a class="" href="univariate-and-multivariable-regression.html"><span class="header-section-number">19</span> Univariate and multivariable regression</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">20</span> Missing data</a></li>
<li><a class="" href="standardised-rates.html"><span class="header-section-number">21</span> Standardised rates</a></li>
<li><a class="" href="moving-averages.html"><span class="header-section-number">22</span> Moving averages</a></li>
<li><a class="" href="time-series-and-outbreak-detection.html"><span class="header-section-number">23</span> Time series and outbreak detection</a></li>
<li><a class="" href="epidemic-modeling.html"><span class="header-section-number">24</span> Epidemic modeling</a></li>
<li><a class="" href="contact-tracing-1.html"><span class="header-section-number">25</span> Contact tracing</a></li>
<li><a class="active" href="survey-analysis.html"><span class="header-section-number">26</span> Survey analysis</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">27</span> Survival analysis</a></li>
<li><a class="" href="gis-basics.html"><span class="header-section-number">28</span> GIS basics</a></li>
<li class="book-part">Data Visualization</li>
<li><a class="" href="tables-for-presentation.html"><span class="header-section-number">29</span> Tables for presentation</a></li>
<li><a class="" href="ggplot-basics.html"><span class="header-section-number">30</span> ggplot basics</a></li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">31</span> ggplot tips</a></li>
<li><a class="" href="epidemic-curves.html"><span class="header-section-number">32</span> Epidemic curves</a></li>
<li><a class="" href="demographic-pyramids-and-likert-scales.html"><span class="header-section-number">33</span> Demographic pyramids and Likert-scales</a></li>
<li><a class="" href="heat-plots.html"><span class="header-section-number">34</span> Heat plots</a></li>
<li><a class="" href="diagrams-and-charts.html"><span class="header-section-number">35</span> Diagrams and charts</a></li>
<li><a class="" href="combinations-analysis.html"><span class="header-section-number">36</span> Combinations analysis</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">37</span> Transmission chains</a></li>
<li><a class="" href="phylogenetic-trees-1.html"><span class="header-section-number">38</span> Phylogenetic trees</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">39</span> Interactive plots</a></li>
<li class="book-part">Reports and dashboards</li>
<li><a class="" href="reports-with-r-markdown.html"><span class="header-section-number">40</span> Reports with R Markdown</a></li>
<li><a class="" href="organizing-routine-reports.html"><span class="header-section-number">41</span> Organizing routine reports</a></li>
<li><a class="" href="dashboards-with-r-markdown.html"><span class="header-section-number">42</span> Dashboards with R Markdown</a></li>
<li><a class="" href="dashboards-with-shiny.html"><span class="header-section-number">43</span> Dashboards with Shiny</a></li>
<li class="book-part">Miscellaneous</li>
<li><a class="" href="writing-functions-1.html"><span class="header-section-number">44</span> Writing functions</a></li>
<li><a class="" href="directory-interactions.html"><span class="header-section-number">45</span> Directory interactions</a></li>
<li><a class="" href="version-control-and-collaboration-with-git-and-github.html"><span class="header-section-number">46</span> Version control and collaboration with Git and Github</a></li>
<li><a class="" href="common-errors.html"><span class="header-section-number">47</span> Common errors</a></li>
<li><a class="" href="getting-help.html"><span class="header-section-number">48</span> Getting help</a></li>
<li><a class="" href="r-on-network-drives.html"><span class="header-section-number">49</span> R on network drives</a></li>
<li><a class="" href="data-table.html"><span class="header-section-number">50</span> Data Table</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="survey-analysis" class="section level1" number="26">
<h1>
<span class="header-section-number">26</span> Survey analysis<a class="anchor" aria-label="anchor" href="#survey-analysis"><i class="fas fa-link"></i></a>
</h1>
<!-- ======================================================= -->
<div id="overview-4" class="section level2" number="26.1">
<h2>
<span class="header-section-number">26.1</span> Overview<a class="anchor" aria-label="anchor" href="#overview-4"><i class="fas fa-link"></i></a>
</h2>
<p>This page demonstrates the use of several packages for survey analysis.</p>
<p>Most survey R packages rely on the <a href="https://cran.r-project.org/web/packages/survey/index.html"><strong>survey</strong> package</a>
for doing weighted analysis.
We will use <strong>survey</strong> as well as <a href="https://cran.r-project.org/web/packages/srvyr/index.html"><strong>srvyr</strong></a>
(a wrapper for <strong>survey</strong> allowing for tidyverse-style coding) and
<a href="https://cran.r-project.org/web/packages/gtsummary/index.html"><strong>gtsummary</strong></a>
(a wrapper for <strong>survey</strong> allowing for publication ready tables).
While the original <strong>survey</strong> package does not allow for tidyverse-style coding,
it does have the added benefit of allowing for survey-weighted generalised linear
models (which will be added to this page at a later date).
We will also demonstrate using a function from the <a href="https://github.com/R4EPI/sitrep"><strong>sitrep</strong></a>
package to create sampling weights (<em>n.b</em> this package is currently not yet on CRAN,
but can be installed from github).</p>
<p>Most of this page is based off work done for the <a href="https://r4epis.netlify.app/">“R4Epis” project</a>;
for detailed code and R-markdown templates see the <a href="https://github.com/R4EPI/sitrep">“R4Epis” github page</a>.
Some of the <strong>survey</strong> package based code is based off early versions of
<a href="https://github.com/EPIET/RapidAssessmentSurveys">EPIET case studies</a>.</p>
<p>At current this page does not address sample size calculations or sampling.
For a simple to use sample size calculator see <a href="https://www.openepi.com/Menu/OE_Menu.htm">OpenEpi</a>.
The <a href="https://epirhandbook.com/gis-basics.html">GIS basics</a> page of the handbook
will eventually have a section on spatial random sampling, and this page will
eventually have a section on sampling frames as well as sample size calculations.</p>
<ol style="list-style-type: decimal">
<li>Survey data</li>
<li>Observation time</li>
<li>Weighting</li>
<li>Survey design objects</li>
<li>Descriptive analysis</li>
<li>Weighted proportions</li>
<li>Weighted rates</li>
</ol>
<!-- ======================================================= -->
</div>
<div id="preparation-17" class="section level2" number="26.2">
<h2>
<span class="header-section-number">26.2</span> Preparation<a class="anchor" aria-label="anchor" href="#preparation-17"><i class="fas fa-link"></i></a>
</h2>
<div id="packages-3" class="section level3 unnumbered">
<h3>Packages<a class="anchor" aria-label="anchor" href="#packages-3"><i class="fas fa-link"></i></a>
</h3>
<p>This code chunk shows the loading of packages required for the analyses. In this handbook we emphasize <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> from <strong>pacman</strong>, which installs the package if necessary <em>and</em> loads it for use. You can also load packages with <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> from <strong>base</strong> R. See the page on <a href="r-basics.html#r-basics">R basics</a> for more information on R packages.<br>
Here we also demonstrate using the <code><a href="https://rdrr.io/pkg/pacman/man/p_load_gh.html">p_load_gh()</a></code> function from <strong>pacman</strong> to install a load a package from github which has not yet been published on CRAN.</p>
<div class="sourceCode" id="cb1240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## load packages from CRAN</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">rio</span>,          <span class="co"># File import</span>
               <span class="va">here</span>,         <span class="co"># File locator</span>
               <span class="va">tidyverse</span>,    <span class="co"># data management + ggplot2 graphics</span>
               <span class="va">tsibble</span>,      <span class="co"># handle time series datasets</span>
               <span class="va">survey</span>,       <span class="co"># for survey functions</span>
               <span class="va">srvyr</span>,        <span class="co"># dplyr wrapper for survey package</span>
               <span class="va">gtsummary</span>,    <span class="co"># wrapper for survey package to produce tables</span>
               <span class="va">apyramid</span>,     <span class="co"># a package dedicated to creating age pyramids</span>
               <span class="va">patchwork</span>,    <span class="co"># for combining ggplots</span>
               <span class="va">ggforce</span>       <span class="co"># for alluvial/sankey plots</span>
               <span class="op">)</span> 

<span class="co">## load packages from github</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load_gh.html">p_load_gh</a></span><span class="op">(</span>
     <span class="st">"R4EPI/sitrep"</span>          <span class="co"># for observation time / weighting functions</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="load-data-1" class="section level3 unnumbered">
<h3>Load data<a class="anchor" aria-label="anchor" href="#load-data-1"><i class="fas fa-link"></i></a>
</h3>
<p>The example dataset used in this section:</p>
<ul>
<li>fictional mortality survey data.</li>
<li>fictional population counts for the survey area.</li>
<li>data dictionary for the fictional mortality survey data.</li>
</ul>
<p>This is based off the MSF OCA ethical review board pre-approved survey. The
fictional dataset was produced as part of the <a href="https://r4epis.netlify.app/">“R4Epis” project</a>.
This is all based off data collected using <a href="https://www.kobotoolbox.org/">KoboToolbox</a>,
which is a data collection software based off <a href="https://opendatakit.org/">Open Data Kit</a>.</p>
<p>Kobo allows you to export both the collected data, as well as the data dictionary
for that dataset. We strongly recommend doing this as it simplifies data cleaning
and is useful for looking up variables/questions.</p>
<p><span style="color: darkgreen;"><strong><em>TIP:</em></strong> The Kobo data dictionary has variable
names in the “name” column of the survey sheet.
Possible values for each variable are specified in choices sheet.
In the choices tab, “name” has the shortened value and the “label::english” and
“label::french” columns have the appropriate long versions.
Using the <strong>epidict</strong> package <code>msf_dict_survey()</code> function to import a Kobo
dictionary excel file will re-format this for you so it can be used easily to recode. </span></p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> The example dataset is not the same
as an export (as in Kobo you export different questionnaire levels individually)
- see the survey data section below to merge the different levels.</span></p>
<p>The dataset is imported using the <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> function from the <strong>rio</strong> package. See the page on <a href="https://epirhandbook.com/import-and-export.html">Import and export</a> for various ways to import data.</p>
<div class="sourceCode" id="cb1241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># import the survey data</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"survey_data.xlsx"</span><span class="op">)</span>

<span class="co"># import the dictionary into R</span>
<span class="va">survey_dict</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"survey_dict.xlsx"</span><span class="op">)</span> </code></pre></div>
<p>The first 10 rows of the survey are displayed below.</p>
<div id="htmlwidget-3a850a87fcefe427e659" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3a850a87fcefe427e659">{"x":{"filter":"none","data":[[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],["2018-04-15T00:00:00Z","2018-03-04T00:00:00Z","2018-04-16T00:00:00Z","2018-01-23T00:00:00Z","2018-01-09T00:00:00Z","2018-03-07T00:00:00Z","2018-02-18T00:00:00Z","2018-04-12T00:00:00Z","2018-04-17T00:00:00Z","2018-01-05T00:00:00Z"],[null,null,null,null,null,null,null,null,null,null],["village_1","village_1","village_10","village_5","village_3","village_8","other","village_7","village_4","village_2"],[null,null,null,null,null,null,null,null,null,null],[1,1,10,5,3,8,11,7,4,2],[9,1,15,6,18,14,17,16,13,14],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],["yes","no","no","yes","no","yes","no","yes","yes","yes"],[null,"no_benefit","neg_experience",null,"other",null,"no_benefit",null,null,null],[null,null,null,null,null,null,null,null,null,null],[6,null,null,8,null,5,null,6,5,5],["female",null,null,"female",null,"male",null,"male","male","female"],[26,null,null,3,null,22,null,33,96,18],[null,null,null,36,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],["no",null,null,"no",null,"yes",null,"yes","yes","yes"],["yes",null,null,null,null,"yes",null,"no","no","no"],["secondary",null,null,null,null,"secondary",null,null,null,null],["no",null,null,"no",null,"yes",null,"no","yes","yes"],[null,null,null,null,null,"yes",null,null,"no","no"],["yes",null,null,null,null,null,null,null,null,"yes"],["no",null,null,"no",null,"yes",null,"yes","no","yes"],["yes",null,null,"no",null,"no",null,"no","yes","yes"],["no",null,null,null,null,null,null,null,"no","no"],[null,null,null,null,null,null,null,null,null,null],["yes",null,null,"no",null,"no",null,"yes","no","no"],["no",null,null,null,null,null,null,"no",null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],["no","no","no","no","no","no","no","no","yes","no"],[null,null,null,null,null,null,null,null,"no",null],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,"dont_know",null],[null,null,null,null,null,null,null,null,null,null],["yes",null,null,"yes",null,"no",null,"yes","no","no"],[null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null],["sexual",null,null,"sexual",null,null,null,"shot",null,null],["0",null,null,"0",null,null,null,"0",null,null],["1",null,null,"1",null,null,null,"0",null,null],["0",null,null,"0",null,null,null,"1",null,null],["0",null,null,"0",null,null,null,"0",null,null],["0",null,null,"0",null,null,null,"0",null,null],["0",null,null,"0",null,null,null,"0",null,null],[9,1,183,83,58,146,205,130,72,33],[1,1,1,1,1,1,1,1,1,1],["9_1","1_1","183_1","83_1","58_1","146_1","205_1","130_1","72_1","33_1"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>start<\/th>\n      <th>end<\/th>\n      <th>today<\/th>\n      <th>deviceid<\/th>\n      <th>date<\/th>\n      <th>team_number<\/th>\n      <th>village_name<\/th>\n      <th>village_other<\/th>\n      <th>cluster_number<\/th>\n      <th>household_number<\/th>\n      <th>households_building<\/th>\n      <th>random_hh<\/th>\n      <th>random_hh_note<\/th>\n      <th>consent<\/th>\n      <th>no_consent_reason<\/th>\n      <th>no_consent_other<\/th>\n      <th>member_number<\/th>\n      <th>sex<\/th>\n      <th>age_years<\/th>\n      <th>age_months_calc<\/th>\n      <th>age_months<\/th>\n      <th>bednet<\/th>\n      <th>read_write<\/th>\n      <th>education_level<\/th>\n      <th>measles_vaccination<\/th>\n      <th>vaccination_card<\/th>\n      <th>pregnant<\/th>\n      <th>malaria_treatment<\/th>\n      <th>arrived<\/th>\n      <th>remember_arrival<\/th>\n      <th>arrived_date<\/th>\n      <th>left<\/th>\n      <th>remember_departure<\/th>\n      <th>left_date<\/th>\n      <th>born<\/th>\n      <th>remember_dob<\/th>\n      <th>birthday_date<\/th>\n      <th>died<\/th>\n      <th>remember_death<\/th>\n      <th>death_date<\/th>\n      <th>cause<\/th>\n      <th>cause_other<\/th>\n      <th>violent_episode<\/th>\n      <th>violent_episodes_number<\/th>\n      <th>violence_nature_other<\/th>\n      <th>violence_nature<\/th>\n      <th>violence_nature/beaten<\/th>\n      <th>violence_nature/sexual<\/th>\n      <th>violence_nature/shot<\/th>\n      <th>violence_nature/detained_kidnapped<\/th>\n      <th>violence_nature/other<\/th>\n      <th>violence_nature/no_response<\/th>\n      <th>index<\/th>\n      <th>index_y<\/th>\n      <th>uid<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[8,9,16,18,19,20,52,53]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>We also want to import the data on sampling population so that we can produce
appropriate weights. This data can be in different formats, however we would
suggest to have it as seen below (this can just be typed in to an excel).</p>
<div class="sourceCode" id="cb1242"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># import the population data</span>
<span class="va">population</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"population.xlsx"</span><span class="op">)</span></code></pre></div>
<p>The first 10 rows of the survey are displayed below.</p>
<div id="htmlwidget-47198106548112000b64" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-47198106548112000b64">{"x":{"filter":"none","data":[["0-2","3-14","15-29","30-44","45+","0-2","3-14","15-29","30-44","45+"],["male","male","male","male","male","female","female","female","female","female"],[0.034,0.1811,0.138,0.0808,0.0661,0.034,0.1811,0.138,0.0808,0.0661],[340,1811,1380,808,661,340,1811,1380,808,661],["district_a","district_a","district_a","district_a","district_a","district_a","district_a","district_a","district_a","district_a"]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>age_group<\/th>\n      <th>sex<\/th>\n      <th>proportions<\/th>\n      <th>population<\/th>\n      <th>health_district<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><p>For cluster surveys you may want to add survey weights at the cluster level.
You could read this data in as above.
Alternatively if there are only a few counts, these could be entered as below
in to a tibble.
In any case you will need to have one column with a cluster identifier which
matches your survey data, and another column with the number of households in
each cluster.</p>
<div class="sourceCode" id="cb1243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define the number of households in each cluster</span>
<span class="va">cluster_counts</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"village_1"</span>, <span class="st">"village_2"</span>, <span class="st">"village_3"</span>, <span class="st">"village_4"</span>, 
                                     <span class="st">"village_5"</span>, <span class="st">"village_6"</span>, <span class="st">"village_7"</span>, <span class="st">"village_8"</span>,
                                     <span class="st">"village_9"</span>, <span class="st">"village_10"</span><span class="op">)</span>, 
                         households <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">700</span>, <span class="fl">400</span>, <span class="fl">600</span>, <span class="fl">500</span>, <span class="fl">300</span>, 
                                        <span class="fl">800</span>, <span class="fl">700</span>, <span class="fl">400</span>, <span class="fl">500</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="clean-data-2" class="section level3 unnumbered">
<h3>Clean data<a class="anchor" aria-label="anchor" href="#clean-data-2"><i class="fas fa-link"></i></a>
</h3>
<p>The below makes sure that the date column is in the appropriate format.
There are several other ways of doing this (see the <a href="https://epirhandbook.com/working-with-dates.html">Working with dates</a>
page for details), however using the dictionary to define dates is quick and easy.</p>
<p>We also create an age group variable using the <code>age_categories()</code> function from
<strong>epikit</strong> - see <a href="https://epirhandbook.com/cleaning-data-and-core-functions.html#num_cats">cleaning data</a>
handbook section for details.
In addition, we create a character variable defining which district the various clusters
are in.</p>
<p>Finally, we recode all of the yes/no variables to TRUE/FALSE variables - otherwise
these cant be used by the <strong>survey</strong> proportion functions.</p>
<div class="sourceCode" id="cb1244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## select the date variable names from the dictionary </span>
<span class="va">DATEVARS</span> <span class="op">&lt;-</span> <span class="va">survey_dict</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"date"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">survey_data</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## filter to match the column names of your data</span>
  <span class="fu">pull</span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="co"># select date vars</span>
  
<span class="co">## change to dates </span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">DATEVARS</span><span class="op">)</span>, <span class="va">as.Date</span><span class="op">)</span><span class="op">)</span>


<span class="co">## add those with only age in months to the year variable (divide by twelve)</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_years <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">age_years</span><span class="op">)</span>, 
                             <span class="va">age_months</span> <span class="op">/</span> <span class="fl">12</span>, 
                             <span class="va">age_years</span><span class="op">)</span><span class="op">)</span>

<span class="co">## define age group variable</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> 
     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_group <span class="op">=</span> <span class="fu">age_categories</span><span class="op">(</span><span class="va">age_years</span>, 
                                    breakers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">15</span>, <span class="fl">30</span>, <span class="fl">45</span><span class="op">)</span>
                                    <span class="op">)</span><span class="op">)</span>


<span class="co">## create a character variable based off groups of a different variable </span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>health_district <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span>
    <span class="va">cluster_number</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">~</span> <span class="st">"district_a"</span>, 
    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"district_b"</span>
  <span class="op">)</span><span class="op">)</span>


<span class="co">## select the yes/no variable names from the dictionary </span>
<span class="va">YNVARS</span> <span class="op">&lt;-</span> <span class="va">survey_dict</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"yn"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">survey_data</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## filter to match the column names of your data</span>
  <span class="fu">pull</span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="co"># select yn vars</span>
  
<span class="co">## change to dates </span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">YNVARS</span><span class="op">)</span>, 
                <span class="va">str_detect</span>, 
                pattern <span class="op">=</span> <span class="st">"yes"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
</div>
<div id="survey-data" class="section level2" number="26.3">
<h2>
<span class="header-section-number">26.3</span> Survey data<a class="anchor" aria-label="anchor" href="#survey-data"><i class="fas fa-link"></i></a>
</h2>
<p>There numerous different sampling designs that can be used for surveys. Here
we will demonstrate code for:
- Stratified
- Cluster
- Stratified and cluster</p>
<p>As described above (depending on how you design your questionnaire) the data for
each level would be exported as a separate dataset from Kobo. In our example there
is one level for households and one level for individuals within those households.</p>
<p>These two levels are linked by a unique identifier.
For a Kobo dataset this variable is "_index" at the household level, which
matches the "_parent_index" at the individual level.
This will create new rows for household with each matching individual,
see the handbook section on <a href="https://epirhandbook.com/joining-data.html">joining</a>
for details.</p>
<div class="sourceCode" id="cb1245"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## join the individual and household data to form a complete data set</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">survey_data_hh</span>, 
                         <span class="va">survey_data_indiv</span>,
                         by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"_index"</span> <span class="op">=</span> <span class="st">"_parent_index"</span><span class="op">)</span><span class="op">)</span>


<span class="co">## create a unique identifier by combining indeces of the two levels </span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> 
     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>uid <span class="op">=</span> <span class="fu">str_glue</span><span class="op">(</span><span class="st">"{index}_{index_y}"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="observation-time" class="section level2" number="26.4">
<h2>
<span class="header-section-number">26.4</span> Observation time<a class="anchor" aria-label="anchor" href="#observation-time"><i class="fas fa-link"></i></a>
</h2>
<p>For mortality surveys we want to now how long each individual was present for in
the location to be able to calculate an appropriate mortality rate for our period
of interest. This is not relevant to all surveys, but particularly for mortality
surveys this is important as they are conducted frequently among mobile or displaced
populations.</p>
<p>To do this we first define our time period of interest, also known as a recall
period (i.e. the time that participants are asked to report on when answering
questions).
We can then use this period to set inappropriate dates to missing, i.e. if deaths
are reported from outside the period of interest.</p>
<div class="sourceCode" id="cb1246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## set the start/end of recall period</span>
<span class="co">## can be changed to date variables from dataset </span>
<span class="co">## (e.g. arrival date &amp; date questionnaire)</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>recall_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2018-01-01"</span><span class="op">)</span>, 
         recall_end   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2018-05-01"</span><span class="op">)</span>
  <span class="op">)</span>


<span class="co"># set inappropriate dates to NA based on rules </span>
<span class="co">## e.g. arrivals before start, departures departures after end</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
           arrived_date <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">arrived_date</span> <span class="op">&lt;</span> <span class="va">recall_start</span>, 
                                 <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,
                                  <span class="va">arrived_date</span><span class="op">)</span>,
           birthday_date <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">birthday_date</span> <span class="op">&lt;</span> <span class="va">recall_start</span>,
                                  <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,
                                  <span class="va">birthday_date</span><span class="op">)</span>,
           left_date <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">left_date</span> <span class="op">&gt;</span> <span class="va">recall_end</span>,
                              <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,
                               <span class="va">left_date</span><span class="op">)</span>,
           death_date <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">death_date</span> <span class="op">&gt;</span> <span class="va">recall_end</span>,
                               <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,
                               <span class="va">death_date</span><span class="op">)</span>
           <span class="op">)</span></code></pre></div>
<p>We can then use our date variables to define start and end dates for each individual.
We can use the <code>find_start_date()</code> function from <strong>sitrep</strong> to fine the causes for
the dates and then use that to calculate the difference between days (person-time).</p>
<p>start date:
Earliest appropriate arrival event within your recall period
Either the beginning of your recall period (which you define in advance), or a
date after the start of recall if applicable (e.g. arrivals or births)</p>
<p>end date:
Earliest appropriate departure event within your recall period
Either the end of your recall period, or a date before the end of recall
if applicable (e.g. departures, deaths)</p>
<div class="sourceCode" id="cb1247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## create new variables for start and end dates/causes</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> 
     <span class="co">## choose earliest date entered in survey</span>
     <span class="co">## from births, household arrivals, and camp arrivals </span>
     <span class="fu">find_start_date</span><span class="op">(</span><span class="st">"birthday_date"</span>,
                  <span class="st">"arrived_date"</span>,
                  period_start <span class="op">=</span> <span class="st">"recall_start"</span>,
                  period_end   <span class="op">=</span> <span class="st">"recall_end"</span>,
                  datecol      <span class="op">=</span> <span class="st">"startdate"</span>,
                  datereason   <span class="op">=</span> <span class="st">"startcause"</span> 
                 <span class="op">)</span> <span class="op">%&gt;%</span>
     <span class="co">## choose earliest date entered in survey</span>
     <span class="co">## from camp departures, death and end of the study</span>
     <span class="fu">find_end_date</span><span class="op">(</span><span class="st">"left_date"</span>,
                <span class="st">"death_date"</span>,
                period_start <span class="op">=</span> <span class="st">"recall_start"</span>,
                period_end   <span class="op">=</span> <span class="st">"recall_end"</span>,
                datecol      <span class="op">=</span> <span class="st">"enddate"</span>,
                datereason   <span class="op">=</span> <span class="st">"endcause"</span> 
               <span class="op">)</span>


<span class="co">## label those that were present at the start/end (except births/deaths)</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> 
     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
       <span class="co">## fill in start date to be the beginning of recall period (for those empty) </span>
       startdate <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">startdate</span><span class="op">)</span>, <span class="va">recall_start</span>, <span class="va">startdate</span><span class="op">)</span>, 
       <span class="co">## set the start cause to present at start if equal to recall period </span>
       <span class="co">## unless it is equal to the birth date </span>
       startcause <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">startdate</span> <span class="op">==</span> <span class="va">recall_start</span> <span class="op">&amp;</span> <span class="va">startcause</span> <span class="op">!=</span> <span class="st">"birthday_date"</span>,
                              <span class="st">"Present at start"</span>, <span class="va">startcause</span><span class="op">)</span>, 
       <span class="co">## fill in end date to be end of recall period (for those empty) </span>
       enddate <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">enddate</span><span class="op">)</span>, <span class="va">recall_end</span>, <span class="va">enddate</span><span class="op">)</span>, 
       <span class="co">## set the end cause to present at end if equall to recall end </span>
       <span class="co">## unless it is equal to the death date</span>
       endcause <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">enddate</span> <span class="op">==</span> <span class="va">recall_end</span> <span class="op">&amp;</span> <span class="va">endcause</span> <span class="op">!=</span> <span class="st">"death_date"</span>, 
                            <span class="st">"Present at end"</span>, <span class="va">endcause</span><span class="op">)</span><span class="op">)</span>


<span class="co">## Define observation time in days</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>obstime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">enddate</span> <span class="op">-</span> <span class="va">startdate</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="weighting" class="section level2" number="26.5">
<h2>
<span class="header-section-number">26.5</span> Weighting<a class="anchor" aria-label="anchor" href="#weighting"><i class="fas fa-link"></i></a>
</h2>
<p>It is important that you drop erroneous observations before adding survey weights.
For example if you have observations with negative observation time, you will need
to check those (you can do this with the <code>assert_positive_timespan()</code> function
from <strong>sitrep</strong>.
Another thing is if you want to drop empty rows (e.g. with <code>drop_na(uid)</code>)
or remove duplicates (see handbook section on <a href="de-duplication.html#de-duplication">De-duplication</a>
for details).
Those without consent need to be dropped too.</p>
<p>In this example we filter for the cases we want to drop and store them in a separate
data frame - this way we can describe those that were excluded from the survey.
We then use the <code>anti_join()</code> function from <strong>dplyr</strong> to remove these dropped cases
from our survey data.</p>
<p><span style="color: red;"><strong><em>DANGER:</em></strong> You cant have missing values in your weight variable, or any of the variables relevant to your survey design (e.g. age, sex, strata or cluster variables).</span></p>
<div class="sourceCode" id="cb1248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## store the cases that you drop so you can describe them (e.g. non-consenting </span>
<span class="co">## or wrong village/cluster)</span>
<span class="va">dropped</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">consent</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">startdate</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">enddate</span><span class="op">)</span> <span class="op">|</span> <span class="va">village_name</span> <span class="op">==</span> <span class="st">"other"</span><span class="op">)</span>

<span class="co">## use the dropped cases to remove the unused rows from the survey data set  </span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="fu">anti_join</span><span class="op">(</span><span class="va">survey_data</span>, <span class="va">dropped</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dropped</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>As mentioned above we demonstrate how to add weights for three different study
designs (stratified, cluster and stratified cluster). These require information
on the source population and/or the clusters surveyed.
We will use the stratified cluster code for this example, but use whichever is
most appropriate for your study design.</p>
<div class="sourceCode" id="cb1249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># stratified ------------------------------------------------------------------</span>
<span class="co"># create a variable called "surv_weight_strata"</span>
<span class="co"># contains weights for each individual - by age group, sex and health district</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="fu">add_weights_strata</span><span class="op">(</span>x <span class="op">=</span> <span class="va">survey_data</span>,
                                         p <span class="op">=</span> <span class="va">population</span>,
                                         surv_weight <span class="op">=</span> <span class="st">"surv_weight_strata"</span>,
                                         surv_weight_ID <span class="op">=</span> <span class="st">"surv_weight_ID_strata"</span>,
                                         <span class="va">age_group</span>, <span class="va">sex</span>, <span class="va">health_district</span><span class="op">)</span>

<span class="co">## cluster ---------------------------------------------------------------------</span>

<span class="co"># get the number of people of individuals interviewed per household</span>
<span class="co"># adds a variable with counts of the household (parent) index variable</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span>
  <span class="fu">add_count</span><span class="op">(</span><span class="va">index</span>, name <span class="op">=</span> <span class="st">"interviewed"</span><span class="op">)</span>


<span class="co">## create cluster weights</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="fu">add_weights_cluster</span><span class="op">(</span>x <span class="op">=</span> <span class="va">survey_data</span>,
                                          cl <span class="op">=</span> <span class="va">cluster_counts</span>,
                                          eligible <span class="op">=</span> <span class="va">member_number</span>,
                                          interviewed <span class="op">=</span> <span class="va">interviewed</span>,
                                          cluster_x <span class="op">=</span> <span class="va">village_name</span>,
                                          cluster_cl <span class="op">=</span> <span class="va">cluster</span>,
                                          household_x <span class="op">=</span> <span class="va">index</span>,
                                          household_cl <span class="op">=</span> <span class="va">households</span>,
                                          surv_weight <span class="op">=</span> <span class="st">"surv_weight_cluster"</span>,
                                          surv_weight_ID <span class="op">=</span> <span class="st">"surv_weight_ID_cluster"</span>,
                                          ignore_cluster <span class="op">=</span> <span class="cn">FALSE</span>,
                                          ignore_household <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>


<span class="co"># stratified and cluster ------------------------------------------------------</span>
<span class="co"># create a survey weight for cluster and strata</span>
<span class="va">survey_data</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>surv_weight_cluster_strata <span class="op">=</span> <span class="va">surv_weight_strata</span> <span class="op">*</span> <span class="va">surv_weight_cluster</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="survey-design-objects" class="section level2" number="26.6">
<h2>
<span class="header-section-number">26.6</span> Survey design objects<a class="anchor" aria-label="anchor" href="#survey-design-objects"><i class="fas fa-link"></i></a>
</h2>
<p>Create survey object according to your study design.
Used the same way as data frames to calculate weight proportions etc.
Make sure that all necessary variables are created before this.</p>
<p>There are four options, comment out those you do not use:
- Simple random
- Stratified
- Cluster
- Stratified cluster</p>
<p>For this template - we will pretend that we cluster surveys in two separate
strata (health districts A and B).
So to get overall estimates we need have combined cluster and strata weights.</p>
<p>As mentioned previously, there are two packages available for doing this. The
classic one is <strong>survey</strong> and then there is a wrapper package called <strong>srvyr</strong>
that makes tidyverse-friendly objects and functions. We will demonstrate both,
but note that most of the code in this chapter will use <strong>srvyr</strong> based objects.
The one exception is that the <strong>gtsummary</strong> package only accepts <strong>survey</strong> objects.</p>
<div id="survey-package" class="section level3" number="26.6.1">
<h3>
<span class="header-section-number">26.6.1</span> <strong>Survey</strong> package<a class="anchor" aria-label="anchor" href="#survey-package"><i class="fas fa-link"></i></a>
</h3>
<p>The <strong>survey</strong> package effectively uses <strong>base</strong> <em>R</em> coding, and so it is not
possible to use pipes (<code><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></code>) or other <strong>dplyr</strong> syntax.
With the <strong>survey</strong> package we use the <code>svydesign()</code> function to define a survey
object with appropriate clusters, weights and strata.</p>
<p><span style="color: black;"><strong><em>NOTE:</em></strong> we need to use the tilde (<code><a href="https://rdrr.io/r/base/tilde.html">~</a></code>) in front of variables, this is because the package uses the <strong>base</strong> <em>R</em> syntax of assigning variables based on formulae. </span></p>
<div class="sourceCode" id="cb1250"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># simple random ---------------------------------------------------------------</span>
<span class="va">base_survey_design_simple</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>ids <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>, <span class="co"># 1 for no cluster ids</span>
                   weights <span class="op">=</span> <span class="cn">NULL</span>,               <span class="co"># No weight added</span>
                   strata <span class="op">=</span> <span class="cn">NULL</span>,                <span class="co"># sampling was simple (no strata)</span>
                   data <span class="op">=</span> <span class="va">survey_data</span>            <span class="co"># have to specify the dataset</span>
                  <span class="op">)</span>

<span class="co">## stratified ------------------------------------------------------------------</span>
<span class="va">base_survey_design_strata</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>ids <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,  <span class="co"># 1 for no cluster ids</span>
                   weights <span class="op">=</span> <span class="op">~</span><span class="va">surv_weight_strata</span>, <span class="co"># weight variable created above</span>
                   strata <span class="op">=</span> <span class="op">~</span><span class="va">health_district</span>,     <span class="co"># sampling was stratified by district</span>
                   data <span class="op">=</span> <span class="va">survey_data</span>             <span class="co"># have to specify the dataset</span>
                  <span class="op">)</span>

<span class="co"># cluster ---------------------------------------------------------------------</span>
<span class="va">base_survey_design_cluster</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>ids <span class="op">=</span> <span class="op">~</span><span class="va">village_name</span>, <span class="co"># cluster ids</span>
                   weights <span class="op">=</span> <span class="op">~</span><span class="va">surv_weight_cluster</span>, <span class="co"># weight variable created above</span>
                   strata <span class="op">=</span> <span class="cn">NULL</span>,                 <span class="co"># sampling was simple (no strata)</span>
                   data <span class="op">=</span> <span class="va">survey_data</span>              <span class="co"># have to specify the dataset</span>
                  <span class="op">)</span>

<span class="co"># stratified cluster ----------------------------------------------------------</span>
<span class="va">base_survey_design</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span>ids <span class="op">=</span> <span class="op">~</span><span class="va">village_name</span>,      <span class="co"># cluster ids</span>
                   weights <span class="op">=</span> <span class="op">~</span><span class="va">surv_weight_cluster_strata</span>, <span class="co"># weight variable created above</span>
                   strata <span class="op">=</span> <span class="op">~</span><span class="va">health_district</span>,             <span class="co"># sampling was stratified by district</span>
                   data <span class="op">=</span> <span class="va">survey_data</span>                     <span class="co"># have to specify the dataset</span>
                  <span class="op">)</span></code></pre></div>
</div>
<div id="srvyr-package" class="section level3" number="26.6.2">
<h3>
<span class="header-section-number">26.6.2</span> <strong>Srvyr</strong> package<a class="anchor" aria-label="anchor" href="#srvyr-package"><i class="fas fa-link"></i></a>
</h3>
<p>With the <strong>srvyr</strong> package we can use the <code>as_survey_design()</code> function, which
has all the same arguments as above but allows pipes (<code><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></code>), and so we do not
need to use the tilde (<code><a href="https://rdrr.io/r/base/tilde.html">~</a></code>).</p>
<div class="sourceCode" id="cb1251"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## simple random ---------------------------------------------------------------</span>
<span class="va">survey_design_simple</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> 
  <span class="fu">as_survey_design</span><span class="op">(</span>ids <span class="op">=</span> <span class="fl">1</span>, <span class="co"># 1 for no cluster ids </span>
                   weights <span class="op">=</span> <span class="cn">NULL</span>, <span class="co"># No weight added</span>
                   strata <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># sampling was simple (no strata)</span>
                  <span class="op">)</span>
<span class="co">## stratified ------------------------------------------------------------------</span>
<span class="va">survey_design_strata</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span>
  <span class="fu">as_survey_design</span><span class="op">(</span>ids <span class="op">=</span> <span class="fl">1</span>, <span class="co"># 1 for no cluster ids</span>
                   weights <span class="op">=</span> <span class="va">surv_weight_strata</span>, <span class="co"># weight variable created above</span>
                   strata <span class="op">=</span> <span class="va">health_district</span> <span class="co"># sampling was stratified by district</span>
                  <span class="op">)</span>
<span class="co">## cluster ---------------------------------------------------------------------</span>
<span class="va">survey_design_cluster</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span>
  <span class="fu">as_survey_design</span><span class="op">(</span>ids <span class="op">=</span> <span class="va">village_name</span>, <span class="co"># cluster ids</span>
                   weights <span class="op">=</span> <span class="va">surv_weight_cluster</span>, <span class="co"># weight variable created above</span>
                   strata <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># sampling was simple (no strata)</span>
                  <span class="op">)</span>

<span class="co">## stratified cluster ----------------------------------------------------------</span>
<span class="va">survey_design</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span>
  <span class="fu">as_survey_design</span><span class="op">(</span>ids <span class="op">=</span> <span class="va">village_name</span>, <span class="co"># cluster ids</span>
                   weights <span class="op">=</span> <span class="va">surv_weight_cluster_strata</span>, <span class="co"># weight variable created above</span>
                   strata <span class="op">=</span> <span class="va">health_district</span> <span class="co"># sampling was stratified by district</span>
                  <span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
</div>
<div id="descriptive-analysis-2" class="section level2" number="26.7">
<h2>
<span class="header-section-number">26.7</span> Descriptive analysis<a class="anchor" aria-label="anchor" href="#descriptive-analysis-2"><i class="fas fa-link"></i></a>
</h2>
<p>Basic descriptive analysis and visualisation is covered extensively in other
chapters of the handbook, so we will not dwell on it here.
For details see the chapters on <a href="https://epirhandbook.com/descriptive-tables.html">descriptive tables</a>,
<a href="https://epirhandbook.com/simple-statistical-tests.html">statistical tests</a>,
<a href="https://epirhandbook.com/tables-for-presentation.html">tables for presentation</a>,
<a href="https://epirhandbook.com/ggplot-basics.html">ggplot basics</a> and
<a href="https://epirhandbook.com/r-markdown-reports.html">R markdown reports</a>.</p>
<p>In this section we will focus on how to investigate bias in your sample and visualise this.
We will also look at visualising population flow in a survey setting using
alluvial/sankey diagrams.</p>
<p>In general, you should consider including the following descriptive analyses:</p>
<ul>
<li>Final number of clusters, households and individuals included<br>
</li>
<li>Number of excluded individuals and the reasons for exclusion</li>
<li>Median (range) number of households per cluster and individuals per household</li>
</ul>
<div id="sampling-bias" class="section level3" number="26.7.1">
<h3>
<span class="header-section-number">26.7.1</span> Sampling bias<a class="anchor" aria-label="anchor" href="#sampling-bias"><i class="fas fa-link"></i></a>
</h3>
<p>Compare the proportions in each age group between your sample and
the source population.
This is important to be able to highlight potential sampling bias.
You could similarly repeat this looking at distributions by sex.</p>
<p>Note that these p-values are just indicative, and a descriptive discussion (or
visualisation with age-pyramids below) of the distributions in your study sample
compared to the source population is more important than the binomial test itself.
This is because increasing sample size will more often than not lead to
differences that may be irrelevant after weighting your data.</p>
<div class="sourceCode" id="cb1252"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## counts and props of the study population</span>
<span class="va">ag</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">drop_na</span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">tally</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>proportion <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, 
         n_total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>

<span class="co">## counts and props of the source population</span>
<span class="va">propcount</span> <span class="op">&lt;-</span> <span class="va">population</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tally</span><span class="op">(</span><span class="va">population</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>proportion <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>

<span class="co">## bind together the columns of two tables, group by age, and perform a </span>
<span class="co">## binomial test to see if n/total is significantly different from population</span>
<span class="co">## proportion.</span>
  <span class="co">## suffix here adds to text to the end of columns in each of the two datasets</span>
<span class="fu">left_join</span><span class="op">(</span><span class="va">ag</span>, <span class="va">propcount</span>, by <span class="op">=</span> <span class="st">"age_group"</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_pop"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">## broom::tidy(binom.test()) makes a data frame out of the binomial test and</span>
  <span class="co">## will add the variables p.value, parameter, conf.low, conf.high, method, and</span>
  <span class="co">## alternative. We will only use p.value here. You can include other</span>
  <span class="co">## columns if you want to report confidence intervals</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>binom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/binom.test.html">binom.test</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">n_total</span>, <span class="va">proportion_pop</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">unnest</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">binom</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># important for expanding the binom.test data frame</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>proportion_pop <span class="op">=</span> <span class="va">proportion_pop</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">## Adjusting the p-values to correct for false positives </span>
  <span class="co">## (because testing multiple age groups). This will only make </span>
  <span class="co">## a difference if you have many age categories</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>p.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">p.value</span>, method <span class="op">=</span> <span class="st">"holm"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
                      
  <span class="co">## Only show p-values over 0.001 (those under report as &lt;0.001)</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>p.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">p.value</span> <span class="op">&lt;</span> <span class="fl">0.001</span>, 
                          <span class="st">"&lt;0.001"</span>, 
                          <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">p.value</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  
  <span class="co">## rename the columns appropriately</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="st">"Age group"</span> <span class="op">=</span> <span class="va">age_group</span>,
    <span class="st">"Study population (n)"</span> <span class="op">=</span> <span class="va">n</span>,
    <span class="st">"Study population (%)"</span> <span class="op">=</span> <span class="va">proportion</span>,
    <span class="st">"Source population (n)"</span> <span class="op">=</span> <span class="va">n_pop</span>,
    <span class="st">"Source population (%)"</span> <span class="op">=</span> <span class="va">proportion_pop</span>,
    <span class="st">"P-value"</span> <span class="op">=</span> <span class="va">p.value</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 5 x 6
## # Groups:   Age group [5]
##   `Age group` `Study population (n)` `Study population (%)` `Source population (n)` `Source population (%)` `P-value`
##   &lt;chr&gt;                        &lt;int&gt;                  &lt;dbl&gt;                   &lt;dbl&gt;                   &lt;dbl&gt; &lt;chr&gt;    
## 1 0-2                             12                 0.0256                    1360                     6.8 &lt;0.001   
## 2 3-14                            42                 0.0896                    7244                    36.2 &lt;0.001   
## 3 15-29                           64                 0.136                     5520                    27.6 &lt;0.001   
## 4 30-44                           52                 0.111                     3232                    16.2 0.002    
## 5 45+                            299                 0.638                     2644                    13.2 &lt;0.001</code></pre>
</div>
<div id="demographic-pyramids" class="section level3" number="26.7.2">
<h3>
<span class="header-section-number">26.7.2</span> Demographic pyramids<a class="anchor" aria-label="anchor" href="#demographic-pyramids"><i class="fas fa-link"></i></a>
</h3>
<p>Demographic (or age-sex) pyramids are an easy way of visualising the distribution
in your survey population. It is also worth considering creating
<a href="https://epirhandbook.com/descriptive-tables.html">descriptive tables</a> of age
and sex by survey strata.
We will demonstrate using the <strong>apyramid</strong> package as it allows for weighted
proportions using our survey design object created above. Other options for creating
<a href="https://epirhandbook.com/demographic-pyramids-and-likert-scales.html">demographic pyramids</a>
are covered extensively in that chapter of the handbook. We will also use a
wrapper function from <strong>sitrep</strong> called <code>plot_age_pyramid()</code> which saves a few lines
of coding for producing a plot with proportions.</p>
<p>As with the formal binomial test of difference, seen above in the sampling bias
section, we are interested here in visualising whether our sampled population
is substantially different from the source population and whether weighting corrects
this difference. To do this we will use the <strong>patchwork</strong> package to show our
<strong>ggplot</strong> visualisations side-by-side; for details see the section on
combining plots in <a href="https://epirhandbook.com/ggplot-tips.html?q=patch#combine-plots">ggplot tips</a>
chapter of the handbook.
We will visualise our source population, our un-weighted survey population and
our weighted survey population.
You may also consider visualising by each strata of your survey - in our example
here that would be by using the argument <code>stack_by  = "health_district"</code>
(see <code>?plot_age_pyramid</code> for details).</p>
<p><span style="color: black;"><strong><em>NOTE:</em></strong> The x and y axes are flipped in pyramids </span></p>
<div class="sourceCode" id="cb1254"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define x-axis limits and labels ---------------------------------------------</span>
<span class="co">## (update these numbers to be the values for your graph)</span>
<span class="va">max_prop</span> <span class="op">&lt;-</span> <span class="fl">35</span>      <span class="co"># choose the highest proportion you want to show </span>
<span class="va">step</span> <span class="op">&lt;-</span> <span class="fl">5</span>           <span class="co"># choose the space you want beween labels </span>

<span class="co">## this part defines vector using the above numbers with axis breaks</span>
<span class="va">breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">max_prop</span><span class="op">/</span><span class="fl">100</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span> <span class="op">-</span> <span class="va">step</span><span class="op">/</span><span class="fl">100</span>, <span class="va">step</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>, 
    <span class="fl">0</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">step</span> <span class="op">/</span> <span class="fl">100</span>, <span class="va">max_prop</span><span class="op">/</span><span class="fl">100</span>, <span class="va">step</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>
    <span class="op">)</span>

<span class="co">## this part defines vector using the above numbers with axis limits</span>
<span class="va">limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">max_prop</span><span class="op">/</span><span class="fl">100</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span>, <span class="va">max_prop</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span>

<span class="co">## this part defines vector using the above numbers with axis labels</span>
<span class="va">labels</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">max_prop</span>, <span class="va">step</span>, <span class="op">-</span><span class="va">step</span><span class="op">)</span>, 
      <span class="fl">0</span>, 
      <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">step</span>, <span class="va">max_prop</span>, <span class="va">step</span><span class="op">)</span>
    <span class="op">)</span>


<span class="co">## create plots individually  --------------------------------------------------</span>

<span class="co">## plot the source population </span>
<span class="co">## nb: this needs to be collapsed for the overall population (i.e. removing health districts)</span>
<span class="va">source_population</span> <span class="op">&lt;-</span> <span class="va">population</span> <span class="op">%&gt;%</span>
  <span class="co">## ensure that age and sex are factors</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">age_group</span>, 
                            levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0-2"</span>, 
                                       <span class="st">"3-14"</span>, 
                                       <span class="st">"15-29"</span>,
                                       <span class="st">"30-44"</span>, 
                                       <span class="st">"45+"</span><span class="op">)</span><span class="op">)</span>, 
         sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age_group</span>, <span class="va">sex</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## add the counts for each health district together </span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## remove the grouping so can calculate overall proportion</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>proportion <span class="op">=</span> <span class="va">population</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">population</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## plot pyramid </span>
  <span class="fu">age_pyramid</span><span class="op">(</span>
            age_group <span class="op">=</span> <span class="va">age_group</span>, 
            split_by <span class="op">=</span> <span class="va">sex</span>, 
            count <span class="op">=</span> <span class="va">proportion</span>, 
            proportional <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">## only show the y axis label (otherwise repeated in all three plots)</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Source population"</span>, 
       y <span class="op">=</span> <span class="st">""</span>, 
       x <span class="op">=</span> <span class="st">"Age group (years)"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## make the x axis the same for all plots </span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">breaks</span>, 
    limits <span class="op">=</span> <span class="va">limits</span>, 
    labels <span class="op">=</span> <span class="va">labels</span><span class="op">)</span>
  
  
<span class="co">## plot the unweighted sample population </span>
<span class="va">sample_population</span> <span class="op">&lt;-</span> <span class="fu">plot_age_pyramid</span><span class="op">(</span><span class="va">survey_data</span>, 
                 age_group <span class="op">=</span> <span class="st">"age_group"</span>, 
                 split_by <span class="op">=</span> <span class="st">"sex"</span>,
                 proportion <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## only show the x axis label (otherwise repeated in all three plots)</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Unweighted sample population"</span>, 
       y <span class="op">=</span> <span class="st">"Proportion (%)"</span>, 
       x <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## make the x axis the same for all plots </span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">breaks</span>, 
    limits <span class="op">=</span> <span class="va">limits</span>, 
    labels <span class="op">=</span> <span class="va">labels</span><span class="op">)</span>


<span class="co">## plot the weighted sample population </span>
<span class="va">weighted_population</span> <span class="op">&lt;-</span> <span class="va">survey_design</span> <span class="op">%&gt;%</span> 
  <span class="co">## make sure the variables are factors</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>age_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">age_group</span><span class="op">)</span>, 
         sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">plot_age_pyramid</span><span class="op">(</span>
    age_group <span class="op">=</span> <span class="st">"age_group"</span>,
    split_by <span class="op">=</span> <span class="st">"sex"</span>, 
    proportion <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">## only show the x axis label (otherwise repeated in all three plots)</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Weighted sample population"</span>, 
       y <span class="op">=</span> <span class="st">""</span>, 
       x <span class="op">=</span> <span class="st">""</span><span class="op">)</span>  <span class="op">+</span> 
  <span class="co">## make the x axis the same for all plots </span>
  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">breaks</span>, 
    limits <span class="op">=</span> <span class="va">limits</span>, 
    labels <span class="op">=</span> <span class="va">labels</span><span class="op">)</span>

<span class="co">## combine all three plots  ----------------------------------------------------</span>
<span class="co">## combine three plots next to eachother using + </span>
<span class="va">source_population</span> <span class="op">+</span> <span class="va">sample_population</span> <span class="op">+</span> <span class="va">weighted_population</span> <span class="op">+</span> 
  <span class="co">## only show one legend and define theme </span>
  <span class="co">## note the use of &amp; for combining theme with plot_layout()</span>
  <span class="fu">plot_layout</span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">&amp;</span> 
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,                    <span class="co"># move legend to bottom</span>
        legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,                <span class="co"># remove title</span>
        text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span>,                <span class="co"># change text size</span>
        axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span>, vjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># turn x-axis text</span>
       <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/weighted_age_pyramid-1.png" width="1440"></div>
</div>
<div id="alluvialsankey-diagram" class="section level3" number="26.7.3">
<h3>
<span class="header-section-number">26.7.3</span> Alluvial/sankey diagram<a class="anchor" aria-label="anchor" href="#alluvialsankey-diagram"><i class="fas fa-link"></i></a>
</h3>
<p>Visualising starting points and outcomes for individuals can be very helpful to
get an overview. There is quite an obvious application for mobile populations,
however there are numerous other applications such as cohorts or any other situation
where there are transitions in states for individuals. These diagrams have several
different names including alluvial, sankey and parallel sets - the details are
in the handbook chapter on <a href="https://epirhandbook.com/diagrams-and-charts.html#alluvialsankey-diagrams">diagrams and charts</a>.</p>
<div class="sourceCode" id="cb1255"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## summarize data</span>
<span class="va">flow_table</span> <span class="op">&lt;-</span> <span class="va">survey_data</span> <span class="op">%&gt;%</span>
  <span class="fu">count</span><span class="op">(</span><span class="va">startcause</span>, <span class="va">endcause</span>, <span class="va">sex</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># get counts </span>
  <span class="fu">gather_set_data</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"startcause"</span>, <span class="st">"endcause"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>     <span class="co"># change format for plotting</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu">fct_relevel</span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"startcause"</span>, <span class="st">"endcause"</span><span class="op">)</span><span class="op">)</span>,  <span class="co"># set startcause as first level</span>
         x <span class="op">=</span> <span class="fu">fct_recode</span><span class="op">(</span><span class="va">x</span>, 
                        <span class="st">"Start \n cause"</span> <span class="op">=</span> <span class="st">"startcause"</span>,   <span class="co"># add line break (\n) after start</span>
                        <span class="st">"End \n cause"</span>   <span class="op">=</span> <span class="st">"endcause"</span><span class="op">)</span>
        <span class="op">)</span>


<span class="co">## plot your dataset </span>
  <span class="co">## on the x axis is the start and end causes</span>
  <span class="co">## gather_set_data generates an ID for each possible combination</span>
  <span class="co">## splitting by y gives the possible start/end combos</span>
  <span class="co">## value as n gives it as counts (could also be changed to proportion)</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">flow_table</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, id <span class="op">=</span> <span class="va">id</span>, split <span class="op">=</span> <span class="va">y</span>, value <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">## colour lines by sex </span>
  <span class="fu">geom_parallel_sets</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, axis.width <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">## fill in the label boxes grey</span>
  <span class="fu">geom_parallel_sets_axes</span><span class="op">(</span>axis.width <span class="op">=</span> <span class="fl">0.15</span>, fill <span class="op">=</span> <span class="st">"grey80"</span>, color <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">## change text colour and angle (needs to be adjusted)</span>
  <span class="fu">geom_parallel_sets_labels</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, angle <span class="op">=</span> <span class="fl">0</span>, size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">## adjusted y and x axes (probably needs more vertical space)</span>
  <span class="fu">scale_x_discrete</span><span class="op">(</span>name <span class="op">=</span> <span class="cn">NULL</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## remove axis labels</span>
  <span class="fu">theme</span><span class="op">(</span>
    title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">26</span><span class="op">)</span>,
    text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">26</span><span class="op">)</span>,
    axis.line <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
    axis.ticks <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
    axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
    panel.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,                    <span class="co"># move legend to bottom</span>
    legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,                <span class="co"># remove title</span>
  <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/visualise_population_flow-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="weighted-proportions" class="section level2" number="26.8">
<h2>
<span class="header-section-number">26.8</span> Weighted proportions<a class="anchor" aria-label="anchor" href="#weighted-proportions"><i class="fas fa-link"></i></a>
</h2>
<p>This section will detail how to produce tables for weighted counts and proportions,
with associated confidence intervals and design effect.
There are four different options using functions from the following packages:
<strong>survey</strong>, <strong>srvyr</strong>, <strong>sitrep</strong> and <strong>gtsummary</strong>.
For minimal coding to produce a standard epidemiology style table, we would
recommend the <strong>sitrep</strong> function - which is a wrapper for <strong>srvyr</strong> code; note
however that this is not yet on CRAN and may change in the future.
Otherwise, the <strong>survey</strong> code is likely to be the most stable long-term, whereas
<strong>srvyr</strong> will fit most nicely within tidyverse work-flows. While <strong>gtsummary</strong>
functions hold a lot of potential, they appear to be experimental and incomplete
at the time of writing.</p>
<div id="survey-package-1" class="section level3" number="26.8.1">
<h3>
<span class="header-section-number">26.8.1</span> <strong>Survey</strong> package<a class="anchor" aria-label="anchor" href="#survey-package-1"><i class="fas fa-link"></i></a>
</h3>
<p>We can use the <code>svyciprop()</code> function from <strong>survey</strong> to get weighted proportions
and accompanying 95% confidence intervals. An appropriate design effect can be
extracted using the <code>svymean()</code> rather than <code>svyprop()</code> function.
It is worth noting that <code>svyprop()</code> only appears to accept variables between 0 and
1 (or TRUE/FALSE), so categorical variables will not work.</p>
<p><span style="color: black;"><strong><em>NOTE:</em></strong> Functions from <strong>survey</strong> also accept <strong>srvyr</strong> design objects, but here we have used the <strong>survey</strong> design object just for consistency </span></p>
<div class="sourceCode" id="cb1256"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## produce weighted counts </span>
<span class="fu">svytable</span><span class="op">(</span><span class="op">~</span><span class="va">died</span>, <span class="va">base_survey_design</span><span class="op">)</span></code></pre></div>
<pre><code>## died
##      FALSE       TRUE 
## 1406244.43   76213.01</code></pre>
<div class="sourceCode" id="cb1258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## produce weighted proportions</span>
<span class="fu">svyciprop</span><span class="op">(</span><span class="op">~</span><span class="va">died</span>, <span class="va">base_survey_design</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></code></pre></div>
<pre><code>##               2.5% 97.5%
## died 0.0514 0.0208  0.12</code></pre>
<div class="sourceCode" id="cb1260"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## get the design effect </span>
<span class="fu">svymean</span><span class="op">(</span><span class="op">~</span><span class="va">died</span>, <span class="va">base_survey_design</span>, na.rm <span class="op">=</span> <span class="cn">T</span>, deff <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">deff</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## diedFALSE  diedTRUE 
##  3.755508  3.755508</code></pre>
<p>We can combine the functions from <strong>survey</strong> shown above in to a function which
we define ourselves below, called <code>svy_prop</code>; and we can then use that function
together with <code>map()</code> from the purrr package to iterate over several variables
and create a table. See the handbook <a href="https://epirhandbook.com/iteration-loops-and-lists.html">iteration</a>
chapter for details on <strong>purrr</strong>.</p>
<div class="sourceCode" id="cb1262"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define function to calculate weighted counts, proportions, CI and design effect</span>
<span class="co"># x is the variable in quotation marks </span>
<span class="co"># design is your survey design object</span>

<span class="va">svy_prop</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">design</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co">## put the variable of interest in a formula </span>
  <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span> <span class="st">"~"</span> , <span class="va">x</span><span class="op">)</span><span class="op">)</span>
  <span class="co">## only keep the TRUE column of counts from svytable</span>
  <span class="va">weighted_counts</span> <span class="op">&lt;-</span> <span class="fu">svytable</span><span class="op">(</span><span class="va">form</span>, <span class="va">design</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
  <span class="co">## calculate proportions (multiply by 100 to get percentages)</span>
  <span class="va">weighted_props</span> <span class="op">&lt;-</span> <span class="fu">svyciprop</span><span class="op">(</span><span class="va">form</span>, <span class="va">design</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>
  <span class="co">## extract the confidence intervals and multiply to get percentages</span>
  <span class="va">weighted_confint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">weighted_props</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>
  <span class="co">## use svymean to calculate design effect and only keep the TRUE column</span>
  <span class="va">design_eff</span> <span class="op">&lt;-</span> <span class="fu">deff</span><span class="op">(</span><span class="fu">svymean</span><span class="op">(</span><span class="va">form</span>, <span class="va">design</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, deff <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="cn">TRUE</span><span class="op">]</span><span class="op">]</span>
  
  <span class="co">## combine in to one data frame</span>
  <span class="va">full_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>
    <span class="st">"Variable"</span>        <span class="op">=</span> <span class="va">x</span>,
    <span class="st">"Count"</span>           <span class="op">=</span> <span class="va">weighted_counts</span>,
    <span class="st">"Proportion"</span>      <span class="op">=</span> <span class="va">weighted_props</span>,
    <span class="va">weighted_confint</span>, 
    <span class="st">"Design effect"</span>   <span class="op">=</span> <span class="va">design_eff</span>
    <span class="op">)</span>
  
  <span class="co">## return table as a dataframe</span>
  <span class="va">full_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">full_table</span>, 
             <span class="co">## remove the variable names from rows (is a separate column now)</span>
             row.names <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
  
  <span class="co">## change numerics back to numeric</span>
  <span class="va">full_table</span><span class="op">[</span> , <span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">full_table</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span>
  
  <span class="co">## return dataframe</span>
  <span class="va">full_table</span>
<span class="op">}</span>

<span class="co">## iterate over several variables to create a table </span>
<span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>
  <span class="co">## define variables of interest</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"died"</span>, <span class="st">"arrived"</span><span class="op">)</span>, 
  <span class="co">## state function using and arguments for that function (design)</span>
  <span class="va">svy_prop</span>, design <span class="op">=</span> <span class="va">base_survey_design</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## collapse list in to a single data frame</span>
  <span class="fu">bind_rows</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## round </span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">where</span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="va">round</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##   Variable    Count Proportion X2.5. X97.5. Design.effect
## 1     left 701199.1       47.3  39.2   55.5           2.4
## 2     died  76213.0        5.1   2.1   12.1           3.8
## 3  arrived 761799.0       51.4  40.9   61.7           3.9</code></pre>
</div>
<div id="srvyr-package-1" class="section level3" number="26.8.2">
<h3>
<span class="header-section-number">26.8.2</span> <strong>Srvyr</strong> package<a class="anchor" aria-label="anchor" href="#srvyr-package-1"><i class="fas fa-link"></i></a>
</h3>
<p>With <strong>srvyr</strong> we can use <strong>dplyr</strong> syntax to create a table. Note that the
<code>survey_mean()</code> function is used and the proportion argument is specified, and
also that the same function is used to calculate design effect. This is because
<strong>srvyr</strong> wraps around both of the <strong>survey</strong> package functions <code>svyciprop()</code> and
<code>svymean()</code>, which are used in the above section.</p>
<p><span style="color: black;"><strong><em>NOTE:</em></strong> It does not seem to be possible to get proportions from categorical variables using <strong>srvyr</strong> either, if you need this then check out the section below using <strong>sitrep</strong> </span></p>
<div class="sourceCode" id="cb1264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## use the srvyr design object</span>
<span class="va">survey_design</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    <span class="co">## produce the weighted counts </span>
    counts <span class="op">=</span> <span class="fu">survey_total</span><span class="op">(</span><span class="va">died</span><span class="op">)</span>, 
    <span class="co">## produce weighted proportions and confidence intervals </span>
    <span class="co">## multiply by 100 to get a percentage </span>
    props <span class="op">=</span> <span class="fu">survey_mean</span><span class="op">(</span><span class="va">died</span>, 
                        proportion <span class="op">=</span> <span class="cn">TRUE</span>, 
                        vartype <span class="op">=</span> <span class="st">"ci"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, 
    <span class="co">## produce the design effect </span>
    deff <span class="op">=</span> <span class="fu">survey_mean</span><span class="op">(</span><span class="va">died</span>, deff <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## only keep the rows of interest</span>
  <span class="co">## (drop standard errors and repeat proportion calculation)</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">props</span>, <span class="va">props_low</span>, <span class="va">props_upp</span>, <span class="va">deff_deff</span><span class="op">)</span></code></pre></div>
<pre><code>##     counts    props props_low props_upp deff_deff
## 1 76213.01 5.140991  2.082773  12.13328  3.755508</code></pre>
<p>Here too we could write a function to then iterate over multiple variables using
the <strong>purrr</strong> package.
See the handbook <a href="https://epirhandbook.com/iteration-loops-and-lists.html">iteration</a>
chapter for details on <strong>purrr</strong>.</p>
<div class="sourceCode" id="cb1266"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Define function to calculate weighted counts, proportions, CI and design effect</span>
<span class="co"># design is your survey design object</span>
<span class="co"># x is the variable in quotation marks </span>


<span class="va">srvyr_prop</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">design</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    <span class="co">## using the survey design object</span>
    <span class="va">design</span>, 
    <span class="co">## produce the weighted counts </span>
    counts <span class="op">=</span> <span class="fu">survey_total</span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, 
    <span class="co">## produce weighted proportions and confidence intervals </span>
    <span class="co">## multiply by 100 to get a percentage </span>
    props <span class="op">=</span> <span class="fu">survey_mean</span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span>, 
                        proportion <span class="op">=</span> <span class="cn">TRUE</span>, 
                        vartype <span class="op">=</span> <span class="st">"ci"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, 
    <span class="co">## produce the design effect </span>
    deff <span class="op">=</span> <span class="fu">survey_mean</span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span>, deff <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## add in the variable name</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">x</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## only keep the rows of interest</span>
  <span class="co">## (drop standard errors and repeat proportion calculation)</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">counts</span>, <span class="va">props</span>, <span class="va">props_low</span>, <span class="va">props_upp</span>, <span class="va">deff_deff</span><span class="op">)</span>
  
<span class="op">}</span>
  

<span class="co">## iterate over several variables to create a table </span>
<span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>
  <span class="co">## define variables of interest</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"died"</span>, <span class="st">"arrived"</span><span class="op">)</span>, 
  <span class="co">## state function using and arguments for that function (design)</span>
  <span class="op">~</span><span class="fu">srvyr_prop</span><span class="op">(</span><span class="va">.x</span>, design <span class="op">=</span> <span class="va">survey_design</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## collapse list in to a single data frame</span>
  <span class="fu">bind_rows</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##   variable    counts     props props_low props_upp deff_deff
## 1     left 701199.14 47.299782 39.235598  55.50736  2.379761
## 2     died  76213.01  5.140991  2.082773  12.13328  3.755508
## 3  arrived 761799.05 51.387583 40.927349  61.72766  3.925504</code></pre>
</div>
<div id="sitrep-package" class="section level3" number="26.8.3">
<h3>
<span class="header-section-number">26.8.3</span> <strong>Sitrep</strong> package<a class="anchor" aria-label="anchor" href="#sitrep-package"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>tab_survey()</code> function from <strong>sitrep</strong> is a wrapper for <strong>srvyr</strong>, allowing
you to create weighted tables with minimal coding. It also allows you to calculate
weighted proportions for categorical variables.</p>
<div class="sourceCode" id="cb1268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## using the survey design object</span>
<span class="va">survey_design</span> <span class="op">%&gt;%</span> 
  <span class="co">## pass the names of variables of interest unquoted</span>
  <span class="fu">tab_survey</span><span class="op">(</span><span class="va">arrived</span>, <span class="va">left</span>, <span class="va">died</span>, <span class="va">education_level</span>,
             deff <span class="op">=</span> <span class="cn">TRUE</span>,   <span class="co"># calculate the design effect</span>
             pretty <span class="op">=</span> <span class="cn">TRUE</span>  <span class="co"># merge the proportion and 95%CI</span>
             <span class="op">)</span></code></pre></div>
<pre><code>## Warning: removing 257 missing value(s) from `education_level`</code></pre>
<pre><code>## # A tibble: 9 x 5
##   variable        value            n  deff ci                
##   &lt;chr&gt;           &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;             
## 1 arrived         TRUE       761799.  3.93 51.4% (40.9--61.7)
## 2 arrived         FALSE      720658.  3.93 48.6% (38.3--59.1)
## 3 left            TRUE       701199.  2.38 47.3% (39.2--55.5)
## 4 left            FALSE      781258.  2.38 52.7% (44.5--60.8)
## 5 died            TRUE        76213.  3.76 5.1% (2.1--12.1)  
## 6 died            FALSE     1406244.  3.76 94.9% (87.9--97.9)
## 7 education_level higher     171644.  4.70 42.4% (26.9--59.7)
## 8 education_level primary    102609.  2.37 25.4% (16.2--37.3)
## 9 education_level secondary  130201.  6.68 32.2% (16.5--53.3)</code></pre>
</div>
<div id="gtsummary-package" class="section level3" number="26.8.4">
<h3>
<span class="header-section-number">26.8.4</span> <strong>Gtsummary</strong> package<a class="anchor" aria-label="anchor" href="#gtsummary-package"><i class="fas fa-link"></i></a>
</h3>
<p>With <strong>gtsummary</strong> there does not seem to be inbuilt functions yet to add confidence
intervals or design effect.
Here we show how to define a function for adding confidence intervals and then
add confidence intervals to a <strong>gtsummary</strong> table created using the <code>tbl_svysummary()</code>
function.</p>
<div class="sourceCode" id="cb1271"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">confidence_intervals</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">variable</span>, <span class="va">by</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co">## extract the confidence intervals and multiply to get percentages</span>
  <span class="va">props</span> <span class="op">&lt;-</span> <span class="fu">svyciprop</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span> <span class="st">"~"</span> , <span class="va">variable</span><span class="op">)</span><span class="op">)</span>,
              <span class="va">data</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  
  <span class="co">## extract the confidence intervals </span>
  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">props</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## make numeric and multiply for percentage</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">.</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>           <span class="co">## round to one digit</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">%&gt;%</span>                           <span class="co">## extract the numbers from matrix</span>
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">.</span>, collapse <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>          <span class="co">## combine to single character</span>
<span class="op">}</span>

<span class="co">## using the survey package design object</span>
<span class="fu">tbl_svysummary</span><span class="op">(</span><span class="va">base_survey_design</span>, 
               include <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">arrived</span>, <span class="va">left</span>, <span class="va">died</span><span class="op">)</span>,   <span class="co">## define variables want to include</span>
               statistic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"{n} ({p}%)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## define stats of interest</span>
  <span class="fu">add_n</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">## add the weighted total </span>
  <span class="fu">add_stat</span><span class="op">(</span>fns <span class="op">=</span> <span class="fu">everything</span><span class="op">(</span><span class="op">)</span> <span class="op">~</span> <span class="va">confidence_intervals</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">## add CIs</span>
  <span class="co">## modify the column headers</span>
  <span class="fu">modify_header</span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      <span class="va">n</span> <span class="op">~</span> <span class="st">"**Weighted total (N)**"</span>,
      <span class="va">stat_0</span> <span class="op">~</span> <span class="st">"**Weighted Count**"</span>,
      <span class="va">add_stat_1</span> <span class="op">~</span> <span class="st">"**95%CI**"</span>
    <span class="op">)</span>
    <span class="op">)</span></code></pre></div>
<div id="obimoluqpw" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#obimoluqpw .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#obimoluqpw .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#obimoluqpw .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#obimoluqpw .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#obimoluqpw .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#obimoluqpw .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#obimoluqpw .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#obimoluqpw .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#obimoluqpw .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#obimoluqpw .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#obimoluqpw .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#obimoluqpw .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#obimoluqpw .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#obimoluqpw .gt_from_md > :first-child {
  margin-top: 0;
}

#obimoluqpw .gt_from_md > :last-child {
  margin-bottom: 0;
}

#obimoluqpw .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#obimoluqpw .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#obimoluqpw .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#obimoluqpw .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#obimoluqpw .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#obimoluqpw .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#obimoluqpw .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#obimoluqpw .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#obimoluqpw .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#obimoluqpw .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#obimoluqpw .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#obimoluqpw .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#obimoluqpw .gt_left {
  text-align: left;
}

#obimoluqpw .gt_center {
  text-align: center;
}

#obimoluqpw .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#obimoluqpw .gt_font_normal {
  font-weight: normal;
}

#obimoluqpw .gt_font_bold {
  font-weight: bold;
}

#obimoluqpw .gt_font_italic {
  font-style: italic;
}

#obimoluqpw .gt_super {
  font-size: 65%;
}

#obimoluqpw .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 65%;
}
</style>
<div class="inline-table"><table class="gt_table">
<thead class="gt_col_headings"><tr>
<th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1"><strong>Characteristic</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1"><strong>Weighted total (N)</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">
<strong>Weighted Count</strong><sup class="gt_footnote_marks">1</sup>
</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1"><strong>95%CI</strong></th>
    </tr></thead>
<tbody class="gt_table_body">
<tr>
<td class="gt_row gt_left">arrived</td>
<td class="gt_row gt_center">1,482,457</td>
<td class="gt_row gt_center">761,799 (51%)</td>
<td class="gt_row gt_center">40.9-61.7</td>
</tr>
<tr>
<td class="gt_row gt_left">left</td>
<td class="gt_row gt_center">1,482,457</td>
<td class="gt_row gt_center">701,199 (47%)</td>
<td class="gt_row gt_center">39.2-55.5</td>
</tr>
<tr>
<td class="gt_row gt_left">died</td>
<td class="gt_row gt_center">1,482,457</td>
<td class="gt_row gt_center">76,213 (5.1%)</td>
<td class="gt_row gt_center">2.1-12.1</td>
</tr>
</tbody>
<tfoot><tr class="gt_footnotes">
<td colspan="4">
        <p class="gt_footnote">
          <sup class="gt_footnote_marks"><em>1</em>
          </sup>
           
          n (%)
          <br></p>
      </td>
    </tr></tfoot>
</table></div>
</div>
<!-- ======================================================= -->
</div>
</div>
<div id="weighted-ratios" class="section level2" number="26.9">
<h2>
<span class="header-section-number">26.9</span> Weighted ratios<a class="anchor" aria-label="anchor" href="#weighted-ratios"><i class="fas fa-link"></i></a>
</h2>
<p>Similarly for weighted ratios (such as for mortality ratios) you can use the
<strong>survey</strong> or the <strong>srvyr</strong> package.
You could similarly write functions (similar to those above) to iterate over
several variables. You could also create a function for <strong>gtsummary</strong> as above
but currently it does not have inbuilt functionality.</p>
<div id="survey-package-2" class="section level3" number="26.9.1">
<h3>
<span class="header-section-number">26.9.1</span> <strong>Survey</strong> package<a class="anchor" aria-label="anchor" href="#survey-package-2"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1272"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ratio</span> <span class="op">&lt;-</span> <span class="fu">svyratio</span><span class="op">(</span><span class="op">~</span><span class="va">died</span>, 
         denominator <span class="op">=</span> <span class="op">~</span><span class="va">obstime</span>, 
         design <span class="op">=</span> <span class="va">base_survey_design</span><span class="op">)</span>

<span class="va">ci</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span><span class="op">(</span><span class="va">ratio</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>
  <span class="va">ratio</span><span class="op">$</span><span class="va">ratio</span> <span class="op">*</span> <span class="fl">10000</span>, 
  <span class="va">ci</span> <span class="op">*</span> <span class="fl">10000</span>
<span class="op">)</span></code></pre></div>
<pre><code>##       obstime    2.5 %   97.5 %
## died 5.981922 1.194294 10.76955</code></pre>
</div>
<div id="srvyr-package-2" class="section level3" number="26.9.2">
<h3>
<span class="header-section-number">26.9.2</span> <strong>Srvyr</strong> package<a class="anchor" aria-label="anchor" href="#srvyr-package-2"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb1274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">survey_design</span> <span class="op">%&gt;%</span> 
  <span class="co">## survey ratio used to account for observation time </span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    mortality <span class="op">=</span> <span class="fu">survey_ratio</span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">died</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10000</span>, 
      <span class="va">obstime</span>, 
      vartype <span class="op">=</span> <span class="st">"ci"</span><span class="op">)</span>
    <span class="op">)</span></code></pre></div>
<pre><code>##   mortality mortality_low mortality_upp
## 1  5.981922     0.3490176      11.61483</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="resources-19" class="section level2" number="26.10">
<h2>
<span class="header-section-number">26.10</span> Resources<a class="anchor" aria-label="anchor" href="#resources-19"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://stats.idre.ucla.edu/r/seminars/survey-data-analysis-with-r/">UCLA stats page</a></p>
<p><a href="http://asdfree.com/">Analyze survey data free</a></p>
<p><a href="http://gdfe.co/srvyr/">srvyr packge</a></p>
<p><a href="http://www.danieldsjoberg.com/gtsummary/reference/index.html">gtsummary package</a></p>
<p><a href="https://github.com/EPIET/RapidAssessmentSurveys">EPIET survey case studies</a></p>

<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="contact-tracing-1.html"><span class="header-section-number">25</span> Contact tracing</a></div>
<div class="next"><a href="survival-analysis.html"><span class="header-section-number">27</span> Survival analysis</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#survey-analysis"><span class="header-section-number">26</span> Survey analysis</a></li>
<li><a class="nav-link" href="#overview-4"><span class="header-section-number">26.1</span> Overview</a></li>
<li>
<a class="nav-link" href="#preparation-17"><span class="header-section-number">26.2</span> Preparation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#packages-3">Packages</a></li>
<li><a class="nav-link" href="#load-data-1">Load data</a></li>
<li><a class="nav-link" href="#clean-data-2">Clean data</a></li>
</ul>
</li>
<li><a class="nav-link" href="#survey-data"><span class="header-section-number">26.3</span> Survey data</a></li>
<li><a class="nav-link" href="#observation-time"><span class="header-section-number">26.4</span> Observation time</a></li>
<li><a class="nav-link" href="#weighting"><span class="header-section-number">26.5</span> Weighting</a></li>
<li>
<a class="nav-link" href="#survey-design-objects"><span class="header-section-number">26.6</span> Survey design objects</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#survey-package"><span class="header-section-number">26.6.1</span> Survey package</a></li>
<li><a class="nav-link" href="#srvyr-package"><span class="header-section-number">26.6.2</span> Srvyr package</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#descriptive-analysis-2"><span class="header-section-number">26.7</span> Descriptive analysis</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#sampling-bias"><span class="header-section-number">26.7.1</span> Sampling bias</a></li>
<li><a class="nav-link" href="#demographic-pyramids"><span class="header-section-number">26.7.2</span> Demographic pyramids</a></li>
<li><a class="nav-link" href="#alluvialsankey-diagram"><span class="header-section-number">26.7.3</span> Alluvial/sankey diagram</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#weighted-proportions"><span class="header-section-number">26.8</span> Weighted proportions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#survey-package-1"><span class="header-section-number">26.8.1</span> Survey package</a></li>
<li><a class="nav-link" href="#srvyr-package-1"><span class="header-section-number">26.8.2</span> Srvyr package</a></li>
<li><a class="nav-link" href="#sitrep-package"><span class="header-section-number">26.8.3</span> Sitrep package</a></li>
<li><a class="nav-link" href="#gtsummary-package"><span class="header-section-number">26.8.4</span> Gtsummary package</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#weighted-ratios"><span class="header-section-number">26.9</span> Weighted ratios</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#survey-package-2"><span class="header-section-number">26.9.1</span> Survey package</a></li>
<li><a class="nav-link" href="#srvyr-package-2"><span class="header-section-number">26.9.2</span> Srvyr package</a></li>
</ul>
</li>
<li><a class="nav-link" href="#resources-19"><span class="header-section-number">26.10</span> Resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>The Epidemiologist R Handbook</strong>" was written by the handbook team. It was last built on 2021-07-11.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
