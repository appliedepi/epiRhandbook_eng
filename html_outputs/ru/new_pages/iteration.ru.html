<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Справочник эпидемиолога R - 16&nbsp; Итерации, циклы и списки</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../new_pages/tables_descriptive.ru.html" rel="next">
<link href="../new_pages/deduplication.ru.html" rel="prev">
<link href="../images/Applied_Epi_logo.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "Поиск не дал результатов",
    "search-matching-documents-text": "Результаты поиска",
    "search-copy-link-title": "Скопировать ссылку",
    "search-hide-matches-text": "Скрыть дополнительные результаты",
    "search-more-match-text": "дополнительный результат в этом документе",
    "search-more-matches-text": "дополнительных результата(-ов) в этом документе",
    "search-clear-button-title": "Очистить",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Отменить",
    "search-submit-button-title": "Найти",
    "search-label": "Поиск"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QXDW878QLX', { 'anonymize_ip': true});
</script>
<!-- Global site tag (gtag.js) - Google Analytics 
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QXDW878QLX');
</script> -->

</head><body class="nav-sidebar floating"><div class="alert alert-info alert-dismissible">
  <!-- <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
  <strong>Need help learning R?</strong> Enroll in Applied Epi's <a href="https://www.appliedepi.org/live/"
    class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/"
    class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/"
    class="alert-link">Community Q&A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org"
    class="alert-link">R Help Desk service</a>. -->
</div>

<script>

  // Function to extract the last two characters from the URL path to determine the language, adjusting for .html extension
  function getLanguageFromURL() {
    let path = window.location.pathname;
    
    // Check if the URL ends with .html and remove it
    if (path.endsWith('.html')) {
      path = path.substring(0, path.length - 5);
    }

    // Extract the last two characters for the language code
    const lang = path.substr(-2);
    return lang;
  }

  const language = getLanguageFromURL();
  const supportedLanguages = ['fr', 'es', 'vn', 'jp', 'pt', 'tr', 'ru'];
  const defaultLanguage = 'en';
  const isSupportedLanguage = supportedLanguages.includes(language);

  // Translations for the content
  const translations = {
    en: '<strong>Need help learning R?</strong> Enroll in Applied Epi\'s <a href="https://www.appliedepi.org/live/" class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/" class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/" class="alert-link">Community Q&A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org" class="alert-link">R Help Desk service</a>.',
    fr: '<strong>Besoin d\'aide pour apprendre R ?</strong> Inscrivez-vous au <a href="https://www.appliedepi.org/live/" class="alert-link">cours d\'introduction à R</a> d\'Applied Epi, essayez nos <a href="https://www.appliedepi.org/tutorial/" class="alert-link">tutoriels R gratuits</a>, postez dans notre forum de <a href="https://community.appliedepi.org/" class="alert-link">questions-réponses communautaires</a>, ou demandez-nous des informations sur <a href="mailto:contact@appliedepi.org" class="alert-link"> notre service d\'assistance R</a>.',
    es: '<strong>¿Necesitas ayuda para aprender R?</strong> Inscríbete en el <a href="https://www.appliedepi.org/live/" class="alert-link">Curso de introducción a R</a> de Applied Epi, prueba nuestros <a href="https://www.appliedepi.org/tutorial/" class="alert-link">Tutoriales gratuitos de R</a>, escribe en nuestro <a href="https://community.appliedepi.org/" class="alert-link">Foro de preguntas y respuestas,</a> o pregunta por nuestra <a href="mailto:contact@appliedepi.org" class="alert-link">Asistencia técnica para R</a>.',
    vn: '<strong>Bạn cần giúp đỡ trong việc học R?</strong> Hãy đăng ký khóa học R cơ bản của Applied Epi tại <a href="https://www.appliedepi.org/live/" class="alert-link">đây</a>, hoặc thử các <a href="https://www.appliedepi.org/tutorial/" class="alert-link">hướng dẫn R miễn phí</a>, đăng bài trong <a href="https://community.appliedepi.org/" class="alert-link">diễn đàn cộng đồng</a>, hoặc gửi câu hỏi tới <a href="mailto:contact@appliedepi.org" class="alert-link">dịch vụ Trợ giúp R</a> của chúng tôi.',
    jp: '<strong>Rの学習について助けが必要ですか？</strong>Applied Epiの<a href="https://www.appliedepi.org/live/" class="alert-link">R入門コース</a>に登録するか、<a href="https://www.appliedepi.org/tutorial/" class="alert-link">無料Rチュートリアル</a>を試すか、<a href="https://community.appliedepi.org/" class="alert-link">コミュニティQ＆Aフォーラム</a>に投稿するか、<a href="mailto:contact@appliedepi.org" class="alert-link">Rヘルプデスクサービス</a>についてお問い合わせください。',
    pt: '<strong>Você precisa de ajuda para aprender R??</strong> Inscreva-se no curso de <a href="https://www.appliedepi.org/live/" class="alert-link">introdução ao R da Applied Epi</a>, experimente nossos <a href="https://www.appliedepi.org/tutorial/" class="alert-link">tutoriais gratuitos sobre o R</a>, publique em nosso <a href="https://community.appliedepi.org/" class="alert-link">fórum de perguntas e respostas</a>, ou solicite nosso <a href="mailto:contact@appliedepi.org" class="alert-link">suporte ao R</a>.',
    tr: '<strong>R öğrenmekte yardıma mı ihtiyacınız var?</strong> Applied Epi\'\nin <a href="https://www.appliedepi.org/live/" class="alert-link">R\'ye giriş kursuna</a> kaydolun, <a href="https://www.appliedepi.org/tutorial/" class="alert-link">ücretsiz R derslerimizi</a> deneyin, <a href="https://community.appliedepi.org/" class="alert-link">Topluluk Q&A forumunda</a> soru paylaşın, ya da <a href="mailto:contact@appliedepi.org" class="alert-link">R Yardım Masası hizmetimiz</a> hakkında sorun.',
    ru: '<strong>Нужна помощь в изучении R?</strong> Запишитесь на <a href="https://www.appliedepi.org/live/" class="alert-link">вводный курс по R</a> от Applied Epi, попробуйте наши <a href="https://www.appliedepi.org/tutorial/" class="alert-link">бесплатные учебные материалы по R</a>, задайте вопрос в нашем <a href="https://community.appliedepi.org/" class="alert-link">форуме вопросов и ответов сообщества</a>, или спросите о нашей услуге <a href="mailto:contact@appliedepi.org" class="alert-link">Службы поддержки по R</a>.'
  };

  // Default to English if the detected language is not supported
  const contentToDisplay = translations[isSupportedLanguage ? language : defaultLanguage];


  // Select the element where the content should be displayed
  const alertElement = document.querySelector('.alert');
  if (alertElement) {
    alertElement.innerHTML = contentToDisplay;
    alertElement.style.display = 'block'; // Make sure to display the element
  }

</script>
<link href="../site_libs/htmltools-fill-0.5.8/fill.css" rel="stylesheet">
<script src="../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../site_libs/datatables-binding-0.31/datatables.js"></script>
<script src="../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="../site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>






<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Переключить боковую панель навигации" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../new_pages/cleaning.ru.html">Управление данными</a></li><li class="breadcrumb-item"><a href="../new_pages/iteration.ru.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Итерации, циклы и списки</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Переключить боковую панель навигации" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/Applied_Epi_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Справочник эпидемиолога R</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://twitter.com/appliedepi" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
    <a href="https://www.linkedin.com/company/appliedepi/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="https://github.com/appliedepi/epihandbook_quarto" title="Исходный код" class="quarto-navigation-tool px-1" aria-label="Исходный код"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Переключить темный режим"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Поиск"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Добро пожаловать</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Об этой книге</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/editorial_style.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Редакционные и технические замечания</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/data_used.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Скачивание руководства и данных</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Основы</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/basics.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Основы R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/transition_to_R.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Переход к R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/packages_suggested.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Рекомендованные пакеты</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/r_projects.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Проекты R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/importing.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Импорт и экспорт</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Управление данными</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/cleaning.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Вычистка данных и ключевые функции</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/dates.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Работа с датами</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/characters_strings.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Текст и последовательности</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/factors.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Факторы</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/pivoting.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Поворот данных</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/grouping.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Группирование данных</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/joining_matching.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Соединение данных</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/deduplication.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Дедупликация</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/iteration.ru.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Итерации, циклы и списки</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Анализ</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/tables_descriptive.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Описательные таблицы</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/stat_tests.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Простые статистические тесты</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/regression.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Однофакторная и многофакторная регрессия</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/missing_data.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Отсутствующие данные</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/standardization.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Стандартизированные коэффициенты</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/moving_average.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Скользящие средние значения</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/time_series.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Временные ряды и обнаружение вспышек</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/epidemic_models.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Моделирование эпидемий</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/contact_tracing.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Отслеживание контактов</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/survey_analysis.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Анализ опросов</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/survival_analysis.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Анализ выживаемости</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/gis.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Основы ГИС</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Визуализация данных</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/tables_presentation.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Таблицы для презентации</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/ggplot_basics.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Основы ggplot</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/ggplot_tips.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Советы по использованию ggplot</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/epicurves.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Эпидемические кривые</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/age_pyramid.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Демографические пирамиды и шкалы Лайкерта</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/heatmaps.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Тепловые диаграммы</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/diagrams.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Диаграммы и схемы</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/combination_analysis.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Анализ комбинаций</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/transmission_chains.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Цепочки передачи</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/phylogenetic_trees.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Филогенетические деревья</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/interactive_plots.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Интерактивные графики</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Отчеты и информационные панели</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/rmarkdown.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Отчеты с помощью R Markdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/reportfactory.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Структурирование рутинных отчетов</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/flexdashboard.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Информационные панели с R Markdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/shiny_basics.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Информационные панели с Shiny</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Разное</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/writing_functions.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Написание функций</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/directories.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Взаимодействие директорий</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/collaboration.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Контроль версий и совместная работа с помощью Git и Github</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/errors.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Частые ошибки</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/help.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Получение помощи</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/network_drives.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">R на сетевых дисках</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/data_table.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">Таблица данных</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Содержание</h2>
   
  <ul>
  <li><a href="#подготовка" id="toc-подготовка" class="nav-link active" data-scroll-target="#подготовка"><span class="header-section-number">16.1</span> Подготовка</a>
  <ul class="collapse">
  <li><a href="#загрузка-пакетов" id="toc-загрузка-пакетов" class="nav-link" data-scroll-target="#загрузка-пакетов">Загрузка пакетов</a></li>
  <li><a href="#импорт-данных" id="toc-импорт-данных" class="nav-link" data-scroll-target="#импорт-данных">Импорт данных</a></li>
  </ul></li>
  <li><a href="#циклы-for" id="toc-циклы-for" class="nav-link" data-scroll-target="#циклы-for"><span class="header-section-number">16.2</span> <em>Циклы for</em></a>
  <ul class="collapse">
  <li><a href="#iter_loops" id="toc-iter_loops" class="nav-link" data-scroll-target="#iter_loops"><em>Циклы for</em> в R</a></li>
  <li><a href="#ключевые-компоненты" id="toc-ключевые-компоненты" class="nav-link" data-scroll-target="#ключевые-компоненты">Ключевые компоненты</a></li>
  <li><a href="#последовательность" id="toc-последовательность" class="nav-link" data-scroll-target="#последовательность">Последовательность</a></li>
  <li><a href="#операции" id="toc-операции" class="nav-link" data-scroll-target="#операции">Операции</a></li>
  <li><a href="#контейнер" id="toc-контейнер" class="nav-link" data-scroll-target="#контейнер">Контейнер</a></li>
  <li><a href="#печать" id="toc-печать" class="nav-link" data-scroll-target="#печать">Печать</a></li>
  <li><a href="#тестирование-цикла-for" id="toc-тестирование-цикла-for" class="nav-link" data-scroll-target="#тестирование-цикла-for">Тестирование цикла for</a></li>
  <li><a href="#циклы-для-графиков" id="toc-циклы-для-графиков" class="nav-link" data-scroll-target="#циклы-для-графиков">Циклы для графиков</a></li>
  <li><a href="#отслеживание-прогресса-цикла" id="toc-отслеживание-прогресса-цикла" class="nav-link" data-scroll-target="#отслеживание-прогресса-цикла">Отслеживание прогресса цикла</a></li>
  </ul></li>
  <li><a href="#iter_purrr" id="toc-iter_purrr" class="nav-link" data-scroll-target="#iter_purrr"><span class="header-section-number">16.3</span> <strong>purrr</strong> и списки</a>
  <ul class="collapse">
  <li><a href="#загрузка-пакетов-1" id="toc-загрузка-пакетов-1" class="nav-link" data-scroll-target="#загрузка-пакетов-1">Загрузка пакетов</a></li>
  <li><a href="#map" id="toc-map" class="nav-link" data-scroll-target="#map"><code>map()</code></a></li>
  <li><a href="#разделение-набора-данных-и-экспорт" id="toc-разделение-набора-данных-и-экспорт" class="nav-link" data-scroll-target="#разделение-набора-данных-и-экспорт">Разделение набора данных и экспорт</a></li>
  <li><a href="#пользовательские-функции" id="toc-пользовательские-функции" class="nav-link" data-scroll-target="#пользовательские-функции">Пользовательские функции</a></li>
  <li><a href="#применение-функций-к-нескольким-столбцам" id="toc-применение-функций-к-нескольким-столбцам" class="nav-link" data-scroll-target="#применение-функций-к-нескольким-столбцам">Применение функций к нескольким столбцам</a></li>
  <li><a href="#извлечение-из-списков" id="toc-извлечение-из-списков" class="nav-link" data-scroll-target="#извлечение-из-списков">Извлечение из списков</a></li>
  <li><a href="#конвертация-списка-в-датафрейм" id="toc-конвертация-списка-в-датафрейм" class="nav-link" data-scroll-target="#конвертация-списка-в-датафрейм">Конвертация списка в датафрейм</a></li>
  <li><a href="#удаление-сохранение-и-сжатие-списков" id="toc-удаление-сохранение-и-сжатие-списков" class="nav-link" data-scroll-target="#удаление-сохранение-и-сжатие-списков">Удаление, сохранение и сжатие списков</a></li>
  <li><a href="#pmap" id="toc-pmap" class="nav-link" data-scroll-target="#pmap"><code>pmap()</code></a></li>
  </ul></li>
  <li><a href="#функции-apply" id="toc-функции-apply" class="nav-link" data-scroll-target="#функции-apply"><span class="header-section-number">16.4</span> Функции Apply</a></li>
  <li><a href="#ресурсы" id="toc-ресурсы" class="nav-link" data-scroll-target="#ресурсы"><span class="header-section-number">16.5</span> Ресурсы</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../new_pages/cleaning.ru.html">Управление данными</a></li><li class="breadcrumb-item"><a href="../new_pages/iteration.ru.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Итерации, циклы и списки</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Итерации, циклы и списки</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Эпидемиологи часто сталкиваются с ситуациями, когда необходимо повторять анализ по подгруппам, например, по странам, районам или возрастным группам. Это лишь некоторые примеры ситуаций, когда требуются <em>итерации</em>. Кодирование ваших повторяющихся операций с помощью подходов, указанных ниже, позволит вам выполнять такие повторяющиеся задачи быстрее, снижать риск ошибок и сокращать длину кода.</p>
<p>На этой странице мы представим два подхода к повторяющимся операциям - использование <em>циклов на основе for</em> и использование пакета <strong>purrr</strong>.</p>
<ol type="1">
<li><em>Циклы for</em> повторяют код для ряда входных данных, но менее часто встречаются в R, чем в других языках программирования. Тем не менее, мы вас с ними познакомим в целях изучения инструмента и для справки.<br>
</li>
<li>Пакет <strong>purrr</strong> является подходом к итеративным операциям из <strong>tidyverse</strong> - он работает путем “сопоставления” функции с разными входными данными (значения, столбцы, наборы данных и т.п.)</li>
</ol>
<p>В ходе изучения мы покажем следующие примеры:</p>
<ul>
<li>Импорт и экспорт нескольких файлов<br>
</li>
<li>Создание эпидкривых для нескольких юрисдикций<br>
</li>
<li>Проведение T-тестов для нескольких столбцов датафрейма</li>
</ul>
<p>В <a href="#iter_purrr">разделе</a> <strong>purrr</strong> мы также дадим несколько примеров создания и работы с объектами <code>lists</code>.</p>
<section id="подготовка" class="level2" data-number="16.1">
<h2 data-number="16.1" class="anchored" data-anchor-id="подготовка"><span class="header-section-number">16.1</span> Подготовка</h2>
<section id="загрузка-пакетов" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="загрузка-пакетов">Загрузка пакетов</h3>
<p>Данный фрагмент кода показывает загрузку пакетов, необходимых для анализа. В данном руководстве мы фокусируемся на использовании <code>p_load()</code> из пакета <strong>pacman</strong>, которая устанавливает пакет, если необходимо, <em>и</em> загружает его для использования. Вы можете также загрузить установленные пакеты с помощью <code>library()</code> из <strong>базового</strong> R. См. страницу [Основы R] для получения дополнительной информации о пакетах R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>     rio,         <span class="co"># импорт/экспорт</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>     here,        <span class="co"># расположение файла</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>     purrr,       <span class="co"># итерации</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>     grates,      <span class="co"># шкалы в ggplot</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>     tidyverse    <span class="co"># управление данными и визуализация</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="импорт-данных" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="импорт-данных">Импорт данных</h3>
<p>Мы импортируем набор данных о случаях имитированной эпидемии Эболы. Если вы хотите выполнять действия параллельно, <a href="https://github.com/appliedepi/epirhandbook_eng/raw/master/data/case_linelists/linelist_cleaned.rds" class="download-button">кликните, чтобы скачать “чистый” построчный список</a> (как .rds файл). Импортируйте данный с помощью функции <code>import()</code> из пакета <strong>rio</strong> (он работает с многими типами файлов, такими как .xlsx, .csv, .rds - см. детали на странице [Импорт и экспорт]).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># импортируем построчный список</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"linelist_cleaned.rds"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Первые 50 строк построчного списка отображены ниже.</p>
<div class="cell">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-78d5f0a0dee137cf904b" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-78d5f0a0dee137cf904b">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08",null,null,"2014-05-04","2014-05-18","2014-05-03","2014-05-22","2014-05-28",null,null,"2014-05-30","2014-05-28","2014-06-14","2014-06-07","2014-06-09",null,null,null,"2014-06-23","2014-06-18","2014-06-24",null,null,"2014-07-03",null,"2014-07-10","2014-06-14",null,"2014-06-18","2014-06-29","2014-07-02","2014-07-12","2014-07-12","2014-06-13","2014-07-15","2014-06-20",null,null,"2014-07-20",null,"2014-07-12","2014-07-19","2014-07-18","2014-07-18","2014-07-27",null,"2014-07-19","2014-07-26","2014-07-24",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15","2014-05-14","2014-05-18","2014-05-20","2014-05-22","2014-05-23","2014-05-29","2014-06-03","2014-06-06","2014-06-07","2014-06-08","2014-06-15","2014-06-17","2014-06-17","2014-06-20","2014-06-19","2014-06-23","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-03","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-13","2014-07-14","2014-07-14","2014-07-13","2014-07-14","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-20","2014-07-22","2014-07-24","2014-07-26","2014-07-24","2014-07-27","2014-07-25","2014-07-27","2014-07-31","2014-08-01","2014-08-03","2014-08-02","2014-08-02","2014-08-04"],[null,"2014-05-18","2014-05-30",null,"2014-05-29","2014-05-24","2014-06-01","2014-06-07","2014-06-18","2014-06-09","2014-06-15",null,"2014-07-09",null,"2014-06-30","2014-07-11","2014-07-01","2014-06-25","2014-07-06","2014-07-02","2014-07-09","2014-07-07","2014-07-20",null,"2014-07-22","2014-07-16","2014-07-14","2014-07-20","2014-07-16","2014-07-19","2014-07-27","2014-07-19",null,"2014-07-26","2014-08-14","2014-08-01","2014-07-23","2014-08-28","2014-07-28","2014-07-19",null,"2014-08-03",null,null,null,"2014-08-06","2014-08-21","2014-09-13","2014-08-04",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["m","f","m","f","m","f","f","f","m","f","m","m","m","f","f","m","f","f","f","f","m","m","f","m","f","m","m","f","m","f","f","f","m","m","f","m","f","f","f","m","f","m","f","m","m","f","m","f","m","m"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["0-4","0-4","50-69","15-19","0-4","15-19","15-19","0-4","50-69","20-29","10-14","30-49","15-19","5-9","5-9","10-14","30-49","15-19","10-14","10-14","15-19","50-69","10-14","20-29","5-9","0-4","30-49","5-9","50-69","10-14","10-14","20-29","20-29","30-49","0-4","10-14","0-4","15-19","20-29","30-49","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-29","20-29","10-14"],["0-4","0-4","55-59","15-19","0-4","15-19","15-19","0-4","60-64","25-29","10-14","40-44","15-19","5-9","5-9","10-14","35-39","15-19","10-14","10-14","15-19","50-54","10-14","25-29","5-9","0-4","30-34","5-9","65-69","10-14","10-14","20-24","20-24","45-49","0-4","10-14","0-4","15-19","20-24","35-39","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-24","25-29","10-14"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing","Port Hospital","Military Hospital","Missing","Missing","Other","Port Hospital","Port Hospital","Port Hospital","Missing","Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Missing","Other","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital","Missing","Military Hospital","Other","Missing","Missing","Port Hospital","Port Hospital","Port Hospital","Missing","Central Hospital","Military Hospital","Other","Other","Other","Missing","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","Missing"],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.461830626007281,8.462729314626459,8.461443675342711,8.46191259217774,8.472923276435059,8.48401630165138,8.458371253408441,8.477617055125091,8.47570184950483,8.477799468789719,8.47145134147474,8.478048406853629,8.48528034195779,8.469575303958671,8.45957352078114,8.474048895115439,8.488029171298839,8.473437335922,8.484082637344621,8.46242233645879,8.470268221265719,8.463984474805329,8.464134789434199,8.456230946296071,8.48334624336805,8.47493999153642,8.47832062438022,8.469393389176499,8.48480589906514,8.47121232619015,8.48438437371817,8.484661585743391,8.477141599844281,8.462381270106089,8.455685978131131,8.4632880274758,8.47940722413856,8.46353857052336,8.461789681588639,8.47508713872833,8.458258081280711,8.4532568143863,8.4732571907655,8.479115866419329,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","no","no","no","no","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","yes","no",null,"no","no","no","yes","no",null,"no","no","yes",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","yes","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes",null,"yes","yes","yes","yes","yes",null,"yes","yes","yes",null,null,"yes","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","yes","yes","yes","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","yes","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"yes","yes",null,"no","no",null,"no","no","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","no","yes","no","no","no","yes","no","no","no",null,"no","yes","no","no","no",null,"no","no","no",null,null,"no","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","no","yes","yes","yes",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],[117.1875,71.81844297615629,16.06524962926347,22.49657064471879,71.41440190438405,41.61712247324614,62.09538908706566,0,16.83765369253662,22.79032897344431,53.41198979591836,24.28026361429067,22.46003435064077,54.32098765432099,41.05784325564545,28.56648199445983,17.03205520132763,25.04129149128882,38.7172182043977,27.3876813705495,31.55555555555556,14.80690759456621,30.88398111998135,26.61934338952972,59.37499999999999,96.61835748792272,19.23947487550928,84.94031221303948,18.41993774061044,27.77226740726046,41.32231404958677,17.20806665861611,24.16716240333135,15.72189710891781,428.9940828402366,27.99302202929125,243.2610124917817,20.23950075898128,30.52744643563797,25.15589569160998,47,39.04,31.06616432017979,77.96836711962574,29.51659612385831,166.4932362122789,100.3086419753086,37.76,20.60378034578518,23.45856237526698],[2,1,2,2,1,1,2,1,1,2,2,2,1,0,2,0,1,1,2,2,1,1,1,0,2,1,1,2,1,0,0,2,1,1,2,2,1,0,2,2,0,2,0,0,2,2,null,1,0,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]},{"name":"case_id","targets":0},{"name":"generation","targets":1},{"name":"date_infection","targets":2},{"name":"date_onset","targets":3},{"name":"date_hospitalisation","targets":4},{"name":"date_outcome","targets":5},{"name":"outcome","targets":6},{"name":"gender","targets":7},{"name":"age","targets":8},{"name":"age_unit","targets":9},{"name":"age_years","targets":10},{"name":"age_cat","targets":11},{"name":"age_cat5","targets":12},{"name":"hospital","targets":13},{"name":"lon","targets":14},{"name":"lat","targets":15},{"name":"infector","targets":16},{"name":"source","targets":17},{"name":"wt_kg","targets":18},{"name":"ht_cm","targets":19},{"name":"ct_blood","targets":20},{"name":"fever","targets":21},{"name":"chills","targets":22},{"name":"cough","targets":23},{"name":"aches","targets":24},{"name":"vomit","targets":25},{"name":"temp","targets":26},{"name":"time_admission","targets":27},{"name":"bmi","targets":28},{"name":"days_onset_hosp","targets":29}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<!-- ======================================================= -->
</section>
</section>
<section id="циклы-for" class="level2" data-number="16.2">
<h2 data-number="16.2" class="anchored" data-anchor-id="циклы-for"><span class="header-section-number">16.2</span> <em>Циклы for</em></h2>
<section id="iter_loops" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="iter_loops"><em>Циклы for</em> в R</h3>
<p><em>Циклы for</em> не очень часто применяются в R, но часто встречаются в других языках программирования. Вам, как начинающему, они могут быть полезны для изучения и практики, поскольку их легче изучать, проводить дебаггинг и разобраться, что происходит при каждой итерации, особенно если вы еще не умеете писать собственные функции.</p>
<p>Вы можете быстро перейти от <em>циклов for</em> к итерации с помощью построенных функций в <strong>purrr</strong> (см. <a href="#iter_purrr">раздел ниже</a>).</p>
</section>
<section id="ключевые-компоненты" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="ключевые-компоненты">Ключевые компоненты</h3>
<p>В <em>цикле for</em> есть три ключевых части:</p>
<ol type="1">
<li><strong>Последовательность</strong> элементов, по которым проводится итерация<br>
</li>
<li><strong>Операции</strong>, которые проводятся для каждого элемента последовательности<br>
</li>
<li><strong>Контейнер</strong> для результатов (опционально)</li>
</ol>
<p>Базовый синтаксис выглядит следующим образом: <code>for (элемент в последовательности) {сделать операции с элементом}</code>. Обратите внимание, что есть скобки и фигурные скобки. Результаты можно вывести на консоль, либо сохранить в контейнере объекта R.</p>
<p>Простой пример <em>цикла for</em> представлен ниже.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (num <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>)) {  <span class="co"># определяем ПОСЛЕДОВАТЕЛЬНОСТЬ (числа с 1 по 5) и цикл открывается с помощью "{"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(num <span class="sc">+</span> <span class="dv">2</span>)             <span class="co"># ОПЕРАЦИИ (добавить два к каждому числу последовательности и вывести на печать)</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>}                            <span class="co"># закрываем цикл с помощью "}"                            </span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3
[1] 4
[1] 5
[1] 6
[1] 7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>                             <span class="co"># В данном примере нет "контейнера"</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="последовательность" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="последовательность">Последовательность</h3>
<p>Это элемент “for” (для) в <em>цикле for</em> - операции будут проводиться “для” каждого элемента в последовательности. Последовательность может быть рядом значений (например, имен юрисдикций, болезней, имен столбцов, элементов списка и т.п.), либо она может быть рядом последовательно идущих чисел (например, 1,2,3,4,5). Каждый из подходов имеет свое применение, что описано ниже.</p>
<p>Базовая структура утверждения в последовательности - <code>item in vector</code> (элемент в векторе).</p>
<ul>
<li>Вы можете записать любой знак или слово вместо “item”(“элемента”) (например, “i”, “num”, “hosp”, “district”, и т.п.). Значение этого “элемента” меняется при каждой итерации цикла, проходя по каждому значению в векторе.<br>
</li>
<li><em>Вектор</em> может быть текстовыми значениями, именами столбцов, либо последовательностью чисел - это значения, которые будут меняться при каждой итерации. Вы можете их использовать внутри операций <em>цикла for</em>, через термин “item” (элемент).</li>
</ul>
<p><strong>Пример: последовательность текстовых значений</strong></p>
<p>В данном примере цикл выполняется для каждого значения в заранее установленном текстовом векторе имен больниц.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># создаем вектор имен больниц</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>hospital_names <span class="ot">&lt;-</span> <span class="fu">unique</span>(linelist<span class="sc">$</span>hospital)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>hospital_names <span class="co"># печать</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Other"                               
[2] "Missing"                             
[3] "St. Mark's Maternity Hospital (SMMH)"
[4] "Port Hospital"                       
[5] "Military Hospital"                   
[6] "Central Hospital"                    </code></pre>
</div>
</div>
<p>Мы выбрали термин <code>hosp</code> для отражения значений из вектора <code>hospital_names</code>. Для первой итерации цикла, значением <code>hosp</code> будет <code>hospital_names[[1]]</code>. Во втором цикле это будет <code>hospital_names[[2]]</code>. И так далее…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 'цикл for' с текстовой последовательностью</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (hosp <span class="cf">in</span> hospital_names){       <span class="co"># последовательность</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>       <span class="co"># ЗДЕСЬ ОПЕРАЦИИ</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Пример: последовательность имен столбцов</strong></p>
<p>Это вариация текстовой последовательности, приведенной выше, в которой имена существующего объекта R извлекаются и становятся вектором. Например, имена столбцов в датафрейме. Что удобно, в коде операций <em>циклов for</em>, имена столбцов могут быть использованы для <em>индексирования</em> (подмножества) оригинального датафрейма</p>
<p>Ниже последовательностью являются <code>names()</code> (имена столбцов) датафрейма <code>linelist</code>. Название нашего “элемента” - <code>col</code>, что отражает каждое название столбца по мере проведения циклов.</p>
<p>Для примера мы включаем код операций внутри <em>цикла for</em>, который проводится для каждого значения в последовательности. В этом коде значения последовательности (имена столбцов) используются для <em>индексирования</em> (подмножества) <code>linelist</code>, по одному. Как рассказано на странице [Основы R], двойные квадратные скобки используются для подмножества <code>[[ ]]</code>. Полученный в результате столбец передается в <code>is.na()</code>, затем в <code>sum()</code> для получения количества отсутствующих значений в столбце. Результат печатается в консоли - одно число для каждого столбца.</p>
<p>Примечание по индексированию с помощью имен столбцов - когда вы ссылаетесь на сам столбец, <em>не пишите просто “col”!</em> <code>col</code> отражает только текстовое имя столбца! Чтобы сослаться на весь столбец, вы должны использовать имя столбца как <em>индекс</em> в <code>linelist</code> с помощью <code>linelist[[col]]</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (col <span class="cf">in</span> <span class="fu">names</span>(linelist)){        <span class="co"># цикл выполняется для каждого столбца в построчном списке; имя столбца представлено как "col" </span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Пример кода операций - печать количества отсутствующих значений в столбце</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">sum</span>(<span class="fu">is.na</span>(linelist[[col]])))  <span class="co"># построчный список индексируется текущим значением "col"</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0
[1] 0
[1] 2087
[1] 256
[1] 0
[1] 936
[1] 1323
[1] 278
[1] 86
[1] 0
[1] 86
[1] 86
[1] 86
[1] 0
[1] 0
[1] 0
[1] 2088
[1] 2088
[1] 0
[1] 0
[1] 0
[1] 249
[1] 249
[1] 249
[1] 249
[1] 249
[1] 149
[1] 765
[1] 0
[1] 256</code></pre>
</div>
</div>
<p><strong>Последовательность чисел</strong></p>
<p>В данном подходе последовательность - ряд последовательно расположенных чисел. Таким образом, значение “элемента” - то не текстовое значение (например, “Central Hospital” или “date_onset”), а число. Это полезно для того, чтобы выполнить циклы для датафреймов, поскольку можно использовать номер “элемента” внутри <em>цикла for</em>, чтобы индексировать датафрейм по <em>номеру строки</em>.</p>
<p>Например, представим, что вы хотите выполнить цикл для каждой строки в вашем датафрейме и извлечь определенную информацию. Вашими “элементами” будут числовые номера строк. Часто в этом случае элементы (“items”) записывают как <code>i</code>.</p>
<p>Процесс <em>циклов for</em> можно объяснить словами следующим образом: “для каждого элемента последовательности чисел от 1 до общего количества строк в моем датафрейме, выполнить X”. Для первой итерации цикла значеним элемента (“item”) <code>i</code> будет 1. Для второй - <code>i</code> будет 2 и т.п.</p>
<p>Вот так выглядит последовательность в виде кода: <code>for (i в 1:nrow(linelist)) {КОД ОПЕРАЦИЙ}</code> где <code>i</code> отражает “item” (элемент), а <code>1:nrow(linelist)</code> создает последовательность последовательно идущих чисел от 1 до количества строк в <code>linelist</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(linelist)) {  <span class="co"># применяем к датафрейму</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ЗДЕСЬ ОПЕРАЦИИ</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>}  </span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Если вы хотите, чтобы последовательность была числами, но вы начинаете с вектора (а не датафрейма), используйте <code>seq_along()</code>, чтобы выдать последовательность чисел для каждого элемента вектора. Например, <code>for (i in seq_along(hospital_names) {КОД ОПЕРАЦИЙ}</code>.</p>
<p>Приведенный ниже код выдает числа, которые станут значением <code>i</code> в своем соответствующем цикле.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">seq_along</span>(hospital_names)  <span class="co"># используем для именованного вектора</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3 4 5 6</code></pre>
</div>
</div>
<p>Преимуществом использования чисел в последовательности является то, что легко использовать число <code>i</code> для индексации <em>контейнера</em>, который хранит выходные результаты цикла. Пример представлен в разделе Операции ниже.</p>
</section>
<section id="операции" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="операции">Операции</h3>
<p>Этот код записан внутри фигурных скобок <code>{ }</code> в <em>цикле for</em>. Вам нужно, чтобы этот код выполнялся для каждого “элемента” в <em>последовательности</em>. Следовательно, будьте внимательны, чтобы каждая часть вашего кода, которая меняет “элемент”, была правильно закодирована таким образом, чтобы он действительно изменился! Например, помните, что для индексирования нужно использовать <code>[[ ]]</code>.</p>
<p>В примере ниже мы проводим итерацию для каждой строки в <code>linelist</code>. Значения пола (<code>gender</code>) и возраста (<code>age</code>) каждой строки вставляются вместе и хранятся в векторе-контейнере <code>cases_demographics</code>. Обратите внимание, как мы также используем индексирование <code>[[i]]</code>, чтобы сохранить выходные результаты цикла в правильной позиции в векторе “контейнере”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># создаем контейнер для хранения результатов - текстовый вектор</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>cases_demographics <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"character"</span>, <span class="at">length =</span> <span class="fu">nrow</span>(linelist))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># цикл for</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(linelist)){</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ОПЕРАЦИИ</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># извлекаем значения из построчного списка для строки i, используя квадратные скобки для индексирования</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  row_gender  <span class="ot">&lt;-</span> linelist<span class="sc">$</span>gender[[i]]</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  row_age     <span class="ot">&lt;-</span> linelist<span class="sc">$</span>age_years[[i]]    <span class="co"># не забудьте индексировать!</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># объединяем пол-возраст и храним в векторе-контейнере в указанной индексом локации</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  cases_demographics[[i]] <span class="ot">&lt;-</span> <span class="fu">str_c</span>(row_gender, row_age, <span class="at">sep =</span> <span class="st">","</span>) </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>}  <span class="co"># окончание цикла</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"># отображаем первые 10 строк контейнера</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cases_demographics, <span class="dv">10</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "m,2"  "f,3"  "m,56" "f,18" "m,3"  "f,16" "f,16" "f,0"  "m,61" "f,27"</code></pre>
</div>
</div>
</section>
<section id="контейнер" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="контейнер">Контейнер</h3>
<p>Иногда результаты <em>циклов for</em> будут печататься в консоли или на панели RStudio Plots (Графики). А иногда вам нужно будет сохранить выходные данные в “контейнере” для использования позже. Такой контейнер может быть вектором, датафреймом или даже списком.</p>
<p>Наиболее эффективным способом является создание контейнера для результатов еще <em>до</em> начала <em>цикла for</em>. На практике это означает, что необходимо создать пустой вектор, датафрейм или список. Их можно создать с помощью функции <code>vector()</code> для векторов или списков, либо с помощью <code>matrix()</code> и <code>data.frame()</code> для датафрейма.</p>
<p><strong>Пустой вектор</strong></p>
<p>Используйте <code>vector()</code> и уточните <code>mode =</code> на основе ожидаемого класса объектов, которые вы вставите, либо “double” (двойной точности - для чисел), “character” (текстовый), или “logical” (логический). Вам также нужно заранее задать длину <code>length =</code>. Это должна быть длина вашей последовательности <em>циклов for</em>.</p>
<p>Допустим, вы хотите сохранить медианную задержку госпитализации для каждой больницы. Вы можете использовать “double” (число двойной точности) и установить длину на количество ожидаемых выходных данных (количество уникальных больниц в наборе данных).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>delays <span class="ot">&lt;-</span> <span class="fu">vector</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"double"</span>,                            <span class="co"># мы ожидаем, что нужно сохранить числа</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">length =</span> <span class="fu">length</span>(<span class="fu">unique</span>(linelist<span class="sc">$</span>hospital))) <span class="co"># число уникальных больниц в наборе данных</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Пустой датафрейм</strong></p>
<p>Вы можете создать пустой датафрейм, указав количество строк и столбцов следующим образом:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>delays <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">3</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Пустой список</strong></p>
<p>Вы можете также сохранить некоторые графики, созданные <em>циклом for</em>, в виде списка. Список похож на вектор, но содержит другие объекты R внутри себя, которые могут быть разных классов. Элементы в списке могут быть отдельным числом, датафреймом, вектором или даже еще одним списком.</p>
<p>Вы создаете пустой список, используя ту же команду <code>vector()</code>, что указана выше, но с аргументом <code>mode = "list"</code>. Уточните любую желаемую длину.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> <span class="dv">16</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="печать" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="печать">Печать</h3>
<p>Обратите внимание, что для печати изнутри <em>цикла for</em> вам скорее всего нужно будет дополнительно обернуть с помощью функции <code>print()</code>.</p>
<p>В примере ниже последовательность является текстовым вектором, который используется для создания подмножества из построчного списка по больницам. Результаты не сохраняются в контейнере, а печатаются в консоли с помощью функции <code>print()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (hosp <span class="cf">in</span> hospital_names){ </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>     hospital_cases <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> <span class="fu">filter</span>(hospital <span class="sc">==</span> hosp)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">print</span>(<span class="fu">nrow</span>(hospital_cases))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 885
[1] 1469
[1] 422
[1] 1762
[1] 896
[1] 454</code></pre>
</div>
</div>
</section>
<section id="тестирование-цикла-for" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="тестирование-цикла-for">Тестирование цикла for</h3>
<p>Чтобы протестировать ваш цикл, вы можете выполнить команду для временного присваивания “элемента”, например, <code>i &lt;- 10</code> или <code>hosp &lt;- "Central Hospital"</code>. Сделайте это <em>за пределами цикла</em> и затем выполните только ваш код операций (код внутри фигурных скобок), чтобы посмотреть, будут ли созданы ожидаемые результаты.</p>
</section>
<section id="циклы-для-графиков" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="циклы-для-графиков">Циклы для графиков</h3>
<p>Чтобы объединить все три компонента (контейнер, последовательность и операции), давайте попробуем построить эпидкривую для каждой больницу (см. страницу [Эпидемические кривые]).</p>
<p>Мы можем создать красивую эпидемическую кривую <em>всех</em> случаев по полу, используя пакет <strong>incidence2</strong>, как показано ниже:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># создаем объект 'incidence' (заболеваемость)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>outbreak <span class="ot">&lt;-</span> incidence2<span class="sc">::</span><span class="fu">incidence</span>(   </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">x =</span> linelist,                   <span class="co"># датафрейм - полный построчный список</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">date_index =</span> <span class="st">"date_onset"</span>,        <span class="co"># столбец дата</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">interval =</span> <span class="st">"week"</span>,              <span class="co"># суммарный подсчет по неделе</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">groups =</span> <span class="st">"gender"</span>)               <span class="co"># группируем значения по полу</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>     <span class="co">#na_as_group = TRUE)             # отсутствующий пол в отдельную группу</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># строим эпидемическую кривую</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(outbreak, <span class="co"># имя объекта заболеваемости</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date_index, <span class="co">#эстетика и оси</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> count, </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">fill =</span> gender), <span class="co"># цвет заливки столбцов по полу</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"black"</span>      <span class="co"># контур столбцов</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>       ) <span class="sc">+</span>  </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_col</span>() <span class="sc">+</span> </span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>     <span class="fu">facet_wrap</span>(<span class="sc">~</span>gender) <span class="sc">+</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>     <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>     <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Outbreak of all cases"</span>, <span class="co">#подписи</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> <span class="st">"Counts"</span>, </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>          <span class="at">y =</span> <span class="st">"Date"</span>, </span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">"Gender"</span>, </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"Gender"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.ru_files/figure-html/unnamed-chunk-16-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="iteration.ru_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Чтобы создать отдельный график для случаев по каждой больнице, мы можем код эпидкривой заложить в <em>цикл for</em>.</p>
<p>Сначала мы сохраняем именованный вектор уникальных имен больниц, <code>hospital_names</code>. <em>Цикл for</em> будет выполнен один раз для каждого из этих имен: <code>for (hosp in hospital_names)</code>. В каждой итерации <em>цикла for</em>, текущее имя больницы из вектора будет представлено как <code>hosp</code> для использования внутри цикла.</p>
<p>Внутри операций цикла вы можете писать код R как обычно, но используйте “элемент” (в данном случае <code>hosp</code>), зная, что его значение будет меняться. Внутри этого цикла:</p>
<ul>
<li>Применяется <code>filter()</code> к построчному списку <code>linelist</code>, так чтобы столбец <code>hospital</code> был равен текущему значению <code>hosp</code><br>
</li>
<li>Создается объект incidence (заболеваемость) в отфильтрованном построчном списке<br>
</li>
<li>Создается график для текущей больницы с автоматически изменяемым заголовком, который использует <code>hosp</code><br>
</li>
<li>График для текущей больницы временно сохраняется и затем печатается<br>
</li>
<li>Затем цикл переходит дальше и повторяет процесс со следующей больницей в <code>hospital_names</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># создаем вектор имен больниц</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>hospital_names <span class="ot">&lt;-</span> <span class="fu">unique</span>(linelist<span class="sc">$</span>hospital)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># для каждого имени ("hosp") в hospital_names, создаем и печатаем эпидкривую</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (hosp <span class="cf">in</span> hospital_names) {</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>     <span class="co"># создаем объект incidence (заболеваемость) конкретно для текущей больницы</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>     outbreak_hosp <span class="ot">&lt;-</span> incidence2<span class="sc">::</span><span class="fu">incidence</span>(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> linelist <span class="sc">%&gt;%</span> <span class="fu">filter</span>(hospital <span class="sc">==</span> hosp),   <span class="co"># построчный список фильтруется до текущей больницы</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">date_index =</span> <span class="st">"date_onset"</span>,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">interval =</span> <span class="st">"week"</span>, </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">groups =</span> <span class="st">"gender"</span><span class="co">#,</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>          <span class="co">#na_as_group = TRUE</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>      plot_hosp <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(outbreak_hosp, <span class="co"># имя объекта incidence</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">aes</span>(<span class="at">x =</span> date_index, <span class="co">#axes</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>                             <span class="at">y =</span> count, </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>                             <span class="at">fill =</span> gender), <span class="co"># цвет заливки по полу</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>                         <span class="at">color =</span> <span class="st">"black"</span>      <span class="co"># цвет контура столбца</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>                         ) <span class="sc">+</span>  </span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>          <span class="fu">geom_col</span>() <span class="sc">+</span> </span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>          <span class="fu">facet_wrap</span>(<span class="sc">~</span>gender) <span class="sc">+</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">labs</span>(<span class="at">title =</span> stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"Epidemic of cases admitted to {hosp}"</span>), <span class="co">#заголовок</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>               <span class="at">x =</span> <span class="st">"Counts"</span>, </span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>               <span class="at">y =</span> <span class="st">"Date"</span>, </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">"Gender"</span>, </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"Gender"</span>)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>     <span class="co"># В более старых версиях R удалите # перед na_as_group и используйте вместо этого эту команду для графика</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot_hosp &lt;- plot(</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="co">#       outbreak_hosp,</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co">#       fill = "gender",</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="co">#       color = "black",</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="co">#       title = stringr::str_glue("Epidemic of cases admitted to {hosp}")</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>     <span class="co">#печать графика больниц</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>     <span class="fu">print</span>(plot_hosp)</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>} <span class="co"># цикл for заканчивается. когда он пройдет по каждой больнице hospital_names </span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.ru_files/figure-html/unnamed-chunk-17-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="iteration.ru_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.ru_files/figure-html/unnamed-chunk-17-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="iteration.ru_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.ru_files/figure-html/unnamed-chunk-17-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="iteration.ru_files/figure-html/unnamed-chunk-17-3.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.ru_files/figure-html/unnamed-chunk-17-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="iteration.ru_files/figure-html/unnamed-chunk-17-4.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.ru_files/figure-html/unnamed-chunk-17-5.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="iteration.ru_files/figure-html/unnamed-chunk-17-5.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.ru_files/figure-html/unnamed-chunk-17-6.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="iteration.ru_files/figure-html/unnamed-chunk-17-6.png" class="img-fluid figure-img" style="width:50.0%"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="отслеживание-прогресса-цикла" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="отслеживание-прогресса-цикла">Отслеживание прогресса цикла</h3>
<p>Цикл с большим количеством итераций может занять минуты или даже часы. Поэтому может полезным печатать прогресс в консоли R. Утверждение <code>if</code> ниже можно разместить <em>внутри</em> операций цикла, чтобы печатать каждое 100е число. Просто скорректируйте его таким образом, чтобы <code>i</code> была “элементом” в вашем цикле.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># цикл с кодом для печати прогресса каждые 100 итераций</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(linelist))){</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># печать прогресса</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">%%</span> <span class="dv">100</span><span class="sc">==</span><span class="dv">0</span>){    <span class="co"># оператор %% - это остаток</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(i)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ======================================================= -->
</section>
</section>
<section id="iter_purrr" class="level2" data-number="16.3">
<h2 data-number="16.3" class="anchored" data-anchor-id="iter_purrr"><span class="header-section-number">16.3</span> <strong>purrr</strong> и списки</h2>
<p>Еще один подход к итеративным операциям - это пакет <strong>purrr</strong> - это подход к итерациям из <strong>tidyverse</strong>.</p>
<p>Если вы столкнулись с выполнением одной и той же задачи несколько раз, наверное, имеет смысл создать обобщенное решение, которое вы можете использовать со многими входными данными. Например, создание графиков для нескольких юрисдикций, либо импорт и объединение множества файлов.</p>
<p>Есть также другие преимущества <strong>purrr</strong> - вы можете использовать его с операторами канала <code>%&gt;%</code>, он справляется с ошибками лучше обычного <em>цикла for</em>, а синтаксис является весьма чистым и простым! Если вы используете цикл <em>for</em>, вы, скорее всего, сможете сделать то же самое более понятным и коротким образом с помощью <strong>purrr</strong>!</p>
<p>Помните, что <strong>purrr</strong> является <em>инструментом функционального программирования</em>. То есть, операции, которые будут применяться циклично, оборачиваются в <em>функции</em>. См. страницу [Написание функций], чтобы узнать, как писать собственные функции.</p>
<p><strong>purrr</strong> также почти полностью основана на <em>списках</em> и <em>векторах</em> - поэтому воспринимайте ее как применение функции к каждому элементу этого списка/вектора!</p>
<section id="загрузка-пакетов-1" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="загрузка-пакетов-1">Загрузка пакетов</h3>
<p><strong>purrr</strong> является частью <strong>tidyverse</strong>, поэтому нет необходимости устанавливать/загружать отдельный пакет.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>     rio,            <span class="co"># импорт/экспорт</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>     here,           <span class="co"># относительные пути к файлу</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>     tidyverse,      <span class="co"># управление данными и визуализация</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>     writexl,        <span class="co"># написание файла Excel с несколькими листами</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>     readxl          <span class="co"># импорт Excel с несколькими листами</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="map" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="map"><code>map()</code></h3>
<p>Одна из ключевых функций <strong>purrr</strong> - это функция <code>map()</code>, которая “сопоставляет” (применяет) функцию к каждому входному элементу списка/вектора, который вы зададите.</p>
<p>Базовый синтаксис: <code>map(.x = ПОСЛЕДОВАТЕЛЬНОСТЬ, .f = ФУНКЦИЯ, ДРУГИЕ АРГУМЕНТЫ)</code>. Если смотреть более детально:</p>
<ul>
<li><code>.x =</code> это <em>входные данные</em>, к которым будет итеративно применяться функция <code>.f</code> - например, вектор имен юрисдикций, столбцов в датафрейме или списка датафреймов<br>
</li>
<li><code>.f =</code> это <em>функция</em>, которая применяется в каждому элементу входных данных <code>.x</code> - это может быть такая функция, как <code>print()</code> которая уже существует, либо это может быть пользовательская функция, которую вы создадите. Функция часто записывается после тильды <code>~</code> (детали ниже).</li>
</ul>
<p>Еще несколько комментариев по синтаксису:</p>
<ul>
<li>Если для функции не требуется уточнять дополнительные аргументы, ее можно записать без скобок и без тильды (например, <code>.f = mean</code>). Чтобы указать аргументы, которые будут иметь одинаковое значение для каждой итерации, задайте их с помощью <code>map()</code>, но за пределами аргумента <code>.f =</code>, например, <code>na.rm = T</code> в <code>map(.x = my_list, .f = mean, na.rm=T)</code>.<br>
</li>
<li>Вы можете использовать <code>.x</code> (или просто <code>.</code>) <em>внутри</em> функции <code>.f =</code> в качестве заполнителя для значения <code>.x</code> для этой итерации<br>
</li>
<li>Используйте синтаксис тильды (<code>~</code>), чтобы обеспечить больший контроль над функцией - запишите функцию как обычно со скобками, например: <code>map(.x = my_list, .f = ~mean(., na.rm = T))</code>. В частности, используйте этот синтаксис, если значение аргумента будет меняться каждую итерацию, либо если это значение самого <code>.x</code> (см. примеры ниже)</li>
</ul>
<p><strong>Выходным результатом использования <code>map()</code> будет список <em>list</em></strong> - list (список) является классом объектов, как и вектор, но его элементы могут относиться к разным классам. Таким образом, если список, созданный с помощью <code>map()</code>, может содержать много датафреймов, либо много векторов, много отдельных значений или даже много списков! Существуют альтернативные версии <code>map()</code>, объясненные ниже, которые создают другие типы выходных данных (например, <code>map_dfr()</code> для создания датафрейма, <code>map_chr()</code> для создания текстовых векторов, и <code>map_dbl()</code> для создания числовых векторов).</p>
<section id="iter_combined" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="iter_combined">Пример - импорт и объединение листов Excel</h4>
<p><strong>Давайте продемонстрируем на примере частой задачи эпидемиолога:</strong> - <em>Вам нужно импортировать рабочую книгу Excel с данными о случаях, но данные разделены на разные именованные листы рабочей книги. Как эффективно импортировать и объединить эти листы в один датафрейм?</em></p>
<p>Представим, что нам прислали указанную ниже рабочую книгу Excel. На каждом листе содержатся случаи из конкретной больницы.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/hospital_linelists_excel_sheets.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="../images/hospital_linelists_excel_sheets.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="615"></a></p>
</figure>
</div>
</div>
</div>
<p>Вот один подход, который использует <code>map()</code>:</p>
<ol type="1">
<li>используйте <code>map()</code> для функции <code>import()</code>, чтобы она выполнялась для каждого листа Excel<br>
</li>
<li>комбинируйте импортированные датафреймы в один, используя <code>bind_rows()</code><br>
</li>
<li>по ходу выполнения сохраните оригинальное имя листа для каждой строки, сохраняя эту информацию в новом столбце итогового датафрейма</li>
</ol>
<p>Во-первых, нам нужно извлечь имена листов и сохранить их. Мы зададим путь к файлу рабочей книги Excel для функции <code>excel_sheets()</code> из пакета <strong>readxl</strong>, который извлекает имена листов. Мы их храним в текстовом векторе, называемом <code>sheet_names</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>sheet_names <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">excel_sheets</span>(<span class="st">"hospital_linelists.xlsx"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Вот эти имена:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>sheet_names</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Central Hospital"              "Military Hospital"            
[3] "Missing"                       "Other"                        
[5] "Port Hospital"                 "St. Mark's Maternity Hospital"</code></pre>
</div>
</div>
<p>Теперь, когда у нас есть этот вектор имен, <code>map()</code> может задавать их по одному функции <code>import()</code>. В этом примере <code>sheet_names</code> - это <code>.x</code>, а <code>import()</code> - это функция <code>.f</code>.</p>
<p>Вспомните, на странице [Импорт и экспорт] мы говорили, что при использовании для рабочих книг Excel, <code>import()</code> может принять аргумент <code>which =</code>, указывающий, какой лист импортировать. Внутри функции <code>.f</code> <code>import()</code>, мы задаем <code>which = .x</code>, чье значение будет меняться при каждой итерации по вектору <code>sheet_names</code> - сначала “Central Hospital”, потом “Military Hospital” и т.п.</p>
<p>Следует отметить - поскольку мы использовали <code>map()</code>, данные из каждого листа Excel будут сохранены как отдельный датафрейм внутри списка. Мы хотим, чтобы у каждого из этих элементов списка (датафреймов) было <em>имя</em>, поэтому до того, как мы подставим <code>sheet_names</code> к <code>map()</code>, мы передаем его через <code>set_names()</code> из <strong>purrr</strong>, чтобы у каждого элемента списка было соответствующее имя.</p>
<p>Мы сохраняем полученный в результате список как <code>combined</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> sheet_names <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">set_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">import</span>(<span class="st">"hospital_linelists.xlsx"</span>, <span class="at">which =</span> .x))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>При рассмотрении выходного результата мы видим, что данные из каждого листа Excel сохранены в списке с определенным именем. Это хорошо, но мы еще не закончили.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/sheets_as_list.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="../images/sheets_as_list.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="544"></a></p>
</figure>
</div>
</div>
</div>
<p>Наконец, мы используем функцию <code>bind_rows()</code> (из <strong>dplyr</strong>), которая принимает список аналогичным образом структурированных датафреймов и комбинирует их в один датафрейм. Чтобы создать новый столбец из элемента списка <em>names</em> (имена), мы используем аргумент <code>.id =</code> и задаем ему желаемое имя для нового столбца.</p>
<p>Ниже представлена полная последовательность команд:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>sheet_names <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">excel_sheets</span>(<span class="st">"hospital_linelists.xlsx"</span>)  <span class="co"># извлекаем имена листов</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> sheet_names <span class="sc">%&gt;%</span>                                     <span class="co"># начинаем с имен листов</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">set_names</span>() <span class="sc">%&gt;%</span>                                        <span class="co"># задаем их имена</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">import</span>(<span class="st">"hospital_linelists.xlsx"</span>, <span class="at">which =</span> .x)) <span class="sc">%&gt;%</span>  <span class="co"># проводим итерации, импорт, сохраняем в списке</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"origin_sheet"</span>) <span class="co"># объединяем список датафреймов, сохраняем их источник в новом столбце  </span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Теперь у нас есть один датафрейм со столбцом, содержащим лист происхождения!</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/sheets_as_df.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="../images/sheets_as_df.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="543"></a></p>
</figure>
</div>
</div>
</div>
<p>Существуют вариации <code>map()</code>, о которых вам нужно знать. Например, <code>map_dfr()</code> выдает датафрейм, а не список. Таким образом, мы могли бы использоватьт ее для указанной выше задачи и нам не пришлось бы связывать строки. Но тогда мы бы не смогли зафиксировать, из какого листа (больницы) мы получили каждый случай.</p>
<p>Другие вариации включают <code>map_chr()</code>, <code>map_dbl()</code>. Эти функции очень полезны по двум причинам. Во-первых, они автоматически конвертируют выходные данные итеративной функции в вектор (не список). Во-вторых, они могут четко контролировать, в каком классе будут выданы данные, вы можете обеспечить текстовый вектор на выходе с помощью <code>map_chr()</code>, либо числовой вектор с помощью <code>map_dbl()</code>. Вернемся к ним позднее в этом разделе!</p>
<p>Функции <code>map_at()</code> и <code>map_if()</code> также очень полезны для итерации - они позволяют вам уточнить, по каким элементам списка вам нужна итерация! Они работают просто с помощью применения вектора индексов/имен (в случае <code>map_at()</code>) или логического теста (в случае <code>map_if()</code>).</p>
<p>Давайте используем пример, где мы не хотим прочитывать первый лист данных по больнице. Мы используем <code>map_at()</code> вместо <code>map()</code>, и уточняем аргумент <code>.at =</code> в <code>c(-1)</code>, что означает <em>не</em> использовать первый элемент <code>.x</code>. Альтернативно вы можете задать вектор положительных чисел или имен в <code>.at =</code>, чтобы уточнить, какие элементы использовать.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>sheet_names <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">excel_sheets</span>(<span class="st">"hospital_linelists.xlsx"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> sheet_names <span class="sc">%&gt;%</span> </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>     purrr<span class="sc">::</span><span class="fu">set_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>     <span class="co"># exclude the first sheet</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">map_at</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">import</span>( <span class="st">"hospital_linelists.xlsx"</span>, <span class="at">which =</span> .x),</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">.at =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Обратите внимание, что имя первого листа все еще будет появляться как элемент выходного списка - но это только текстовое имя (не датафрейм). Вам нужно удалить этот элемент до связывания строк. Мы рассмотрим, как удалять и модифицировать элементы списка в одном из разделов ниже.</p>
</section>
</section>
<section id="разделение-набора-данных-и-экспорт" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="разделение-набора-данных-и-экспорт">Разделение набора данных и экспорт</h3>
<p>Ниже мы приведем пример того, как разделять набор данных на части и затем использовать итерацию <code>map()</code> для экспорта каждой части как отдельного листа Excel, либо как отдельного файла CSV.</p>
<section id="разделение-набора-данных" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="разделение-набора-данных">Разделение набора данных</h4>
<p>Представим, что у нас есть полный построчный список случаев <code>linelist</code> в виде датафрейма, и теперь мы хотим создать отдельный построчный список для каждой больницы и экспортировать его как отдельный CSV файл. Ниже мы выполним следующие шаги:</p>
<p>Используем <code>group_split()</code> (из <strong>dplyr</strong>), чтобы разделить датафрейм <code>linelist</code> по уникальным значениям в столбце <code>hospital</code>. На выходе мы получим список, содержащий по одному датафрейму на подмножество больниц.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>linelist_split <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">group_split</span>(hospital)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Мы можем выполнить <code>View(linelist_split)</code> и увидеть, что в этом списке есть 6 датафреймов (таблицы”tibble”), каждая из которых представляет случаи из одной больницы.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/purrr_linelist_split.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="../images/purrr_linelist_split.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="574"></a></p>
</figure>
</div>
</div>
</div>
<p>Однако обратите внимание, что датафреймы в списке по умолчанию не имеют имен! Мы хотим, чтобы у каждого было имя, а затем использовать это имя при сохранении CSV файла.</p>
<p>Одним из подходов к извлечению имен будет использовать <code>pull()</code> (из <strong>dplyr</strong>), чтобы извлечь столбец <code>hospital</code> для каждого датафрейма в списке. Затем, чтобы перестраховаться, мы конвертируем значения в текстовые и затем используем <code>unique()</code>, чтобы получить имя для этого конкретного датафрейма. Все эти шаги применяются к каждому датафрейму с помощью <code>map()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist_split) <span class="ot">&lt;-</span> linelist_split <span class="sc">%&gt;%</span>   <span class="co"># присваиваем именам указанных датафреймов </span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>     <span class="co"># извлекаем имена, выполнив нижеследующее для каждого датафрейма: </span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">pull</span>(.x, hospital)) <span class="sc">%&gt;%</span>        <span class="co"># берем столбец hospital</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">as.character</span>(.x)) <span class="sc">%&gt;%</span>          <span class="co"># конвертируем на всякий случай в текстовый</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">unique</span>(.x))                    <span class="co"># берем уникальное имя больницы</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Теперь мы можем увидеть, что у каждого элемента списка есть имя. Эти имена мы можем увидеть с помощью <code>names(linelist_split)</code>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/purrr_linelist_split_named.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="../images/purrr_linelist_split_named.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="575"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist_split)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Central Hospital"                    
[2] "Military Hospital"                   
[3] "Missing"                             
[4] "Other"                               
[5] "Port Hospital"                       
[6] "St. Mark's Maternity Hospital (SMMH)"</code></pre>
</div>
</div>
<section id="более-одного-столбца-group_split" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="более-одного-столбца-group_split">Более одного столбца <code>group_split()</code></h5>
<p>Если вы хотите разделить построчный список <em>более чем по одному столбцу группировки</em>, например, создать подмножество из построчного списка на пересечении больницы И пола, вам нужен другой подход к именованию элементов списка. Это требует сбора уникальных “ключей групп”, используя <code>group_keys()</code> из <strong>dplyr</strong> - они выдаются как датафрейм. Затем вы можете комбинировать групповые ключи в значения с помощью <code>unite()</code>, как показано ниже, и присвоить эти составные имена к <code>linelist_split</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># разделяем построчный список по уникальным комбинациям больницы-пола</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>linelist_split <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">group_split</span>(hospital, gender)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># извлекаем group_keys() в виде датафрейма</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>groupings <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">group_by</span>(hospital, gender) <span class="sc">%&gt;%</span>       </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>     <span class="fu">group_keys</span>()</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>groupings      <span class="co"># показываем уникальные группы </span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 × 2
   hospital                             gender
   &lt;chr&gt;                                &lt;chr&gt; 
 1 Central Hospital                     f     
 2 Central Hospital                     m     
 3 Central Hospital                     &lt;NA&gt;  
 4 Military Hospital                    f     
 5 Military Hospital                    m     
 6 Military Hospital                    &lt;NA&gt;  
 7 Missing                              f     
 8 Missing                              m     
 9 Missing                              &lt;NA&gt;  
10 Other                                f     
11 Other                                m     
12 Other                                &lt;NA&gt;  
13 Port Hospital                        f     
14 Port Hospital                        m     
15 Port Hospital                        &lt;NA&gt;  
16 St. Mark's Maternity Hospital (SMMH) f     
17 St. Mark's Maternity Hospital (SMMH) m     
18 St. Mark's Maternity Hospital (SMMH) &lt;NA&gt;  </code></pre>
</div>
</div>
<p>Теперь мы объединяем эти группировки, разделенные дефисами, и присваиваем их как имена элементов списка в <code>linelist_split</code>. Здесь потребуются несколько дополнительных строк кода, так как мы меняем <code>NA</code> на “Missing”, используем <code>unite()</code> из <strong>dplyr</strong> для объединения значений столбца (разделенных дефисами), а затем конвертируем в неименованный вектор, чтобы он мог быть использован в качестве имен <code>linelist_split</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Комбинируем в одно значение имени </span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist_split) <span class="ot">&lt;-</span> groupings <span class="sc">%&gt;%</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), replace_na, <span class="st">"Missing"</span>)) <span class="sc">%&gt;%</span>  <span class="co"># меняем NA на "Missing" во всех столбцах</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">unite</span>(<span class="st">"combined"</span>, <span class="at">sep =</span> <span class="st">"-"</span>) <span class="sc">%&gt;%</span>                         <span class="co"># рбъединяем все значения столбца в одно</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">setNames</span>(<span class="cn">NULL</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">as_vector</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">as.list</span>()</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="экспорт-в-виде-листов-excel" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="экспорт-в-виде-листов-excel">Экспорт в виде листов Excel</h4>
<p>Чтобы экспортировать построчные списки больниц <em>в виде рабочей книги Excel с одним построчным списком на лист</em>, мы можем просто указать именованный список <code>linelist_split</code> в функции <code>write_xlsx()</code> из пакета <strong>writexl</strong>. Это позволит сохранить одну рабочую книгу Excel с несколькими листами. Имена элементов списка автоматически будут применены к именам листов.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>linelist_split <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>     writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(<span class="at">path =</span> <span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"hospital_linelists.xlsx"</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Теперь вы можете открыть Excel файл и увидеть, что у каждой больницы есть свой лист.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/purrr_export_sheets.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="../images/purrr_export_sheets.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="652"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="экспорт-в-виде-csv-файлов" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="экспорт-в-виде-csv-файлов">Экспорт в виде CSV файлов</h4>
<p>Это чуть более сложная команда, но вы можете также экспортировать каждый построчный список по конкретной больнице в виде отдельного CSV файла с названием файла, специфичным для этой больницы.</p>
<p>Опять же, мы используем <code>map()</code>: мы берем вектор имен элементов списка (показан выше) и применяем <code>map()</code>, чтобы провести по ним итерации, применяя <code>export()</code> (из пакета <strong>rio</strong>, см. страницу [Импорт и экспорт]) к датафрейму в списке <code>linelist_split</code>, у которого такое имя. Мы также используем имя для создания уникального имени файла. Вот как это работает:</p>
<ul>
<li>Мы начинаем с вектора текстовых имен, подставляем в <code>map()</code> как <code>.x</code><br>
</li>
<li>Функцией <code>.f</code> является <code>export()</code>, которая требует датафрейма и пути к файлу, куда его записать<br>
</li>
<li>Входные данные <code>.x</code> (имя больницы) используется <em>внутри</em> <code>.f</code> для извлечения/индекса этого конкретного элемента из списка <code>linelist_split</code>. Это приводит к тому, что только один датафрейм за раз указывается для <code>export()</code>.<br>
</li>
<li>Например, когда <code>map()</code> проводит итерацию для “Military Hospital”, тогда <code>linelist_split[[.x]]</code> на самом деле является <code>linelist_split[["Military Hospital"]]</code>, выдавая таким образом второй элемент <code>linelist_split</code> - а именно, все случаи из больницы Military Hospital.<br>
</li>
<li>Путь к файлу, указанный для <code>export()</code> является динамичным с помощью использования <code>str_glue()</code> (см. страницу [Текст и последовательности]):
<ul>
<li><code>here()</code> используется, чтобы получить базовый путь к файлу и указать папку “data” (обратите внимание на одинарные кавычки, чтобы не прерывать двойные кавычки <code>str_glue()</code>)<br>
</li>
</ul></li>
<li>Затем слэш <code>/</code>, а затем снова <code>.x</code>, что напечатает текущее имя больницы, чтобы сделать файл идентифицируемым<br>
</li>
<li>Наконец, расширение “.csv”, которое <code>export()</code> использует для создания CSV файла</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(linelist_split) <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">export</span>(linelist_split[[.x]], <span class="at">file =</span> <span class="fu">str_glue</span>(<span class="st">"{here('data')}/{.x}.csv"</span>)))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now you can see that each file is saved in the “data” folder of the R Project “Epi_R_handbook”!</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/purrr_export_csv.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="../images/purrr_export_csv.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="632"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="пользовательские-функции" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="пользовательские-функции">Пользовательские функции</h3>
<p>Вы можете захотеть создать собственную функцию, которую зададите в <code>map()</code>.</p>
<p>Представим, что вы хотите создать эпидемические кривые для случаев по каждой больнице. Чтобы это сделать, используя <strong>purrr</strong>, наша функция <code>.f</code> может быть <code>ggplot()</code> и расширения с помощью <code>+</code>, как обычно. В качестве выходных данных <code>map()</code> мы всегда получаем список, графики сохраняются в списке (list). Поскольку это графики, их можно извлечь и построить с помощью функции <code>ggarrange()</code> из пакета <strong>ggpubr</strong> (<a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html">документация</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># загрузите пакет для построения элементов из списка</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggpubr)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># постройте по вектору 6 имен больниц (созданных ранее)</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># используйте указанную функцию ggplot</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># выходным результатом будет список с 6 графиками ggplot</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>hospital_names <span class="ot">&lt;-</span> <span class="fu">unique</span>(linelist<span class="sc">$</span>hospital)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>my_plots <span class="ot">&lt;-</span> <span class="fu">map</span>(</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">.x =</span> hospital_names,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">.f =</span> <span class="sc">~</span><span class="fu">ggplot</span>(<span class="at">data =</span> linelist <span class="sc">%&gt;%</span> <span class="fu">filter</span>(hospital <span class="sc">==</span> .x)) <span class="sc">+</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>                <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_onset)) <span class="sc">+</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">labs</span>(<span class="at">title =</span> .x)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="co"># напечатайте графики ggplot (они хранятся в списке)</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> my_plots, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">3</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="iteration.ru_files/figure-html/unnamed-chunk-43-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="iteration.ru_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Если этот код <code>map()</code> выглядит слишком хаотично, вы можете получить тот же результат, сохранив вашу конкретную команду <code>ggplot()</code> как пользовательскую функцию, например, мы можем ее назвать <code>make_epicurve())</code>. Эта функция затем используется внутри <code>map()</code>. <code>.x</code> будет итеративно замещаться именем больницы и будет использован как <code>hosp_name</code> в функции <code>make_epicurve()</code>. См. страницу [Написание функций].</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Создаем функцию</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>make_epicurve <span class="ot">&lt;-</span> <span class="cf">function</span>(hosp_name){</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data =</span> linelist <span class="sc">%&gt;%</span> <span class="fu">filter</span>(hospital <span class="sc">==</span> hosp_name)) <span class="sc">+</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_onset)) <span class="sc">+</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> hosp_name)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># сопоставляем</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>my_plots <span class="ot">&lt;-</span> <span class="fu">map</span>(hospital_names, <span class="sc">~</span><span class="fu">make_epicurve</span>(<span class="at">hosp_name =</span> .x))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># печатаем графики ggplot (они хранятся в списке)</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> my_plots, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">3</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="применение-функций-к-нескольким-столбцам" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="применение-функций-к-нескольким-столбцам">Применение функций к нескольким столбцам</h3>
<p>Еще один частый пример - применить функцию к нескольким столбцам. Ниже мы применяем функцию <code>t.test()</code> с помощью <code>map()</code> к числовым столбцам в датафрейме <code>linelist</code>, сравнивая числовые значения по полу.</p>
<p>Вспмоните из страницы [Простые статистические тесты], что <code>t.test()</code> может принять входные данные в формате формулы, такие как <code>t.test(числовой столбец ~ двоичный столбец)</code>. В этом примере мы делаем нижеследующее:</p>
<ul>
<li>Интересующие числовые столбцы выбираются из <code>linelist</code> - они становятся входными данными <code>.x</code> для <code>map()</code><br>
</li>
<li>Функция <code>t.test()</code> указывается как функция <code>.f</code>, которая применяется к каждому числовому столбцу<br>
</li>
<li>Внутри скобок <code>t.test()</code>:
<ul>
<li>первая <code>~</code> стоит перед <code>.f</code>, по которой <code>map()</code> будет проводить итерацию <code>.x</code><br>
</li>
<li><code>.x</code> отражает текущий столбец, который подается в функцию <code>t.test()</code><br>
</li>
<li>вторая <code>~</code> является частью уравнения t-test, описанного выше<br>
</li>
<li>функция <code>t.test()</code> ожидает двоичный столбец с правой стороны уравнения. Мы задаем вектор <code>linelist$gender</code> независимо и статично (обратите внимание, что он не включен в <code>select()</code>).</li>
</ul></li>
</ul>
<p><code>map()</code> выдает список, поэтому выходными результатами является список результатов t-теста - по одному элементу списка для каждого проанализированного числового столбца.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Результаты сохраняются как список</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, wt_kg, ht_cm, ct_blood, temp) <span class="sc">%&gt;%</span>  <span class="co"># сохраняем только некоторые числовые столбцы для map across</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="at">.f =</span> <span class="sc">~</span><span class="fu">t.test</span>(.x <span class="sc">~</span> linelist<span class="sc">$</span>gender))        <span class="co"># функция t.test, с уравнением ЧИСЛОВОЕ ~ КАТЕГОРИАЛЬНОЕ</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Вот как выглядит список <code>t.test_results</code> при открытии (просмотре) в RStudio. Мы выделили те части, которые важны для примеров на этой странице.</p>
<ul>
<li>Вы можете увидеть сверху, что весь список называется <code>t.test_results</code> и содержит пять элементов. Эти пять элементов называются <code>age</code>, <code>wt_km</code>, <code>ht_cm</code>, <code>ct_blood</code>, <code>temp</code> по каждой переменной, которая использовалась в t-тесте с <code>gender</code> (пол) из построчного списка <code>linelist</code>.<br>
</li>
<li>Каждый из этих пяти элементов сам по себе является списком с такими элементами внутри, как <code>p.value</code> и <code>conf.int</code>. Некоторые из этих элементов, такие как <code>p.value</code> являются отдельными числами, а некоторы - например, <code>estimate</code>, состоят из двух или более элементов (<code>mean in group f</code>(среднее в группе f) и <code>mean in group m</code> (среднее в группе m)).</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="../images/purrr_ttest.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="../images/purrr_ttest.png" style="height:150.0%" width="286" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Примечание: Помните, что если вы хотите применить функцию только к определенным столбцам в датафрейме, вы можете просто использовать <code>mutate()</code> и <code>across()</code>, как объяснялось на странице [Вычистка данных и ключевые функции]. Ниже приведен пример применения <code>as.character()</code> только к столбцу “age” (возраст). Обратите внимание на размещение скобок и запятых.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># конвертируем столбцы с именем столбца, содержащим "age" в текстовый класс</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>linelist <span class="ot">&lt;-</span> linelist <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="at">.cols =</span> <span class="fu">contains</span>(<span class="st">"age"</span>), <span class="at">.fns =</span> as.character))  </span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="извлечение-из-списков" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="извлечение-из-списков">Извлечение из списков</h3>
<p>Так как <code>map()</code> выдает выходной результат в классе список, мы обсудим, как извлекать данные из списков, используя соответствующие функции <strong>purrr</strong>. Чтобы это продемонстрировать, мы будем использовать список <code>t.test_results</code> из предыдущего раздела. Это список из 5 списков - каждый из 5 списков содержит результаты t-теста между столбцом из датафрейма <code>linelist</code> и его двоичным столбцом <code>gender</code>. См. изображение в разделе выше, где показана структура списка визуально.</p>
<section id="имена-элементов" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="имена-элементов">Имена элементов</h4>
<p>Чтобы извлечь имена самих элементов, просто используйте <code>names()</code> из <strong>базового</strong> R. В таком случае мы используем <code>names()</code> для <code>t.test_results</code>, чтобы выдать имена каждого под-списка, которые являются именами 5 переменных, по которым проводились t-тесты.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(t.test_results)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "age"      "wt_kg"    "ht_cm"    "ct_blood" "temp"    </code></pre>
</div>
</div>
</section>
<section id="элементы-по-имени-или-позиции" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="элементы-по-имени-или-позиции">Элементы по имени или позиции</h4>
<p>Чтобы извлечь элементы списка по именам или по позиции, вы можете использовать квадратные скобки <code>[[ ]]</code>, как описано на странице [Основы R]. Ниже мы используем двойные квадратные скобки, чтобы индексировать список <code>t.tests_results</code> и отобразить первый элемент, который является результатом t-теста по <code>age</code> (возраст).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>t.test_results[[<span class="dv">1</span>]] <span class="co"># первый элемент по позиции</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  .x by linelist$gender
t = -21.3, df = 4902.9, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means between group f and group m is not equal to 0
95 percent confidence interval:
 -7.544409 -6.272675
sample estimates:
mean in group f mean in group m 
       12.66085        19.56939 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>t.test_results[[<span class="dv">1</span>]][<span class="st">"p.value"</span>] <span class="co"># выдает элемент с именем "p.value" из первого элемента  </span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$p.value
[1] 2.350374e-96</code></pre>
</div>
</div>
<p>Однако ниже мы продемонстрируем использование простых и гибких функций <strong>purrr</strong> <code>map()</code> и <code>pluck()</code> для достижения таких же результатов.</p>
</section>
<section id="pluck" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="pluck"><code>pluck()</code></h4>
<p><code>pluck()</code> извлекает элемент по имени или позиции. Например - чтобы извлечь результаты t-теста для возраста, вы можете использовать <code>pluck()</code> следующим образом:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">"age"</span>)        <span class="co"># альтернативно, используем pluck(1)</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Welch Two Sample t-test

data:  .x by linelist$gender
t = -21.3, df = 4902.9, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means between group f and group m is not equal to 0
95 percent confidence interval:
 -7.544409 -6.272675
sample estimates:
mean in group f mean in group m 
       12.66085        19.56939 </code></pre>
</div>
</div>
<p>Индексируйте более глубокие уровни, указывая последующие уровни запятыми. Приведенный ниже код извлекает элемент под названием “p.value” из списка <code>age</code> внутри списка <code>t.test_results</code>. Вы можете также использовать числа вместо текстовых имен.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">"age"</span>, <span class="st">"p.value"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.350374e-96</code></pre>
</div>
</div>
<p>Вы можете извлекать такие внутренние элементы из <em>всех</em> элементов первого уровня, используя <code>map()</code>, чтобы выполнить функцию <code>pluck()</code> по каждому элементу первого уровня. Например, код ниже извлекает элементы “p.value” из всех списков внутри <code>t.test_results</code>. Список результатов т-теста является <code>.x</code>, по которому проводится итерация, <code>pluck()</code> является функцией <code>.f</code>, которая подлежит итерации, а значение “p-value” задается в функцию.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(pluck, <span class="st">"p.value"</span>)   <span class="co"># выдать каждое p-значение</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$age
[1] 2.350374e-96

$wt_kg
[1] 2.664367e-182

$ht_cm
[1] 3.515713e-144

$ct_blood
[1] 0.4473498

$temp
[1] 0.5735923</code></pre>
</div>
</div>
<p>В качестве еще одной альтернативы <code>map()</code> предлагает сокращение, где вы можете записать имя элемента в кавычках, и она его извлечет. Если вы используете <code>map()</code>, выходным результатом будет список, а если вы используете <code>map_chr()</code> - это будет именованный текстовый вектор, а если вы используете <code>map_dbl()</code> - то именованный числовой вектор.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="st">"p.value"</span>)   <span class="co"># выдать p-значения как именованный числовой вектор</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          age         wt_kg         ht_cm      ct_blood          temp 
 2.350374e-96 2.664367e-182 3.515713e-144  4.473498e-01  5.735923e-01 </code></pre>
</div>
</div>
<p>Более детально о <code>pluck()</code> вы можете прочитать в <strong>purrr</strong> <a href="https://purrr.tidyverse.org/reference/pluck.html">документации</a>. У нее есть родственная функция <code>chuck()</code>, которая выдаст ошибку вместо NULL, если элемент не существует.</p>
</section>
</section>
<section id="конвертация-списка-в-датафрейм" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="конвертация-списка-в-датафрейм">Конвертация списка в датафрейм</h3>
<p>Это сложная тема - см. раздел Ресурсы с более полными самоучителями. Тем не менее, мы продемонстрируем конвертацию списка результатов t-теста в датафрейм. Мы создадим датафрейм со столбцами для переменной, ее p-значения и со средними значениями из двух групп (мужчины и женщины).</p>
<p>Вот некоторые из новых подходов и функций, которые будут использованы:</p>
<ul>
<li>Фнукция <code>tibble()</code> будет использована для создания таблицы tibble (как датафрейм)
<ul>
<li>Мы заключаем функцию <code>tibble()</code> в фигурные скобки <code>{ }</code>, чтобы предотвратить сохранение всех <code>t.test_results</code> в качестве первого столбца tibble<br>
</li>
</ul></li>
<li>Внутри <code>tibble()</code> создается каждый столбец, похожим образом как в синтаксисе <code>mutate()</code>:
<ul>
<li><code>.</code> представляет <code>t.test_results</code></li>
<li>Чтобы создать столбец с именами переменных t-теста (имена каждого элемента списка), мы используем <code>names()</code>, как описано выше<br>
</li>
<li>Чтобы создать столбец с p-значениями, мы используем <code>map_dbl()</code> как описано выше, чтобы извлечь элементы <code>p.value</code> и конвертировать их в числовой вектор</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> {</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">variables =</span> <span class="fu">names</span>(.),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">p         =</span> <span class="fu">map_dbl</span>(., <span class="st">"p.value"</span>))</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  variables         p
  &lt;chr&gt;         &lt;dbl&gt;
1 age       2.35e- 96
2 wt_kg     2.66e-182
3 ht_cm     3.52e-144
4 ct_blood  4.47e-  1
5 temp      5.74e-  1</code></pre>
</div>
</div>
<p>Но теперь давайте добавим столбцы, содержащие средние значения для каждой группы (мужчины и женщины).</p>
<p>Нам нужно извлечь элемент <code>estimate</code>, но он на самом деле содержит <em>два</em> элемента (<code>mean in group f</code> (среднее значение в группе f) и <code>mean in group m</code>(среднее значение в группе m)). Таким образом, его невозможно упростить в вектор с помощью <code>map_chr()</code> или <code>map_dbl()</code>. Вместо этого, мы используем <code>map()</code>, которая при использовании внутри <code>tibble()</code> создаст <em>столбец класса список (list) внутри tibble</em>! Да, это возможно!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">tibble</span>(</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">variables =</span> <span class="fu">names</span>(.),</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> <span class="fu">map_dbl</span>(., <span class="st">"p.value"</span>),</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">means =</span> <span class="fu">map</span>(., <span class="st">"estimate"</span>))}</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  variables         p means       
  &lt;chr&gt;         &lt;dbl&gt; &lt;named list&gt;
1 age       2.35e- 96 &lt;dbl [2]&gt;   
2 wt_kg     2.66e-182 &lt;dbl [2]&gt;   
3 ht_cm     3.52e-144 &lt;dbl [2]&gt;   
4 ct_blood  4.47e-  1 &lt;dbl [2]&gt;   
5 temp      5.74e-  1 &lt;dbl [2]&gt;   </code></pre>
</div>
</div>
<p>Как только у вас будет этот столбец в классеп список, есть несколько функций <strong>tidyr</strong> (часть <strong>tidyverse</strong>), которые помогут вам разложить эти столбцы “многоуровневого списка”. Более подробно прочитайте об этом <a href="">тут</a>, либо введя <code>vignette("rectangle")</code>. Вкратце:</p>
<ul>
<li><code>unnest_wider()</code> - дает каждому элементу столбца-списка свой собственный столбец<br>
</li>
<li><code>unnest_longer()</code> - дает каждому элементу столбца-списка свою собственную строку</li>
<li><code>hoist()</code> - действует как <code>unnest_wider()</code>, но вы уточняете, какие элементы разложить</li>
</ul>
<p>Ниже мы задаем tibble в <code>unnest_wider()</code>, уточняя столбец из tibble <code>means</code> (который является многоуровневым списком). Результатом будет то, что вместо <code>means</code> мы получаем два новых столбца, каждый из которых отображает два элемента, которые раньше находились в каждой ячейке <code>means</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>t.test_results <span class="sc">%&gt;%</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">tibble</span>(</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">variables =</span> <span class="fu">names</span>(.),</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> <span class="fu">map_dbl</span>(., <span class="st">"p.value"</span>),</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">means =</span> <span class="fu">map</span>(., <span class="st">"estimate"</span>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    )} <span class="sc">%&gt;%</span> </span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_wider</span>(means)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
  variables         p `mean in group f` `mean in group m`
  &lt;chr&gt;         &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;
1 age       2.35e- 96              12.7              19.6
2 wt_kg     2.66e-182              45.8              59.6
3 ht_cm     3.52e-144             109.              142. 
4 ct_blood  4.47e-  1              21.2              21.2
5 temp      5.74e-  1              38.6              38.6</code></pre>
</div>
</div>
</section>
<section id="удаление-сохранение-и-сжатие-списков" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="удаление-сохранение-и-сжатие-списков">Удаление, сохранение и сжатие списков</h3>
<p>Поскольку работа с <strong>purrr</strong> так часто предполагает списки, мы кратко рассмотрим некоторые функции <strong>purrr</strong> для модификации списков. См. раздел Ресурсы, где указаны более подробные самоучители по функциям <strong>purrr</strong>.</p>
<ul>
<li><code>list_modify()</code> имеет множество применений, в том числе для удаления элемента списка<br>
</li>
<li><code>keep()</code> сохраняет элементы, указанные в <code>.p =</code>, либо там, где функция, указанная в <code>.p =</code> оценена как TRUE (ИСТИНА)<br>
</li>
<li><code>discard()</code> удаляет элементы, указанные в <code>.p</code>, либо там, где функция, указанная в <code>.p =</code> оценена как TRUE (ИСТИНА)<br>
</li>
<li><code>compact()</code> удаляет все пустые элементы</li>
</ul>
<p>Вот некоторые примеры использования списка <code>combined</code>, созданного в разделе выше <a href="#iter_combined">использование map() для импорта и объединения нескольких файлов</a> (он содержит 6 датафреймов построчного списка случаев):</p>
<p>Элементы могут быть удалены по имени с помощью <code>list_modify()</code> и установки имени (name) равного <code>NULL</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>combined <span class="sc">%&gt;%</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_modify</span>(<span class="st">"Central Hospital"</span> <span class="ot">=</span> <span class="cn">NULL</span>)   <span class="co"># удаляем элемент списка по имени</span></span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Вы можете также удалить элементы по критериям, задасв “предикативное” уравнение в <code>.p =</code> (уравнение, которое оценивает как TRUE (ИСТИНА) или FALSE(ЛОЖЬ)). Разместите тильду <code>~</code> до функции и используйте <code>.x</code>, чтобы отобразить элемент списка. При использовании <code>keep()</code> элементы списка, оцененые как TRUE (ИСТИНА) будут сохранены. И наборот, при использовании <code>discard()</code> элементы списка, оцененные как TRUE (ИСТИНА) будут удалены.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># сохраняем только элементы списка, где более 500 строк</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>combined <span class="sc">%&gt;%</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">keep</span>(<span class="at">.p =</span> <span class="sc">~</span><span class="fu">nrow</span>(.x) <span class="sc">&gt;</span> <span class="dv">500</span>)  </span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>В примере ниже, элементы списка удаляются, если они не относятся к классу датафрейма.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># удаляем все элементы списка, которые не являются датафреймами</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>combined <span class="sc">%&gt;%</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">discard</span>(<span class="at">.p =</span> <span class="sc">~</span><span class="fu">class</span>(.x) <span class="sc">!=</span> <span class="st">"data.frame"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ваша предикативная функция также может ссылаться на элементы/столбцы внутри каждого элемента списка. Например, ниже удаляются элементы списка, где среднее значение столбца <code>ct_blood</code> составляет более 25.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># сохраняем только те элементы списка, где среднее значение столбца ct_blood выше 25</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>combined <span class="sc">%&gt;%</span> </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">discard</span>(<span class="at">.p =</span> <span class="sc">~</span><span class="fu">mean</span>(.x<span class="sc">$</span>ct_blood) <span class="sc">&gt;</span> <span class="dv">25</span>)  </span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Эта команда удалит все пустые элементы списка:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Удаляем все пустые элементы списка</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>combined <span class="sc">%&gt;%</span> </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compact</span>()</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pmap" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="pmap"><code>pmap()</code></h3>
<p>РАЗДЕЛ НАХОДИТСЯ В РАЗРАБОТКЕ</p>
</section>
</section>
<section id="функции-apply" class="level2" data-number="16.4">
<h2 data-number="16.4" class="anchored" data-anchor-id="функции-apply"><span class="header-section-number">16.4</span> Функции Apply</h2>
<p>Семейство фукнций “apply” является альтернативой <strong>purrr</strong> для итеративных операций из <strong>базового</strong> R. Более подробно можно об этом почитать <a href="https://www.datacamp.com/community/tutorials/r-tutorial-apply-family">тут</a>.</p>
<!-- ======================================================= -->
</section>
<section id="ресурсы" class="level2" data-number="16.5">
<h2 data-number="16.5" class="anchored" data-anchor-id="ресурсы"><span class="header-section-number">16.5</span> Ресурсы</h2>
<p><a href="https://datacarpentry.org/semester-biology/materials/for-loops-R/">циклы for с Data Carpentry</a></p>
<p><a href="https://r4ds.had.co.nz/iteration.html#iteration">R для науки о данных страница по итерациям</a></p>
<p><a href="https://martinctc.github.io/blog/vignette-write-and-read-multiple-excel-files-with-purrr/">Виньетка по написанию/прочтению Excel файлов</a></p>
<p>purrr <a href="https://jennybc.github.io/purrr-tutorial/index.html">самоучитель</a> от jennybc</p>
<p>Еще один purrr <a href="http://www.rebeccabarter.com/blog/2019-08-19_purrr/">самоучитель</a> от Rebecca Barter</p>
<p>purrr <a href="http://zevross.com/blog/2019/06/11/the-power-of-three-purrr-poseful-iteration-in-r-with-map-pmap-and-imap/">самоучитель</a> по map, pmap, и imap</p>
<p><a href="https://raw.githubusercontent.com/rstudio/cheatsheets/master/pngs/thumbnails/purrr-cheatsheet-thumbs.png">Шпаргалка по purrr</a></p>
<p><a href="https://www.emilhvitfeldt.com/post/2018-01-08-purrr-tips-and-tricks/">Советы и хитрости в purrr</a></p>
<p><a href="https://hookedondata.org/going-off-the-map/#keep-and-discard">сохранение и удаление</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Скопировано");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Скопировано");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../new_pages/deduplication.ru.html" class="pagination-link" aria-label="Дедупликация">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Дедупликация</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../new_pages/tables_descriptive.ru.html" class="pagination-link" aria-label="Описательные таблицы">
        <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Описательные таблицы</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"loop":false,"descPosition":"bottom","closeEffect":"zoom","selector":".lightbox","openEffect":"zoom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>