<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Справочник эпидемиолога R - 27&nbsp; Анализ выживаемости</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../new_pages/gis.ru.html" rel="next">
<link href="../new_pages/survey_analysis.ru.html" rel="prev">
<link href="../images/Applied_Epi_logo.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "Поиск не дал результатов",
    "search-matching-documents-text": "Результаты поиска",
    "search-copy-link-title": "Скопировать ссылку",
    "search-hide-matches-text": "Скрыть дополнительные результаты",
    "search-more-match-text": "дополнительный результат в этом документе",
    "search-more-matches-text": "дополнительных результата(-ов) в этом документе",
    "search-clear-button-title": "Очистить",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Отменить",
    "search-submit-button-title": "Найти",
    "search-label": "Поиск"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QXDW878QLX', { 'anonymize_ip': true});
</script>
<!-- Global site tag (gtag.js) - Google Analytics 
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QXDW878QLX');
</script> -->

</head><body class="nav-sidebar floating"><div class="alert alert-info alert-dismissible">
  <!-- <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
  <strong>Need help learning R?</strong> Enroll in Applied Epi's <a href="https://www.appliedepi.org/live/"
    class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/"
    class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/"
    class="alert-link">Community Q&A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org"
    class="alert-link">R Help Desk service</a>. -->
</div>

<script>

  // Function to extract the last two characters from the URL path to determine the language, adjusting for .html extension
  function getLanguageFromURL() {
    let path = window.location.pathname;
    
    // Check if the URL ends with .html and remove it
    if (path.endsWith('.html')) {
      path = path.substring(0, path.length - 5);
    }

    // Extract the last two characters for the language code
    const lang = path.substr(-2);
    return lang;
  }

  const language = getLanguageFromURL();
  const supportedLanguages = ['fr', 'es', 'vn', 'jp', 'pt', 'tr', 'ru'];
  const defaultLanguage = 'en';
  const isSupportedLanguage = supportedLanguages.includes(language);

  // Translations for the content
  const translations = {
    en: '<strong>Need help learning R?</strong> Enroll in Applied Epi\'s <a href="https://www.appliedepi.org/live/" class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/" class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/" class="alert-link">Community Q&A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org" class="alert-link">R Help Desk service</a>.',
    fr: '<strong>Besoin d\'aide pour apprendre R ?</strong> Inscrivez-vous au <a href="https://www.appliedepi.org/live/" class="alert-link">cours d\'introduction à R</a> d\'Applied Epi, essayez nos <a href="https://www.appliedepi.org/tutorial/" class="alert-link">tutoriels R gratuits</a>, postez dans notre forum de <a href="https://community.appliedepi.org/" class="alert-link">questions-réponses communautaires</a>, ou demandez-nous des informations sur <a href="mailto:contact@appliedepi.org" class="alert-link"> notre service d\'assistance R</a>.',
    es: '<strong>¿Necesitas ayuda para aprender R?</strong> Inscríbete en el <a href="https://www.appliedepi.org/live/" class="alert-link">Curso de introducción a R</a> de Applied Epi, prueba nuestros <a href="https://www.appliedepi.org/tutorial/" class="alert-link">Tutoriales gratuitos de R</a>, escribe en nuestro <a href="https://community.appliedepi.org/" class="alert-link">Foro de preguntas y respuestas,</a> o pregunta por nuestra <a href="mailto:contact@appliedepi.org" class="alert-link">Asistencia técnica para R</a>.',
    vn: '<strong>Bạn cần giúp đỡ trong việc học R?</strong> Hãy đăng ký khóa học R cơ bản của Applied Epi tại <a href="https://www.appliedepi.org/live/" class="alert-link">đây</a>, hoặc thử các <a href="https://www.appliedepi.org/tutorial/" class="alert-link">hướng dẫn R miễn phí</a>, đăng bài trong <a href="https://community.appliedepi.org/" class="alert-link">diễn đàn cộng đồng</a>, hoặc gửi câu hỏi tới <a href="mailto:contact@appliedepi.org" class="alert-link">dịch vụ Trợ giúp R</a> của chúng tôi.',
    jp: '<strong>Rの学習について助けが必要ですか？</strong>Applied Epiの<a href="https://www.appliedepi.org/live/" class="alert-link">R入門コース</a>に登録するか、<a href="https://www.appliedepi.org/tutorial/" class="alert-link">無料Rチュートリアル</a>を試すか、<a href="https://community.appliedepi.org/" class="alert-link">コミュニティQ＆Aフォーラム</a>に投稿するか、<a href="mailto:contact@appliedepi.org" class="alert-link">Rヘルプデスクサービス</a>についてお問い合わせください。',
    pt: '<strong>Você precisa de ajuda para aprender R??</strong> Inscreva-se no curso de <a href="https://www.appliedepi.org/live/" class="alert-link">introdução ao R da Applied Epi</a>, experimente nossos <a href="https://www.appliedepi.org/tutorial/" class="alert-link">tutoriais gratuitos sobre o R</a>, publique em nosso <a href="https://community.appliedepi.org/" class="alert-link">fórum de perguntas e respostas</a>, ou solicite nosso <a href="mailto:contact@appliedepi.org" class="alert-link">suporte ao R</a>.',
    tr: '<strong>R öğrenmekte yardıma mı ihtiyacınız var?</strong> Applied Epi\'\nin <a href="https://www.appliedepi.org/live/" class="alert-link">R\'ye giriş kursuna</a> kaydolun, <a href="https://www.appliedepi.org/tutorial/" class="alert-link">ücretsiz R derslerimizi</a> deneyin, <a href="https://community.appliedepi.org/" class="alert-link">Topluluk Q&A forumunda</a> soru paylaşın, ya da <a href="mailto:contact@appliedepi.org" class="alert-link">R Yardım Masası hizmetimiz</a> hakkında sorun.',
    ru: '<strong>Нужна помощь в изучении R?</strong> Запишитесь на <a href="https://www.appliedepi.org/live/" class="alert-link">вводный курс по R</a> от Applied Epi, попробуйте наши <a href="https://www.appliedepi.org/tutorial/" class="alert-link">бесплатные учебные материалы по R</a>, задайте вопрос в нашем <a href="https://community.appliedepi.org/" class="alert-link">форуме вопросов и ответов сообщества</a>, или спросите о нашей услуге <a href="mailto:contact@appliedepi.org" class="alert-link">Службы поддержки по R</a>.'
  };

  // Default to English if the detected language is not supported
  const contentToDisplay = translations[isSupportedLanguage ? language : defaultLanguage];


  // Select the element where the content should be displayed
  const alertElement = document.querySelector('.alert');
  if (alertElement) {
    alertElement.innerHTML = contentToDisplay;
    alertElement.style.display = 'block'; // Make sure to display the element
  }

</script>
<link href="../site_libs/htmltools-fill-0.5.8/fill.css" rel="stylesheet">
<script src="../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../site_libs/datatables-binding-0.31/datatables.js"></script>
<script src="../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="../site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>






<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Переключить боковую панель навигации" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../new_pages/tables_descriptive.ru.html">Анализ</a></li><li class="breadcrumb-item"><a href="../new_pages/survival_analysis.ru.html"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Анализ выживаемости</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Переключить боковую панель навигации" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/Applied_Epi_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Справочник эпидемиолога R</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://twitter.com/appliedepi" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter"></i></a>
    <a href="https://www.linkedin.com/company/appliedepi/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="https://github.com/appliedepi/epihandbook_quarto" title="Исходный код" class="quarto-navigation-tool px-1" aria-label="Исходный код"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Переключить темный режим"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Поиск"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Добро пожаловать</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Об этой книге</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/editorial_style.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Редакционные и технические замечания</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/data_used.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Скачивание руководства и данных</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Основы</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/basics.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Основы R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/transition_to_R.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Переход к R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/packages_suggested.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Рекомендованные пакеты</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/r_projects.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Проекты R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/importing.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Импорт и экспорт</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Управление данными</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/cleaning.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Вычистка данных и ключевые функции</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/dates.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Работа с датами</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/characters_strings.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Текст и последовательности</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/factors.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Факторы</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/pivoting.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Поворот данных</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/grouping.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Группирование данных</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/joining_matching.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Соединение данных</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/deduplication.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Дедупликация</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/iteration.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Итерации, циклы и списки</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Анализ</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/tables_descriptive.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Описательные таблицы</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/stat_tests.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Простые статистические тесты</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/regression.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Однофакторная и многофакторная регрессия</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/missing_data.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Отсутствующие данные</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/standardization.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Стандартизированные коэффициенты</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/moving_average.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Скользящие средние значения</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/time_series.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Временные ряды и обнаружение вспышек</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/epidemic_models.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Моделирование эпидемий</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/contact_tracing.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Отслеживание контактов</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/survey_analysis.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Анализ опросов</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/survival_analysis.ru.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Анализ выживаемости</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/gis.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Основы ГИС</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Визуализация данных</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/tables_presentation.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Таблицы для презентации</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/ggplot_basics.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Основы ggplot</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/ggplot_tips.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Советы по использованию ggplot</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/epicurves.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Эпидемические кривые</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/age_pyramid.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Демографические пирамиды и шкалы Лайкерта</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/heatmaps.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Тепловые диаграммы</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/diagrams.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Диаграммы и схемы</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/combination_analysis.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Анализ комбинаций</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/transmission_chains.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Цепочки передачи</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/phylogenetic_trees.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Филогенетические деревья</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/interactive_plots.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Интерактивные графики</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Отчеты и информационные панели</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/rmarkdown.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Отчеты с помощью R Markdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/reportfactory.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Структурирование рутинных отчетов</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/flexdashboard.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Информационные панели с R Markdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/shiny_basics.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Информационные панели с Shiny</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Разное</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Переключить раздел">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/writing_functions.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Написание функций</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/directories.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Взаимодействие директорий</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/collaboration.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Контроль версий и совместная работа с помощью Git и Github</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/errors.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Частые ошибки</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/help.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Получение помощи</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/network_drives.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">R на сетевых дисках</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../new_pages/data_table.ru.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">Таблица данных</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Содержание</h2>
   
  <ul>
  <li><a href="#обзор" id="toc-обзор" class="nav-link active" data-scroll-target="#обзор"><span class="header-section-number">27.1</span> Обзор</a></li>
  <li><a href="#подготока" id="toc-подготока" class="nav-link" data-scroll-target="#подготока"><span class="header-section-number">27.2</span> Подготока</a>
  <ul class="collapse">
  <li><a href="#загрузка-пакетов" id="toc-загрузка-пакетов" class="nav-link" data-scroll-target="#загрузка-пакетов">Загрузка пакетов</a></li>
  <li><a href="#импорт-набора-данных" id="toc-импорт-набора-данных" class="nav-link" data-scroll-target="#импорт-набора-данных">Импорт набора данных</a></li>
  <li><a href="#управление-данными-и-преобразования" id="toc-управление-данными-и-преобразования" class="nav-link" data-scroll-target="#управление-данными-и-преобразования">Управление данными и преобразования</a></li>
  </ul></li>
  <li><a href="#основы-анализа-выживаемости" id="toc-основы-анализа-выживаемости" class="nav-link" data-scroll-target="#основы-анализа-выживаемости"><span class="header-section-number">27.3</span> Основы анализа выживаемости</a>
  <ul class="collapse">
  <li><a href="#построение-объекта-типа-surv" id="toc-построение-объекта-типа-surv" class="nav-link" data-scroll-target="#построение-объекта-типа-surv">Построение объекта типа surv</a></li>
  <li><a href="#проведение-начального-анализа" id="toc-проведение-начального-анализа" class="nav-link" data-scroll-target="#проведение-начального-анализа">Проведение начального анализа</a></li>
  <li><a href="#совокупный-риск" id="toc-совокупный-риск" class="nav-link" data-scroll-target="#совокупный-риск">Совокупный риск</a></li>
  <li><a href="#построение-кривых-каплана-мейера" id="toc-построение-кривых-каплана-мейера" class="nav-link" data-scroll-target="#построение-кривых-каплана-мейера">Построение кривых Каплана-Мейера</a></li>
  </ul></li>
  <li><a href="#сравнение-кривых-выживаемости" id="toc-сравнение-кривых-выживаемости" class="nav-link" data-scroll-target="#сравнение-кривых-выживаемости"><span class="header-section-number">27.4</span> Сравнение кривых выживаемости</a>
  <ul class="collapse">
  <li><a href="#логарифмический-ранговый-критерий" id="toc-логарифмический-ранговый-критерий" class="nav-link" data-scroll-target="#логарифмический-ранговый-критерий">Логарифмический ранговый критерий</a></li>
  </ul></li>
  <li><a href="#регрессия-кокса" id="toc-регрессия-кокса" class="nav-link" data-scroll-target="#регрессия-кокса"><span class="header-section-number">27.5</span> Регрессия Кокса</a>
  <ul class="collapse">
  <li><a href="#построение-модели-кокса" id="toc-построение-модели-кокса" class="nav-link" data-scroll-target="#построение-модели-кокса">Построение модели Кокса</a></li>
  <li><a href="#форест-графики" id="toc-форест-графики" class="nav-link" data-scroll-target="#форест-графики">Форест-графики</a></li>
  </ul></li>
  <li><a href="#ковариаты-зависящие-от-времени-в-моделях-выживания" id="toc-ковариаты-зависящие-от-времени-в-моделях-выживания" class="nav-link" data-scroll-target="#ковариаты-зависящие-от-времени-в-моделях-выживания"><span class="header-section-number">27.6</span> Ковариаты, зависящие от времени, в моделях выживания</a>
  <ul class="collapse">
  <li><a href="#настройка-ковариаты-зависящей-от-времени" id="toc-настройка-ковариаты-зависящей-от-времени" class="nav-link" data-scroll-target="#настройка-ковариаты-зависящей-от-времени">Настройка ковариаты, зависящей от времени</a></li>
  <li><a href="#регрессия-кокса-с-ковариатами-зависящими-от-времени" id="toc-регрессия-кокса-с-ковариатами-зависящими-от-времени" class="nav-link" data-scroll-target="#регрессия-кокса-с-ковариатами-зависящими-от-времени">Регрессия Кокса с ковариатами, зависящими от времени</a></li>
  </ul></li>
  <li><a href="#ресурсы" id="toc-ресурсы" class="nav-link" data-scroll-target="#ресурсы"><span class="header-section-number">27.7</span> Ресурсы</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../new_pages/tables_descriptive.ru.html">Анализ</a></li><li class="breadcrumb-item"><a href="../new_pages/survival_analysis.ru.html"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Анализ выживаемости</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Анализ выживаемости</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="../images/survival_analysis.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="../images/survival_analysis.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
<!-- ======================================================= -->
<section id="обзор" class="level2" data-number="27.1">
<h2 data-number="27.1" class="anchored" data-anchor-id="обзор"><span class="header-section-number">27.1</span> Обзор</h2>
<p><em>Анализ выживаемости</em> фокусируется на описании для отдельного лица или группы лиц определенной точки событий, называемой <strong><em>происшествие</em></strong> (возникновение заболевания, излечение от заболевания, смерть, рецидив после ответа на лечение…), которая происходит в период времени, называемый <strong><em>время происшествия</em></strong> (или <strong><em>время отслеживания</em></strong> в когортных/популяционных исследованиях), во время которого ведется наблюдение за лицами. Чтобы определить время происшествия, необходимо определить отправную точку (это может быть дата включения, дата постановки диагноза…).</p>
<p>В этом случае объектом вывода при анализе выживаемости является время между отправной точкой и событием. В современных медицинских исследованиях оно широко используется, например, в клинических исследованиях для оценки эффекта лечения или в онкологической эпидемиологии для оценки большого числа показателей выживаемости при раке.</p>
<p>Как правило, выражается в <strong><em>вероятности выживания</em></strong>, которая является вероятностью того, что интересующее событие не возникло до длительности t.</p>
<p><strong><em>Цензурировуание</em></strong>: Цензурирование возникает в том случае, если в конце наблюдения у некоторых индивидуумов не произошло интересующее событие, и, таким образом, истинное время наступления события неизвестно. Здесь мы в основном рассматриваем правое цензурирование, но более подробную информацию о цензурировании и анализе выживаемости в целом можно найти в разделе Ресурсы.</p>
<!-- ======================================================= -->
</section>
<section id="подготока" class="level2" data-number="27.2">
<h2 data-number="27.2" class="anchored" data-anchor-id="подготока"><span class="header-section-number">27.2</span> Подготока</h2>
<section id="загрузка-пакетов" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="загрузка-пакетов">Загрузка пакетов</h3>
<p>Чтобы выполнить анализ выживаемости в R, одним из наиболее часто используемых пакетов является пакет <strong>survival</strong>. Сначала мы его установим, затем загрузим его и другие пакеты, которые используются в данном разделе:</p>
<p>В данном руководстве мы фокусируемся на использовании <code>p_load()</code> из пакета <strong>pacman</strong>, которая устанавливает пакет, если необходимо, <em>и</em> загружает его для использования. Вы можете также загрузить установленные пакеты с помощью <code>library()</code> из <strong>базового</strong> R. См. страницу <a href="../new_pages/basics.ru.html">Основы R</a> для получения дополнительной информации о пакетах R.</p>
<p>На этой странице мы рассмотрим анализ выживаемости на примере построчного списка, использованного на большинстве предыдущих страниц, который мы немного изменим, чтобы иметь надлежащие данные о выживаемости.</p>
</section>
<section id="импорт-набора-данных" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="импорт-набора-данных">Импорт набора данных</h3>
<p>Мы импортируем набор данных о случаях из имитированной эпидемии Эболы. Если вы хотите выполнять действия параллельно, <a href="https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/case_linelists/linelist_cleaned.rds" class="download-button">кликните, чтобы скачать “чистый” построчный список</a> (как файл .rds). Импортируйте данные с помощью функции <code>import()</code> из пакета <strong>rio</strong> (она работает с разными типами файлов, такиим как .xlsx, .csv, .rds - см. детальную информацию на странице <a href="../new_pages/importing.ru.html">Импорт и экспорт</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># импортируем построчный список</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>linelist_case_data <span class="ot">&lt;-</span> rio<span class="sc">::</span><span class="fu">import</span>(<span class="st">"linelist_cleaned.rds"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="управление-данными-и-преобразования" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="управление-данными-и-преобразования">Управление данными и преобразования</h3>
<p>Если говорить кратко, данные о выживаемости можно описать как имеющие следующие три характеристики:</p>
<ol type="1">
<li>зависимая переменная или отклик - время ожидания до возникновения хорошо определенного события,</li>
<li>наблюдения цензурированы в том смысле, что для некоторых единиц интересующее событие не возникло на момент анализа данных, и</li>
<li>существуют предикторы или независимые переменные, чей эффект на время ожидания мы хотим оценить или контролировать</li>
</ol>
<p>Следовательно, мы создаем разные переменные, необходимые для соблюдения этой структуры и выполнения анализа выживаемости.</p>
<p>Мы определяем:</p>
<ul>
<li>новый датафрейм <code>linelist_surv</code> для этого анализа<br>
</li>
<li>интересующее нас событие, как “смерть” (следовательно, вероятность выживания будет вероятностью того, что человек жив через определнный промежуток времени после отправной точки),</li>
<li>время отслеживания (<code>futime</code>) как время от возникновения до времени исхода <em>в днях</em>,</li>
<li>цензурированных пациентов, каак тех, кто выздоровел или по кому исход неизвестен, т.е. событие “смерть” не наблюдалось (<code>event=0</code>).</li>
</ul>
<p><span style="color: orange;"><strong><em>ВНИМАНИЕ:</em></strong> Поскольку в реальном когортном исследовании информация об отправной точке и окончании отслеживания известна, поскольку люди находятся под наблюдением, мы будем удалять наблюдения, в которых дата возникновения или дата исхода неизвестна. Также будут удалены случаи, когда дата возникновения заболевания позже даты исхода, так как они считаются ошибочными.</span></p>
<p><span style="color: darkgreen;"><strong><em>СОВЕТ:</em></strong> Учитывая, что фильтрация по дате больше чем (&gt;) или меньше чем (&lt;) позволяет удалить строки с пропущенными значениями, применение фильтра к неправильным датам также приведет к удалению строк с пропущенными датами.</span></p>
<p>Затем используем <code>case_when()</code>, чтобы создать столбец <code>age_cat_small</code>, в котором будет только 3 возрастных категории.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#создаем новые данные под названием linelist_surv из linelist_case_data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="ot">&lt;-</span>  linelist_case_data <span class="sc">%&gt;%</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>       <span class="co"># удаляем наблюдения с неправильными или отсутствующими датами возникновения или датой исхода</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>       date_outcome <span class="sc">&gt;</span> date_onset) <span class="sc">%&gt;%</span> </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>       <span class="co"># создаем переменную event (событие), которая будет равна 1, если пациент умер и 0, если было применено правое цензурирование</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">event =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(outcome) <span class="sc">|</span> outcome <span class="sc">==</span> <span class="st">"Recover"</span>, <span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>       <span class="co"># создаем переменную по времени отслеживания в днях</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">futime =</span> <span class="fu">as.double</span>(date_outcome <span class="sc">-</span> date_onset), </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>       <span class="co"># создаем новую переменную возрастной категории только с 3 уровнями страт</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">age_cat_small =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>( </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>            age_years <span class="sc">&lt;</span> <span class="dv">5</span>  <span class="sc">~</span> <span class="st">"0-4"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>            age_years <span class="sc">&gt;=</span> <span class="dv">5</span> <span class="sc">&amp;</span> age_years <span class="sc">&lt;</span> <span class="dv">20</span> <span class="sc">~</span> <span class="st">"5-19"</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>            age_years <span class="sc">&gt;=</span> <span class="dv">20</span>   <span class="sc">~</span> <span class="st">"20+"</span>),</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>       <span class="co"># на предыдущем шаге переменная age_cat_small была создана как текстовая.</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>       <span class="co"># теперь конвертируем в фактор и задаем уровни</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>       <span class="co"># Обратите внимание, что значения NA остаются NA, а не размещаются, например, в уровень "unknown" (неизвестно),</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>       <span class="co"># поскольку при следующем анализе их нужно будет убрать</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">age_cat_small =</span> <span class="fu">fct_relevel</span>(age_cat_small, <span class="st">"0-4"</span>, <span class="st">"5-19"</span>, <span class="st">"20+"</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>       )</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span style="color: darkgreen;"><strong><em>СОВЕТ:</em></strong> Мы можем верифицировать новые столбцы, которые мы создали, посмотрев суммарную статистику по <code>futime</code> и кросс-табуляцию между <code>event</code> и <code>outcome</code>, из которых они были созданы. Кроме этой верификации полезной привычкой будет сообщение медианного времени отслеживания при интерпретации результатов анализа выживаемости.</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linelist_surv<span class="sc">$</span>futime)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   1.00    6.00   10.00   11.98   16.00   64.00 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># кросс-табуляция новой переменной event и переменной outcome, из которой она была создана</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># чтобы проверить, что код сделал то, что нужно</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(outcome, event)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> outcome    0    1
   Death    0 1952
 Recover 1547    0
    &lt;NA&gt; 1040    0</code></pre>
</div>
</div>
<p>Теперь проведем кросс-табуляцию новой переменной age_cat_small и старого столбца age_cat, чтобы убедиться в правильности присваивания</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(age_cat_small, age_cat)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> age_cat_small 0-4 5-9 10-14 15-19 20-29 30-49 50-69 70+ NA_
           0-4 834   0     0     0     0     0     0   0   0
          5-19   0 852   717   575     0     0     0   0   0
           20+   0   0     0     0   862   554    69   5   0
          &lt;NA&gt;   0   0     0     0     0     0     0   0  71</code></pre>
</div>
</div>
<p>Рассмотрим первые 10 наблюдений из данных <code>linelist_surv</code>, рассматривая конкретные переменные (включая те, которые только что созданы).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(case_id, age_cat_small, date_onset, date_outcome, outcome, event, futime) <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   case_id age_cat_small date_onset date_outcome outcome event futime
1   8689b7           0-4 2014-05-13   2014-05-18 Recover     0      5
2   11f8ea           20+ 2014-05-16   2014-05-30 Recover     0     14
3   893f25           0-4 2014-05-21   2014-05-29 Recover     0      8
4   be99c8          5-19 2014-05-22   2014-05-24 Recover     0      2
5   07e3e8          5-19 2014-05-27   2014-06-01 Recover     0      5
6   369449           0-4 2014-06-02   2014-06-07   Death     1      5
7   f393b4           20+ 2014-06-05   2014-06-18 Recover     0     13
8   1389ca           20+ 2014-06-05   2014-06-09   Death     1      4
9   2978ac          5-19 2014-06-06   2014-06-15   Death     1      9
10  fc15ef          5-19 2014-06-16   2014-07-09 Recover     0     23</code></pre>
</div>
</div>
<p>Мы также можем провести кросс-табуляцию столбцов <code>age_cat_small</code> и <code>gender</code>, чтобы получить дополнительную информацию о распределении этого нового столбца по полу. Мы используем <code>tabyl()</code> и функции <em>adorn</em> из <strong>janitor</strong>, как описано на странице [Описательные таблицы].</p>
<!-- Для этого мы используем функцию `stat.table()` из пакета **Epi**. -->
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(gender, age_cat_small, <span class="at">show_na =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_totals</span>(<span class="at">where =</span> <span class="st">"both"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_percentages</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_pct_formatting</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_ns</span>(<span class="at">position =</span> <span class="st">"front"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> gender         0-4          5-19           20+          Total
      f 482 (22.4%) 1,184 (54.9%)   490 (22.7%) 2,156 (100.0%)
      m 325 (15.0%)   880 (40.6%)   960 (44.3%) 2,165 (100.0%)
  Total 807 (18.7%) 2,064 (47.8%) 1,450 (33.6%) 4,321 (100.0%)</code></pre>
</div>
</div>
<!-- Epi::stat.table(  -->
<!--   #задаем переменные для кросс-табуляции -->
<!--   list( -->
<!--     gender,  -->
<!--     age_cat_small -->
<!--     ), -->
<!--   #уточняем функцию, которую мы хотим вызвать (mean,count..) -->
<!--   list(  -->
<!--     count(), -->
<!--     percent(age_cat_small) -->
<!--     ),  -->
<!--   #добавляем границы -->
<!--   margins=T,  -->
<!--   #использованные данные -->
<!--   data = linelist_surv  -->
<!--   ) -->
<!-- ``` -->
<!-- ======================================================= -->
</section>
</section>
<section id="основы-анализа-выживаемости" class="level2" data-number="27.3">
<h2 data-number="27.3" class="anchored" data-anchor-id="основы-анализа-выживаемости"><span class="header-section-number">27.3</span> Основы анализа выживаемости</h2>
<section id="построение-объекта-типа-surv" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="построение-объекта-типа-surv">Построение объекта типа surv</h3>
<p>Сначала мы используем <code>Surv()</code> из <strong>survival</strong>, чтобы построить объект выживаемости (survival) из столбцов времени отслеживания и события.</p>
<p>В результате такого шага создается объект типа <em>Surv</em>, объединяющий информацию о времени и о том, наблюдалось ли интересующее нас событие (смерть). Этот объект в конечном итоге будет использоваться в правой части последующих формул модели (см. <a href="https://cran.r-project.org/web/packages/survival/vignettes/survival.pdf">документацию</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># используем синтаксис Suv() для данных с правым цензурированием</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>survobj <span class="ot">&lt;-</span> <span class="fu">Surv</span>(<span class="at">time =</span> linelist_surv<span class="sc">$</span>futime,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">event =</span> linelist_surv<span class="sc">$</span>event)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- ```{r} -->
<!-- survobj <- with(linelist_surv, -->
<!--                 survival::Surv(futime, event) -->
<!--                 ) -->
<!-- ``` -->
<p>Для рассмотрения представим первые 10 строк данных <code>linelist_surv</code>, и рассмотрим только некоторые важные столбцы.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>linelist_surv <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(case_id, date_onset, date_outcome, futime, outcome, event) <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   case_id date_onset date_outcome futime outcome event
1   8689b7 2014-05-13   2014-05-18      5 Recover     0
2   11f8ea 2014-05-16   2014-05-30     14 Recover     0
3   893f25 2014-05-21   2014-05-29      8 Recover     0
4   be99c8 2014-05-22   2014-05-24      2 Recover     0
5   07e3e8 2014-05-27   2014-06-01      5 Recover     0
6   369449 2014-06-02   2014-06-07      5   Death     1
7   f393b4 2014-06-05   2014-06-18     13 Recover     0
8   1389ca 2014-06-05   2014-06-09      4   Death     1
9   2978ac 2014-06-06   2014-06-15      9   Death     1
10  fc15ef 2014-06-16   2014-07-09     23 Recover     0</code></pre>
</div>
</div>
<p>Вот первые 10 элементов <code>survobj</code>. Они печатаются по сути как вектор времени отслеживания с “+”, который отражает, было ли проведено правое цензурирование для наблюдения. Посмотрите, как соотносятся числа выше и ниже.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#печать первых 50 элементов вектора, чтобы посмотреть, как он выглядит</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(survobj, <span class="dv">10</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  5+ 14+  8+  2+  5+  5  13+  4   9  23+</code></pre>
</div>
</div>
</section>
<section id="проведение-начального-анализа" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="проведение-начального-анализа">Проведение начального анализа</h3>
<p>Затем мы начинаем наш анализ с использования функции <code>survfit()</code> для создания <em>объекта survfit</em>, который создает расчеты по умолчанию для оценок <strong><em>Каплана Мейера</em></strong> (КМ) для общей (предельной) кривой выживания, которые по факту являются ступенчатой функцией со скачками во время наблюдаемого события. Итоговый <em>объект survfit</em> содержит одну или более кривых выживания и создается, используя объект <em>Surv</em> как переменную отклика в формуле модели.</p>
<p><span style="color: black;"><strong><em>ПРИМЕЧАНИЕ:</em></strong> Оценка Каплана-Мейера представляет собой непараметрическую оценку максимального правдоподобия функции выживания. (см. дополнительную информацию в Ресурсах).</span></p>
<p>Сводная информауия по этому <em>объекту survfit</em> выдаст то, что называется <em>таблица вероятности дожития</em>. Для каждого временного шага отслеживания (<code>time</code>), когда произошло событие (в возрастающем порядке):</p>
<ul>
<li>количество людей, находящихся в группе риска по развитию события (люди, у которых событие еще не наступило и которые не подвергались цензурированию: <code>n.risk</code>)<br>
</li>
<li>те, у кого произошло событие (<code>n.event</code>)<br>
</li>
<li>и из указанных выше: вероятность <em>не</em> развить событие (вероятность не умереть или выжить дольше определенного времени)<br>
</li>
<li>наконец, рассчитывается и отображается стандартная ошибка и доверительный интервал для этой вероятности</li>
</ul>
<p>Мы строим оценки КМ по формуле, где объект, ранее являвшийся Surv, “survobj”, является переменной отклика. “~ 1” уточняет, что мы выполняем модель для общей выживаемости.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># строим оценки КМ, используя формулу, где объект Surv "survobj" является переменной отклика.</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># "~ 1" указывает, что мы выполняем модель для общей выживаемости  </span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>linelistsurv_fit <span class="ot">&lt;-</span>  survival<span class="sc">::</span><span class="fu">survfit</span>(survobj <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">#печать сводной информации для большей детальности</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linelistsurv_fit)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = survobj ~ 1)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    1   4539      30    0.993 0.00120        0.991        0.996
    2   4500      69    0.978 0.00217        0.974        0.982
    3   4394     149    0.945 0.00340        0.938        0.952
    4   4176     194    0.901 0.00447        0.892        0.910
    5   3899     214    0.852 0.00535        0.841        0.862
    6   3592     210    0.802 0.00604        0.790        0.814
    7   3223     179    0.757 0.00656        0.745        0.770
    8   2899     167    0.714 0.00700        0.700        0.728
    9   2593     145    0.674 0.00735        0.660        0.688
   10   2311     109    0.642 0.00761        0.627        0.657
   11   2081     119    0.605 0.00788        0.590        0.621
   12   1843      89    0.576 0.00809        0.560        0.592
   13   1608      55    0.556 0.00823        0.540        0.573
   14   1448      43    0.540 0.00837        0.524        0.556
   15   1296      31    0.527 0.00848        0.511        0.544
   16   1152      48    0.505 0.00870        0.488        0.522
   17   1002      29    0.490 0.00886        0.473        0.508
   18    898      21    0.479 0.00900        0.462        0.497
   19    798       7    0.475 0.00906        0.457        0.493
   20    705       4    0.472 0.00911        0.454        0.490
   21    626      13    0.462 0.00932        0.444        0.481
   22    546       8    0.455 0.00948        0.437        0.474
   23    481       5    0.451 0.00962        0.432        0.470
   24    436       4    0.447 0.00975        0.428        0.466
   25    378       4    0.442 0.00993        0.423        0.462
   26    336       3    0.438 0.01010        0.419        0.458
   27    297       1    0.436 0.01017        0.417        0.457
   29    235       1    0.435 0.01030        0.415        0.455
   38     73       1    0.429 0.01175        0.406        0.452</code></pre>
</div>
</div>
<p>При использовании <code>summary()</code> мы можем добавить опцию <code>times</code> и уточнить определенное время, для которого нам нужна информация о выживаемости</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#печатаем сводную информацию на конкретные моменты времени</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linelistsurv_fit, <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">60</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = survobj ~ 1)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    5   3899     656    0.852 0.00535        0.841        0.862
   10   2311     810    0.642 0.00761        0.627        0.657
   20    705     446    0.472 0.00911        0.454        0.490
   30    210      39    0.435 0.01030        0.415        0.455
   60      2       1    0.429 0.01175        0.406        0.452</code></pre>
</div>
</div>
<p>Мы можем также использовать функцию <code>print()</code>. Аргумент <code>print.rmean = TRUE</code> используется, чтобы получить среднее время выживания и его стандартную ошибку (se).</p>
<p><span style="color: black;"><strong><em>ПРИМЕЧАНИЕ:</em></strong> Ограниченное среднее время выживания (RMST) - это специфическая мера выживаемости, которая все чаще используется в анализе выживаемости при раке и часто определяется как площадь под кривой выживания, если мы наблюдаем пациентов до ограниченного времени T (подробнее в разделе “Ресурсы”)..</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># печать объекта linelistsurv_fit со средним временем выживания и его стандартной ошибкой </span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(linelistsurv_fit, <span class="at">print.rmean =</span> <span class="cn">TRUE</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = survobj ~ 1)

        n events rmean* se(rmean) median 0.95LCL 0.95UCL
[1,] 4539   1952   33.1     0.539     17      16      18
    * restricted mean with upper limit =  64 </code></pre>
</div>
</div>
<p><span style="color: darkgreen;"><strong><em>СОВЕТ:</em></strong> Мы можем создать <em>объект surv</em> напрямую в функции <code>survfit()</code> и сохранить строку кода. Это будет выглядеть следующим образом: <code>linelistsurv_quick &lt;-  survfit(Surv(futime, event) ~ 1, data=linelist_surv)</code>.</span></p>
</section>
<section id="совокупный-риск" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="совокупный-риск">Совокупный риск</h3>
<p>Кроме функции <code>summary()</code> мы также можем использовать функцию <code>str()</code>, которая дает больше деталей о структуре объекта <code>survfit()</code>. Это список из 16 элементов.</p>
<p>Среди этих элементов есть важный: <code>cumhaz</code>, который является числовым вектором. С ним можно построить график, чтобы показать <strong><em>совокупный моментный риск</em></strong>, где <strong><em>моментный риск</em></strong> - это <strong><em>моментнй коэффициент возникновения события</em></strong> (см. Ресурсы).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(linelistsurv_fit)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 16
 $ n        : int 4539
 $ time     : num [1:59] 1 2 3 4 5 6 7 8 9 10 ...
 $ n.risk   : num [1:59] 4539 4500 4394 4176 3899 ...
 $ n.event  : num [1:59] 30 69 149 194 214 210 179 167 145 109 ...
 $ n.censor : num [1:59] 9 37 69 83 93 159 145 139 137 121 ...
 $ surv     : num [1:59] 0.993 0.978 0.945 0.901 0.852 ...
 $ std.err  : num [1:59] 0.00121 0.00222 0.00359 0.00496 0.00628 ...
 $ cumhaz   : num [1:59] 0.00661 0.02194 0.05585 0.10231 0.15719 ...
 $ std.chaz : num [1:59] 0.00121 0.00221 0.00355 0.00487 0.00615 ...
 $ type     : chr "right"
 $ logse    : logi TRUE
 $ conf.int : num 0.95
 $ conf.type: chr "log"
 $ lower    : num [1:59] 0.991 0.974 0.938 0.892 0.841 ...
 $ upper    : num [1:59] 0.996 0.982 0.952 0.91 0.862 ...
 $ call     : language survfit(formula = survobj ~ 1)
 - attr(*, "class")= chr "survfit"</code></pre>
</div>
</div>
<!-- ======================================================= -->
</section>
<section id="построение-кривых-каплана-мейера" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="построение-кривых-каплана-мейера">Построение кривых Каплана-Мейера</h3>
<p>Как только построены оценки КМ, мы можем визуализировать вероятность быть живым через определенное время, используя базовую функцию <code>plot()</code>, которая рисует “Кривую Каплана-Мейера”. Иными словами, кривая ниже является традиционной иллюстрацией опыта выживания в двух полных группах пациентов.</p>
<p>Мы можем быстро верифицировать минимум и максимум времени отслеживания на кривой.</p>
<p>Простой способ интерпретации заключается в том, что в нулевой момент времени все участники еще живы, поэтому вероятность выживания равна 100%. С течением времени эта вероятность уменьшается, поскольку пациенты умирают. Доля участников, выживших после 60 дней отслеживания, составляет около 40%.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(linelistsurv_fit, </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Days of follow-up"</span>,    <span class="co"># подпись оси x</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Survival Probability"</span>,   <span class="co"># подпись оси y</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span> <span class="st">"Overall survival curve"</span> <span class="co"># заголовок рисунка</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>     )</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.ru_files/figure-html/unnamed-chunk-13-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="survival_analysis.ru_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Доверительный интервал оценок выживаемости КМ также строится по умолчанию и может быть отменен добавлением опции <code>conf.int = FALSE</code> в команду <code>plot()</code>.</p>
<p>Поскольку интересующее событие - это “смерть”, построение кривой, описывающей дополнения долей выживаемости, приведет к построению кумулятивных долей смертности. Это можно сделать с помощью <code>lines()</code>, которая добавит информацию на существующий график.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># оригинальный график</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  linelistsurv_fit,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Days of follow-up"</span>,       </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>,       </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">mark.time =</span> <span class="cn">TRUE</span>,              <span class="co"># отмечаем события на кривой: "+" печатается при каждом событии</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,              <span class="co"># не наносить на график доверительный интервал</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Overall survival curve and cumulative mortality"</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="co"># рисуем дополнительную кривую к предыдущему графику</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  linelistsurv_fit,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">3</span>,             <span class="co"># используем другой тип линии для ясности</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> <span class="st">"event"</span>,       <span class="co"># рисуем кумулятивные события вместо выживания </span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">mark.time =</span> <span class="cn">FALSE</span>,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="co"># добавляем легенду на график</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"topright"</span>,                               <span class="co"># положение легенды</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Survival"</span>, <span class="st">"Cum. Mortality"</span>), <span class="co"># текст легенды </span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>),                            <span class="co"># типы линий для использования в легенде</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> .<span class="dv">85</span>,                                <span class="co"># параметры, которые задают размер текст легенды</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">"n"</span>                                 <span class="co"># тип без рамки для легенды</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.ru_files/figure-html/unnamed-chunk-14-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="survival_analysis.ru_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<!-- ======================================================= -->
</section>
</section>
<section id="сравнение-кривых-выживаемости" class="level2" data-number="27.4">
<h2 data-number="27.4" class="anchored" data-anchor-id="сравнение-кривых-выживаемости"><span class="header-section-number">27.4</span> Сравнение кривых выживаемости</h2>
<p>Для сравнения выживаемости в различных группах наблюдаемых нами участников или пациентов может потребоваться сначала рассмотреть соответствующие кривые выживаемости, а затем провести тесты для оценки различий между независимыми группами. Это сравнение может касаться групп по полу, возрасту, лечению, сопутствующим заболеваниям…</p>
<section id="логарифмический-ранговый-критерий" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="логарифмический-ранговый-критерий">Логарифмический ранговый критерий</h3>
<p>Логарифмический ранговый критерий является популярным тестом, который сравнивает весь опыт выживания между двумя или более <em>независимыми</em> группами, его можно рассматривать как тест того, являются ли кривые выживаемости идентичными (накладывающимися) или нет (нулевая гипотеза - нет разницы в выживаемости между группами). Функция <code>survdiff()</code> из пакета <strong>survival</strong> позволяет применить логарифмический ранговый критерий, когда мы уточняем <code>rho = 0</code> (значение по умолчанию). Результаты теста дают статистику хи-квадрата и p-значение, поскольку статистика логарифмического ранга примерно распределена как статистика теста хи-квадрат.</p>
<p>Сначала мы попытаемся сравнить кривые выживаемости по гендерным группам. Для этого сначала попробуем визуализировать их (проверить, накладываются ли две кривые выживания друг на друга). Необходимо создать новый <em>объект survfit</em> с немного другой формулой. Затем будет создан <em>объект survdiff</em>.</p>
<p>Задав <code>~ gender</code> в качестве правой стороны формулы, мы строим уже не общую выживаемость, а выживаемость по полу.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># создаем новый объект survfit на основе пола</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>linelistsurv_fit_sex <span class="ot">&lt;-</span>  <span class="fu">survfit</span>(<span class="fu">Surv</span>(futime, event) <span class="sc">~</span> gender, <span class="at">data =</span> linelist_surv)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Теперь мы можем построить график кривых выживания по полу. Посмотрите на <em>порядок</em> уровней страты в столбце пол до определения цветов и легенды.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># задаем цвета</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>col_sex <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"lightgreen"</span>, <span class="st">"darkgreen"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># создаем график</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  linelistsurv_fit_sex,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> col_sex,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Days of follow-up"</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co"># добавляем легенду</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"topright"</span>,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Female"</span>,<span class="st">"Male"</span>),</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> col_sex,</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">1</span>,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> .<span class="dv">9</span>,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">"n"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.ru_files/figure-html/unnamed-chunk-15-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="survival_analysis.ru_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Теперь мы можем рассчитать тест разницы между кривыми выживаемости, используя <code>survdiff()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#рассчитываем тест разницы между кривыми выживаемости</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>survival<span class="sc">::</span><span class="fu">survdiff</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(futime, event) <span class="sc">~</span> gender, </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> linelist_surv</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survival::survdiff(formula = Surv(futime, event) ~ gender, data = linelist_surv)

n=4321, 218 observations deleted due to missingness.

            N Observed Expected (O-E)^2/E (O-E)^2/V
gender=f 2156      924      909     0.255     0.524
gender=m 2165      929      944     0.245     0.524

 Chisq= 0.5  on 1 degrees of freedom, p= 0.5 </code></pre>
</div>
</div>
<p>Мы видим, что кривая выживаемости для женщин и кривая для мужчин накладываются друг на друга, а логарифмический ранговый критерий не дает доказательств различий в выживаемости между женщинами и мужчинами.</p>
<p>Некоторые другие пакеты R позволяют иллюстрировать кривые выживаемости для разных групп и тестировать разницу одновременно. Используя функцию <code>ggsurvplot()</code> из пакета <strong>survminer</strong>, мы также можем включить на нашу кривую напечатанные таблицы рисков для каждой группы, а также p-значение из логарифмического ранкового критерия.</p>
<p><span style="color: orange;"><strong><em>ВНИМАНИЕ:</em></strong> функции <strong>survminer</strong> требуют, чтобы вы задавали объект выживаемости <em>и</em> снова задавали данные, используемын для построения объекта выживаемости. Не забудьте это сделать, иначе получите неспецифическое сообщение об ошибке. </span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    linelistsurv_fit_sex, </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> linelist_surv,          <span class="co"># снова задаем данные, используемые для построения linelistsurv_fit_sex </span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">conf.int =</span> <span class="cn">FALSE</span>,              <span class="co"># не показывать доверительный интервал оценок КМ</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv.scale =</span> <span class="st">"percent"</span>,        <span class="co"># представляет вероятности на оси y в %</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">break.time.by =</span> <span class="dv">10</span>,            <span class="co"># представляет ось времени с шагом в 10 дней</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Follow-up days"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"Survival Probability"</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">pval =</span> T,                      <span class="co"># печать p-значения логарифмического рангового критерия </span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">pval.coord =</span> <span class="fu">c</span>(<span class="dv">40</span>,.<span class="dv">91</span>),        <span class="co"># печать p-значения на этих координатах графика</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">risk.table =</span> T,                <span class="co"># печать таблицы рисков внизу </span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="st">"Gender"</span>,       <span class="co"># характеристики легенды</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"Female"</span>,<span class="st">"Male"</span>),</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">font.legend =</span> <span class="dv">10</span>, </span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">palette =</span> <span class="st">"Dark2"</span>,             <span class="co"># уточняем цветовую палитру </span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">surv.median.line =</span> <span class="st">"hv"</span>,       <span class="co"># рисуем горизонтальные и вертикальные линии по медианному выживанию</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">ggtheme =</span> <span class="fu">theme_light</span>()        <span class="co"># упрощаем фон графика</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.ru_files/figure-html/unnamed-chunk-17-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="survival_analysis.ru_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Мы можем также протестировать различия в выживаемости по источнику инфекции (источнику загрязнения).</p>
<p>В данном случае логарифмический ранговый критерий дает достаточно доказательств различий вероятности выживания при <code>alpha= 0.005</code>. Вероятности выживания для пациентов, которые были заражены на похоронах, выше, чем вероятности выживания пациентов, которые заразились в других местах, что указывает на преимущество в выживаемости.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>linelistsurv_fit_source <span class="ot">&lt;-</span>  <span class="fu">survfit</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(futime, event) <span class="sc">~</span> source,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> linelist_surv</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>( </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  linelistsurv_fit_source,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> linelist_surv,</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"strata"</span>,   <span class="co"># line types</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> T,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv.scale =</span> <span class="st">"percent"</span>,  </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">break.time.by =</span> <span class="dv">10</span>, </span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Follow-up days"</span>,</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab=</span> <span class="st">"Survival Probability"</span>,</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">pval =</span> T,</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">pval.coord =</span> <span class="fu">c</span>(<span class="dv">40</span>,.<span class="dv">91</span>),</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> T,</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"Source of </span><span class="sc">\n</span><span class="st">infection"</span>,</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"Funeral"</span>, <span class="st">"Other"</span>),</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">font.legend =</span> <span class="dv">10</span>,</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#E7B800"</span>,<span class="st">"#3E606F"</span>),</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv.median.line =</span> <span class="st">"hv"</span>, </span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_light</span>()</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in geom_segment(aes(x = 0, y = max(y2), xend = max(x1), yend = max(y2)), : All aesthetics have length 1, but the data has 2 rows.
ℹ Did you mean to use `annotate()`?
All aesthetics have length 1, but the data has 2 rows.
ℹ Did you mean to use `annotate()`?
All aesthetics have length 1, but the data has 2 rows.
ℹ Did you mean to use `annotate()`?
All aesthetics have length 1, but the data has 2 rows.
ℹ Did you mean to use `annotate()`?</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.ru_files/figure-html/unnamed-chunk-18-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="survival_analysis.ru_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<!-- ======================================================= -->
</section>
</section>
<section id="регрессия-кокса" class="level2" data-number="27.5">
<h2 data-number="27.5" class="anchored" data-anchor-id="регрессия-кокса"><span class="header-section-number">27.5</span> Регрессия Кокса</h2>
<p>Регрессия пропорциональных рисков Кокса является одним из наиболее популярных методов регрессии для анализа выживаемости. Можно использовать и другие модели, поскольку модель Кокса требует <em>важных допущений</em>, которые необходимо верифицировать для правильного использования, например, допущение о пропорциональных моментных рисках: см. ссылки.</p>
<p>В регрессии пропорциональных рисков Кокса мерой эффекта является <strong><em>коэффициент моментных рисков</em></strong> (HR), который представляет собой риск происшествия (или риск смерти в нашем примере), учитывая, что участник дожил до определенного времени. Как правило, нас интересует сравнение <em>независимых</em> групп по отношению к их моментным рискам, и мы используем отношение моментных рисков, корторое похоже на отношение шансов в плане создания множественной логистической регрессии. Функция <code>cox.ph()</code> из пакета <strong>survival</strong> используется для построения этой модели. Для тестирования допущения о пропорциональных моментных рисках при построении регрессии Кокса можно использовать функцию <code>cox.zph()</code> из пакета <strong>survival</strong>.</p>
<p><span style="color: black;"><strong><em>ПРИМЕЧАНИЕ:</em></strong> Вероятность должна лежать в диапазоне от 0 до 1. Однако моментный риск представляет собой ожидаемое число событий за единицу времени.</span></p>
<ul>
<li>Если коэффициент моментного риска для предиктора близок к 1, то этот предиктор не влияет на выживаемость,</li>
<li>Если коэффициент моментного риска менее 1, тогда предиктор является защитным (т.е. связан с улучшением выживаемости),</li>
<li>А если коэффициент моментного риска больше 1, тогда предиктор связан с повышенным риском (или снижением выживаемости).</li>
</ul>
<section id="построение-модели-кокса" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="построение-модели-кокса">Построение модели Кокса</h3>
<p>Сначала мы можем построить модель для оценки влияния возраста и пола на выживаемость. Просто напечатав модель, мы получим информацию о:</p>
<ul>
<li>оценочных коэффициентах регрессии <code>coef</code>, которые количественно выражают связь между предикторами и исходом,</li>
<li>их экспоненциальной функции (для интерпретируемости, <code>exp(coef)</code>), которая создает <em>коэффициент моментного риска</em>,</li>
<li>их стандартной ошибке <code>se(coef)</code>,</li>
<li>z-балле: на сколько стандартных ошибок расчетный коэффициент удален от 0,</li>
<li>и p-значение: вероятность того, что расчетный коэффициент мог бы быть 0.</li>
</ul>
<p>Функция <code>summary()</code>, примененная к объекту модели Кокса даст вам больше информации, например, доверительный интервал оцененного коэффициента моментного риска и разные баллы тестов.</p>
<p>Эффект первой ковариаты <code>gender</code> (пол) представлен в первой строке. <code>genderm</code> (мужской) напечатан, что указывает на то, что первый уровень страты (“f”), т.е. группа женского пола, является референтной группой для пола. Таким образом, интерпретация тестового параметра относится к мужчинам по сравнению с женщинами. p-значение указывает на отсутствие достаточных доказательств влияния пола на ожидаемый моментный риск или связи между полом и смертностью от всех причин.</p>
<p>То же отсутствие доказательств отмечается в отношении возрастной группы.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#строим модель Кокса</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>linelistsurv_cox_sexage <span class="ot">&lt;-</span>  survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>              <span class="fu">Surv</span>(futime, event) <span class="sc">~</span> gender <span class="sc">+</span> age_cat_small, </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> linelist_surv</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">#печать построенной модели</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>linelistsurv_cox_sexage</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survival::coxph(formula = Surv(futime, event) ~ gender + age_cat_small, 
    data = linelist_surv)

                      coef exp(coef) se(coef)      z     p
genderm           -0.03149   0.96900  0.04767 -0.661 0.509
age_cat_small5-19  0.09400   1.09856  0.06454  1.456 0.145
age_cat_small20+   0.05032   1.05161  0.06953  0.724 0.469

Likelihood ratio test=2.8  on 3 df, p=0.4243
n= 4321, number of events= 1853 
   (218 observations deleted due to missingness)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#сводная информация по модели</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linelistsurv_cox_sexage)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survival::coxph(formula = Surv(futime, event) ~ gender + age_cat_small, 
    data = linelist_surv)

  n= 4321, number of events= 1853 
   (218 observations deleted due to missingness)

                      coef exp(coef) se(coef)      z Pr(&gt;|z|)
genderm           -0.03149   0.96900  0.04767 -0.661    0.509
age_cat_small5-19  0.09400   1.09856  0.06454  1.456    0.145
age_cat_small20+   0.05032   1.05161  0.06953  0.724    0.469

                  exp(coef) exp(-coef) lower .95 upper .95
genderm               0.969     1.0320    0.8826     1.064
age_cat_small5-19     1.099     0.9103    0.9680     1.247
age_cat_small20+      1.052     0.9509    0.9176     1.205

Concordance= 0.514  (se = 0.007 )
Likelihood ratio test= 2.8  on 3 df,   p=0.4
Wald test            = 2.78  on 3 df,   p=0.4
Score (logrank) test = 2.78  on 3 df,   p=0.4</code></pre>
</div>
</div>
<p>Было интересно выполнить модель и посмотреть на результаты, но первый взгляд на то, соблюдается ли предположение о пропорциональных моментных рисках, мог бы помочь сэкономить время.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>test_ph_sexage <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">cox.zph</span>(linelistsurv_cox_sexage)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>test_ph_sexage</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              chisq df    p
gender        0.454  1 0.50
age_cat_small 0.838  2 0.66
GLOBAL        1.399  3 0.71</code></pre>
</div>
</div>
<p><span style="color: black;"><strong><em>ПРИМЕЧАНИЕ:</em></strong> Второй аргумент под названием <em>method</em> (метод) может быть задан при расчете модели Кокса, которая определяет как работать с одинаковыми результатами. <em>По умолчанию</em> используется “efron”, а другие опции включают “breslow” и “exact”.</span></p>
<p>В другой модели мы добавляем дополнительные факторы риска, такие как источник инфекции и количество дней между датой возникновения заболевания и госпитализацией. На этот раз мы сначала проверяем предположение о пропорциональном моментном риске, прежде чем двигаться дальше.</p>
<p>В этой модели мы включили непрерывный предиктор (<code>days_onset_hosp</code>). В этом случае мы интерпретируем оценки параметров как увеличение ожидаемого логарифма относительного моментного риска на каждую единицу увеличения предиктора при постоянстве других предикторов. Сначала мы проверим предположение о пропорциональных моментных рисках.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">#строим модель</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>linelistsurv_cox <span class="ot">&lt;-</span>  <span class="fu">coxph</span>(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">Surv</span>(futime, event) <span class="sc">~</span> gender <span class="sc">+</span> age_years<span class="sc">+</span> source <span class="sc">+</span> days_onset_hosp,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> linelist_surv</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co">#тестируем модель пропорциональных рисков</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>linelistsurv_ph_test <span class="ot">&lt;-</span> <span class="fu">cox.zph</span>(linelistsurv_cox)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>linelistsurv_ph_test</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   chisq df       p
gender           0.45062  1    0.50
age_years        0.00199  1    0.96
source           1.79622  1    0.18
days_onset_hosp 31.66167  1 1.8e-08
GLOBAL          34.08502  4 7.2e-07</code></pre>
</div>
</div>
<p>Графическая верификация этого допущения может выполнена с помощью функции <code>ggcoxzph()</code> из пакета <strong>survminer</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>survminer<span class="sc">::</span><span class="fu">ggcoxzph</span>(linelistsurv_ph_test)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.ru_files/figure-html/unnamed-chunk-19-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="survival_analysis.ru_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Результаты моделирования свидетельствуют о наличии отрицательной связи между продолжительностью госпитализации и смертностью от всех причин. Ожидаемый риск в 0,9 раза ниже у человека, поступившего на один день позже, чем у другого, при постоянном учете пола. Или, в более простом варианте, увеличение продолжительности госпитализации на одну единицу связано с уменьшением риска смерти на 10,7% (<code>coef *100</code>).</p>
<p>Полученные результаты свидетельствуют также о положительной связи между источником инфекции и смертностью от всех причин. То есть риск смерти (в 1,21 раза) повышается у пациентов, у которых источником инфекции были не похороны.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#печатаем сводную информацию по модели</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linelistsurv_cox)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(futime, event) ~ gender + age_years + source + 
    days_onset_hosp, data = linelist_surv)

  n= 2772, number of events= 1180 
   (1767 observations deleted due to missingness)

                     coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
genderm          0.004710  1.004721  0.060827  0.077   0.9383    
age_years       -0.002249  0.997753  0.002421 -0.929   0.3528    
sourceother      0.178393  1.195295  0.084291  2.116   0.0343 *  
days_onset_hosp -0.104063  0.901169  0.014245 -7.305 2.77e-13 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                exp(coef) exp(-coef) lower .95 upper .95
genderm            1.0047     0.9953    0.8918    1.1319
age_years          0.9978     1.0023    0.9930    1.0025
sourceother        1.1953     0.8366    1.0133    1.4100
days_onset_hosp    0.9012     1.1097    0.8764    0.9267

Concordance= 0.566  (se = 0.009 )
Likelihood ratio test= 71.31  on 4 df,   p=1e-14
Wald test            = 59.22  on 4 df,   p=4e-12
Score (logrank) test = 59.54  on 4 df,   p=4e-12</code></pre>
</div>
</div>
<p>Мы можем верифицировать это отношение с помощью таблицы:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>linelist_case_data <span class="sc">%&gt;%</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabyl</span>(days_onset_hosp, outcome) <span class="sc">%&gt;%</span> </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_percentages</span>() <span class="sc">%&gt;%</span>  </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">adorn_pct_formatting</span>()</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> days_onset_hosp Death Recover   NA_
               0 44.3%   31.4% 24.3%
               1 46.6%   32.2% 21.2%
               2 43.0%   32.8% 24.2%
               3 45.0%   32.3% 22.7%
               4 41.5%   38.3% 20.2%
               5 40.0%   36.2% 23.8%
               6 32.2%   48.7% 19.1%
               7 31.8%   38.6% 29.5%
               8 29.8%   38.6% 31.6%
               9 30.3%   51.5% 18.2%
              10 16.7%   58.3% 25.0%
              11 36.4%   45.5% 18.2%
              12 18.8%   62.5% 18.8%
              13 10.0%   60.0% 30.0%
              14 10.0%   50.0% 40.0%
              15 28.6%   42.9% 28.6%
              16 20.0%   80.0%  0.0%
              17  0.0%  100.0%  0.0%
              18  0.0%  100.0%  0.0%
              22  0.0%  100.0%  0.0%
              NA 52.7%   31.2% 16.0%</code></pre>
</div>
</div>
<p>Необходимо рассмотреть и исследовать, почему такая связь существует в данных. Одно из возможных объяснений может заключаться в том, что пациенты, прожившие достаточно долго, чтобы быть госпитализированными позже, изначально имели менее тяжелое заболевание. Другое, возможно, более вероятное объяснение состоит в том, что, поскольку мы использовали смоделированный фальшивый набор данных, эта закономерность не отражает реальности!</p>
<!-- ======================================================= -->
</section>
<section id="форест-графики" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="форест-графики">Форест-графики</h3>
<p>Затем мы можем визуализировать результаты модели Кокса, используя практичные форест-графики с помощью функции <code>ggforest()</code> из <strong>пакета survminer</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggforest</span>(linelistsurv_cox, <span class="at">data =</span> linelist_surv)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.ru_files/figure-html/forestp-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="survival_analysis.ru_files/figure-html/forestp-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<!-- ======================================================= -->
</section>
</section>
<section id="ковариаты-зависящие-от-времени-в-моделях-выживания" class="level2" data-number="27.6">
<h2 data-number="27.6" class="anchored" data-anchor-id="ковариаты-зависящие-от-времени-в-моделях-выживания"><span class="header-section-number">27.6</span> Ковариаты, зависящие от времени, в моделях выживания</h2>
<p>Некоторые из нижеследующих разделов были адаптированы с разрешения автора из превосходной книги <a href="https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html">Введение в анализ выживаемости в R</a>, написанной <a href="https://www.emilyzabor.com/">Доктором Эмили Забор</a></p>
<p>В предыдущем разделе мы рассмотрели использование регрессии Кокса для изучения ассоциаций между интересующими нас ковариатами и результатами выживания. Однако эти анализы основаны на том, что ковариата измеряется на исходном уровне, то есть до начала периода отслеживания события.</p>
<p>Что произойдет, если вас интересует ковариата, которая измеряется <strong>после</strong> того, как началось время отслеживания? Или если у вас ковариата, которая может меняться со временем?</p>
<p>Например, вы работаете с клиническими данными, в которых повторяются измерения показателей больничных лабораторий, которые могут меняться с течением времени. Это является примером <strong>Ковариаты, зависящей от времени</strong>. Для решения этой задачи необходима специальная настройка, но, к счастью, модель Кокса очень гибкая, и этот тип данных также может быть смоделирован с помощью инструментов из пакета <strong>survival</strong>.</p>
<section id="настройка-ковариаты-зависящей-от-времени" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="настройка-ковариаты-зависящей-от-времени">Настройка ковариаты, зависящей от времени</h3>
<p>Анализ ковариат, зависящих от времени, в R требует создания специального набора данных. Если интересно, см. более подробную статью об этом от автора пакета <strong>survival</strong> <a href="https://cran.r-project.org/web/packages/survival/vignettes/timedep.pdf">Использование зависящих от времени ковариат и зависящих от времени коэффициентов в модели Кокса</a>.</p>
<p>Для этого используем новый набор данных из пакета <code>SemiCompRisks</code> под названием <code>BMT</code>, который включает данные о 137 пациентах после пересадки костного мозга. Переменные, на которых мы сфокусируемся:</p>
<ul>
<li><code>T1</code> - время (в днях) до смерти или последнего отслеживания<br>
</li>
<li><code>delta1</code> - индикатор смерти; 1-умер, 0-жив<br>
</li>
<li><code>TA</code> - время (в днях) до острой реакции трансплантат против хозяина<br>
</li>
<li><code>deltaA</code> - индикатор острой реакции трансплантат против хозяина;
<ul>
<li>1 - развилась острая реакция трансплантат против хозяина<br>
</li>
<li>0 - никогда не было острой реакции трансплантат против хозяина</li>
</ul></li>
</ul>
<p>Мы загрузим этот набор данных из пакета <strong>survival</strong>, используя команду из <strong>базового</strong> R <code>data()</code>, которую можно использовать для загрузки данных, которые уже включены в пакет R, который загружается. Датафрейм <code>BMT</code> появится в рабочей среде R (environment).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(BMT, <span class="at">package =</span> <span class="st">"SemiCompRisks"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="добавляем-уникальный-идентификатор-пациента" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="добавляем-уникальный-идентификатор-пациента">Добавляем уникальный идентификатор пациента</h4>
<p>В данных <code>BMT</code> нет столбца с уникальным ID, который необходим для создания такого типа набора данных, который нам нужен. Поэтому мы используем функцию <code>rowid_to_column()</code> из пакета <strong>tidyverse</strong> <strong>tibble</strong> для создания нового столбца с id под именем <code>my_id</code> (добавляет столбец в начале датафрейма с последовательными идентификаторами строк, начиная с 1). Назовем датафрейм <code>bmt</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>bmt <span class="ot">&lt;-</span> <span class="fu">rowid_to_column</span>(BMT, <span class="st">"my_id"</span>)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Набор данных теперь выглядит так:</p>
<div class="cell">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-6a28abf43c7a29619ee0" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-6a28abf43c7a29619ee0">{"x":{"filter":"none","vertical":false,"data":[[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[2081,1602,1496,1462,1433,1377,1330,996,226,1199,1111,530,1182,1167,418,417,276,156,781,172,487,716,194,371,526,122,1279,110,243,86,466,262,162,262,1,107,269,350,2569,2506,2409,2218,1857,1829,1562,1470,1363,1030,860,1258,2246,1870,1799,1709,1674,1568,1527,1324,957,932,847,848,1850,1843,1535,1447,1384,414,2204,1063,481,105,641,390,288,522,79,1156,583,48,431,1074,393,10,53,80,35,1499,704,653,222,1356,2640,2430,2252,2140,2133,1238,1631,2024,1345,1136,845,491,162,1298,121,2,62,265,547,341,318,195,469,93,515,183,105,128,164,129,122,80,677,73,168,74,16,248,732,105,392,63,97,153,363],[2081,1602,1496,1462,1433,1377,1330,996,226,1199,1111,530,1182,1167,418,383,276,104,609,172,487,662,194,230,526,122,129,74,122,86,466,192,109,55,1,107,110,332,2569,2506,2409,2218,1857,1829,1562,1470,1363,1030,860,1258,2246,1870,1799,1709,1674,1568,1527,1324,957,932,847,848,1850,1843,1535,1447,1384,414,2204,1063,481,105,641,390,288,421,79,748,486,48,272,1074,381,10,53,80,35,248,704,211,219,606,2640,2430,2252,2140,2133,1238,1631,2024,1345,1136,845,422,162,84,100,2,47,242,456,268,318,32,467,47,390,183,105,115,164,93,120,80,677,64,168,74,16,157,625,48,273,63,76,113,363],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,0,1,0,1,0,0,1,1,1,0,0,1,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,1,0,1,0,0,0,0,1,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,1,1,1,1,0,1,1,1,1,0,0,1,0,1,1,0,0,1,0,0,0,1,1,1,1,0,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[67,1602,1496,70,1433,1377,1330,72,226,1199,1111,38,1182,39,418,417,276,28,781,22,487,716,194,371,526,88,1279,110,243,86,466,10,162,262,1,107,269,350,2569,2506,2409,2218,1857,1829,1562,1470,1363,1030,860,1258,52,1870,1799,20,1674,1568,1527,25,957,29,847,848,1850,1843,1535,1447,1384,414,2204,1063,30,21,641,390,18,25,16,1156,583,48,431,1074,393,10,53,10,35,1499,36,653,222,1356,2640,2430,2252,2140,2133,1238,1631,2024,32,1136,845,491,162,1298,28,2,62,265,547,21,318,195,469,93,515,183,105,128,164,129,122,21,677,73,168,29,16,248,732,105,392,38,97,153,363],[1,0,0,1,0,0,0,1,0,0,0,1,0,1,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,1,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0],[121,139,307,95,236,123,96,121,226,91,1111,84,112,487,220,417,81,156,781,172,76,716,94,184,121,122,1279,110,243,86,119,84,162,262,1,107,120,350,2569,2506,2409,2218,260,1829,1562,180,200,210,860,120,380,230,140,348,1674,1568,1527,1324,957,932,847,155,1850,1843,1535,220,200,414,2204,240,120,105,641,390,100,140,79,180,583,48,431,120,100,10,53,80,35,1499,155,653,123,1356,2640,2430,150,220,250,250,150,180,360,140,845,180,162,1298,121,2,62,210,130,100,140,195,90,93,515,130,105,128,164,129,122,80,150,73,200,74,16,100,732,105,122,63,97,153,363],[1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,0,1,0,0,0,1,0,1,1,1,0,0,0,0,0,1,1,0,0,0,0,1,0,0,0,0,0,1,0,0,1,1,1,0,1,1,1,1,1,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0,1,1,0,0,0,1,1,0,1,0,0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,1,1,1,1,1,1,1,1,0,1,0,0,0,0,0,1,1,1,1,0,1,0,0,1,0,0,0,0,0,0,1,0,1,0,0,1,0,0,1,0,0,0,0],[13,18,12,13,12,12,17,12,10,29,22,34,22,1167,21,16,21,20,26,37,22,17,25,9,11,13,22,49,23,86,100,59,40,24,1,107,27,33,21,17,16,11,15,19,18,14,12,14,15,66,15,16,12,19,24,14,13,15,69,7,16,16,9,19,21,24,19,27,12,16,24,15,11,11,288,20,79,18,11,14,12,19,16,10,53,80,35,9,18,23,52,14,22,14,17,18,17,18,40,16,14,15,20,491,13,1298,65,2,11,14,24,17,12,16,20,28,31,21,105,12,164,51,12,0,8,38,48,24,16,52,18,30,24,16,97,59,19],[1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1,1],[26,21,26,17,32,22,20,22,18,24,19,17,24,27,18,15,18,20,27,40,22,28,26,39,15,20,17,28,37,17,15,29,36,23,42,30,29,22,19,31,35,16,29,19,26,27,13,25,25,30,45,33,32,23,37,15,22,46,18,27,28,23,37,34,35,33,21,21,25,50,35,37,26,50,45,28,43,14,17,32,30,30,33,34,33,30,23,35,29,23,28,33,18,29,35,27,36,24,27,35,50,47,40,22,22,8,39,20,27,32,31,20,35,36,35,7,23,11,14,37,19,37,25,35,15,45,32,41,27,33,39,17,43,44,48,31,52],[33,37,35,21,36,31,17,24,21,40,28,28,23,22,14,20,5,33,27,37,20,32,32,31,20,26,20,25,38,26,18,32,43,16,48,19,20,20,13,34,31,16,35,18,30,34,24,29,31,16,39,30,23,28,34,19,12,31,17,30,29,26,36,32,32,28,18,15,19,38,36,34,24,48,43,30,43,19,14,33,23,32,28,54,41,35,25,18,21,16,30,22,23,26,31,17,39,28,21,41,36,27,39,21,23,2,48,19,25,32,28,23,40,39,33,2,25,7,18,35,32,34,29,28,14,42,43,29,36,39,43,14,50,37,56,25,48],[1,1,1,0,1,1,1,1,0,1,1,1,0,0,1,1,0,1,1,0,1,1,0,0,1,1,0,1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,0,0,0,0,1,0,1,1,0,1,1,0,1,1,0,0,0,0,0,1,0,1,1,1,1,1,1,1,0,1,0,0,0,1,0,1,0,0,0,1,0,1,1,1,1,1,1,1,0,1,1,0,1,1,0,0,1,0,1,1,1,1,1,0,0,1,0,1,1,0,1,0,0,0,0,1,1,0,0,0,0,0,0,0,1,1,1,0,1],[0,1,1,1,1,1,0,0,1,1,1,1,0,1,1,1,0,1,0,0,1,1,1,1,1,0,0,0,1,0,1,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,0,1,1,0,0,0,1,1,0,1,1,1,0,1,1,0,0,1,1,0,1,0,0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,1,0,1,1,1,0,1,1,1,1,0,1,1,0,0,1,1,0,0,0,0,0,1,1,1,0,0,1,1,1,0,1,1,1,0,0,0,1,1,0,1,1,1,1,0,0,1,1,1,1,1,1,1],[1,0,1,0,1,1,1,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,1,1,1,0,1,1,1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,0,1,0,1,0,1,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,1,1,1,0,0,1,0,0,0,0,1,1,1,0,1,1,0,1,0,1,0,1,1,0,0,0,1,0,1,1,0,1,1,1,0,0,1,1,0,0,0,1,1,1,0,1,0,1,0,0,1,0,1,1,0,1,1,1,1,1,1,1,0,1,0,1,1,1],[1,0,0,0,1,1,1,0,0,1,1,0,1,1,0,0,0,1,1,1,0,0,0,1,0,1,0,0,1,0,0,0,0,1,0,1,1,0,0,0,1,0,0,0,1,1,0,0,1,0,0,1,0,0,0,0,1,1,0,0,0,0,1,1,0,1,0,1,1,0,1,1,0,0,1,1,0,0,0,0,0,0,0,1,1,1,1,1,0,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,1,0,0,0,1,1,1,0,0,0,0,0,0,1,1,0,1,0,0,0,1,1,0,1,1,0,0,0,1,1,0],[98,1720,127,168,93,2187,1006,1319,208,174,236,151,203,191,110,824,146,85,187,129,128,84,329,147,943,2616,937,303,170,239,508,74,393,331,196,178,361,834,270,60,120,60,90,210,90,240,90,210,180,180,105,225,120,90,60,90,450,75,90,60,75,180,180,270,180,150,120,120,60,270,90,120,90,120,90,90,90,60,120,150,120,150,120,240,180,150,150,30,105,90,120,210,750,24,120,210,240,240,690,105,120,900,210,210,300,105,210,75,90,180,630,180,300,90,120,135,210,120,150,270,285,240,510,780,150,180,150,750,180,180,150,210,240,360,330,240,180],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,0,0,1,0,0,0,0,1,0,0,1,0,1,1,0,0,0,0,1,0,0,0,1,1,1,1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,1,1,0,0,1,1,0,1,1,1,1,1,1,1,0,1,0,1,1,1,1,0,1,1,1,1,1,1,1,0,0,1,1,1,0,1,0,0,0],[1,1,1,1,1,1,1,1,1,3,3,3,2,2,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,3,3,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,2,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,4,4,4,3,3,1,1,1,1,1,1,2,4,4,3,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,4,4,4,4,3,3,3,3,3],[0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,1,1,0,0,0,0,0,0,1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,1,1,1,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>my_id<\/th>\n      <th>g<\/th>\n      <th>T1<\/th>\n      <th>T2<\/th>\n      <th>delta1<\/th>\n      <th>delta2<\/th>\n      <th>delta3<\/th>\n      <th>TA<\/th>\n      <th>deltaA<\/th>\n      <th>TC<\/th>\n      <th>deltaC<\/th>\n      <th>TP<\/th>\n      <th>deltaP<\/th>\n      <th>Z1<\/th>\n      <th>Z2<\/th>\n      <th>Z3<\/th>\n      <th>Z4<\/th>\n      <th>Z5<\/th>\n      <th>Z6<\/th>\n      <th>Z7<\/th>\n      <th>Z8<\/th>\n      <th>Z9<\/th>\n      <th>Z10<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22]},{"name":"my_id","targets":0},{"name":"g","targets":1},{"name":"T1","targets":2},{"name":"T2","targets":3},{"name":"delta1","targets":4},{"name":"delta2","targets":5},{"name":"delta3","targets":6},{"name":"TA","targets":7},{"name":"deltaA","targets":8},{"name":"TC","targets":9},{"name":"deltaC","targets":10},{"name":"TP","targets":11},{"name":"deltaP","targets":12},{"name":"Z1","targets":13},{"name":"Z2","targets":14},{"name":"Z3","targets":15},{"name":"Z4","targets":16},{"name":"Z5","targets":17},{"name":"Z6","targets":18},{"name":"Z7","targets":19},{"name":"Z8","targets":20},{"name":"Z9","targets":21},{"name":"Z10","targets":22}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="расширяем-строки-по-пациентам" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="расширяем-строки-по-пациентам">Расширяем строки по пациентам</h4>
<p>Далее используем функцию <code>tmerge()</code> с функциями-помощниками <code>event()</code> и <code>tdc()</code>, чтобы создать реструктурированный набор данных. Наша цель - реструктурировать набор данных, чтобы создать отдельную строку для каждого пациента в каждый временной интервал, когда у них отличаются значения <code>deltaA</code>. В этом случае у каждого пациента может быть не более двух строк в зависимости от того, развилась ли у него острая реакция “трансплантат против хозяина” за период сбора данных. Назовем наш новый показатель развития острой реакции трансплантат против хозяина <code>agvhd</code>.</p>
<ul>
<li><code>tmerge()</code> создает длинный набор данных с несколькими временными интервалами для разных значений ковариат для каждого пациента</li>
<li><code>event()</code> создает новый индикатор события для новых созданных временных интервалов</li>
<li><code>tdc()</code> создает столбец зависящей от времени ковариаты, <code>agvhd</code>, по новым созданным временным интервалам</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>td_dat <span class="ot">&lt;-</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tmerge</span>(</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data1 =</span> bmt <span class="sc">%&gt;%</span> <span class="fu">select</span>(my_id, T1, delta1), </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data2 =</span> bmt <span class="sc">%&gt;%</span> <span class="fu">select</span>(my_id, T1, delta1, TA, deltaA), </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> my_id, </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">death =</span> <span class="fu">event</span>(T1, delta1),</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">agvhd =</span> <span class="fu">tdc</span>(TA)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Чтобы увидеть, что это даст, давайте рассмотрим данные по первым 5 пациентам.</p>
<p>Интересующие переменные в оригинальном наборе данных выглядели так:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>bmt <span class="sc">%&gt;%</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(my_id, T1, delta1, TA, deltaA) <span class="sc">%&gt;%</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(my_id <span class="sc">%in%</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">5</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  my_id   T1 delta1   TA deltaA
1     1 2081      0   67      1
2     2 1602      0 1602      0
3     3 1496      0 1496      0
4     4 1462      0   70      1
5     5 1433      0 1433      0</code></pre>
</div>
</div>
<p>Новый набор данных для тех же пациентов выглядит так:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>td_dat <span class="sc">%&gt;%</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(my_id <span class="sc">%in%</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">5</span>))</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  my_id   T1 delta1 tstart tstop death agvhd
1     1 2081      0      0    67     0     0
2     1 2081      0     67  2081     0     1
3     2 1602      0      0  1602     0     0
4     3 1496      0      0  1496     0     0
5     4 1462      0      0    70     0     0
6     4 1462      0     70  1462     0     1
7     5 1433      0      0  1433     0     0</code></pre>
</div>
</div>
<p>Теперь у некоторых наших пациентов есть две строки в наборе данных, соответствующие интервалам, в которых они имеют разные значения нашей новой переменной, <code>agvhd</code>. Например, у Пациента 1 сейчас две строки со значением <code>agvhd</code> ноль с момента 0 до времени 67, и значение 1 с времени 67 до времени 2081.</p>
</section>
</section>
<section id="регрессия-кокса-с-ковариатами-зависящими-от-времени" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="регрессия-кокса-с-ковариатами-зависящими-от-времени">Регрессия Кокса с ковариатами, зависящими от времени</h3>
<p>Теперь, когда мы переформатировали наши данные и добавили новую зависящую от времени переменную <code>aghvd</code>, давайте построим простую регрессию Кокса с одной переменной. Мы можем использовать ту же функцию <code>coxph()</code> как ранее, нам только нужно изменить нашу функцию <code>Surv()</code>, чтобы уточнить время начала и окончания каждого интервала, используя аргументы <code>time1 =</code> и <code>time2 =</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>bmt_td_model <span class="ot">=</span> <span class="fu">coxph</span>(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(<span class="at">time =</span> tstart, <span class="at">time2 =</span> tstop, <span class="at">event =</span> death) <span class="sc">~</span> agvhd, </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> td_dat</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bmt_td_model)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time = tstart, time2 = tstop, event = death) ~ 
    agvhd, data = td_dat)

  n= 163, number of events= 80 

        coef exp(coef) se(coef)    z Pr(&gt;|z|)
agvhd 0.3351    1.3980   0.2815 1.19    0.234

      exp(coef) exp(-coef) lower .95 upper .95
agvhd     1.398     0.7153    0.8052     2.427

Concordance= 0.535  (se = 0.024 )
Likelihood ratio test= 1.33  on 1 df,   p=0.2
Wald test            = 1.42  on 1 df,   p=0.2
Score (logrank) test = 1.43  on 1 df,   p=0.2</code></pre>
</div>
</div>
<p>Опять же, мы визуализируем результаты нашей модели Кокса, используя функцию <code>ggforest()</code> из <strong>пакета survminer</strong>.:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggforest</span>(bmt_td_model, <span class="at">data =</span> td_dat)</span></code><button title="Скопировать текст" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="survival_analysis.ru_files/figure-html/unnamed-chunk-28-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="survival_analysis.ru_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Как видно из форест-графика, доверительного интервала и значения p, в контексте нашей простой модели не наблюдается сильной связи между смертью и острой реакцией трансплантат против хозяина.</p>
<!-- ======================================================= -->
</section>
</section>
<section id="ресурсы" class="level2" data-number="27.7">
<h2 data-number="27.7" class="anchored" data-anchor-id="ресурсы"><span class="header-section-number">27.7</span> Ресурсы</h2>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2394262/">Анализ выживаемости Часть I: Основные концепции и первый анализ</a></p>
<p><a href="https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html">Анализ выживаемости в R</a></p>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2954271/">Анализ выживаемости в исследованиях по инфекционным заболеваниям: Описание событий во времени</a></p>
<p><a href="https://data.princeton.edu/wws509/notes/c7.pdf">Глава по продвинутым моделям выживания от Принстона</a></p>
<p><a href="https://cran.r-project.org/web/packages/survival/vignettes/timedep.pdf">Использование ковариат, зависящих от времени, в модели Кокса</a></p>
<p><a href="https://publicifsv.sund.ku.dk/~ts/survival/survival-cheat.pdf">Шпаргалка по анализу выживаемости в R</a></p>
<p><a href="https://paulvanderlaken.files.wordpress.com/2017/08/survminer_cheatsheet.pdf">Шпаргалка по Survminer</a></p>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6322561/">Работа по разным мерам выживаемости для данных регистров рака с предоставлением Rcode в качестве дополнительных материалов</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Скопировано");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Скопировано");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../new_pages/survey_analysis.ru.html" class="pagination-link" aria-label="Анализ опросов">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Анализ опросов</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../new_pages/gis.ru.html" class="pagination-link" aria-label="Основы ГИС">
        <span class="nav-page-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Основы ГИС</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","openEffect":"zoom","descPosition":"bottom","selector":".lightbox","loop":false});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>