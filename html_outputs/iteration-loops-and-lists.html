<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>16 Iteration, loops, and lists | The Epidemiologist R Handbook</title>
<meta name="author" content="the handbook team">
<meta name="description" content="Epidemiologists often are faced with repeating analyses on subgroups such as countries, districts, or age groups. These are but a few of the many situations involving iteration. Coding your...">
<meta name="generator" content="bookdown 0.29 with bs4_book()">
<meta property="og:title" content="16 Iteration, loops, and lists | The Epidemiologist R Handbook">
<meta property="og:type" content="book">
<meta property="og:description" content="Epidemiologists often are faced with repeating analyses on subgroups such as countries, districts, or age groups. These are but a few of the many situations involving iteration. Coding your...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="16 Iteration, loops, and lists | The Epidemiologist R Handbook">
<meta name="twitter:description" content="Epidemiologists often are faced with repeating analyses on subgroups such as countries, districts, or age groups. These are but a few of the many situations involving iteration. Coding your...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.24/datatables.js"></script><link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/tabwid.css" rel="stylesheet">
<link href="libs/tabwid-1.1.0/scrool.css" rel="stylesheet">
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.9/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.10.0/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script><script src="libs/plotly-basic-2.5.1/plotly-basic-2.5.1.min.js"></script><script src="libs/plotly-cartesian-2.5.1/plotly-cartesian-2.5.1.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-9.3.1/highcharts.js"></script><script src="libs/highcharts-9.3.1/highcharts-3d.js"></script><script src="libs/highcharts-9.3.1/highcharts-more.js"></script><script src="libs/highcharts-9.3.1/modules/stock.js"></script><script src="libs/highcharts-9.3.1/modules/map.js"></script><script src="libs/highcharts-9.3.1/modules/data.js"></script><script src="libs/highcharts-9.3.1/modules/exporting.js"></script><script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script><script src="libs/highcharts-9.3.1/modules/drilldown.js"></script><script src="libs/highcharts-9.3.1/modules/item-series.js"></script><script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-9.3.1/modules/annotations.js"></script><script src="libs/highcharts-9.3.1/modules/export-data.js"></script><script src="libs/highcharts-9.3.1/modules/funnel.js"></script><script src="libs/highcharts-9.3.1/modules/heatmap.js"></script><script src="libs/highcharts-9.3.1/modules/treemap.js"></script><script src="libs/highcharts-9.3.1/modules/sankey.js"></script><script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script><script src="libs/highcharts-9.3.1/modules/organization.js"></script><script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script><script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script><script src="libs/highcharts-9.3.1/modules/sunburst.js"></script><script src="libs/highcharts-9.3.1/modules/vector.js"></script><script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script><script src="libs/highcharts-9.3.1/modules/xrange.js"></script><script src="libs/highcharts-9.3.1/modules/tilemap.js"></script><script src="libs/highcharts-9.3.1/modules/venn.js"></script><script src="libs/highcharts-9.3.1/modules/gantt.js"></script><script src="libs/highcharts-9.3.1/modules/timeline.js"></script><script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script><script src="libs/highcharts-9.3.1/modules/bullet.js"></script><script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script><script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script><script src="libs/highcharts-9.3.1/modules/lollipop.js"></script><script src="libs/highcharts-9.3.1/modules/series-label.js"></script><script src="libs/highcharts-9.3.1/plugins/motion.js"></script><script src="libs/highcharts-9.3.1/custom/reset.js"></script><script src="libs/highcharts-9.3.1/modules/boost.js"></script><script src="libs/highchart-binding-0.9.4/highchart.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-QXDW878QLX"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QXDW878QLX');
    </script>
</head>
<body>
<div class="alert alert-info alert-dismissible">
      <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
      <strong>Need help learning R?</strong> Enroll in Applied Epi's <a href="https://www.appliedepi.org/live/" class="alert-link">intro R course</a>, try our <a href="https://www.appliedepi.org/tutorial/" class="alert-link">free R tutorials</a>, post in our <a href="https://community.appliedepi.org/" class="alert-link">Community Q&amp;A forum</a>, or ask about our <a href="mailto:contact@appliedepi.org" class="alert-link">R Help Desk service</a>.
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">The Epidemiologist R Handbook</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">About this book</li>
<li><a class="" href="editorial-and-technical-notes.html"><span class="header-section-number">1</span> Editorial and technical notes</a></li>
<li><a class="" href="download-handbook-and-data.html"><span class="header-section-number">2</span> Download handbook and data</a></li>
<li class="book-part">Basics</li>
<li><a class="" href="r-basics.html"><span class="header-section-number">3</span> R Basics</a></li>
<li><a class="" href="transition-to-r.html"><span class="header-section-number">4</span> Transition to R</a></li>
<li><a class="" href="suggested-packages-1.html"><span class="header-section-number">5</span> Suggested packages</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> R projects</a></li>
<li><a class="" href="import-and-export.html"><span class="header-section-number">7</span> Import and export</a></li>
<li class="book-part">Data Management</li>
<li><a class="" href="cleaning-data-and-core-functions.html"><span class="header-section-number">8</span> Cleaning data and core functions</a></li>
<li><a class="" href="working-with-dates.html"><span class="header-section-number">9</span> Working with dates</a></li>
<li><a class="" href="characters-and-strings.html"><span class="header-section-number">10</span> Characters and strings</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> Factors</a></li>
<li><a class="" href="pivoting-data.html"><span class="header-section-number">12</span> Pivoting data</a></li>
<li><a class="" href="grouping-data.html"><span class="header-section-number">13</span> Grouping data</a></li>
<li><a class="" href="joining-data.html"><span class="header-section-number">14</span> Joining data</a></li>
<li><a class="" href="de-duplication.html"><span class="header-section-number">15</span> De-duplication</a></li>
<li><a class="active" href="iteration-loops-and-lists.html"><span class="header-section-number">16</span> Iteration, loops, and lists</a></li>
<li class="book-part">Analysis</li>
<li><a class="" href="descriptive-tables.html"><span class="header-section-number">17</span> Descriptive tables</a></li>
<li><a class="" href="simple-statistical-tests.html"><span class="header-section-number">18</span> Simple statistical tests</a></li>
<li><a class="" href="univariate-and-multivariable-regression.html"><span class="header-section-number">19</span> Univariate and multivariable regression</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">20</span> Missing data</a></li>
<li><a class="" href="standardised-rates.html"><span class="header-section-number">21</span> Standardised rates</a></li>
<li><a class="" href="moving-averages.html"><span class="header-section-number">22</span> Moving averages</a></li>
<li><a class="" href="time-series-and-outbreak-detection.html"><span class="header-section-number">23</span> Time series and outbreak detection</a></li>
<li><a class="" href="epidemic-modeling.html"><span class="header-section-number">24</span> Epidemic modeling</a></li>
<li><a class="" href="contact-tracing-1.html"><span class="header-section-number">25</span> Contact tracing</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">26</span> Survey analysis</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">27</span> Survival analysis</a></li>
<li><a class="" href="gis-basics.html"><span class="header-section-number">28</span> GIS basics</a></li>
<li class="book-part">Data Visualization</li>
<li><a class="" href="tables-for-presentation.html"><span class="header-section-number">29</span> Tables for presentation</a></li>
<li><a class="" href="ggplot-basics.html"><span class="header-section-number">30</span> ggplot basics</a></li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">31</span> ggplot tips</a></li>
<li><a class="" href="epidemic-curves.html"><span class="header-section-number">32</span> Epidemic curves</a></li>
<li><a class="" href="demographic-pyramids-and-likert-scales.html"><span class="header-section-number">33</span> Demographic pyramids and Likert-scales</a></li>
<li><a class="" href="heat-plots.html"><span class="header-section-number">34</span> Heat plots</a></li>
<li><a class="" href="diagrams-and-charts.html"><span class="header-section-number">35</span> Diagrams and charts</a></li>
<li><a class="" href="combinations-analysis.html"><span class="header-section-number">36</span> Combinations analysis</a></li>
<li><a class="" href="phylogenetic-trees-1.html"><span class="header-section-number">37</span> Phylogenetic trees</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">38</span> Interactive plots</a></li>
<li class="book-part">Reports and dashboards</li>
<li><a class="" href="reports-with-r-markdown.html"><span class="header-section-number">39</span> Reports with R Markdown</a></li>
<li><a class="" href="organizing-routine-reports.html"><span class="header-section-number">40</span> Organizing routine reports</a></li>
<li><a class="" href="dashboards-with-r-markdown.html"><span class="header-section-number">41</span> Dashboards with R Markdown</a></li>
<li><a class="" href="dashboards-with-shiny.html"><span class="header-section-number">42</span> Dashboards with Shiny</a></li>
<li class="book-part">Miscellaneous</li>
<li><a class="" href="writing-functions-1.html"><span class="header-section-number">43</span> Writing functions</a></li>
<li><a class="" href="directory-interactions.html"><span class="header-section-number">44</span> Directory interactions</a></li>
<li><a class="" href="version-control-and-collaboration-with-git-and-github.html"><span class="header-section-number">45</span> Version control and collaboration with Git and Github</a></li>
<li><a class="" href="common-errors.html"><span class="header-section-number">46</span> Common errors</a></li>
<li><a class="" href="getting-help.html"><span class="header-section-number">47</span> Getting help</a></li>
<li><a class="" href="r-on-network-drives.html"><span class="header-section-number">48</span> R on network drives</a></li>
<li><a class="" href="data-table.html"><span class="header-section-number">49</span> Data Table</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="iteration-loops-and-lists" class="section level1" number="16">
<h1>
<span class="header-section-number">16</span> Iteration, loops, and lists<a class="anchor" aria-label="anchor" href="#iteration-loops-and-lists"><i class="fas fa-link"></i></a>
</h1>
<p>Epidemiologists often are faced with repeating analyses on subgroups such as countries, districts, or age groups. These are but a few of the many situations involving <em>iteration</em>. Coding your iterative operations using the approaches below will help you perform such repetitive tasks faster, reduce the chance of error, and reduce code length.</p>
<p>This page will introduce two approaches to iterative operations - using <em>for loops</em> and using the package <strong>purrr</strong>.</p>
<ol style="list-style-type: decimal">
<li>
<em>for loops</em> iterate code across a series of inputs, but are less common in R than in other programming languages. Nevertheless, we introduce them here as a learning tool and reference<br>
</li>
<li>The <strong>purrr</strong> package is the <strong>tidyverse</strong> approach to iterative operations - it works by “mapping” a function across many inputs (values, columns, datasets, etc.)</li>
</ol>
<p>Along the way, we’ll show examples like:</p>
<ul>
<li>Importing and exporting multiple files<br>
</li>
<li>Creating epicurves for multiple jurisdictions<br>
</li>
<li>Running T-tests for several columns in a data frame</li>
</ul>
<p>In the <strong>purrr</strong> <a href="iteration-loops-and-lists.html#iter_purrr">section</a> we will also provide several examples of creating and handling <code>lists</code>.</p>
<div id="preparation-7" class="section level2" number="16.1">
<h2>
<span class="header-section-number">16.1</span> Preparation<a class="anchor" aria-label="anchor" href="#preparation-7"><i class="fas fa-link"></i></a>
</h2>
<div id="load-packages-8" class="section level3 unnumbered">
<h3>Load packages<a class="anchor" aria-label="anchor" href="#load-packages-8"><i class="fas fa-link"></i></a>
</h3>
<p>This code chunk shows the loading of packages required for the analyses. In this handbook we emphasize <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> from <strong>pacman</strong>, which installs the package if necessary <em>and</em> loads it for use. You can also load installed packages with <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> from <strong>base</strong> R. See the page on <a href="r-basics.html#r-basics">R basics</a> for more information on R packages.</p>
<div class="sourceCode" id="cb751"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>     <span class="va">rio</span>,         <span class="co"># import/export</span></span>
<span>     <span class="va">here</span>,        <span class="co"># file locator</span></span>
<span>     <span class="va">purrr</span>,       <span class="co"># iteration</span></span>
<span>     <span class="va">tidyverse</span>    <span class="co"># data management and visualization</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="import-data-9" class="section level3 unnumbered">
<h3>Import data<a class="anchor" aria-label="anchor" href="#import-data-9"><i class="fas fa-link"></i></a>
</h3>
<p>We import the dataset of cases from a simulated Ebola epidemic. If you want to follow along, <a href="https://github.com/appliedepi/epirhandbook_eng/raw/master/data/case_linelists/linelist_cleaned.rds" class="download-button">click to download the “clean” linelist</a> (as .rds file). Import data with the <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> function from the <strong>rio</strong> package (it handles many file types like .xlsx, .csv, .rds - see the <a href="import-and-export.html#import-and-export">Import and export</a> page for details).</p>
<div class="sourceCode" id="cb752"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># import the linelist</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"linelist_cleaned.rds"</span><span class="op">)</span></span></code></pre></div>
<p>The first 50 rows of the linelist are displayed below.</p>
<div id="htmlwidget-51b406f12270687a6bd1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-51b406f12270687a6bd1">{"x":{"filter":"none","vertical":false,"data":[["5fe599","8689b7","11f8ea","b8812a","893f25","be99c8","07e3e8","369449","f393b4","1389ca","2978ac","57a565","fc15ef","2eaa9a","bbfa93","c97dd9","f50e8a","3a7673","7f5a01","ddddee","99e8fa","567136","9371a9","bc2adf","403057","8bd1e8","f327be","42e1a9","90e5fe","959170","8ebf6e","e56412","6d788e","a47529","67be4e","da8ecb","148f18","2cb9a5","f5c142","70a9fe","3ad520","062638","c76676","baacc1","497372","23e499","38cc4a","3789ee","c71dcd","6b70f0"],[4,4,2,3,3,3,4,4,4,4,4,4,6,5,6,9,10,8,7,6,7,6,8,6,10,8,6,12,5,8,7,9,11,5,8,5,6,11,7,9,7,8,9,12,13,9,8,10,8,7],["2014-05-08",null,null,"2014-05-04","2014-05-18","2014-05-03","2014-05-22","2014-05-28",null,null,"2014-05-30","2014-05-28","2014-06-14","2014-06-07","2014-06-09",null,null,null,"2014-06-23","2014-06-18","2014-06-24",null,null,"2014-07-03",null,"2014-07-10","2014-06-14",null,"2014-06-18","2014-06-29","2014-07-02","2014-07-12","2014-07-12","2014-06-13","2014-07-15","2014-06-20",null,null,"2014-07-20",null,"2014-07-12","2014-07-19","2014-07-18","2014-07-18","2014-07-27",null,"2014-07-19","2014-07-26","2014-07-24",null],["2014-05-13","2014-05-13","2014-05-16","2014-05-18","2014-05-21","2014-05-22","2014-05-27","2014-06-02","2014-06-05","2014-06-05","2014-06-06","2014-06-13","2014-06-16","2014-06-17","2014-06-18","2014-06-19","2014-06-22","2014-06-23","2014-06-25","2014-06-26","2014-06-28","2014-07-02","2014-07-08","2014-07-09","2014-07-09","2014-07-10","2014-07-12","2014-07-12","2014-07-13","2014-07-13","2014-07-14","2014-07-15","2014-07-16","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-22","2014-07-22","2014-07-24","2014-07-24","2014-07-25","2014-07-25","2014-07-27","2014-07-29","2014-07-30",null,"2014-08-01","2014-08-02","2014-08-03"],["2014-05-15","2014-05-14","2014-05-18","2014-05-20","2014-05-22","2014-05-23","2014-05-29","2014-06-03","2014-06-06","2014-06-07","2014-06-08","2014-06-15","2014-06-17","2014-06-17","2014-06-20","2014-06-19","2014-06-23","2014-06-24","2014-06-27","2014-06-28","2014-06-29","2014-07-03","2014-07-09","2014-07-09","2014-07-11","2014-07-11","2014-07-13","2014-07-14","2014-07-14","2014-07-13","2014-07-14","2014-07-17","2014-07-17","2014-07-18","2014-07-19","2014-07-20","2014-07-20","2014-07-22","2014-07-24","2014-07-26","2014-07-24","2014-07-27","2014-07-25","2014-07-27","2014-07-31","2014-08-01","2014-08-03","2014-08-02","2014-08-02","2014-08-04"],[null,"2014-05-18","2014-05-30",null,"2014-05-29","2014-05-24","2014-06-01","2014-06-07","2014-06-18","2014-06-09","2014-06-15",null,"2014-07-09",null,"2014-06-30","2014-07-11","2014-07-01","2014-06-25","2014-07-06","2014-07-02","2014-07-09","2014-07-07","2014-07-20",null,"2014-07-22","2014-07-16","2014-07-14","2014-07-20","2014-07-16","2014-07-19","2014-07-27","2014-07-19",null,"2014-07-26","2014-08-14","2014-08-01","2014-07-23","2014-08-28","2014-07-28","2014-07-19",null,"2014-08-03",null,null,null,"2014-08-06","2014-08-21","2014-09-13","2014-08-04",null],[null,"Recover","Recover",null,"Recover","Recover","Recover","Death","Recover","Death","Death","Death","Recover","Recover",null,"Recover",null,null,"Death","Death","Recover",null,null,null,"Death",null,"Death","Death",null,"Death","Recover","Death","Recover","Death","Recover",null,"Death","Recover","Recover","Death",null,null,"Death","Death","Death","Death","Recover",null,"Death","Death"],["m","f","m","f","m","f","f","f","m","f","m","m","m","f","f","m","f","f","f","f","m","m","f","m","f","m","m","f","m","f","f","f","m","m","f","m","f","f","f","m","f","m","f","m","m","f","m","f","m","m"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years","years"],[2,3,56,18,3,16,16,0,61,27,12,42,19,7,7,13,35,17,11,11,19,54,14,28,6,3,31,6,67,14,10,21,20,45,1,12,3,15,20,36,7,13,14,3,10,1,0,20,26,14],["0-4","0-4","50-69","15-19","0-4","15-19","15-19","0-4","50-69","20-29","10-14","30-49","15-19","5-9","5-9","10-14","30-49","15-19","10-14","10-14","15-19","50-69","10-14","20-29","5-9","0-4","30-49","5-9","50-69","10-14","10-14","20-29","20-29","30-49","0-4","10-14","0-4","15-19","20-29","30-49","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-29","20-29","10-14"],["0-4","0-4","55-59","15-19","0-4","15-19","15-19","0-4","60-64","25-29","10-14","40-44","15-19","5-9","5-9","10-14","35-39","15-19","10-14","10-14","15-19","50-54","10-14","25-29","5-9","0-4","30-34","5-9","65-69","10-14","10-14","20-24","20-24","45-49","0-4","10-14","0-4","15-19","20-24","35-39","5-9","10-14","10-14","0-4","10-14","0-4","0-4","20-24","25-29","10-14"],["Other","Missing","St. Mark's Maternity Hospital (SMMH)","Port Hospital","Military Hospital","Port Hospital","Missing","Missing","Missing","Missing","Port Hospital","Military Hospital","Missing","Missing","Other","Port Hospital","Port Hospital","Port Hospital","Missing","Other","Port Hospital","Port Hospital","St. Mark's Maternity Hospital (SMMH)","Missing","Other","Missing","St. Mark's Maternity Hospital (SMMH)","Military Hospital","Port Hospital","Central Hospital","Military Hospital","Central Hospital","Missing","Military Hospital","Other","Missing","Missing","Port Hospital","Port Hospital","Port Hospital","Missing","Central Hospital","Military Hospital","Other","Other","Other","Missing","St. Mark's Maternity Hospital (SMMH)","St. Mark's Maternity Hospital (SMMH)","Missing"],[-13.2157351064963,-13.2152339775486,-13.212910703914,-13.2363711169728,-13.2228638912441,-13.222625321098,-13.2331547837254,-13.2320975453153,-13.2225511595637,-13.2572163655863,-13.2206286746001,-13.253989309478,-13.2385127873491,-13.209391925612,-13.2157278814899,-13.2243437095992,-13.2336087079551,-13.21422143145,-13.2339681355349,-13.2535640411465,-13.2250089377786,-13.2160657166043,-13.2680671272333,-13.2266742923612,-13.2160179088168,-13.2482584611565,-13.2156319199566,-13.2142410663192,-13.2614879104088,-13.2452992638476,-13.2630592726116,-13.2343341712241,-13.2199077448676,-13.2227293309912,-13.2343062806506,-13.218781651651,-13.2483677722899,-13.2097478342339,-13.2680867723786,-13.2587535457526,-13.262635786914,-13.2697246824573,-13.2209026809759,-13.2330734719715,-13.2680923666905,-13.2547212675054,-13.2573683214693,-13.2137356012883,-13.2175973322257,-13.2486407324245],[8.46897295100924,8.45171855856465,8.46481700596819,8.4754761613651,8.46082377490923,8.46183062600728,8.46272931462646,8.46144367534271,8.46191259217774,8.47292327643506,8.48401630165138,8.45837125340844,8.47761705512509,8.47570184950483,8.47779946878972,8.47145134147474,8.47804840685363,8.48528034195779,8.46957530395867,8.45957352078114,8.47404889511544,8.48802917129884,8.473437335922,8.48408263734462,8.46242233645879,8.47026822126572,8.46398447480533,8.4641347894342,8.45623094629607,8.48334624336805,8.47493999153642,8.47832062438022,8.4693933891765,8.48480589906514,8.47121232619015,8.48438437371817,8.48466158574339,8.47714159984428,8.46238127010609,8.45568597813113,8.4632880274758,8.47940722413856,8.46353857052336,8.46178968158864,8.47508713872833,8.45825808128071,8.4532568143863,8.4732571907655,8.47911586641933,8.48480340615605],["f547d6",null,null,"f90f5f","11f8ea","aec8ec","893f25","133ee7",null,null,"996f3a","133ee7","37a6f6","9f6884","4802b1",null,null,null,"a75c7f","8e104d","ab634e",null,null,"b799eb",null,"5d9e4d","a15e13",null,"ea3740","beb26e","567136","894024","36e2e7","a2086d","7baf73","eb2277",null,null,"d6584f",null,"312ecf","52ea64","cfd79c","d145b7","174288",null,"53608c","3b096b","f5c142",null],["other",null,null,"other","other","other","other","other",null,null,"other","other","other","other","other",null,null,null,"other","other","other",null,null,"other",null,"other","other",null,"other","funeral","other","funeral","other","other","other","funeral",null,null,"other",null,"other","other","other","other","other",null,"funeral","other","other",null],[27,25,91,41,36,56,47,0,86,69,67,84,68,44,34,66,78,47,53,47,71,86,53,69,38,46,68,37,100,56,50,57,65,72,29,69,37,48,54,71,47,61,47,35,53,16,13,59,69,67],[48,59,238,135,71,116,87,11,226,174,112,186,174,90,91,152,214,137,117,131,150,241,131,161,80,69,188,66,233,142,110,182,164,214,26,157,39,154,133,168,100,125,123,67,134,31,36,125,183,169],[22,22,21,23,23,21,21,22,22,22,22,22,22,21,23,22,23,21,22,23,21,23,21,24,23,22,24,23,20,24,24,20,24,21,22,21,23,22,23,23,23,22,23,22,22,22,23,22,22,22],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","no","no","no","no","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","no","yes","no",null,"no","no","no","yes","no",null,"no","no","yes",null,null,"no","no",null,"no","no",null,null,"no","no",null,"no","no",null,"no","yes","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","yes","yes","yes","yes","yes","yes","yes","yes","yes",null,"yes","yes","yes","yes","yes",null,"yes","yes","yes",null,null,"yes","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","yes","yes","yes","no",null],["no",null,null,"no","no","no",null,"no","no","no","no","no","no","no","no","yes","no","no",null,"no","no","no","no","no",null,"no","no","no",null,null,"no","no",null,"no","no",null,null,"yes","yes",null,"no","no",null,"no","no","no","no","no","no",null],["yes",null,null,"no","yes","yes",null,"yes","yes","no","yes","no","no","no","yes","no","no","no",null,"no","yes","no","no","no",null,"no","no","no",null,null,"no","yes",null,"yes","yes",null,null,"yes","yes",null,"yes","yes",null,"yes","yes","no","yes","yes","yes",null],[36.8,36.9,36.9,36.8,36.9,37.6,37.3,37,36.4,35.9,36.5,36.9,36.5,37.1,36.5,37.3,37,38,38,36,37,36.7,36.9,36.5,37,36.5,37.6,36.6,36.6,36.2,36.4,37.1,37.5,37.5,37.4,36.9,36.4,37.3,37,37.8,36.5,37.5,36.7,37,37.3,36.6,36.5,36.6,37.6,36.8],[null,"09:36","16:48","11:22","12:60","14:13","14:33","09:25","11:16","10:55","16:03","11:14","12:42","11:06","09:10","08:45",null,"15:41","13:34","18:58","12:43","16:33","14:29","07:18","08:11","16:32","16:17","07:32","17:45",null,"13:24","14:43","02:33","11:36","17:28","16:27",null,"20:49",null,"11:38","14:25","13:42","21:22","13:33","19:06","17:14","20:09",null,"10:23","09:09"],[117.1875,71.8184429761563,16.0652496292635,22.4965706447188,71.4144019043841,41.6171224732461,62.0953890870657,0,16.8376536925366,22.7903289734443,53.4119897959184,24.2802636142907,22.4600343506408,54.320987654321,41.0578432556455,28.5664819944598,17.0320552013276,25.0412914912888,38.7172182043977,27.3876813705495,31.5555555555556,14.8069075945662,30.8839811199813,26.6193433895297,59.375,96.6183574879227,19.2394748755093,84.9403122130395,18.4199377406104,27.7722674072605,41.3223140495868,17.2080666586161,24.1671624033314,15.7218971089178,428.994082840237,27.9930220292912,243.261012491782,20.2395007589813,30.527446435638,25.15589569161,47,39.04,31.0661643201798,77.9683671196257,29.5165961238583,166.493236212279,100.308641975309,37.76,20.6037803457852,23.458562375267],[2,1,2,2,1,1,2,1,1,2,2,2,1,0,2,0,1,1,2,2,1,1,1,0,2,1,1,2,1,0,0,2,1,1,2,2,1,0,2,2,0,2,0,0,2,2,null,1,0,1]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>case_id<\/th>\n      <th>generation<\/th>\n      <th>date_infection<\/th>\n      <th>date_onset<\/th>\n      <th>date_hospitalisation<\/th>\n      <th>date_outcome<\/th>\n      <th>outcome<\/th>\n      <th>gender<\/th>\n      <th>age<\/th>\n      <th>age_unit<\/th>\n      <th>age_years<\/th>\n      <th>age_cat<\/th>\n      <th>age_cat5<\/th>\n      <th>hospital<\/th>\n      <th>lon<\/th>\n      <th>lat<\/th>\n      <th>infector<\/th>\n      <th>source<\/th>\n      <th>wt_kg<\/th>\n      <th>ht_cm<\/th>\n      <th>ct_blood<\/th>\n      <th>fever<\/th>\n      <th>chills<\/th>\n      <th>cough<\/th>\n      <th>aches<\/th>\n      <th>vomit<\/th>\n      <th>temp<\/th>\n      <th>time_admission<\/th>\n      <th>bmi<\/th>\n      <th>days_onset_hosp<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,8,10,14,15,18,19,20,26,28,29]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script><!-- ======================================================= -->
</div>
</div>
<div id="for-loops" class="section level2" number="16.2">
<h2>
<span class="header-section-number">16.2</span> <em>for loops</em><a class="anchor" aria-label="anchor" href="#for-loops"><i class="fas fa-link"></i></a>
</h2>
<div id="iter_loops" class="section level3 unnumbered">
<h3>
<em>for loops</em> in R<a class="anchor" aria-label="anchor" href="#iter_loops"><i class="fas fa-link"></i></a>
</h3>
<p><em>for loops</em> are not emphasized in R, but are common in other programming languages. As a beginner, they can be helpful to learn and practice with because they are easier to “explore”, “de-bug”, and otherwise grasp exactly what is happening for each iteration, especially when you are not yet comfortable writing your own functions.</p>
<p>You may move quickly through <em>for loops</em> to iterating with mapped functions with <strong>purrr</strong> (see <a href="iteration-loops-and-lists.html#iter_purrr">section below</a>).</p>
</div>
<div id="core-components" class="section level3 unnumbered">
<h3>Core components<a class="anchor" aria-label="anchor" href="#core-components"><i class="fas fa-link"></i></a>
</h3>
<p>A <em>for loop</em> has three core parts:</p>
<ol style="list-style-type: decimal">
<li>The <strong>sequence</strong> of items to iterate through<br>
</li>
<li>The <strong>operations</strong> to conduct per item in the sequence<br>
</li>
<li>The <strong>container</strong> for the results (optional)</li>
</ol>
<p>The basic syntax is: <code>for (item in sequence) {do operations using item}</code>. Note the parentheses and the curly brackets. The results could be printed to console, or stored in a container R object.</p>
<p>A simple <em>for loop</em> example is below.</p>
<div class="sourceCode" id="cb753"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">num</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># the SEQUENCE is defined (numbers 1 to 5) and loop is opened with "{"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">num</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span>             <span class="co"># The OPERATIONS (add two to each sequence number and print)</span></span>
<span><span class="op">}</span>                            <span class="co"># The loop is closed with "}"                            </span></span></code></pre></div>
<pre><code>## [1] 3
## [1] 4
## [1] 5
## [1] 6
## [1] 7</code></pre>
<div class="sourceCode" id="cb755"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>                             <span class="co"># There is no "container" in this example</span></span></code></pre></div>
</div>
<div id="sequence" class="section level3 unnumbered">
<h3>Sequence<a class="anchor" aria-label="anchor" href="#sequence"><i class="fas fa-link"></i></a>
</h3>
<p>This is the “for” part of a <em>for loop</em> - the operations will run “for” each item in the sequence. The sequence can be a series of values (e.g. names of jurisdictions, diseases, column names, list elements, etc), or it can be a series of consecutive numbers (e.g. 1,2,3,4,5). Each approach has their own utilities, described below.</p>
<p>The basic structure of a sequence statement is <code>item in vector</code>.</p>
<ul>
<li>You can write any character or word in place of “item” (e.g. “i”, “num”, “hosp”, “district”, etc.). The value of this “item” changes with each iteration of the loop, proceeding through each value in the vector.<br>
</li>
<li>The <em>vector</em> could be of character values, column names, or perhaps a sequence of numbers - these are the values that will change with each iteration. You can use them within the <em>for loop</em> operations using the “item” term.</li>
</ul>
<p><strong>Example: sequence of character values</strong></p>
<p>In this example, a loop is performed for each value in a pre-defined character vector of hospital names.</p>
<div class="sourceCode" id="cb756"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make vector of the hospital names</span></span>
<span><span class="va">hospital_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span></span>
<span><span class="va">hospital_names</span> <span class="co"># print</span></span></code></pre></div>
<pre><code>## [1] "Other"                                "Missing"                             
## [3] "St. Mark's Maternity Hospital (SMMH)" "Port Hospital"                       
## [5] "Military Hospital"                    "Central Hospital"</code></pre>
<p>We have chosen the term <code>hosp</code> to represent values from the vector <code>hospital_names</code>. For the first iteration of the loop, the value of <code>hosp</code> will be <code>hospital_names[[1]]</code>. For the second loop it will be <code>hospital_names[[2]]</code>. And so on…</p>
<div class="sourceCode" id="cb758"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># a 'for loop' with character sequence</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">hosp</span> <span class="kw">in</span> <span class="va">hospital_names</span><span class="op">)</span><span class="op">{</span>       <span class="co"># sequence</span></span>
<span>  </span>
<span>       <span class="co"># OPERATIONS HERE</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p><strong>Example: sequence of column names</strong></p>
<p>This is a variation on the character sequence above, in which the names of an existing R object are extracted and become the vector. For example, the column names of a data frame. Conveniently, in the operations code of the <em>for loop</em>, the column names can be used to <em>index</em> (subset) their original data frame</p>
<p>Below, the sequence is the <code><a href="https://rdrr.io/r/base/names.html">names()</a></code> (column names) of the <code>linelist</code> data frame. Our “item” name is <code>col</code>, which will represent each column name as the loops proceeds.</p>
<p>For purposes of example, we include operations code inside the <em>for loop</em>, which is run for every value in the sequence. In this code, the sequence values (column names) are used to <em>index</em> (subset) <code>linelist</code>, one-at-a-time. As taught in the <a href="r-basics.html#r-basics">R basics</a> page, double branckets <code>[[ ]]</code> are used to subset. The resulting column is passed to <code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code>, then to <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> to produce the number of values in the column that are missing. The result is printed to the console - one number for each column.</p>
<p>A note on indexing with column names - whenever referencing the column itself <em>do not just write “col”!</em> <code>col</code> represents just the character column name! To refer to the entire column you must use the column name as an <em>index</em> on <code>linelist</code> via <code>linelist[[col]]</code>.</p>
<div class="sourceCode" id="cb759"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>        <span class="co"># loop runs for each column in linelist; column name represented by "col" </span></span>
<span>  </span>
<span>  <span class="co"># Example operations code - print number of missing values in column</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>  <span class="co"># linelist is indexed by current value of "col"</span></span>
<span>     </span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [1] 0
## [1] 0
## [1] 2087
## [1] 256
## [1] 0
## [1] 936
## [1] 1323
## [1] 278
## [1] 86
## [1] 0
## [1] 86
## [1] 86
## [1] 86
## [1] 0
## [1] 0
## [1] 0
## [1] 2088
## [1] 2088
## [1] 0
## [1] 0
## [1] 0
## [1] 249
## [1] 249
## [1] 249
## [1] 249
## [1] 249
## [1] 149
## [1] 765
## [1] 0
## [1] 256</code></pre>
<p><strong>Sequence of numbers</strong></p>
<p>In this approach, the sequence is a series of consecutive numbers. Thus, the value of the “item” is not a character value (e.g. “Central Hospital” or “date_onset”) but is a number. This is useful for looping through data frames, as you can use the “item” number inside the <em>for loop</em> to index the data frame by <em>row number</em>.</p>
<p>For example, let’s say that you want to loop through every row in your data frame and extract certain information. Your “items” would be numeric row numbers. Often, “items” in this case are written as <code>i</code>.</p>
<p>The <em>for loop</em> process could be explained in words as “for every item in a sequence of numbers from 1 to the total number of rows in my data frame, do X”. For the first iteration of the loop, the value of “item” <code>i</code> would be 1. For the second iteration, <code>i</code> would be 2, etc.</p>
<p>Here is what the sequence looks like in code: <code>for (i in 1:nrow(linelist)) {OPERATIONS CODE}</code> where <code>i</code> represents the “item” and <code>1:nrow(linelist)</code> produces a sequence of consecutive numbers from 1 through the number of rows in <code>linelist</code>.</p>
<div class="sourceCode" id="cb761"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># use on a data frame</span></span>
<span>  <span class="co"># OPERATIONS HERE</span></span>
<span><span class="op">}</span>  </span></code></pre></div>
<p>If you want the sequence to be numbers, but you are starting from a vector (not a data frame), use the shortcut <code><a href="https://rdrr.io/r/base/seq.html">seq_along()</a></code> to return a sequence of numbers for each element in the vector. For example, <code>for (i in seq_along(hospital_names) {OPERATIONS CODE}</code>.</p>
<p>The below code actually returns numbers, which would become the value of <code>i</code> in their respective loop.</p>
<div class="sourceCode" id="cb762"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">hospital_names</span><span class="op">)</span>  <span class="co"># use on a named vector</span></span></code></pre></div>
<pre><code>## [1] 1 2 3 4 5 6</code></pre>
<p>One advantage of using numbers in the sequence is that is easy to also use the <code>i</code> number to index a <em>container</em> that stores the loop outputs. There is an example of this in the Operations section below.</p>
</div>
<div id="operations" class="section level3 unnumbered">
<h3>Operations<a class="anchor" aria-label="anchor" href="#operations"><i class="fas fa-link"></i></a>
</h3>
<p>This is code within the curly brackets <code><a href="https://rdrr.io/r/base/Paren.html">{ }</a></code> of the <em>for loop</em>. You want this code to run for each “item” in the <em>sequence</em>. Therefore, be careful that every part of your code that changes by the “item” is correctly coded such that it actually changes! E.g. remember to use <code>[[ ]]</code> for indexing.</p>
<p>In the example below, we iterate through each row in the <code>linelist</code>. The <code>gender</code> and <code>age</code> values of each row are pasted together and stored in the container character vector <code>cases_demographics</code>. Note how we also use indexing <code>[[i]]</code> to save the loop output to the correct position in the “container” vector.</p>
<div class="sourceCode" id="cb764"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create container to store results - a character vector</span></span>
<span><span class="va">cases_demographics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"character"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the for loop</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># OPERATIONS</span></span>
<span>  <span class="co"># extract values from linelist for row i, using brackets for indexing</span></span>
<span>  <span class="va">row_gender</span>  <span class="op">&lt;-</span> <span class="va">linelist</span><span class="op">$</span><span class="va">gender</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">row_age</span>     <span class="op">&lt;-</span> <span class="va">linelist</span><span class="op">$</span><span class="va">age_years</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>    <span class="co"># don't forget to index!</span></span>
<span>     </span>
<span>  <span class="co"># combine gender-age and store in container vector at indexed location</span></span>
<span>  <span class="va">cases_demographics</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op">(</span><span class="va">row_gender</span>, <span class="va">row_age</span>, sep <span class="op">=</span> <span class="st">","</span><span class="op">)</span> </span>
<span></span>
<span><span class="op">}</span>  <span class="co"># end for loop</span></span>
<span></span>
<span></span>
<span><span class="co"># display first 10 rows of container</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cases_demographics</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] "m,2"  "f,3"  "m,56" "f,18" "m,3"  "f,16" "f,16" "f,0"  "m,61" "f,27"</code></pre>
</div>
<div id="container" class="section level3 unnumbered">
<h3>Container<a class="anchor" aria-label="anchor" href="#container"><i class="fas fa-link"></i></a>
</h3>
<p>Sometimes the results of your <em>for loop</em> will be printed to the console or RStudio Plots pane. Other times, you will want to store the outputs in a “container” for later use. Such a container could be a vector, a data frame, or even a list.</p>
<p>It is most efficient to create the container for the results <em>before</em> even beginning the <em>for loop</em>. In practice, this means creating an empty vector, data frame, or list. These can be created with the functions <code><a href="https://rdrr.io/r/base/vector.html">vector()</a></code> for vectors or lists, or with <code><a href="https://rdrr.io/r/base/matrix.html">matrix()</a></code> and <code><a href="https://rdrr.io/r/base/data.frame.html">data.frame()</a></code> for a data frame.</p>
<p><strong>Empty vector</strong></p>
<p>Use <code><a href="https://rdrr.io/r/base/vector.html">vector()</a></code> and specify the <code>mode =</code> based on the expected class of the objects you will insert - either “double” (to hold numbers), “character”, or “logical”. You should also set the <code>length =</code> in advance. This should be the length of your <em>for loop</em> sequence.</p>
<p>Say you want to store the median delay-to-admission for each hospital. You would use “double” and set the length to be the number of expected outputs (the number of unique hospitals in the data set).</p>
<div class="sourceCode" id="cb766"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span></span>
<span>  mode <span class="op">=</span> <span class="st">"double"</span>,                            <span class="co"># we expect to store numbers</span></span>
<span>  length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># the number of unique hospitals in the dataset</span></span></code></pre></div>
<p><strong>Empty data frame</strong></p>
<p>You can make an empty data frame by specifying the number of rows and columns like this:</p>
<div class="sourceCode" id="cb767"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Empty list</strong></p>
<p>You may want store some plots created by a <em>for loop</em> in a list. A list is like vector, but holds other R objects within it that can be of different classes. Items in a list could be a single number, a dataframe, a vector, and even another list.</p>
<p>You actually initialize an empty list using the same <code><a href="https://rdrr.io/r/base/vector.html">vector()</a></code> command as above, but with <code>mode = "list"</code>. Specify the length however you wish.</p>
<div class="sourceCode" id="cb768"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="printing" class="section level3 unnumbered">
<h3>Printing<a class="anchor" aria-label="anchor" href="#printing"><i class="fas fa-link"></i></a>
</h3>
<p>Note that to print from within a <em>for loop</em> you will likely need to explicitly wrap with the function <code><a href="https://rdrr.io/r/base/print.html">print()</a></code>.</p>
<p>In this example below, the sequence is an explicit character vector, which is used to subset the linelist by hospital. The results are not stored in a container, but rather are printed to console with the <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> function.</p>
<div class="sourceCode" id="cb769"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">hosp</span> <span class="kw">in</span> <span class="va">hospital_names</span><span class="op">)</span><span class="op">{</span> </span>
<span>     <span class="va">hospital_cases</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">hosp</span><span class="op">)</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">hospital_cases</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code>## [1] 885
## [1] 1469
## [1] 422
## [1] 1762
## [1] 896
## [1] 454</code></pre>
</div>
<div id="testing-your-for-loop" class="section level3 unnumbered">
<h3>Testing your for loop<a class="anchor" aria-label="anchor" href="#testing-your-for-loop"><i class="fas fa-link"></i></a>
</h3>
<p>To test your loop, you can run a command to make a temporary assignment of the “item”, such as <code>i &lt;- 10</code> or <code>hosp &lt;- "Central Hospital"</code>. Do this <em>outside the loop</em> and then run your operations code only (the code within the curly brackets) to see if the expected results are produced.</p>
</div>
<div id="looping-plots" class="section level3 unnumbered">
<h3>Looping plots<a class="anchor" aria-label="anchor" href="#looping-plots"><i class="fas fa-link"></i></a>
</h3>
<p>To put all three components together (container, sequence, and operations) let’s try to plot an epicurve for each hospital (see page on <a href="epidemic-curves.html#epidemic-curves">Epidemic curves</a>).</p>
<p>We can make a nice epicurve of <em>all</em> the cases by gender using the <strong>incidence2</strong> package as below:</p>
<div class="sourceCode" id="cb771"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create 'incidence' object</span></span>
<span><span class="va">outbreak</span> <span class="op">&lt;-</span> <span class="fu">incidence2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/incidence2/man/incidence.html">incidence</a></span><span class="op">(</span>   </span>
<span>     x <span class="op">=</span> <span class="va">linelist</span>,                   <span class="co"># dataframe - complete linelist</span></span>
<span>     date_index <span class="op">=</span> <span class="va">date_onset</span>,        <span class="co"># date column</span></span>
<span>     interval <span class="op">=</span> <span class="st">"week"</span>,              <span class="co"># aggregate counts weekly</span></span>
<span>     groups <span class="op">=</span> <span class="va">gender</span>,                <span class="co"># group values by gender</span></span>
<span>     na_as_group <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>             <span class="co"># missing gender is own group</span></span>
<span></span>
<span><span class="co"># plot epi curve</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">outbreak</span>,                       <span class="co"># name of incidence object</span></span>
<span>     fill <span class="op">=</span> <span class="st">"gender"</span>,                <span class="co"># color bars by gender</span></span>
<span>     color <span class="op">=</span> <span class="st">"black"</span>,                <span class="co"># outline color of bars</span></span>
<span>     title <span class="op">=</span> <span class="st">"Outbreak of ALL cases"</span> <span class="co"># title</span></span>
<span>     <span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-600-1.png" width="672"></div>
<p>To produce a separate plot for each hospital’s cases, we can put this epicurve code within a <em>for loop</em>.</p>
<p>First, we save a named vector of the unique hospital names, <code>hospital_names</code>. The <em>for loop</em> will run once for each of these names: <code>for (hosp in hospital_names)</code>. Each iteration of the <em>for loop</em>, the current hospital name from the vector will be represented as <code>hosp</code> for use within the loop.</p>
<p>Within the loop operations, you can write R code as normal, but use the “item” (<code>hosp</code> in this case) knowing that its value will be changing. Within this loop:</p>
<ul>
<li>A <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> is applied to <code>linelist</code>, such that column <code>hospital</code> must equal the current value of <code>hosp</code><br>
</li>
<li>The incidence object is created on the filtered linelist<br>
</li>
<li>The plot for the current hospital is created, with an auto-adjusting title that uses <code>hosp</code><br>
</li>
<li>The plot for the current hospital is temporarily saved and then printed<br>
</li>
<li>The loop then moves onward to repeat with the next hospital in <code>hospital_names</code>
</li>
</ul>
<div class="sourceCode" id="cb772"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make vector of the hospital names</span></span>
<span><span class="va">hospital_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># for each name ("hosp") in hospital_names, create and print the epi curve</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">hosp</span> <span class="kw">in</span> <span class="va">hospital_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>     </span>
<span>     <span class="co"># create incidence object specific to the current hospital</span></span>
<span>     <span class="va">outbreak_hosp</span> <span class="op">&lt;-</span> <span class="fu">incidence2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/incidence2/man/incidence.html">incidence</a></span><span class="op">(</span></span>
<span>          x <span class="op">=</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">hosp</span><span class="op">)</span>,   <span class="co"># linelist is filtered to the current hospital</span></span>
<span>          date_index <span class="op">=</span> <span class="va">date_onset</span>,</span>
<span>          interval <span class="op">=</span> <span class="st">"week"</span>, </span>
<span>          groups <span class="op">=</span> <span class="va">gender</span>,</span>
<span>          na_as_group <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>     <span class="op">)</span></span>
<span>     </span>
<span>     <span class="co"># Create and save the plot. Title automatically adjusts to the current hospital</span></span>
<span>     <span class="va">plot_hosp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>       <span class="va">outbreak_hosp</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"gender"</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>       title <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"Epidemic of cases admitted to {hosp}"</span><span class="op">)</span></span>
<span>     <span class="op">)</span></span>
<span>     </span>
<span>     <span class="co"># print the plot for the current hospital</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">plot_hosp</span><span class="op">)</span></span>
<span>     </span>
<span><span class="op">}</span> <span class="co"># end the for loop when it has been run for every hospital in hospital_names </span></span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-601-1.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-601-2.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-601-3.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-601-4.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-601-5.png" width="50%"><img src="_main_files/figure-html/unnamed-chunk-601-6.png" width="50%"></p>
</div>
<div id="tracking-progress-of-a-loop" class="section level3 unnumbered">
<h3>Tracking progress of a loop<a class="anchor" aria-label="anchor" href="#tracking-progress-of-a-loop"><i class="fas fa-link"></i></a>
</h3>
<p>A loop with many iterations can run for many minutes or even hours. Thus, it can be helpful to print the progress to the R console. The <code>if</code> statement below can be placed <em>within</em> the loop operations to print every 100th number. Just adjust it so that <code>i</code> is the “item” in your loop.</p>
<div class="sourceCode" id="cb773"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb773-1"><a href="iteration-loops-and-lists.html#cb773-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loop with code to print progress every 100 iterations</span></span>
<span id="cb773-2"><a href="iteration-loops-and-lists.html#cb773-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(linelist))){</span>
<span id="cb773-3"><a href="iteration-loops-and-lists.html#cb773-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-4"><a href="iteration-loops-and-lists.html#cb773-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print progress</span></span>
<span id="cb773-5"><a href="iteration-loops-and-lists.html#cb773-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(i <span class="sc">%%</span> <span class="dv">100</span><span class="sc">==</span><span class="dv">0</span>){    <span class="co"># The %% operator is the remainder</span></span>
<span id="cb773-6"><a href="iteration-loops-and-lists.html#cb773-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(i)</span>
<span id="cb773-7"><a href="iteration-loops-and-lists.html#cb773-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-8"><a href="iteration-loops-and-lists.html#cb773-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<!-- ======================================================= -->
</div>
</div>
<div id="iter_purrr" class="section level2" number="16.3">
<h2>
<span class="header-section-number">16.3</span> <strong>purrr</strong> and lists<a class="anchor" aria-label="anchor" href="#iter_purrr"><i class="fas fa-link"></i></a>
</h2>
<p>Another approach to iterative operations is the <strong>purrr</strong> package - it is the <strong>tidyverse</strong> approach to iteration.</p>
<p>If you are faced with performing the same task several times, it is probably worth creating a generalised solution that you can use across many inputs. For example, producing plots for multiple jurisdictions, or importing and combining many files.</p>
<p>There are also a few other advantages to <strong>purrr</strong> - you can use it with pipes <code>%&gt;%</code>, it handles errors better than normal <em>for loops</em>, and the syntax is quite clean and simple! If you are using a <em>for loop</em>, you can probably do it more clearly and succinctly with <strong>purrr</strong>!</p>
<p>Keep in mind that <strong>purrr</strong> is a <em>functional programming tool</em>. That is, the operations that are to be iteratively applied are wrapped up into <em>functions</em>. See the <a href="writing-functions-1.html#writing-functions-1">Writing functions</a> page to learn how to write your own functions.</p>
<p><strong>purrr</strong> is also almost entirely based around <em>lists</em> and <em>vectors</em> - so think about it as applying a function to each element of that list/vector!</p>
<div id="load-packages-9" class="section level3 unnumbered">
<h3>Load packages<a class="anchor" aria-label="anchor" href="#load-packages-9"><i class="fas fa-link"></i></a>
</h3>
<p><strong>purrr</strong> is part of the <strong>tidyverse</strong>, so there is no need to install/load a separate package.</p>
<div class="sourceCode" id="cb774"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span></span>
<span>     <span class="va">rio</span>,            <span class="co"># import/export</span></span>
<span>     <span class="va">here</span>,           <span class="co"># relative filepaths</span></span>
<span>     <span class="va">tidyverse</span>,      <span class="co"># data mgmt and viz</span></span>
<span>     <span class="va">writexl</span>,        <span class="co"># write Excel file with multiple sheets</span></span>
<span>     <span class="va">readxl</span>          <span class="co"># import Excel with multiple sheets</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="map" class="section level3 unnumbered">
<h3>
<code>map()</code><a class="anchor" aria-label="anchor" href="#map"><i class="fas fa-link"></i></a>
</h3>
<p>One core <strong>purrr</strong> function is <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, which “maps” (applies) a function to each input element of a list/vector you provide.</p>
<p>The basic syntax is <code>map(.x = SEQUENCE, .f = FUNCTION, OTHER ARGUMENTS)</code>. In a bit more detail:</p>
<ul>
<li>
<code>.x =</code> are the <em>inputs</em> upon which the <code>.f</code> function will be iteratively applied - e.g. a vector of jurisdiction names, columns in a data frame, or a list of data frames<br>
</li>
<li>
<code>.f =</code> is the <em>function</em> to apply to each element of the <code>.x</code> input - it could be a function like <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> that already exists, or a custom function that you define. The function is often written after a tilde <code>~</code> (details below).</li>
</ul>
<p>A few more notes on syntax:</p>
<ul>
<li>If the function needs no further arguments specified, it can be written with no parentheses and no tilde (e.g. <code>.f = mean</code>). To provide arguments that will be the same value for each iteration, provide them within <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> but outside the <code>.f =</code> argument, such as the <code>na.rm = T</code> in <code>map(.x = my_list, .f = mean, na.rm=T)</code>.<br>
</li>
<li>You can use <code>.x</code> (or simply <code>.</code>) <em>within</em> the <code>.f =</code> function as a placeholder for the <code>.x</code> value of that iteration<br>
</li>
<li>Use tilde syntax (<code>~</code>) to have greater control over the function - write the function as normal with parentheses, such as: <code>map(.x = my_list, .f = ~mean(., na.rm = T))</code>. Use this syntax particularly if the value of an argument will change each iteration, or if it is the value <code>.x</code> itself (see examples below)</li>
</ul>
<p><strong>The output of using <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> is a <em>list</em></strong> - a list is an object class like a vector but whose elements can be of different classes. So, a list produced by <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> could contain many data frames, or many vectors, many single values, or even many lists! There are alternative versions of <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> explained below that produce other types of outputs (e.g. <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> to produce a data frame, <code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code> to produce character vectors, and <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> to produce numeric vectors).</p>
<div id="iter_combined" class="section level4 unnumbered">
<h4>Example - import and combine Excel sheets<a class="anchor" aria-label="anchor" href="#iter_combined"><i class="fas fa-link"></i></a>
</h4>
<p><strong>Let’s demonstrate with a common epidemiologist task:</strong> - <em>You want to import an Excel workbook with case data, but the data are split across different named sheets in the workbook. How do you efficiently import and combine the sheets into one data frame?</em></p>
<p>Let’s say we are sent the below Excel workbook. Each sheet contains cases from a given hospital.</p>
<div class="inline-figure"><img src="images/hospital_linelists_excel_sheets.png" width="615" style="display: block; margin: auto;"></div>
<p>Here is one approach that uses <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>:</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> the function <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> so that it runs for each Excel sheet<br>
</li>
<li>Combine the imported data frames into one using <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code><br>
</li>
<li>Along the way, preserve the original sheet name for each row, storing this information in a new column in the final data frame</li>
</ol>
<p>First, we need to extract the sheet names and save them. We provide the Excel workbook’s file path to the function <code>excel_sheets()</code> from the package <strong>readxl</strong>, which extracts the sheet names. We store them in a character vector called <code>sheet_names</code>.</p>
<div class="sourceCode" id="cb775"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sheet_names</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/excel_sheets.html">excel_sheets</a></span><span class="op">(</span><span class="st">"hospital_linelists.xlsx"</span><span class="op">)</span></span></code></pre></div>
<p>Here are the names:</p>
<div class="sourceCode" id="cb776"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sheet_names</span></span></code></pre></div>
<pre><code>## [1] "Central Hospital"              "Military Hospital"             "Missing"                      
## [4] "Other"                         "Port Hospital"                 "St. Mark's Maternity Hospital"</code></pre>
<p>Now that we have this vector of names, <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> can provide them one-by-one to the function <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code>. In this example, the <code>sheet_names</code> are <code>.x</code> and <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> is the function <code>.f</code>.</p>
<p>Recall from the <a href="import-and-export.html#import-and-export">Import and export</a> page that when used on Excel workbooks, <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> can accept the argument <code>which =</code> specifying the sheet to import. Within the <code>.f</code> function <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code>, we provide <code>which = .x</code>, whose value will change with each iteration through the vector <code>sheet_names</code> - first “Central Hospital”, then “Military Hospital”, etc.</p>
<p>Of note - because we have used <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, the data in each Excel sheet will be saved as a separate data frame within a list. We want each of these list elements (data frames) to have a <em>name</em>, so before we pass <code>sheet_names</code> to <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> we pass it through <code><a href="https://rlang.r-lib.org/reference/set_names.html">set_names()</a></code> from <strong>purrr</strong>, which ensures that each list element gets the appropriate name.</p>
<p>We save the output list as <code>combined</code>.</p>
<div class="sourceCode" id="cb778"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="va">sheet_names</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"hospital_linelists.xlsx"</span>, which <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>When we inspect output, we see that the data from each Excel sheet is saved in the list with a name. This is good, but we are not quite finished.</p>
<div class="inline-figure"><img src="images/sheets_as_list.png" width="544" style="display: block; margin: auto;"></div>
<p>Lastly, we use the function <code><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows()</a></code> (from <strong>dplyr</strong>) which accepts the list of similarly-structured data frames and combines them into one data frame. To create a new column from the list element <em>names</em>, we use the argument <code>.id =</code> and provide it with the desired name for the new column.</p>
<p>Below is the whole sequence of commands:</p>
<div class="sourceCode" id="cb779"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sheet_names</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/excel_sheets.html">excel_sheets</a></span><span class="op">(</span><span class="st">"hospital_linelists.xlsx"</span><span class="op">)</span>  <span class="co"># extract sheet names</span></span>
<span> </span>
<span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="va">sheet_names</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                                     <span class="co"># begin with sheet names</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                                        <span class="co"># set their names</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"hospital_linelists.xlsx"</span>, which <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># iterate, import, save in list</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"origin_sheet"</span><span class="op">)</span> <span class="co"># combine list of data frames, preserving origin in new column  </span></span></code></pre></div>
<p>And now we have one data frame with a column containing the sheet of origin!</p>
<div class="inline-figure"><img src="images/sheets_as_df.png" width="543" style="display: block; margin: auto;"></div>
<p>There are variations of <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> that you should be aware of. For example, <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr()</a></code> returns a data frame, not a list. Thus, we could have used it for the task above and not have had to bind rows. But then we would not have been able to capture which sheet (hospital) each case came from.</p>
<p>Other variations include <code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code>, <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code>. These are very useful functions for two reasons. Firstly. they automatically convert the output of an iterative function into a vector (not a list). Secondly, they can explicitly control the class that the data comes back in - you ensure that your data comes back as a character vector with <code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code>, or numeric vector with <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code>. Lets return to these later in the section!</p>
<p>The functions <code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at()</a></code> and <code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_if()</a></code> are also very useful for iteration - they allow you to specify which elements of a list you should iterate at! These work by simply applying a vector of indexes/names (in the case of <code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at()</a></code>) or a logical test (in the case of <code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_if()</a></code>).</p>
<p>Lets use an example where we didn’t want to read the first sheet of hospital data. We use <code><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at()</a></code> instead of <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, and specify the <code>.at =</code> argument to <code>c(-1)</code> which means to <em>not</em> use the first element of <code>.x</code>. Alternatively, you can provide a vector of positive numbers, or names, to <code>.at =</code> to specify which elements to use.</p>
<div class="sourceCode" id="cb780"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sheet_names</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/excel_sheets.html">excel_sheets</a></span><span class="op">(</span><span class="st">"hospital_linelists.xlsx"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="va">sheet_names</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="co"># exclude the first sheet</span></span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_if.html">map_at</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span> <span class="st">"hospital_linelists.xlsx"</span>, which <span class="op">=</span> <span class="va">.x</span><span class="op">)</span>,</span>
<span>            .at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note that the first sheet name will still appear as an element of the output list - but it is only a single character name (not a data frame). You would need to remove this element before binding rows. We will cover how to remove and modify list elements in a later section.</p>
</div>
</div>
<div id="split-dataset-and-export" class="section level3 unnumbered">
<h3>Split dataset and export<a class="anchor" aria-label="anchor" href="#split-dataset-and-export"><i class="fas fa-link"></i></a>
</h3>
<p>Below, we give an example of how to split a dataset into parts and then use <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> iteration to export each part as a separate Excel sheet, or as a separate CSV file.</p>
<div id="split-dataset" class="section level4 unnumbered">
<h4>Split dataset<a class="anchor" aria-label="anchor" href="#split-dataset"><i class="fas fa-link"></i></a>
</h4>
<p>Let’s say we have the complete case <code>linelist</code> as a data frame, and we now want to create a separate linelist for each hospital and export each as a separate CSV file. Below, we do the following steps:</p>
<p>Use <code><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split()</a></code> (from <strong>dplyr</strong>) to split the <code>linelist</code> data frame by unique values in column <code>hospital</code>. The output is a list containing one data frame per hospital subset.</p>
<div class="sourceCode" id="cb781"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_split</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="va">hospital</span><span class="op">)</span></span></code></pre></div>
<p>We can run <code>View(linelist_split)</code> and see that this list contains 6 data frames (“tibbles”), each representing the cases from one hospital.</p>
<div class="inline-figure"><img src="images/purrr_linelist_split.png" width="574" style="display: block; margin: auto;"></div>
<p>However, note that the data frames in the list do not have names by default! We want each to have a name, and then to use that name when saving the CSV file.</p>
<p>One approach to extracting the names is to use <code><a href="https://dplyr.tidyverse.org/reference/pull.html">pull()</a></code> (from <strong>dplyr</strong>) to extract the <code>hospital</code> column from each data frame in the list. Then, to be safe, we convert the values to character and then use <code><a href="https://rdrr.io/r/base/unique.html">unique()</a></code> to get the name for that particular data frame. All of these steps are applied to each data frame via <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>.</p>
<div class="sourceCode" id="cb782"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">linelist_split</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>   <span class="co"># Assign to names of listed data frames </span></span>
<span>     <span class="co"># Extract the names by doing the following to each data frame: </span></span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">hospital</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>        <span class="co"># Pull out hospital column</span></span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>          <span class="co"># Convert to character, just in case</span></span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span>                    <span class="co"># Take the unique hospital name</span></span></code></pre></div>
<p>We can now see that each of the list elements has a name. These names can be accessed via <code>names(linelist_split)</code>.</p>
<div class="inline-figure"><img src="images/purrr_linelist_split_named.png" width="575" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb783"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "Central Hospital"                     "Military Hospital"                   
## [3] "Missing"                              "Other"                               
## [5] "Port Hospital"                        "St. Mark's Maternity Hospital (SMMH)"</code></pre>
<div id="more-than-one-group_split-column" class="section level5 unnumbered">
<h5>More than one <code>group_split()</code> column<a class="anchor" aria-label="anchor" href="#more-than-one-group_split-column"><i class="fas fa-link"></i></a>
</h5>
<p>If you wanted to split the linelist by <em>more than one grouping column</em>, such as to produce subset linelist by intersection of hospital AND gender, you will need a different approach to naming the list elements. This involves collecting the unique “group keys” using <code><a href="https://dplyr.tidyverse.org/reference/group_data.html">group_keys()</a></code> from <strong>dplyr</strong> - they are returned as a data frame. Then you can combine the group keys into values with <code><a href="https://tidyr.tidyverse.org/reference/unite.html">unite()</a></code> as shown below, and assign these conglomerate names to <code>linelist_split</code>.</p>
<div class="sourceCode" id="cb785"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># split linelist by unique hospital-gender combinations</span></span>
<span><span class="va">linelist_split</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="va">gender</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># extract group_keys() as a dataframe</span></span>
<span><span class="va">groupings</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">hospital</span>, <span class="va">gender</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>       </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_data.html">group_keys</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">groupings</span>      <span class="co"># show unique groupings </span></span></code></pre></div>
<pre><code>## # A tibble: 18 × 2
##    hospital                             gender
##    &lt;chr&gt;                                &lt;chr&gt; 
##  1 Central Hospital                     f     
##  2 Central Hospital                     m     
##  3 Central Hospital                     &lt;NA&gt;  
##  4 Military Hospital                    f     
##  5 Military Hospital                    m     
##  6 Military Hospital                    &lt;NA&gt;  
##  7 Missing                              f     
##  8 Missing                              m     
##  9 Missing                              &lt;NA&gt;  
## 10 Other                                f     
## 11 Other                                m     
## 12 Other                                &lt;NA&gt;  
## 13 Port Hospital                        f     
## 14 Port Hospital                        m     
## 15 Port Hospital                        &lt;NA&gt;  
## 16 St. Mark's Maternity Hospital (SMMH) f     
## 17 St. Mark's Maternity Hospital (SMMH) m     
## 18 St. Mark's Maternity Hospital (SMMH) &lt;NA&gt;</code></pre>
<p>Now we combine the groupings together, separated by dashes, and assign them as the names of list elements in <code>linelist_split</code>. This takes some extra lines as we replace <code>NA</code> with “Missing”, use <code><a href="https://tidyr.tidyverse.org/reference/unite.html">unite()</a></code> from <strong>dplyr</strong> to combine the column values together (separated by dashes), and then convert into an un-named vector so it can be used as names of <code>linelist_split</code>.</p>
<div class="sourceCode" id="cb787"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Combine into one name value </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">groupings</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">replace_na</span>, <span class="st">"Missing"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># replace NA with "Missing" in all columns</span></span>
<span>     <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unite.html">unite</a></span><span class="op">(</span><span class="st">"combined"</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>                         <span class="co"># Unite all column values into one</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/as_vector.html">as_vector</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="export-as-excel-sheets" class="section level4 unnumbered">
<h4>Export as Excel sheets<a class="anchor" aria-label="anchor" href="#export-as-excel-sheets"><i class="fas fa-link"></i></a>
</h4>
<p>To export the hospital linelists as <em>an Excel workbook with one linelist per sheet</em>, we can just provide the named list <code>linelist_split</code> to the <code>write_xlsx()</code> function from the <strong>writexl</strong> package. This has the ability to save one Excel workbook with multiple sheets. The list element names are automatically applied as the sheet names.</p>
<div class="sourceCode" id="cb788"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linelist_split</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu">writexl</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/writexl/reference/write_xlsx.html">write_xlsx</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"hospital_linelists.xlsx"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You can now open the Excel file and see that each hospital has its own sheet.</p>
<div class="inline-figure"><img src="images/purrr_export_sheets.png" width="652" style="display: block; margin: auto;"></div>
</div>
<div id="export-as-csv-files" class="section level4 unnumbered">
<h4>Export as CSV files<a class="anchor" aria-label="anchor" href="#export-as-csv-files"><i class="fas fa-link"></i></a>
</h4>
<p>It is a bit more complex command, but you can also export each hospital-specific linelist as a separate CSV file, with a file name specific to the hospital.</p>
<p>Again we use <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>: we take the vector of list element names (shown above) and use <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> to iterate through them, applying <code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code> (from the <strong>rio</strong> package, see <a href="import-and-export.html#import-and-export">Import and export</a> page) on the data frame in the list <code>linelist_split</code> that has that name. We also use the name to create a unique file name. Here is how it works:</p>
<ul>
<li>We begin with the vector of character names, passed to <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> as <code>.x</code><br>
</li>
<li>The <code>.f</code> function is <code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code> , which requires a data frame and a file path to write to<br>
</li>
<li>The input <code>.x</code> (the hospital name) is used <em>within</em> <code>.f</code> to extract/index that specific element of <code>linelist_split</code> list. This results in only one data frame at a time being provided to <code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code>.<br>
</li>
<li>For example, when <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> iterates for “Military Hospital”, then <code>linelist_split[[.x]]</code> is actually <code>linelist_split[["Military Hospital"]]</code>, thus returning the second element of <code>linelist_split</code> - which is all the cases from Military Hospital.<br>
</li>
<li>The file path provided to <code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code> is dynamic via use of <code><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue()</a></code> (see <a href="characters-and-strings.html#characters-and-strings">Characters and strings</a> page):
<ul>
<li>
<code><a href="https://here.r-lib.org//reference/here.html">here()</a></code> is used to get the base of the file path and specify the “data” folder (note single quotes to not interrupt the <code><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue()</a></code> double quotes)<br>
</li>
</ul>
</li>
<li>Then a slash <code>/</code>, and then again the <code>.x</code> which prints the current hospital name to make the file identifiable<br>
</li>
<li>Finally the extension “.csv” which <code><a href="https://rdrr.io/pkg/rio/man/export.html">export()</a></code> uses to create a CSV file</li>
</ul>
<div class="sourceCode" id="cb789"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>     <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/export.html">export</a></span><span class="op">(</span><span class="va">linelist_split</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>, file <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"{here('data')}/{.x}.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now you can see that each file is saved in the “data” folder of the R Project “Epi_R_handbook”!</p>
<div class="inline-figure"><img src="images/purrr_export_csv.png" width="632" style="display: block; margin: auto;"></div>
</div>
</div>
<div id="custom-functions" class="section level3 unnumbered">
<h3>Custom functions<a class="anchor" aria-label="anchor" href="#custom-functions"><i class="fas fa-link"></i></a>
</h3>
<p>You may want to create your own function to provide to <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>.</p>
<p>Let’s say we want to create epidemic curves for each hospital’s cases. To do this using <strong>purrr</strong>, our <code>.f</code> function can be <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> and extensions with <code>+</code> as usual. As the output of <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> is always a list, the plots are stored in a list. Because they are plots, they can be extracted and plotted with the <code>ggarrange()</code> function from the <strong>ggpubr</strong> package (<a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html">documentation</a>).</p>
<div class="sourceCode" id="cb790"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load package for plotting elements from list</span></span>
<span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">ggpubr</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># map across the vector of 6 hospital "names" (created earlier)</span></span>
<span><span class="co"># use the ggplot function specified</span></span>
<span><span class="co"># output is a list with 6 ggplots</span></span>
<span></span>
<span><span class="va">hospital_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">linelist</span><span class="op">$</span><span class="va">hospital</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>  .x <span class="op">=</span> <span class="va">hospital_names</span>,</span>
<span>  .f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="va">.x</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># print the ggplots (they are stored in a list)</span></span>
<span><span class="fu">ggarrange</span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">my_plots</span>, ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-627-1.png" width="672"></div>
<p>If this <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> code looks too messy, you can achieve the same result by saving your specific <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> command as a custom user-defined function, for example we can name it <code>make_epicurve())</code>. This function is then used within the <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>. <code>.x</code> will be iteratively replaced by the hospital name, and used as <code>hosp_name</code> in the <code>make_epicurve()</code> function. See the page on <a href="writing-functions-1.html#writing-functions-1">Writing functions</a>.</p>
<div class="sourceCode" id="cb791"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create function</span></span>
<span><span class="va">make_epicurve</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">hosp_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">hospital</span> <span class="op">==</span> <span class="va">hosp_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="va">hosp_name</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb792"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># mapping</span></span>
<span><span class="va">my_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">hospital_names</span>, <span class="op">~</span><span class="fu">make_epicurve</span><span class="op">(</span>hosp_name <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># print the ggplots (they are stored in a list)</span></span>
<span><span class="fu">ggarrange</span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">my_plots</span>, ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="mapping-a-function-across-columns" class="section level3 unnumbered">
<h3>Mapping a function across columns<a class="anchor" aria-label="anchor" href="#mapping-a-function-across-columns"><i class="fas fa-link"></i></a>
</h3>
<p>Another common use-case is to map a function across many columns. Below, we <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> the function <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> across numeric columns in the data frame <code>linelist</code>, comparing the numeric values by gender.</p>
<p>Recall from the page on <a href="simple-statistical-tests.html#simple-statistical-tests">Simple statistical tests</a> that <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> can take inputs in a formula format, such as <code>t.test(numeric column ~ binary column)</code>. In this example, we do the following:</p>
<ul>
<li>The numeric columns of interest are selected from <code>linelist</code> - these become the <code>.x</code> inputs to <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code><br>
</li>
<li>The function <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> is supplied as the <code>.f</code> function, which is applied to each numeric column<br>
</li>
<li>Within the parentheses of <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code>:
<ul>
<li>the first <code>~</code> precedes the <code>.f</code> that <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> will iterate over <code>.x</code><br>
</li>
<li>the <code>.x</code> represents the current column being supplied to the function <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code><br>
</li>
<li>the second <code>~</code> is part of the t-test equation described above<br>
</li>
<li>the <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code> function expects a binary column on the right-hand side of the equation. We supply the vector <code>linelist$gender</code> independently and statically (note that it is not included in <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>).</li>
</ul>
</li>
</ul>
<p><code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> returns a list, so the output is a list of t-test results - one list element for each numeric column analysed.</p>
<div class="sourceCode" id="cb793"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Results are saved as a list</span></span>
<span><span class="va">t.test_results</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">wt_kg</span>, <span class="va">ht_cm</span>, <span class="va">ct_blood</span>, <span class="va">temp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co"># keep only some numeric columns to map across</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">.x</span> <span class="op">~</span> <span class="va">linelist</span><span class="op">$</span><span class="va">gender</span><span class="op">)</span><span class="op">)</span>        <span class="co"># t.test function, with equation NUMERIC ~ CATEGORICAL</span></span></code></pre></div>
<p>Here is what the list <code>t.test_results</code> looks like when opened (Viewed) in RStudio. We have highlighted parts that are important for the examples in this page.</p>
<ul>
<li>You can see at the top that the whole list is named <code>t.test_results</code> and has five elements. Those five elements are named <code>age</code>, <code>wt_km</code>, <code>ht_cm</code>, <code>ct_blood</code>, <code>temp</code> after each variable that was used in a t-test with <code>gender</code> from the <code>linelist</code>.<br>
</li>
<li>Each of those five elements are themselves lists, with elements within them such as <code>p.value</code> and <code>conf.int</code>. Some of these elements like <code>p.value</code> are single numbers, whereas some such as <code>estimate</code> consist of two or more elements (<code>mean in group f</code> and <code>mean in group m</code>).</li>
</ul>
<div class="inline-figure"><img src="images/purrr_ttest.png" width="286" height="150%"></div>
<p>Note: Remember that if you want to apply a function to only certain columns in a data frame, you can also simply use <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code>, as explained in the <a href="cleaning-data-and-core-functions.html#cleaning-data-and-core-functions">Cleaning data and core functions</a> page. Below is an example of applying <code><a href="https://rdrr.io/r/base/character.html">as.character()</a></code> to only the “age” columns. Note the placement of the parentheses and commas.</p>
<div class="sourceCode" id="cb794"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># convert columns with column name containing "age" to class Character</span></span>
<span><span class="va">linelist</span> <span class="op">&lt;-</span> <span class="va">linelist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"age"</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="va">as.character</span><span class="op">)</span><span class="op">)</span>  </span></code></pre></div>
</div>
<div id="extract-from-lists" class="section level3 unnumbered">
<h3>Extract from lists<a class="anchor" aria-label="anchor" href="#extract-from-lists"><i class="fas fa-link"></i></a>
</h3>
<p>As <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> produces an output of class List, we will spend some time discussing how to extract data from lists using accompanying <strong>purrr</strong> functions. To demonstrate this, we will use the list <code>t.test_results</code> from the previous section. This is a list of 5 lists - each of the 5 lists contains the results of a t-test between a column from <code>linelist</code> data frame and its binary column <code>gender</code>. See the image in the section above for a visual of the list structure.</p>
<div id="names-of-elements" class="section level4 unnumbered">
<h4>Names of elements<a class="anchor" aria-label="anchor" href="#names-of-elements"><i class="fas fa-link"></i></a>
</h4>
<p>To extract the names of the elements themselves, simply use <code><a href="https://rdrr.io/r/base/names.html">names()</a></code> from <strong>base</strong> R. In this case, we use <code><a href="https://rdrr.io/r/base/names.html">names()</a></code> on <code>t.test_results</code> to return the names of each sub-list, which are the names of the 5 variables that had t-tests performed.</p>
<div class="sourceCode" id="cb795"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">t.test_results</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] "age"      "wt_kg"    "ht_cm"    "ct_blood" "temp"</code></pre>
</div>
<div id="elements-by-name-or-position" class="section level4 unnumbered">
<h4>Elements by name or position<a class="anchor" aria-label="anchor" href="#elements-by-name-or-position"><i class="fas fa-link"></i></a>
</h4>
<p>To extract list elements by name or by position you can use brackets <code>[[ ]]</code> as described in the <a href="r-basics.html#r-basics">R basics</a> page. Below we use double brackets to index the list <code>t.tests_results</code> and display the first element which is the results of the t-test on <code>age</code>.</p>
<div class="sourceCode" id="cb797"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># first element by position</span></span></code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  .x by linelist$gender
## t = -21.3, df = 4902.9, p-value &lt; 2.2e-16
## alternative hypothesis: true difference in means between group f and group m is not equal to 0
## 95 percent confidence interval:
##  -7.544409 -6.272675
## sample estimates:
## mean in group f mean in group m 
##        12.66085        19.56939</code></pre>
<div class="sourceCode" id="cb799"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"p.value"</span><span class="op">]</span> <span class="co"># return element named "p.value" from first element  </span></span></code></pre></div>
<pre><code>## $p.value
## [1] 2.350374e-96</code></pre>
<p>However, below we will demonstrate use of the simple and flexible <strong>purrr</strong> functions <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> and <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> to achieve the same outcomes.</p>
</div>
<div id="pluck" class="section level4 unnumbered">
<h4>
<code>pluck()</code><a class="anchor" aria-label="anchor" href="#pluck"><i class="fas fa-link"></i></a>
</h4>
<p><code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> pulls out elements by name or by position. For example - to extract the t-test results for age, you can use <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> like this:</p>
<div class="sourceCode" id="cb801"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"age"</span><span class="op">)</span>        <span class="co"># alternatively, use pluck(1)</span></span></code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  .x by linelist$gender
## t = -21.3, df = 4902.9, p-value &lt; 2.2e-16
## alternative hypothesis: true difference in means between group f and group m is not equal to 0
## 95 percent confidence interval:
##  -7.544409 -6.272675
## sample estimates:
## mean in group f mean in group m 
##        12.66085        19.56939</code></pre>
<p>Index deeper levels by specifying the further levels with commas. The below extracts the element named “p.value” from the list <code>age</code> within the list <code>t.test_results</code>. You can also use numbers instead of character names.</p>
<div class="sourceCode" id="cb803"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"p.value"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## [1] 2.350374e-96</code></pre>
<p>You can extract such inner elements from <em>all</em> first-level elements by using <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> to run the <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> function across each first-level element. For example, the below code extracts the “p.value” elements from all lists within <code>t.test_results</code>. The list of t-test results is the <code>.x</code> iterated across, <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> is the <code>.f</code> function being iterated, and the value “p-value” is provided to the function.</p>
<div class="sourceCode" id="cb805"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">pluck</span>, <span class="st">"p.value"</span><span class="op">)</span>   <span class="co"># return every p-value</span></span></code></pre></div>
<pre><code>## $age
## [1] 2.350374e-96
## 
## $wt_kg
## [1] 2.664367e-182
## 
## $ht_cm
## [1] 3.515713e-144
## 
## $ct_blood
## [1] 0.4473498
## 
## $temp
## [1] 0.5735923</code></pre>
<p>As another alternative, <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> offers a shorthand where you can write the element name in quotes, and it will pluck it out. If you use <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> the output will be a list, whereas if you use <code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code> it will be a named character vector and if you use <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> it will be a named numeric vector.</p>
<div class="sourceCode" id="cb807"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="st">"p.value"</span><span class="op">)</span>   <span class="co"># return p-values as a named numeric vector</span></span></code></pre></div>
<pre><code>##           age         wt_kg         ht_cm      ct_blood          temp 
##  2.350374e-96 2.664367e-182 3.515713e-144  4.473498e-01  5.735923e-01</code></pre>
<p>You can read more about <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> in it’s <strong>purrr</strong> <a href="https://purrr.tidyverse.org/reference/pluck.html">documentation</a>. It has a sibling function <code><a href="https://purrr.tidyverse.org/reference/pluck.html">chuck()</a></code> that will return an error instead of NULL if an element does not exist.</p>
</div>
</div>
<div id="convert-list-to-data-frame" class="section level3 unnumbered">
<h3>Convert list to data frame<a class="anchor" aria-label="anchor" href="#convert-list-to-data-frame"><i class="fas fa-link"></i></a>
</h3>
<p>This is a complex topic - see the Resources section for more complete tutorials. Nevertheless, we will demonstrate converting the list of t-test results into a data frame. We will create a data frame with columns for the variable, its p-value, and the means from the two groups (male and female).</p>
<p>Here are some of the new approaches and functions that will be used:</p>
<ul>
<li>The function <code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code> will be used to create a tibble (like a data frame)
<ul>
<li>We surround the <code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code> function with curly brackets <code><a href="https://rdrr.io/r/base/Paren.html">{ }</a></code> to prevent the entire <code>t.test_results</code> from being stored as the first tibble column<br>
</li>
</ul>
</li>
<li>Within <code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code>, each column is created explicitly, similar to the syntax of <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>:
<ul>
<li>The <code>.</code> represents <code>t.test_results</code>
</li>
<li>To create a column with the t-test variable names (the names of each list element) we use <code><a href="https://rdrr.io/r/base/names.html">names()</a></code> as described above<br>
</li>
<li>To create a column with the p-values we use <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code> as described above to pull the <code>p.value</code> elements and convert them to a numeric vector</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb809"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>    p         <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"p.value"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<pre><code>## # A tibble: 5 × 2
##   variables         p
##   &lt;chr&gt;         &lt;dbl&gt;
## 1 age       2.35e- 96
## 2 wt_kg     2.66e-182
## 3 ht_cm     3.52e-144
## 4 ct_blood  4.47e-  1
## 5 temp      5.74e-  1</code></pre>
<p>But now let’s add columns containing the means for each group (males and females).</p>
<p>We would need to extract the element <code>estimate</code>, but this actually contains <em>two</em> elements within it (<code>mean in group f</code> and <code>mean in group m</code>). So, it cannot be simplified into a vector with <code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code> or <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code>. Instead, we use <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, which used within <code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code> will create <em>a column of class list within the tibble</em>! Yes, this is possible!</p>
<div class="sourceCode" id="cb811"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>    p <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"p.value"</span><span class="op">)</span>,</span>
<span>    means <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"estimate"</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
<pre><code>## # A tibble: 5 × 3
##   variables         p means       
##   &lt;chr&gt;         &lt;dbl&gt; &lt;named list&gt;
## 1 age       2.35e- 96 &lt;dbl [2]&gt;   
## 2 wt_kg     2.66e-182 &lt;dbl [2]&gt;   
## 3 ht_cm     3.52e-144 &lt;dbl [2]&gt;   
## 4 ct_blood  4.47e-  1 &lt;dbl [2]&gt;   
## 5 temp      5.74e-  1 &lt;dbl [2]&gt;</code></pre>
<p>Once you have this list column, there are several <strong>tidyr</strong> functions (part of <strong>tidyverse</strong>) that help you “rectangle” or “un-nest” these “nested list” columns. Read more about them <a href="">here</a>, or by running <code><a href="https://tidyr.tidyverse.org/articles/rectangle.html">vignette("rectangle")</a></code>. In brief:</p>
<ul>
<li>
<code><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider()</a></code> - gives each element of a list-column its own column<br>
</li>
<li>
<code><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_longer()</a></code> - gives each element of a list-column its own row</li>
<li>
<code><a href="https://tidyr.tidyverse.org/reference/hoist.html">hoist()</a></code> - acts like <code><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider()</a></code> but you specify which elements to unnest</li>
</ul>
<p>Below, we pass the tibble to <code><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider()</a></code> specifying the tibble’s <code>means</code> column (which is a nested list). The result is that <code>means</code> is replaced by two new columns, each reflecting the two elements that were previously in each <code>means</code> cell.</p>
<div class="sourceCode" id="cb813"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t.test_results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="op">{</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>,</span>
<span>    p <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"p.value"</span><span class="op">)</span>,</span>
<span>    means <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"estimate"</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/hoist.html">unnest_wider</a></span><span class="op">(</span><span class="va">means</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tibble: 5 × 4
##   variables         p `mean in group f` `mean in group m`
##   &lt;chr&gt;         &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;
## 1 age       2.35e- 96              12.7              19.6
## 2 wt_kg     2.66e-182              45.8              59.6
## 3 ht_cm     3.52e-144             109.              142. 
## 4 ct_blood  4.47e-  1              21.2              21.2
## 5 temp      5.74e-  1              38.6              38.6</code></pre>
</div>
<div id="discard-keep-and-compact-lists" class="section level3 unnumbered">
<h3>Discard, keep, and compact lists<a class="anchor" aria-label="anchor" href="#discard-keep-and-compact-lists"><i class="fas fa-link"></i></a>
</h3>
<p>Because working with <strong>purrr</strong> so often involves lists, we will briefly explore some <strong>purrr</strong> functions to modify lists. See the Resources section for more complete tutorials on <strong>purrr</strong> functions.</p>
<ul>
<li>
<code><a href="https://purrr.tidyverse.org/reference/list_modify.html">list_modify()</a></code> has many uses, one of which can be to remove a list element<br>
</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/keep.html">keep()</a></code> retains the elements specified to <code>.p =</code>, or where a function supplied to <code>.p =</code> evaluates to TRUE<br>
</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/keep.html">discard()</a></code> removes the elements specified to <code>.p</code>, or where a function supplied to <code>.p =</code> evaluates to TRUE<br>
</li>
<li>
<code><a href="https://purrr.tidyverse.org/reference/keep.html">compact()</a></code> removes all empty elements</li>
</ul>
<p>Here are some examples using the <code>combined</code> list created in the section above on <a href="iteration-loops-and-lists.html#iter_combined">using map() to import and combine multiple files</a> (it contains 6 case linelist data frames):</p>
<p>Elements can be removed by name with <code><a href="https://purrr.tidyverse.org/reference/list_modify.html">list_modify()</a></code> and setting the name equal to <code>NULL</code>.</p>
<div class="sourceCode" id="cb815"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_modify.html">list_modify</a></span><span class="op">(</span><span class="st">"Central Hospital"</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>   <span class="co"># remove list element by name</span></span></code></pre></div>
<p>You can also remove elements by criteria, by providing a “predicate” equation to <code>.p =</code> (an equation that evaluates to either TRUE or FALSE). Place a tilde <code>~</code> before the function and use <code>.x</code> to represent the list element. Using <code><a href="https://purrr.tidyverse.org/reference/keep.html">keep()</a></code> the list elements that evaluate to TRUE will be kept. Inversely, if using <code><a href="https://purrr.tidyverse.org/reference/keep.html">discard()</a></code> the list elements that evaluate to TRUE will be removed.</p>
<div class="sourceCode" id="cb816"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># keep only list elements with more than 500 rows</span></span>
<span><span class="va">combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">keep</a></span><span class="op">(</span>.p <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">500</span><span class="op">)</span>  </span></code></pre></div>
<p>In the below example, list elements are discarded if their class are not data frames.</p>
<div class="sourceCode" id="cb817"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Discard list elements that are not data frames</span></span>
<span><span class="va">combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">discard</a></span><span class="op">(</span>.p <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"data.frame"</span><span class="op">)</span></span></code></pre></div>
<p>Your predicate function can also reference elements/columns within each list item. For example, below, list elements where the mean of column <code>ct_blood</code> is over 25 are discarded.</p>
<div class="sourceCode" id="cb818"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># keep only list elements where ct_blood column mean is over 25</span></span>
<span><span class="va">combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">discard</a></span><span class="op">(</span>.p <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">ct_blood</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">25</span><span class="op">)</span>  </span></code></pre></div>
<p>This command would remove all empty list elements:</p>
<div class="sourceCode" id="cb819"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove all empty list elements</span></span>
<span><span class="va">combined</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html">compact</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="pmap" class="section level3 unnumbered">
<h3>
<code>pmap()</code><a class="anchor" aria-label="anchor" href="#pmap"><i class="fas fa-link"></i></a>
</h3>
<p>THIS SECTION IS UNDER CONSTRUCTION</p>
</div>
</div>
<div id="apply-functions" class="section level2" number="16.4">
<h2>
<span class="header-section-number">16.4</span> Apply functions<a class="anchor" aria-label="anchor" href="#apply-functions"><i class="fas fa-link"></i></a>
</h2>
<p>The “apply” family of functions is a <strong>base</strong> R alternative to <strong>purrr</strong> for iterative operations. You can read more about them <a href="https://www.datacamp.com/community/tutorials/r-tutorial-apply-family">here</a>.</p>
<!-- ======================================================= -->
</div>
<div id="resources-9" class="section level2" number="16.5">
<h2>
<span class="header-section-number">16.5</span> Resources<a class="anchor" aria-label="anchor" href="#resources-9"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://datacarpentry.org/semester-biology/materials/for-loops-R/">for loops with Data Carpentry</a></p>
<p>The <a href="https://r4ds.had.co.nz/iteration.html#iteration">R for Data Science page on iteration</a></p>
<p><a href="https://martinctc.github.io/blog/vignette-write-and-read-multiple-excel-files-with-purrr/">Vignette on write/read Excel files</a></p>
<p>A purrr <a href="https://jennybc.github.io/purrr-tutorial/index.html">tutorial</a> by jennybc</p>
<p>Another purrr <a href="http://www.rebeccabarter.com/blog/2019-08-19_purrr/">tutorial</a> by Rebecca Barter</p>
<p>A purrr <a href="http://zevross.com/blog/2019/06/11/the-power-of-three-purrr-poseful-iteration-in-r-with-map-pmap-and-imap/">tutorial</a> on map, pmap, and imap</p>
<p><a href="https://raw.githubusercontent.com/rstudio/cheatsheets/master/pngs/thumbnails/purrr-cheatsheet-thumbs.png">purrr cheatsheet</a></p>
<p><a href="https://www.emilhvitfeldt.com/post/2018-01-08-purrr-tips-and-tricks/">purrr tips and tricks</a></p>
<p><a href="https://hookedondata.org/going-off-the-map/#keep-and-discard">keep and discard</a></p>

</div>
</div>



<div class="chapter-nav">
<div class="prev"><a href="de-duplication.html"><span class="header-section-number">15</span> De-duplication</a></div>
<div class="next"><a href="descriptive-tables.html"><span class="header-section-number">17</span> Descriptive tables</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#iteration-loops-and-lists"><span class="header-section-number">16</span> Iteration, loops, and lists</a></li>
<li>
<a class="nav-link" href="#preparation-7"><span class="header-section-number">16.1</span> Preparation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#load-packages-8">Load packages</a></li>
<li><a class="nav-link" href="#import-data-9">Import data</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#for-loops"><span class="header-section-number">16.2</span> for loops</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#iter_loops">for loops in R</a></li>
<li><a class="nav-link" href="#core-components">Core components</a></li>
<li><a class="nav-link" href="#sequence">Sequence</a></li>
<li><a class="nav-link" href="#operations">Operations</a></li>
<li><a class="nav-link" href="#container">Container</a></li>
<li><a class="nav-link" href="#printing">Printing</a></li>
<li><a class="nav-link" href="#testing-your-for-loop">Testing your for loop</a></li>
<li><a class="nav-link" href="#looping-plots">Looping plots</a></li>
<li><a class="nav-link" href="#tracking-progress-of-a-loop">Tracking progress of a loop</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#iter_purrr"><span class="header-section-number">16.3</span> purrr and lists</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#load-packages-9">Load packages</a></li>
<li><a class="nav-link" href="#map">map()</a></li>
<li><a class="nav-link" href="#split-dataset-and-export">Split dataset and export</a></li>
<li><a class="nav-link" href="#custom-functions">Custom functions</a></li>
<li><a class="nav-link" href="#mapping-a-function-across-columns">Mapping a function across columns</a></li>
<li><a class="nav-link" href="#extract-from-lists">Extract from lists</a></li>
<li><a class="nav-link" href="#convert-list-to-data-frame">Convert list to data frame</a></li>
<li><a class="nav-link" href="#discard-keep-and-compact-lists">Discard, keep, and compact lists</a></li>
<li><a class="nav-link" href="#pmap">pmap()</a></li>
</ul>
</li>
<li><a class="nav-link" href="#apply-functions"><span class="header-section-number">16.4</span> Apply functions</a></li>
<li><a class="nav-link" href="#resources-9"><span class="header-section-number">16.5</span> Resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>
</div>
  

  

</div>
 <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>The Epidemiologist R Handbook</strong>" was written by the handbook team. It was last built on 2022-11-20.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
